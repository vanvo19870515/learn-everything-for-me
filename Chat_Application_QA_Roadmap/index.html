
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Knowledge base for SDET, Playwright, Selenium, API, and QA strategy">
      
      
      
        <link rel="canonical" href="https://vanvo19870515.github.io/learn-everything-for-me/Chat_Application_QA_Roadmap/">
      
      
        <link rel="prev" href="../sql-roadmap/">
      
      
        <link rel="next" href="../Chat_Application_QA_Roadmap_Infographic.html">
      
      
        
      
      
      <link rel="icon" href="../assets/avatar-32.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.7.1">
    
    
      
        <title>QA Chat Application Roadmap - Learn Everything For Me</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.484c7ddc.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.ab4e12ef.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="blue" data-md-color-accent="light-blue">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#learning-roadmap-chat-application-testing-qa-sdet-real-time" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="Learn Everything For Me" class="md-header__button md-logo" aria-label="Learn Everything For Me" data-md-component="logo">
      
  <img src="../assets/avatar.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Learn Everything For Me
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              QA Chat Application Roadmap
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="default" data-md-color-primary="blue" data-md-color-accent="light-blue"  aria-hidden="true"  type="radio" name="__palette" id="__palette_0">
    
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="slate" data-md-color-primary="blue" data-md-color-accent="light-blue"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="m17.75 4.09-2.53 1.94.91 3.06-2.63-1.81-2.63 1.81.91-3.06-2.53-1.94L12.44 4l1.06-3 1.06 3zm3.5 6.91-1.64 1.25.59 1.98-1.7-1.17-1.7 1.17.59-1.98L15.75 11l2.06-.05L18.5 9l.69 1.95zm-2.28 4.95c.83-.08 1.72 1.1 1.19 1.85-.32.45-.66.87-1.08 1.27C15.17 23 8.84 23 4.94 19.07c-3.91-3.9-3.91-10.24 0-14.14.4-.4.82-.76 1.27-1.08.75-.53 1.93.36 1.85 1.19-.27 2.86.69 5.83 2.89 8.02a9.96 9.96 0 0 0 8.02 2.89m-1.64 2.02a12.08 12.08 0 0 1-7.8-3.47c-2.17-2.19-3.33-5-3.49-7.82-2.81 3.14-2.7 7.96.31 10.98 3.02 3.01 7.84 3.12 10.98.31"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
      <div class="md-header__source">
        <a href="https://github.com/vanvo19870515/learn-everything-for-me" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    vanvo19870515/learn-everything-for-me
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="Learn Everything For Me" class="md-nav__button md-logo" aria-label="Learn Everything For Me" data-md-component="logo">
      
  <img src="../assets/avatar.png" alt="logo">

    </a>
    Learn Everything For Me
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/vanvo19870515/learn-everything-for-me" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    vanvo19870515/learn-everything-for-me
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Home
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
        
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_2" >
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    
  
    Playwright
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            
  
    Playwright
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../Playwright_Guide_Reorganized/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Playwright Guide
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../playwright-agents/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Canary & Agentic Workflow
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../playwright-fixtures/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Fixtures & Config
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../playwright-assertions/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Assertions Reference
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../playwright-reporter/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Reporter API
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../playwright-library/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Library vs Test Runner
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../migration-guides/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Migration Guides
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
        
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_3" >
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    
  
    SQL Resources
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            
  
    SQL Resources
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../sql-roadmap/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    SQL Roadmap
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
    
      
        
        
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" checked>
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    
  
    QA Resources
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            
  
    QA Resources
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    
  
    QA Chat Application Roadmap
  

    
  </span>
  
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    
  
    QA Chat Application Roadmap
  

    
  </span>
  
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#mind-map-overview" class="md-nav__link">
    <span class="md-ellipsis">
      
        ğŸ“Š Mind Map Overview
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ultimate-goal" class="md-nav__link">
    <span class="md-ellipsis">
      
        ğŸ¯ Ultimate Goal
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#learning-path-diagram" class="md-nav__link">
    <span class="md-ellipsis">
      
        ğŸ“ˆ Learning Path Diagram
      
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../Chat_Application_QA_Roadmap_Infographic.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    QA Chat Application Roadmap Infographic
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../k6_performance_testing/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    QA Load Test with K6
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../k6-grafana-very-detail/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    QA K6 Grafana roadmap detail
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../security-testing-apis/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    QA APIs Security Testing
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../qa-sdet-roadmap/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    QA/SDET Transition Roadmap
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../qa-roadmap/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    QA & Automation Roadmap
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../sdet-framework-foundation/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    QA Core Principles Framework Roadmap
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../playwright-sdet-framework-intro/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    SDET Framework Introduction (Example)
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../n8n-road-map/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    QA n8n roadmap
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
        
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_5" >
        
          
          <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    
  
    Data Resources
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            
  
    Data Resources
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../elasticsearch-roadmap/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Elasticsearch Roadmap
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../elasticsearch-query-deepdive/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Elasticsearch Query Deep Dive
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../http-caching/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    HTTP Caching Guide
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
        
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_6" >
        
          
          <label class="md-nav__link" for="__nav_6" id="__nav_6_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    
  
    Testing Strategy
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6">
            <span class="md-nav__icon md-icon"></span>
            
  
    Testing Strategy
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../Test_Automation_Pyramid_Guide/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Test Automation Pyramid
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../Flaky_Test_Guide/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Flaky Test Guide
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../Flaky_Test_Infographic.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Flaky Test Infographic
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../ui-api-pom-comparison/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    UI POM vs API POM
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../shift-left-testing/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Shift-Left Testing
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../mutation-testing/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Mutation Testing
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
        
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_7" >
        
          
          <label class="md-nav__link" for="__nav_7" id="__nav_7_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    
  
    SDET Prep
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_7_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_7">
            <span class="md-nav__icon md-icon"></span>
            
  
    SDET Prep
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../SDET_Interview_Preparation_Guide/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    SDET Interview Preparation
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../Experienced_Automation_Tester_QA/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Experienced Automation Tester Q&A
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../Automation_Interview_QA/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Automation Interview Q&A
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../java-oop-concepts/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Java OOP Concepts
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#mind-map-overview" class="md-nav__link">
    <span class="md-ellipsis">
      
        ğŸ“Š Mind Map Overview
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ultimate-goal" class="md-nav__link">
    <span class="md-ellipsis">
      
        ğŸ¯ Ultimate Goal
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#learning-path-diagram" class="md-nav__link">
    <span class="md-ellipsis">
      
        ğŸ“ˆ Learning Path Diagram
      
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              
              <article class="md-content__inner md-typeset">
                
                  


  
  


<h1 id="learning-roadmap-chat-application-testing-qa-sdet-real-time">ğŸ§­ LEARNING ROADMAP: CHAT APPLICATION TESTING (QA / SDET â€“ REAL-TIME)<a class="headerlink" href="#learning-roadmap-chat-application-testing-qa-sdet-real-time" title="Permanent link">&para;</a></h1>
<h2 id="mind-map-overview">ğŸ“Š Mind Map Overview<a class="headerlink" href="#mind-map-overview" title="Permanent link">&para;</a></h2>
<p><img alt="QA Roadmap for Chat App" src="../assets/unnamed.png" /></p>
<div class="highlight"><pre><span></span><code>mindmap
  root((Chat Application&lt;br/&gt;QA Roadmap))
    Phase 1: Foundations
      WebSocket Basics
        Handshake
        Open/Close
        Message Flow
      Socket.io Concepts
        Namespaces
        Rooms
        Events
        Heartbeat
      Key Differences
        Request/Response vs Persistent
        Stateless vs Stateful
        TPS vs Concurrent
    Phase 2: Performance
      Metrics
        Concurrent Connections
        Message Throughput
        Message Latency
        Reconnect Rate
      Tools
        k6 (Recommended)
        JMeter
      Test Scenarios
        Spike Test
        Soak Test
        Burst Test
    Phase 3: Security
      IDOR Issues
        Room Access
        Message Access
        User Impersonation
      Authentication
        Token Management
        Reconnection Auth
      Encryption
        E2EE
        Data Leak
        WSS Protocol
      Tools
        Burp Suite
        DevTools
        Postman
    Phase 4: Advanced
      Strategic Questions
        Architecture Understanding
        Failure Scenarios
        System Design
      Deliverables
        Performance Strategy
        Security Checklist
        Failure Analysis
</code></pre></div>
<hr />
<h2 id="ultimate-goal">ğŸ¯ Ultimate Goal<a class="headerlink" href="#ultimate-goal" title="Permanent link">&para;</a></h2>
<p>After <strong>3â€“6 months</strong>, you will be able to:</p>
<ul>
<li>âœ… <strong>Design Performance Tests</strong> for Real-time Chat systems</li>
<li>âœ… <strong>Identify &amp; simulate</strong> real-world bottlenecks</li>
<li>âœ… <strong>Master Security &amp; Privacy</strong> testing for Chat applications</li>
<li>âœ… <strong>Consult effectively</strong> with Backend / Product / Security teams</li>
<li>âœ… <strong>Become a specialized Chat QA</strong> (rare &amp; highly-paid role)</li>
</ul>
<hr />
<h2 id="learning-path-diagram">ğŸ“ˆ Learning Path Diagram<a class="headerlink" href="#learning-path-diagram" title="Permanent link">&para;</a></h2>
<div class="highlight"><pre><span></span><code>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    CHAT APPLICATION QA ROADMAP                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                     â”‚                     â”‚
    â”Œâ”€â”€â”€â–¼â”€â”€â”€â”            â”Œâ”€â”€â”€â–¼â”€â”€â”€â”            â”Œâ”€â”€â”€â–¼â”€â”€â”€â”
    â”‚ WEEK  â”‚            â”‚ WEEK  â”‚            â”‚ WEEK  â”‚
    â”‚ 1-3   â”‚            â”‚ 4-9   â”‚            â”‚ 10-13 â”‚
    â”‚       â”‚            â”‚       â”‚            â”‚       â”‚
    â”‚Phase 1â”‚            â”‚Phase 2â”‚            â”‚Phase 3â”‚
    â”‚Foundation          â”‚Performance         â”‚Securityâ”‚
    â””â”€â”€â”€â”¬â”€â”€â”€â”˜            â””â”€â”€â”€â”¬â”€â”€â”€â”˜            â””â”€â”€â”€â”¬â”€â”€â”€â”˜
        â”‚                    â”‚                    â”‚
        â”‚                    â”‚                    â”‚
    â”Œâ”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”
    â”‚              WEEK 14-24 (Optional)                â”‚
    â”‚                                                    â”‚
    â”‚                 Phase 4: Advanced                 â”‚
    â”‚         Become &quot;Product Guardian&quot;                 â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</code></pre></div>
<hr />
<h1 id="phase-1-real-time-foundations-23-weeks">ğŸ“š PHASE 1 â€” REAL-TIME FOUNDATIONS (2â€“3 Weeks)<a class="headerlink" href="#phase-1-real-time-foundations-23-weeks" title="Permanent link">&para;</a></h1>
<h2 id="what-you-need-to-learn-first">ğŸ“ What You Need to Learn First<a class="headerlink" href="#what-you-need-to-learn-first" title="Permanent link">&para;</a></h2>
<h3 id="1-understanding-chat-traditional-web">1ï¸âƒ£ Understanding Chat â‰  Traditional Web<a class="headerlink" href="#1-understanding-chat-traditional-web" title="Permanent link">&para;</a></h3>
<h4 id="core-differences-explained">ğŸ”„ Core Differences Explained<a class="headerlink" href="#core-differences-explained" title="Permanent link">&para;</a></h4>
<table>
<thead>
<tr>
<th style="text-align: left;">Aspect</th>
<th style="text-align: left;">Traditional Web</th>
<th style="text-align: left;">Chat (Real-time)</th>
<th style="text-align: left;">Why It Matters</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><strong>Communication Pattern</strong></td>
<td style="text-align: left;">Request/Response</td>
<td style="text-align: left;">Persistent Connection</td>
<td style="text-align: left;">Chat needs constant connection</td>
</tr>
<tr>
<td style="text-align: left;"><strong>State Management</strong></td>
<td style="text-align: left;">Stateless</td>
<td style="text-align: left;">Stateful</td>
<td style="text-align: left;">Chat remembers who's connected</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Primary Metric</strong></td>
<td style="text-align: left;">TPS (Transactions Per Sec)</td>
<td style="text-align: left;">Concurrent Connections</td>
<td style="text-align: left;">We care about users, not requests</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Latency Focus</strong></td>
<td style="text-align: left;">Page Load Time</td>
<td style="text-align: left;">Message Latency</td>
<td style="text-align: left;">Users expect instant delivery</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Protocol</strong></td>
<td style="text-align: left;">HTTP</td>
<td style="text-align: left;">WebSocket / Socket.io</td>
<td style="text-align: left;">Different protocol = different testing</td>
</tr>
</tbody>
</table>
<h4 id="visual-comparison">ğŸ’¡ Visual Comparison<a class="headerlink" href="#visual-comparison" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>Traditional Web (HTTP):
â”Œâ”€â”€â”€â”€â”€â”€â”  Request   â”Œâ”€â”€â”€â”€â”€â”€â”
â”‚Clientâ”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚Serverâ”‚
â””â”€â”€â”€â”€â”€â”€â”˜            â””â”€â”€â”€â”€â”€â”€â”˜
â”Œâ”€â”€â”€â”€â”€â”€â”  Response  â”Œâ”€â”€â”€â”€â”€â”€â”
â”‚Clientâ”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤Serverâ”‚
â””â”€â”€â”€â”€â”€â”€â”˜            â””â”€â”€â”€â”€â”€â”€â”˜
(Connection closes after each request)

Real-time Chat (WebSocket):
â”Œâ”€â”€â”€â”€â”€â”€â”  Handshake  â”Œâ”€â”€â”€â”€â”€â”€â”
â”‚Clientâ”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚Serverâ”‚
â””â”€â”€â”€â”€â”€â”€â”˜             â””â”€â”€â”€â”€â”€â”€â”˜
â”Œâ”€â”€â”€â”€â”€â”€â”             â”Œâ”€â”€â”€â”€â”€â”€â”
â”‚Clientâ”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚Serverâ”‚ (Persistent)
â””â”€â”€â”€â”€â”€â”€â”˜             â””â”€â”€â”€â”€â”€â”€â”˜
â”‚Clientâ”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤Serverâ”‚ (Bi-directional)
â””â”€â”€â”€â”€â”€â”€â”˜             â””â”€â”€â”€â”€â”€â”€â”˜
(Connection stays open, messages flow both ways)
</code></pre></div>
<h3 id="2-essential-knowledge-you-dont-need-to-code-backend">2ï¸âƒ£ Essential Knowledge (You Don't Need to Code Backend!)<a class="headerlink" href="#2-essential-knowledge-you-dont-need-to-code-backend" title="Permanent link">&para;</a></h3>
<h4 id="websocket-lifecycle-must-understand">ğŸ”Œ WebSocket Lifecycle (Must Understand)<a class="headerlink" href="#websocket-lifecycle-must-understand" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>sequenceDiagram
    participant C as Client
    participant S as Server

    Note over C,S: 1. HANDSHAKE Phase
    C-&gt;&gt;S: HTTP Upgrade Request
    S-&gt;&gt;C: 101 Switching Protocols

    Note over C,S: 2. CONNECTION OPENED
    S-&gt;&gt;C: Connection Established

    Note over C,S: 3. MESSAGE Exchange
    C-&gt;&gt;S: Send Message (text/binary)
    S-&gt;&gt;C: Acknowledge
    S-&gt;&gt;C: Broadcast to Other Users

    Note over C,S: 4. HEARTBEAT (Keep-Alive)
    C-&gt;&gt;S: Ping
    S-&gt;&gt;C: Pong

    Note over C,S: 5. CONNECTION CLOSE
    C-&gt;&gt;S: Close Frame
    S-&gt;&gt;C: Close Frame
    Connection Closed
</code></pre></div>
<p><strong>What Each Phase Means:</strong></p>
<ol>
<li><strong>Handshake</strong></li>
<li>Client sends HTTP request with <code>Upgrade: websocket</code> header</li>
<li>Server responds with <code>101 Switching Protocols</code></li>
<li>
<p>Connection upgrades from HTTP to WebSocket</p>
</li>
<li>
<p><strong>Open</strong></p>
</li>
<li>Connection is established</li>
<li>Both sides can send/receive immediately</li>
<li>
<p>No need to open new connection for each message</p>
</li>
<li>
<p><strong>Message</strong></p>
</li>
<li>Data can flow both ways (client â†” server)</li>
<li>Messages can be text or binary</li>
<li>
<p>No headers needed (unlike HTTP)</p>
</li>
<li>
<p><strong>Close</strong></p>
</li>
<li>Either side can initiate close</li>
<li>Connection gracefully terminates</li>
<li>Resources are cleaned up</li>
</ol>
<h4 id="socketio-concepts-most-chat-apps-use-this">ğŸ¯ Socket.io Concepts (Most Chat Apps Use This)<a class="headerlink" href="#socketio-concepts-most-chat-apps-use-this" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>Socket.io Architecture:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         Socket.io Server                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚      Namespace: &quot;/chat&quot;           â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
â”‚  â”‚  â”‚   Room: &quot;room-123&quot;          â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”   â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â”‚User1â”‚ â”‚User2â”‚ â”‚User3â”‚   â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”˜   â”‚  â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
â”‚  â”‚  â”‚   Room: &quot;room-456&quot;          â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”           â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â”‚User4â”‚ â”‚User5â”‚           â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”˜           â”‚  â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</code></pre></div>
<p><strong>Key Concepts Explained:</strong></p>
<ol>
<li><strong>Namespace</strong> (<code>/chat</code>, <code>/admin</code>)</li>
<li>Logical separation of different app features</li>
<li>Like different "departments" in a building</li>
<li>
<p>Example: <code>/chat</code> for messaging, <code>/notification</code> for alerts</p>
</li>
<li>
<p><strong>Room</strong> (<code>room-123</code>, <code>user-456</code>)</p>
</li>
<li>A channel where users can chat</li>
<li>Users can join/leave rooms</li>
<li>
<p>Messages sent to a room reach all users in that room</p>
</li>
<li>
<p><strong>Event-based Messaging</strong>
   <div class="highlight"><pre><span></span><code><span class="c1">// Client sends</span>
<span class="nx">socket</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;send_message&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">text</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Hello&#39;</span><span class="w"> </span><span class="p">});</span>

<span class="c1">// Server receives and broadcasts</span>
<span class="nx">io</span><span class="p">.</span><span class="nx">to</span><span class="p">(</span><span class="s1">&#39;room-123&#39;</span><span class="p">).</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;new_message&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">text</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Hello&#39;</span><span class="w"> </span><span class="p">});</span>

<span class="c1">// All clients in room-123 receive</span>
<span class="nx">socket</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;new_message&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="nx">data</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">text</span><span class="p">);</span><span class="w"> </span><span class="c1">// &quot;Hello&quot;</span>
<span class="p">});</span>
</code></pre></div></p>
</li>
<li>
<p><strong>Heartbeat (Ping-Pong)</strong></p>
</li>
<li>Keep-alive mechanism</li>
<li>Server sends ping, client responds with pong</li>
<li>If no pong received, connection is considered dead</li>
<li>
<p><strong>Why important for testing</strong>: Network issues can cause false disconnections</p>
</li>
<li>
<p><strong>Fan-out (1 â†’ N users)</strong></p>
</li>
<li><strong>This is the stress point!</strong></li>
<li>1 user sends message â†’ Server broadcasts to N users</li>
<li>If 10,000 users in a room, 1 message = 10,000 server operations</li>
<li><strong>This is where performance testing focuses</strong></li>
</ol>
<h4 id="practical-learning-exercise">ğŸ“ Practical Learning Exercise<a class="headerlink" href="#practical-learning-exercise" title="Permanent link">&para;</a></h4>
<p><strong>Week 1-2: Build Understanding</strong></p>
<ol>
<li><strong>Day 1-2</strong>: Study WebSocket basics</li>
<li>Watch: "WebSocket explained in 5 minutes" (YouTube)</li>
<li>Read: MDN WebSocket API documentation</li>
<li>
<p><strong>Goal</strong>: Understand the handshake process</p>
</li>
<li>
<p><strong>Day 3-4</strong>: Explore Socket.io</p>
</li>
<li>Visit: socket.io/get-started/chat</li>
<li>Run their example chat app locally</li>
<li>
<p><strong>Goal</strong>: See how rooms and namespaces work</p>
</li>
<li>
<p><strong>Day 5-7</strong>: Test a simple chat</p>
</li>
<li>Use browser DevTools â†’ Network â†’ WS tab</li>
<li>Observe messages being sent/received</li>
<li><strong>Goal</strong>: Visualize the real-time flow</li>
</ol>
<p><strong>Week 3: Deep Dive</strong></p>
<ol>
<li><strong>Day 8-10</strong>: Understand fan-out</li>
<li>Test: 1 user sends â†’ how many receive?</li>
<li>Observe: Server logs during broadcast</li>
<li>
<p><strong>Goal</strong>: Grasp the "1 â†’ N" concept</p>
</li>
<li>
<p><strong>Day 11-14</strong>: Document your learnings</p>
</li>
<li>Write: "Chat Architecture Notes" for yourself</li>
<li>Create: Simple diagram of how chat works</li>
<li><strong>Goal</strong>: Solidify understanding</li>
</ol>
<hr />
<h1 id="phase-2-performance-testing-for-chat-46-weeks">ğŸ”¥ PHASE 2 â€” PERFORMANCE TESTING FOR CHAT (4â€“6 Weeks)<a class="headerlink" href="#phase-2-performance-testing-for-chat-46-weeks" title="Permanent link">&para;</a></h1>
<h2 id="why-chat-performance-testing-is-different">ğŸ“Š Why Chat Performance Testing is Different<a class="headerlink" href="#why-chat-performance-testing-is-different" title="Permanent link">&para;</a></h2>
<h3 id="the-fundamental-shift">The Fundamental Shift<a class="headerlink" href="#the-fundamental-shift" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code>Traditional Web Performance Testing:
Focus: How many requests per second?
Metric: TPS (Transactions Per Second)
Test: Can server handle 1000 req/sec?

Chat Performance Testing:
Focus: How many users can stay connected?
Metric: Concurrent Connections
Test: Can 10,000 users stay connected and chat?
</code></pre></div>
<h3 id="3-critical-metrics-completely-different-from-web">3ï¸âƒ£ Critical Metrics (Completely Different from Web!)<a class="headerlink" href="#3-critical-metrics-completely-different-from-web" title="Permanent link">&para;</a></h3>
<h4 id="metrics-overview-diagram">ğŸ“ˆ Metrics Overview Diagram<a class="headerlink" href="#metrics-overview-diagram" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>graph TD
    A[Chat Performance Metrics] --&gt; B[Connection Metrics]
    A --&gt; C[Message Metrics]
    A --&gt; D[System Metrics]

    B --&gt; B1[Concurrent Connections]
    B --&gt; B2[Connection Establishment Time]
    B --&gt; B3[Reconnect Rate]
    B --&gt; B4[Drop Rate]

    C --&gt; C1[Message Throughput msg/sec]
    C --&gt; C2[Message Latency p95/p99]
    C --&gt; C3[Message Delivery Rate]
    C --&gt; C4[Queue Backlog]

    D --&gt; D1[Server CPU Usage]
    D --&gt; D2[Server Memory]
    D --&gt; D3[Network Bandwidth]
    D --&gt; D4[Error Rate]
</code></pre></div>
<h4 id="detailed-metric-explanations">Detailed Metric Explanations<a class="headerlink" href="#detailed-metric-explanations" title="Permanent link">&para;</a></h4>
<p><strong>1. Concurrent Connections</strong> â­ Most Important!
- <strong>What it means</strong>: How many users are connected simultaneously
- <strong>Why it matters</strong>: Each connection consumes server resources (memory, file descriptors)
- <strong>How to measure</strong>: Count active WebSocket connections
- <strong>Example</strong>: 
  - âœ… Good: 10,000 concurrent connections, stable
  - âŒ Bad: 5,000 concurrent connections, server crashes</p>
<p><strong>2. Message Throughput (msg/sec)</strong>
- <strong>What it means</strong>: How many messages can be processed per second
- <strong>Why it matters</strong>: Chat apps need to handle message bursts
- <strong>How to measure</strong>: Messages sent Ã· time
- <strong>Example</strong>:
  - âœ… Good: 50,000 msg/sec (1 user sends â†’ 10,000 receive = 10,001 messages processed)
  - âŒ Bad: 1,000 msg/sec, messages queued and delayed</p>
<p><strong>3. Message Latency (p95 / p99)</strong>
- <strong>What it means</strong>: Time from sending to receiving
- <strong>Why it matters</strong>: Users expect instant delivery
- <strong>How to measure</strong>: 
  - p95: 95% of messages delivered within X ms
  - p99: 99% of messages delivered within Y ms
- <strong>Example</strong>:
  - âœ… Good: p95 = 50ms, p99 = 100ms
  - âŒ Bad: p95 = 5000ms (5 seconds delay!)</p>
<p><strong>4. Drop Rate</strong>
- <strong>What it means</strong>: Percentage of connections that fail/disconnect
- <strong>Why it matters</strong>: Dropped connections = bad user experience
- <strong>How to measure</strong>: (Failed connections / Total attempts) Ã— 100
- <strong>Example</strong>:
  - âœ… Good: Drop rate &lt; 0.1%
  - âŒ Bad: Drop rate &gt; 5%</p>
<p><strong>5. Reconnect Rate</strong>
- <strong>What it means</strong>: How quickly users can reconnect after disconnection
- <strong>Why it matters</strong>: Network issues happen, users need quick recovery
- <strong>How to measure</strong>: Time from disconnect to reconnect
- <strong>Example</strong>:
  - âœ… Good: Reconnect in &lt; 2 seconds
  - âŒ Bad: Reconnect takes 30+ seconds</p>
<p><strong>6. Queue Backlog</strong>
- <strong>What it means</strong>: Messages waiting to be processed
- <strong>Why it matters</strong>: Growing backlog = system can't keep up
- <strong>How to measure</strong>: Number of messages in queue
- <strong>Example</strong>:
  - âœ… Good: Queue size &lt; 100 messages
  - âŒ Bad: Queue size &gt; 10,000 messages (messages delayed)</p>
<p><strong>7. Server CPU / Memory</strong>
- <strong>What it means</strong>: Resource usage on server
- <strong>Why it matters</strong>: High usage = potential crashes
- <strong>How to measure</strong>: Monitor server metrics
- <strong>Example</strong>:
  - âœ… Good: CPU &lt; 70%, Memory stable
  - âŒ Bad: CPU &gt; 95%, Memory constantly increasing (memory leak!)</p>
<h3 id="4-recommended-tools">4ï¸âƒ£ Recommended Tools<a class="headerlink" href="#4-recommended-tools" title="Permanent link">&para;</a></h3>
<h4 id="k6-highly-recommended">âœ… k6 (Highly Recommended!)<a class="headerlink" href="#k6-highly-recommended" title="Permanent link">&para;</a></h4>
<p><strong>Why k6 for Chat Testing?</strong></p>
<div class="highlight"><pre><span></span><code>k6 Advantages:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ âœ… Native WebSocket Support         â”‚
â”‚ âœ… JavaScript-based (easy to learn) â”‚
â”‚ âœ… CI/CD Friendly                   â”‚
â”‚ âœ… Great Documentation              â”‚
â”‚ âœ… Active Community                 â”‚
â”‚ âœ… Lightweight                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</code></pre></div>
<p><strong>Example k6 Script for Chat Testing:</strong></p>
<div class="highlight"><pre><span></span><code><span class="k">import</span><span class="w"> </span><span class="nx">ws</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;k6/ws&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">check</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;k6&#39;</span><span class="p">;</span>

<span class="k">export</span><span class="w"> </span><span class="kd">const</span><span class="w"> </span><span class="nx">options</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">stages</span><span class="o">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">    </span><span class="p">{</span><span class="w"> </span><span class="nx">duration</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;1m&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">target</span><span class="o">:</span><span class="w"> </span><span class="mf">100</span><span class="w"> </span><span class="p">},</span><span class="w">    </span><span class="c1">// Ramp up to 100 users</span>
<span class="w">    </span><span class="p">{</span><span class="w"> </span><span class="nx">duration</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;3m&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">target</span><span class="o">:</span><span class="w"> </span><span class="mf">100</span><span class="w"> </span><span class="p">},</span><span class="w">    </span><span class="c1">// Stay at 100 users</span>
<span class="w">    </span><span class="p">{</span><span class="w"> </span><span class="nx">duration</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;1m&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">target</span><span class="o">:</span><span class="w"> </span><span class="mf">0</span><span class="w"> </span><span class="p">},</span><span class="w">      </span><span class="c1">// Ramp down</span>
<span class="w">  </span><span class="p">],</span>
<span class="p">};</span>

<span class="k">export</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">url</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;ws://localhost:3000/chat&#39;</span><span class="p">;</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">params</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">tags</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;ChatConnection&#39;</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">};</span>

<span class="w">  </span><span class="c1">// Connect to WebSocket</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">response</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">ws</span><span class="p">.</span><span class="nx">connect</span><span class="p">(</span><span class="nx">url</span><span class="p">,</span><span class="w"> </span><span class="nx">params</span><span class="p">,</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="p">(</span><span class="nx">socket</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// On connection open</span>
<span class="w">    </span><span class="nx">socket</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;open&#39;</span><span class="p">,</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;WebSocket connection opened&#39;</span><span class="p">);</span>

<span class="w">      </span><span class="c1">// Join a room</span>
<span class="w">      </span><span class="nx">socket</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="nb">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">({</span>
<span class="w">        </span><span class="nx">type</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;join&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="nx">room</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;test-room&#39;</span>
<span class="w">      </span><span class="p">}));</span>
<span class="w">    </span><span class="p">});</span>

<span class="w">    </span><span class="c1">// Listen for messages</span>
<span class="w">    </span><span class="nx">socket</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;message&#39;</span><span class="p">,</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="p">(</span><span class="nx">data</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">message</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span>

<span class="w">      </span><span class="nx">check</span><span class="p">(</span><span class="nx">response</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="s1">&#39;message received&#39;</span><span class="o">:</span><span class="w"> </span><span class="p">(</span><span class="nx">r</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">message</span><span class="p">.</span><span class="nx">type</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;chat&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="s1">&#39;message has text&#39;</span><span class="o">:</span><span class="w"> </span><span class="p">(</span><span class="nx">r</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">message</span><span class="p">.</span><span class="nx">text</span><span class="w"> </span><span class="o">!==</span><span class="w"> </span><span class="kc">undefined</span><span class="p">,</span>
<span class="w">      </span><span class="p">});</span>
<span class="w">    </span><span class="p">});</span>

<span class="w">    </span><span class="c1">// Send a test message every 5 seconds</span>
<span class="w">    </span><span class="nx">socket</span><span class="p">.</span><span class="nx">setInterval</span><span class="p">(</span><span class="kd">function</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">socket</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="nb">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">({</span>
<span class="w">        </span><span class="nx">type</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;message&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="nx">text</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Hello from k6!&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="nx">room</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;test-room&#39;</span>
<span class="w">      </span><span class="p">}));</span>
<span class="w">    </span><span class="p">},</span><span class="w"> </span><span class="mf">5000</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// Close connection after 30 seconds</span>
<span class="w">    </span><span class="nx">socket</span><span class="p">.</span><span class="nx">setTimeout</span><span class="p">(</span><span class="kd">function</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">socket</span><span class="p">.</span><span class="nx">close</span><span class="p">();</span>
<span class="w">    </span><span class="p">},</span><span class="w"> </span><span class="mf">30000</span><span class="p">);</span>
<span class="w">  </span><span class="p">});</span>

<span class="w">  </span><span class="nx">check</span><span class="p">(</span><span class="nx">response</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="s1">&#39;status is 101&#39;</span><span class="o">:</span><span class="w"> </span><span class="p">(</span><span class="nx">r</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">r</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">r</span><span class="p">.</span><span class="nx">status</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="mf">101</span><span class="p">,</span>
<span class="w">  </span><span class="p">});</span>
<span class="p">}</span>
</code></pre></div>
<p><strong>Learning k6 (Week 4-5):</strong></p>
<ol>
<li>
<p><strong>Day 1-2</strong>: Install and run first test
   <div class="highlight"><pre><span></span><code><span class="c1"># Install k6</span>
brew<span class="w"> </span>install<span class="w"> </span>k6<span class="w">  </span><span class="c1"># Mac</span>
<span class="c1"># or</span>
choco<span class="w"> </span>install<span class="w"> </span>k6<span class="w">  </span><span class="c1"># Windows</span>

<span class="c1"># Run example</span>
k6<span class="w"> </span>run<span class="w"> </span>chat-test.js
</code></pre></div></p>
</li>
<li>
<p><strong>Day 3-5</strong>: Understand WebSocket in k6</p>
</li>
<li>Read: k6.io/docs/javascript-api/k6-ws</li>
<li>Practice: Connect to a test chat server</li>
<li>
<p><strong>Goal</strong>: Successfully connect and send messages</p>
</li>
<li>
<p><strong>Day 6-10</strong>: Build real test scenarios</p>
</li>
<li>Test concurrent connections</li>
<li>Measure message latency</li>
<li><strong>Goal</strong>: Write your first performance test</li>
</ol>
<h4 id="jmeter-only-if-required">âš ï¸ JMeter (Only if Required)<a class="headerlink" href="#jmeter-only-if-required" title="Permanent link">&para;</a></h4>
<p><strong>Why JMeter is Less Ideal:</strong></p>
<div class="highlight"><pre><span></span><code>JMeter Limitations for Chat:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ âŒ Requires WebSocket Plugin        â”‚
â”‚ âŒ Heavy Resource Usage             â”‚
â”‚ âŒ Hard to Maintain                 â”‚
â”‚ âŒ GUI-based (harder to version)    â”‚
â”‚ âŒ Less flexible for long-running   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</code></pre></div>
<p><strong>When to Use JMeter:</strong>
- Company policy requires JMeter
- Team already uses JMeter extensively
- Need GUI-based testing</p>
<h3 id="5-real-world-test-scenarios">5ï¸âƒ£ Real-World Test Scenarios<a class="headerlink" href="#5-real-world-test-scenarios" title="Permanent link">&para;</a></h3>
<h4 id="scenario-1-spike-connections-test">Scenario 1: Spike Connections Test ğŸ”¥<a class="headerlink" href="#scenario-1-spike-connections-test" title="Permanent link">&para;</a></h4>
<p><strong>Objective</strong>: Test how server handles sudden connection surge</p>
<div class="highlight"><pre><span></span><code>Test Pattern:
Time (minutes)
0:00  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º 10,000 users
      (Ramp up in 1 minute)

Observations:
- How many connections succeed?
- Where does it fail? (Handshake? Auth?)
- Server response time?
- Error messages?
</code></pre></div>
<p><strong>k6 Script Example:</strong></p>
<div class="highlight"><pre><span></span><code><span class="k">export</span><span class="w"> </span><span class="kd">const</span><span class="w"> </span><span class="nx">options</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">stages</span><span class="o">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">    </span><span class="p">{</span><span class="w"> </span><span class="nx">duration</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;1m&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">target</span><span class="o">:</span><span class="w"> </span><span class="mf">10000</span><span class="w"> </span><span class="p">},</span><span class="w">  </span><span class="c1">// Spike to 10k in 1 min</span>
<span class="w">    </span><span class="p">{</span><span class="w"> </span><span class="nx">duration</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;2m&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">target</span><span class="o">:</span><span class="w"> </span><span class="mf">10000</span><span class="w"> </span><span class="p">},</span><span class="w">  </span><span class="c1">// Hold for 2 min</span>
<span class="w">    </span><span class="p">{</span><span class="w"> </span><span class="nx">duration</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;1m&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">target</span><span class="o">:</span><span class="w"> </span><span class="mf">0</span><span class="w"> </span><span class="p">},</span><span class="w">      </span><span class="c1">// Ramp down</span>
<span class="w">  </span><span class="p">],</span>
<span class="w">  </span><span class="nx">thresholds</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="s1">&#39;ws_connecting&#39;</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="s1">&#39;rate&lt;0.01&#39;</span><span class="p">],</span><span class="w">     </span><span class="c1">// &lt; 1% connection failures</span>
<span class="w">    </span><span class="s1">&#39;ws_session_duration&#39;</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="s1">&#39;p(95)&lt;2000&#39;</span><span class="p">],</span><span class="w"> </span><span class="c1">// 95% connect in &lt; 2s</span>
<span class="w">  </span><span class="p">},</span>
<span class="p">};</span>

<span class="k">export</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">url</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;ws://your-chat-server.com/chat&#39;</span><span class="p">;</span>

<span class="w">  </span><span class="nx">ws</span><span class="p">.</span><span class="nx">connect</span><span class="p">(</span><span class="nx">url</span><span class="p">,</span><span class="w"> </span><span class="p">{},</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="p">(</span><span class="nx">socket</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">socket</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;open&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="c1">// Test authentication</span>
<span class="w">      </span><span class="nx">socket</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="nb">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">({</span><span class="w"> </span><span class="nx">type</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;auth&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">token</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;test-token&#39;</span><span class="w"> </span><span class="p">}));</span>
<span class="w">    </span><span class="p">});</span>

<span class="w">    </span><span class="nx">socket</span><span class="p">.</span><span class="nx">setTimeout</span><span class="p">(()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">socket</span><span class="p">.</span><span class="nx">close</span><span class="p">(),</span><span class="w"> </span><span class="mf">60000</span><span class="p">);</span>
<span class="w">  </span><span class="p">});</span>
<span class="p">}</span>
</code></pre></div>
<p><strong>What to Look For:</strong>
- âœ… <strong>Good</strong>: 9,950+ connections succeed (&lt; 0.5% failure)
- âŒ <strong>Bad</strong>: Only 5,000 connections succeed (50% failure)
- ğŸ” <strong>Debug</strong>: Check server logs for "connection refused" or "timeout"</p>
<h4 id="scenario-2-soak-test-long-running">Scenario 2: Soak Test (Long-Running) â°<a class="headerlink" href="#scenario-2-soak-test-long-running" title="Permanent link">&para;</a></h4>
<p><strong>Objective</strong>: Find memory leaks and zombie connections</p>
<div class="highlight"><pre><span></span><code>Test Pattern:
Time (hours)
0:00  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º 8:00
      (5,000 users stay connected for 8 hours)

What to Monitor:
- Memory usage over time (should be stable)
- Number of active connections (should stay at 5k)
- Message delivery (should remain consistent)
</code></pre></div>
<p><strong>k6 Script Example:</strong></p>
<div class="highlight"><pre><span></span><code><span class="k">export</span><span class="w"> </span><span class="kd">const</span><span class="w"> </span><span class="nx">options</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">stages</span><span class="o">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">    </span><span class="p">{</span><span class="w"> </span><span class="nx">duration</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;5m&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">target</span><span class="o">:</span><span class="w"> </span><span class="mf">5000</span><span class="w"> </span><span class="p">},</span><span class="w">   </span><span class="c1">// Ramp up to 5k users</span>
<span class="w">    </span><span class="p">{</span><span class="w"> </span><span class="nx">duration</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;8h&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">target</span><span class="o">:</span><span class="w"> </span><span class="mf">5000</span><span class="w"> </span><span class="p">},</span><span class="w">   </span><span class="c1">// Soak for 8 hours</span>
<span class="w">    </span><span class="p">{</span><span class="w"> </span><span class="nx">duration</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;5m&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">target</span><span class="o">:</span><span class="w"> </span><span class="mf">0</span><span class="w"> </span><span class="p">},</span><span class="w">      </span><span class="c1">// Ramp down</span>
<span class="w">  </span><span class="p">],</span>
<span class="p">};</span>

<span class="k">export</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">url</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;ws://your-chat-server.com/chat&#39;</span><span class="p">;</span>

<span class="w">  </span><span class="nx">ws</span><span class="p">.</span><span class="nx">connect</span><span class="p">(</span><span class="nx">url</span><span class="p">,</span><span class="w"> </span><span class="p">{},</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="p">(</span><span class="nx">socket</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">socket</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;open&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">socket</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="nb">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">({</span><span class="w"> </span><span class="nx">type</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;join&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">room</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;soak-test&#39;</span><span class="w"> </span><span class="p">}));</span>
<span class="w">    </span><span class="p">});</span>

<span class="w">    </span><span class="c1">// Send heartbeat every 30 seconds</span>
<span class="w">    </span><span class="nx">socket</span><span class="p">.</span><span class="nx">setInterval</span><span class="p">(()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">socket</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="nb">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">({</span><span class="w"> </span><span class="nx">type</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;ping&#39;</span><span class="w"> </span><span class="p">}));</span>
<span class="w">    </span><span class="p">},</span><span class="w"> </span><span class="mf">30000</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// Listen for messages</span>
<span class="w">    </span><span class="nx">socket</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;message&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="nx">data</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="c1">// Process message</span>
<span class="w">    </span><span class="p">});</span>
<span class="w">  </span><span class="p">});</span>
<span class="p">}</span>
</code></pre></div>
<p><strong>What to Look For:</strong>
- âœ… <strong>Good</strong>: Memory usage stays flat, all connections remain active
- âŒ <strong>Bad</strong>: Memory usage increases over time (memory leak!)
- âŒ <strong>Bad</strong>: Connections drop over time (zombie connections)
- ğŸ” <strong>Debug</strong>: Use server monitoring tools (Grafana, Prometheus)</p>
<h4 id="scenario-3-burst-message-test">Scenario 3: Burst Message Test ğŸ’¥<a class="headerlink" href="#scenario-3-burst-message-test" title="Permanent link">&para;</a></h4>
<p><strong>Objective</strong>: Test rate limiting and queue overflow</p>
<div class="highlight"><pre><span></span><code>Test Pattern:
Time (seconds)
0:00  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º User sends 100 messages
      (All within 1 second)

What to Test:
- Does rate limiting work?
- Does queue overflow?
- Are messages lost?
- Server stability?
</code></pre></div>
<p><strong>k6 Script Example:</strong></p>
<div class="highlight"><pre><span></span><code><span class="k">export</span><span class="w"> </span><span class="kd">const</span><span class="w"> </span><span class="nx">options</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">vus</span><span class="o">:</span><span class="w"> </span><span class="mf">10</span><span class="p">,</span><span class="w">  </span><span class="c1">// 10 virtual users</span>
<span class="w">  </span><span class="nx">duration</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;1m&#39;</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">export</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">url</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;ws://your-chat-server.com/chat&#39;</span><span class="p">;</span>

<span class="w">  </span><span class="nx">ws</span><span class="p">.</span><span class="nx">connect</span><span class="p">(</span><span class="nx">url</span><span class="p">,</span><span class="w"> </span><span class="p">{},</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="p">(</span><span class="nx">socket</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">socket</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;open&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="c1">// Send 100 messages rapidly</span>
<span class="w">      </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">let</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mf">100</span><span class="p">;</span><span class="w"> </span><span class="nx">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">socket</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="nb">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">({</span>
<span class="w">          </span><span class="nx">type</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;message&#39;</span><span class="p">,</span>
<span class="w">          </span><span class="nx">text</span><span class="o">:</span><span class="w"> </span><span class="sb">`Message </span><span class="si">${</span><span class="nx">i</span><span class="si">}</span><span class="sb">`</span><span class="p">,</span>
<span class="w">          </span><span class="nx">room</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;burst-test&#39;</span>
<span class="w">        </span><span class="p">}));</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">});</span>

<span class="w">    </span><span class="nx">socket</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;message&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="nx">data</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="c1">// Verify message was received</span>
<span class="w">    </span><span class="p">});</span>
<span class="w">  </span><span class="p">});</span>
<span class="p">}</span>
</code></pre></div>
<p><strong>What to Look For:</strong>
- âœ… <strong>Good</strong>: Rate limiting kicks in, messages queued properly
- âŒ <strong>Bad</strong>: Server crashes or messages lost
- ğŸ” <strong>Debug</strong>: Check server logs for "rate limit exceeded" or "queue full"</p>
<h3 id="learning-path-for-phase-2">ğŸ“š Learning Path for Phase 2<a class="headerlink" href="#learning-path-for-phase-2" title="Permanent link">&para;</a></h3>
<p><strong>Week 4-5: Tool Setup &amp; Basics</strong>
- Day 1-3: Install k6, run first test
- Day 4-7: Learn WebSocket testing in k6
- Day 8-10: Write basic connection test
- Day 11-14: Measure concurrent connections</p>
<p><strong>Week 6-7: Advanced Scenarios</strong>
- Day 15-17: Implement spike test
- Day 18-21: Implement soak test
- Day 22-24: Implement burst test
- Day 25-28: Analyze results and create reports</p>
<p><strong>Week 8-9: Real-World Practice</strong>
- Day 29-35: Test a real chat application
- Day 36-42: Create performance test strategy document
- Day 43-49: Present findings to team</p>
<hr />
<h1 id="phase-3-security-privacy-for-chat-34-weeks">ğŸ›¡ï¸ PHASE 3 â€” SECURITY &amp; PRIVACY FOR CHAT (3â€“4 Weeks)<a class="headerlink" href="#phase-3-security-privacy-for-chat-34-weeks" title="Permanent link">&para;</a></h1>
<h2 id="why-chat-security-is-critical">ğŸ”’ Why Chat Security is Critical<a class="headerlink" href="#why-chat-security-is-critical" title="Permanent link">&para;</a></h2>
<p>Chat applications handle sensitive data:
- Personal conversations
- Private information
- Authentication tokens
- User presence status</p>
<p><strong>One security flaw = Data breach affecting thousands of users!</strong></p>
<h3 id="6-common-security-vulnerabilities-in-chat">6ï¸âƒ£ Common Security Vulnerabilities in Chat<a class="headerlink" href="#6-common-security-vulnerabilities-in-chat" title="Permanent link">&para;</a></h3>
<h4 id="idor-insecure-direct-object-reference">ğŸ”¥ IDOR (Insecure Direct Object Reference)<a class="headerlink" href="#idor-insecure-direct-object-reference" title="Permanent link">&para;</a></h4>
<p><strong>What is IDOR?</strong>
Accessing resources that belong to other users without authorization.</p>
<p><strong>Why Chat is Vulnerable:</strong>
- Multiple rooms/conversations
- Complex permission models
- Real-time nature makes it hard to verify</p>
<p><strong>Common IDOR Attacks in Chat:</strong></p>
<div class="highlight"><pre><span></span><code>Attack Scenario 1: Unauthorized Room Access
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Attacker&#39;s Request:                     â”‚
â”‚ POST /api/rooms/join                    â”‚
â”‚ { &quot;roomId&quot;: &quot;room-123&quot; }                â”‚
â”‚                                         â”‚
â”‚ âŒ Vulnerable: No check if user has     â”‚
â”‚    permission to join room-123          â”‚
â”‚                                         â”‚
â”‚ âœ… Secure: Verify user is invited/      â”‚
â”‚    has access before allowing join      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Attack Scenario 2: Read Other Users&#39; Messages
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Attacker&#39;s Request:                     â”‚
â”‚ GET /api/messages?conversationId=456    â”‚
â”‚                                         â”‚
â”‚ âŒ Vulnerable: Returns all messages     â”‚
â”‚    without checking if user is part of  â”‚
â”‚    conversation-456                     â”‚
â”‚                                         â”‚
â”‚ âœ… Secure: Verify user is participant   â”‚
â”‚    before returning messages            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Attack Scenario 3: Send Messages as Another User
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Attacker&#39;s WebSocket Message:           â”‚
â”‚ {                                       â”‚
â”‚   &quot;type&quot;: &quot;send_message&quot;,               â”‚
â”‚   &quot;userId&quot;: &quot;victim-user-id&quot;,  â† âš ï¸    â”‚
â”‚   &quot;text&quot;: &quot;Fake message&quot;                â”‚
â”‚ }                                       â”‚
â”‚                                         â”‚
â”‚ âŒ Vulnerable: Server trusts userId     â”‚
â”‚    from client message                  â”‚
â”‚                                         â”‚
â”‚ âœ… Secure: Use authenticated session    â”‚
â”‚    userId, ignore client-provided id   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</code></pre></div>
<p><strong>How to Test for IDOR:</strong></p>
<div class="highlight"><pre><span></span><code><span class="c1">// Test Case 1: Try to join private room</span>
<span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">testUnauthorizedRoomAccess</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// As User A</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">tokenA</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">login</span><span class="p">(</span><span class="s1">&#39;userA@example.com&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;password&#39;</span><span class="p">);</span>

<span class="w">  </span><span class="c1">// Try to join room that belongs to User B</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">response</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">fetch</span><span class="p">(</span><span class="s1">&#39;/api/rooms/join&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">method</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;POST&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="nx">headers</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="s1">&#39;Authorization&#39;</span><span class="o">:</span><span class="w"> </span><span class="sb">`Bearer </span><span class="si">${</span><span class="nx">tokenA</span><span class="si">}</span><span class="sb">`</span><span class="w"> </span><span class="p">},</span>
<span class="w">    </span><span class="nx">body</span><span class="o">:</span><span class="w"> </span><span class="nb">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">({</span><span class="w"> </span><span class="nx">roomId</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;user-b-private-room&#39;</span><span class="w"> </span><span class="p">})</span>
<span class="w">  </span><span class="p">});</span>

<span class="w">  </span><span class="c1">// Should fail with 403 Forbidden</span>
<span class="w">  </span><span class="nx">expect</span><span class="p">(</span><span class="nx">response</span><span class="p">.</span><span class="nx">status</span><span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="mf">403</span><span class="p">);</span>
<span class="p">}</span>

<span class="c1">// Test Case 2: Try to read other user&#39;s messages</span>
<span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">testUnauthorizedMessageAccess</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">tokenA</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">login</span><span class="p">(</span><span class="s1">&#39;userA@example.com&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;password&#39;</span><span class="p">);</span>

<span class="w">  </span><span class="c1">// Try to get messages from conversation between User B and User C</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">response</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">fetch</span><span class="p">(</span><span class="s1">&#39;/api/messages?conversationId=bc-conversation&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">headers</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="s1">&#39;Authorization&#39;</span><span class="o">:</span><span class="w"> </span><span class="sb">`Bearer </span><span class="si">${</span><span class="nx">tokenA</span><span class="si">}</span><span class="sb">`</span><span class="w"> </span><span class="p">}</span>
<span class="w">  </span><span class="p">});</span>

<span class="w">  </span><span class="c1">// Should fail with 403 Forbidden</span>
<span class="w">  </span><span class="nx">expect</span><span class="p">(</span><span class="nx">response</span><span class="p">.</span><span class="nx">status</span><span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="mf">403</span><span class="p">);</span>
<span class="p">}</span>

<span class="c1">// Test Case 3: Try to send message as another user</span>
<span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">testUserImpersonation</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">socket</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">io</span><span class="p">(</span><span class="s1">&#39;ws://chat-server.com&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">auth</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">token</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;user-a-token&#39;</span><span class="w"> </span><span class="p">}</span>
<span class="w">  </span><span class="p">});</span>

<span class="w">  </span><span class="nx">socket</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;connect&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// Try to send message claiming to be User B</span>
<span class="w">    </span><span class="nx">socket</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;send_message&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">userId</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;user-b-id&#39;</span><span class="p">,</span><span class="w">  </span><span class="c1">// âš ï¸ Should be ignored by server</span>
<span class="w">      </span><span class="nx">text</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Fake message&#39;</span><span class="p">,</span>
<span class="w">      </span><span class="nx">roomId</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;room-123&#39;</span>
<span class="w">    </span><span class="p">});</span>
<span class="w">  </span><span class="p">});</span>

<span class="w">  </span><span class="c1">// Verify message shows as from User A (not User B)</span>
<span class="w">  </span><span class="nx">socket</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;message_sent&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="nx">message</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">expect</span><span class="p">(</span><span class="nx">message</span><span class="p">.</span><span class="nx">userId</span><span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="s1">&#39;user-a-id&#39;</span><span class="p">);</span>
<span class="w">  </span><span class="p">});</span>
<span class="p">}</span>
</code></pre></div>
<h4 id="authentication-authorization-issues">ğŸ” Authentication &amp; Authorization Issues<a class="headerlink" href="#authentication-authorization-issues" title="Permanent link">&para;</a></h4>
<p><strong>Common Problems:</strong></p>
<div class="highlight"><pre><span></span><code>Problem 1: Token Reuse
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ âŒ Vulnerable:                           â”‚
â”‚ - Token never expires                   â”‚
â”‚ - Token can be reused multiple times    â”‚
â”‚ - Stolen token = permanent access       â”‚
â”‚                                         â”‚
â”‚ âœ… Secure:                              â”‚
â”‚ - Token expires (JWT with exp claim)    â”‚
â”‚ - One-time tokens for critical actions  â”‚
â”‚ - Refresh token mechanism               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Problem 2: Reconnection Without Re-authentication
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ âŒ Vulnerable:                           â”‚
â”‚ Client disconnects â†’ Reconnects         â”‚
â”‚ Server accepts reconnection with old    â”‚
â”‚ session (no auth check)                 â”‚
â”‚                                         â”‚
â”‚ âœ… Secure:                              â”‚
â”‚ Reconnection requires new token or      â”‚
â”‚ re-verification of existing token       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Problem 3: Token in URL
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ âŒ Vulnerable:                           â”‚
â”‚ ws://chat.com/chat?token=abc123         â”‚
â”‚                                         â”‚
â”‚ Problems:                               â”‚
â”‚ - Token visible in browser history      â”‚
â”‚ - Token in server logs                  â”‚
â”‚ - Token can be shared via URL           â”‚
â”‚                                         â”‚
â”‚ âœ… Secure:                              â”‚
â”‚ Token in Authorization header or        â”‚
â”‚ cookie (HttpOnly, Secure)               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</code></pre></div>
<p><strong>Test Cases:</strong></p>
<div class="highlight"><pre><span></span><code><span class="c1">// Test Case 1: Token Expiration</span>
<span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">testTokenExpiration</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">token</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">login</span><span class="p">(</span><span class="s1">&#39;user@example.com&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;password&#39;</span><span class="p">);</span>

<span class="w">  </span><span class="c1">// Wait for token to expire (or use expired token)</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">expiredToken</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;expired-jwt-token&#39;</span><span class="p">;</span>

<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">socket</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">io</span><span class="p">(</span><span class="s1">&#39;ws://chat-server.com&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">auth</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">token</span><span class="o">:</span><span class="w"> </span><span class="nx">expiredToken</span><span class="w"> </span><span class="p">}</span>
<span class="w">  </span><span class="p">});</span>

<span class="w">  </span><span class="nx">socket</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;connect_error&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="nx">error</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// Should reject connection</span>
<span class="w">    </span><span class="nx">expect</span><span class="p">(</span><span class="nx">error</span><span class="p">.</span><span class="nx">message</span><span class="p">).</span><span class="nx">toContain</span><span class="p">(</span><span class="s1">&#39;token expired&#39;</span><span class="p">);</span>
<span class="w">  </span><span class="p">});</span>
<span class="p">}</span>

<span class="c1">// Test Case 2: Reconnection Authentication</span>
<span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">testReconnectionAuth</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">socket</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">io</span><span class="p">(</span><span class="s1">&#39;ws://chat-server.com&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">auth</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">token</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;valid-token&#39;</span><span class="w"> </span><span class="p">}</span>
<span class="w">  </span><span class="p">});</span>

<span class="w">  </span><span class="nx">socket</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;connect&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// Disconnect</span>
<span class="w">    </span><span class="nx">socket</span><span class="p">.</span><span class="nx">disconnect</span><span class="p">();</span>

<span class="w">    </span><span class="c1">// Try to reconnect without new token</span>
<span class="w">    </span><span class="nx">socket</span><span class="p">.</span><span class="nx">connect</span><span class="p">();</span>

<span class="w">    </span><span class="nx">socket</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;connect_error&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="nx">error</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="c1">// Should require re-authentication</span>
<span class="w">      </span><span class="nx">expect</span><span class="p">(</span><span class="nx">error</span><span class="p">.</span><span class="nx">message</span><span class="p">).</span><span class="nx">toContain</span><span class="p">(</span><span class="s1">&#39;authentication required&#39;</span><span class="p">);</span>
<span class="w">    </span><span class="p">});</span>
<span class="w">  </span><span class="p">});</span>
<span class="p">}</span>
</code></pre></div>
<h4 id="encryption-data-leak-issues">ğŸ”’ Encryption &amp; Data Leak Issues<a class="headerlink" href="#encryption-data-leak-issues" title="Permanent link">&para;</a></h4>
<p><strong>End-to-End Encryption (E2EE):</strong></p>
<div class="highlight"><pre><span></span><code>E2EE Flow:
â”Œâ”€â”€â”€â”€â”€â”€â”                    â”Œâ”€â”€â”€â”€â”€â”€â”
â”‚User Aâ”‚                    â”‚User Bâ”‚
â””â”€â”€â”¬â”€â”€â”€â”˜                    â””â”€â”€â”€â”¬â”€â”€â”˜
   â”‚                            â”‚
   â”‚ 1. Encrypt message         â”‚
   â”‚    with User B&#39;s key       â”‚
   â”‚                            â”‚
   â–¼                            â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”                    â”‚
â”‚Serverâ”‚ 2. Store encrypted â”‚
â”‚      â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚      â”‚    (Server cannot read)
â””â”€â”€â”¬â”€â”€â”€â”˜
   â”‚
   â”‚ 3. Forward encrypted
   â”‚    message to User B
   â”‚
   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”
â”‚User Bâ”‚ 4. Decrypt with
â”‚      â”‚    private key
â””â”€â”€â”€â”€â”€â”€â”˜
</code></pre></div>
<p><strong>Common Data Leak Points:</strong></p>
<div class="highlight"><pre><span></span><code>1. Plaintext in Server Logs
âŒ Server logs: &quot;User sent: My password is 12345&quot;
âœ… Server logs: &quot;User sent message (encrypted)&quot;

2. WebSocket Traffic (Non-WSS)
âŒ ws://chat.com (unencrypted)
âœ… wss://chat.com (encrypted with TLS)

3. Error Messages Leak Info
âŒ Error: &quot;User john@example.com not found in room-123&quot;
âœ… Error: &quot;Access denied&quot;

4. Message Metadata Exposure
âŒ API returns: { sender: &quot;admin&quot;, isAdmin: true, email: &quot;admin@...&quot; }
âœ… API returns: { sender: &quot;user-123&quot; } (minimal info)
</code></pre></div>
<p><strong>Test Cases:</strong></p>
<div class="highlight"><pre><span></span><code><span class="c1">// Test Case 1: Check for WSS (Secure WebSocket)</span>
<span class="kd">function</span><span class="w"> </span><span class="nx">testSecureConnection</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">socket</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">io</span><span class="p">(</span><span class="s1">&#39;wss://chat-server.com&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// Should use wss:// not ws://</span>
<span class="w">  </span><span class="p">});</span>

<span class="w">  </span><span class="nx">socket</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;connect&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// Verify connection is secure</span>
<span class="w">    </span><span class="nx">expect</span><span class="p">(</span><span class="nb">window</span><span class="p">.</span><span class="nx">location</span><span class="p">.</span><span class="nx">protocol</span><span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="s1">&#39;https:&#39;</span><span class="p">);</span>
<span class="w">  </span><span class="p">});</span>
<span class="p">}</span>

<span class="c1">// Test Case 2: Check Error Messages</span>
<span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">testErrorMessageLeak</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">await</span><span class="w"> </span><span class="nx">fetch</span><span class="p">(</span><span class="s1">&#39;/api/rooms/nonexistent-room/messages&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">headers</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="s1">&#39;Authorization&#39;</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Bearer valid-token&#39;</span><span class="w"> </span><span class="p">}</span>
<span class="w">    </span><span class="p">});</span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="nx">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// Error should not contain sensitive info</span>
<span class="w">    </span><span class="nx">expect</span><span class="p">(</span><span class="nx">error</span><span class="p">.</span><span class="nx">message</span><span class="p">).</span><span class="nx">not</span><span class="p">.</span><span class="nx">toContain</span><span class="p">(</span><span class="s1">&#39;@&#39;</span><span class="p">);</span>
<span class="w">    </span><span class="nx">expect</span><span class="p">(</span><span class="nx">error</span><span class="p">.</span><span class="nx">message</span><span class="p">).</span><span class="nx">not</span><span class="p">.</span><span class="nx">toContain</span><span class="p">(</span><span class="s1">&#39;password&#39;</span><span class="p">);</span>
<span class="w">    </span><span class="nx">expect</span><span class="p">(</span><span class="nx">error</span><span class="p">.</span><span class="nx">message</span><span class="p">).</span><span class="nx">not</span><span class="p">.</span><span class="nx">toContain</span><span class="p">(</span><span class="s1">&#39;token&#39;</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>

<span class="c1">// Test Case 3: Verify E2EE</span>
<span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">testEndToEndEncryption</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// Send message and capture network traffic</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">message</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;Secret message&#39;</span><span class="p">;</span>
<span class="w">  </span><span class="nx">socket</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;send_message&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">text</span><span class="o">:</span><span class="w"> </span><span class="nx">message</span><span class="w"> </span><span class="p">});</span>

<span class="w">  </span><span class="c1">// Check network tab - message should be encrypted</span>
<span class="w">  </span><span class="c1">// (Not readable plaintext)</span>
<span class="p">}</span>
</code></pre></div>
<h3 id="7-security-testing-tools">7ï¸âƒ£ Security Testing Tools<a class="headerlink" href="#7-security-testing-tools" title="Permanent link">&para;</a></h3>
<h4 id="tool-overview">ğŸ”§ Tool Overview<a class="headerlink" href="#tool-overview" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>Security Testing Tools for Chat:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. Burp Suite                           â”‚
â”‚    - WebSocket interception             â”‚
â”‚    - Modify messages in real-time       â”‚
â”‚    - Replay attacks                     â”‚
â”‚                                         â”‚
â”‚ 2. Browser DevTools                     â”‚
â”‚    - Network â†’ WS tab                   â”‚
â”‚    - View WebSocket frames              â”‚
â”‚    - Inspect message payloads           â”‚
â”‚                                         â”‚
â”‚ 3. Postman                              â”‚
â”‚    - WebSocket client                   â”‚
â”‚    - Manual testing                     â”‚
â”‚    - Test different scenarios           â”‚
â”‚                                         â”‚
â”‚ 4. OWASP ZAP                            â”‚
â”‚    - Automated security scanning        â”‚
â”‚    - API security testing               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</code></pre></div>
<p><strong>Burp Suite Setup for Chat Testing:</strong></p>
<div class="highlight"><pre><span></span><code>Burp Suite Configuration:
1. Install Burp Suite Community (free)
2. Configure browser proxy (127.0.0.1:8080)
3. Enable WebSocket interception
4. Intercept and modify messages
</code></pre></div>
<p><strong>Browser DevTools Usage:</strong></p>
<div class="highlight"><pre><span></span><code><span class="c1">// Steps to test with DevTools:</span>
<span class="c1">// 1. Open Chrome DevTools (F12)</span>
<span class="c1">// 2. Go to Network tab</span>
<span class="c1">// 3. Filter by &quot;WS&quot; (WebSocket)</span>
<span class="c1">// 4. Connect to chat</span>
<span class="c1">// 5. View messages in real-time</span>
<span class="c1">// 6. Check for:</span>
<span class="c1">//    - Plaintext sensitive data</span>
<span class="c1">//    - Unencrypted connections (ws://)</span>
<span class="c1">//    - Token exposure</span>
</code></pre></div>
<h3 id="learning-path-for-phase-3">ğŸ“š Learning Path for Phase 3<a class="headerlink" href="#learning-path-for-phase-3" title="Permanent link">&para;</a></h3>
<p><strong>Week 10-11: Security Fundamentals</strong>
- Day 1-3: Study OWASP Top 10 (focus on A2, A4, A5)
- Day 4-7: Learn IDOR attacks and prevention
- Day 8-10: Study authentication/authorization patterns
- Day 11-14: Practice with Burp Suite</p>
<p><strong>Week 12-13: Practical Testing</strong>
- Day 15-17: Test IDOR vulnerabilities in chat app
- Day 18-21: Test authentication flows
- Day 22-24: Test encryption and data leak
- Day 25-28: Create security test report</p>
<hr />
<h1 id="phase-4-advanced-become-the-product-guardian-optional-10-weeks">ğŸš€ PHASE 4 â€” ADVANCED: BECOME "THE PRODUCT GUARDIAN" (Optional, 10+ Weeks)<a class="headerlink" href="#phase-4-advanced-become-the-product-guardian-optional-10-weeks" title="Permanent link">&para;</a></h1>
<h2 id="moving-beyond-testing">ğŸ¯ Moving Beyond Testing<a class="headerlink" href="#moving-beyond-testing" title="Permanent link">&para;</a></h2>
<p>At this phase, you're not just testingâ€”you're thinking like an architect.</p>
<h3 id="8-strategic-questioning-think-like-a-system-designer">8ï¸âƒ£ Strategic Questioning (Think Like a System Designer)<a class="headerlink" href="#8-strategic-questioning-think-like-a-system-designer" title="Permanent link">&para;</a></h3>
<p><strong>Instead of asking: "Does it work?"</strong></p>
<p><strong>Ask these questions instead:</strong></p>
<h4 id="question-1-architecture-understanding">Question 1: Architecture Understanding<a class="headerlink" href="#question-1-architecture-understanding" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>âŒ Bad Question:
&quot;Can users send messages?&quot;

âœ… Strategic Question:
&quot;How does the server broadcast one message to 1,000 users?
 - Does it use fan-out?
 - Is there a message queue?
 - How does it handle failures?&quot;
</code></pre></div>
<h4 id="question-2-failure-scenarios">Question 2: Failure Scenarios<a class="headerlink" href="#question-2-failure-scenarios" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>âŒ Bad Question:
&quot;What happens if server is down?&quot;

âœ… Strategic Question:
&quot;If one node in the cluster crashes:
 - Are messages lost?
 - How is chat history synced?
 - Can users reconnect to different node?
 - What&#39;s the recovery time?&quot;
</code></pre></div>
<h4 id="question-3-data-consistency">Question 3: Data Consistency<a class="headerlink" href="#question-3-data-consistency" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>âŒ Bad Question:
&quot;Are messages saved?&quot;

âœ… Strategic Question:
&quot;How is chat history synced when a user reconnects after 1 hour?
 - Are missed messages delivered?
 - Is there a message queue?
 - How are duplicates prevented?&quot;
</code></pre></div>
<h4 id="question-4-rate-limiting-strategy">Question 4: Rate Limiting Strategy<a class="headerlink" href="#question-4-rate-limiting-strategy" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>âŒ Bad Question:
&quot;Is there rate limiting?&quot;

âœ… Strategic Question:
&quot;Where is rate limiting implemented?
 - At gateway level?
 - At application level?
 - Per user or per room?
 - What happens when limit is exceeded?&quot;
</code></pre></div>
<h3 id="9-high-value-deliverables">9ï¸âƒ£ High-Value Deliverables<a class="headerlink" href="#9-high-value-deliverables" title="Permanent link">&para;</a></h3>
<p>Create these documents to prove your expertise:</p>
<h4 id="document-1-chat-performance-test-strategy">Document 1: Chat Performance Test Strategy<a class="headerlink" href="#document-1-chat-performance-test-strategy" title="Permanent link">&para;</a></h4>
<p><strong>Template Structure:</strong></p>
<div class="highlight"><pre><span></span><code><span class="gh"># Chat Application Performance Test Strategy</span>

<span class="gu">## 1. Executive Summary</span>
<span class="k">-</span><span class="w"> </span>Current capacity: X concurrent users
<span class="k">-</span><span class="w"> </span>Target capacity: Y concurrent users
<span class="k">-</span><span class="w"> </span>Key risks identified

<span class="gu">## 2. Test Objectives</span>
<span class="k">-</span><span class="w"> </span>Concurrent connection limits
<span class="k">-</span><span class="w"> </span>Message throughput requirements
<span class="k">-</span><span class="w"> </span>Latency SLAs

<span class="gu">## 3. Test Scenarios</span>
<span class="gu">### Scenario 1: Spike Connections</span>
<span class="k">-</span><span class="w"> </span>Objective
<span class="k">-</span><span class="w"> </span>Test design
<span class="k">-</span><span class="w"> </span>Success criteria

<span class="gu">### Scenario 2: Soak Test</span>
<span class="k">-</span><span class="w"> </span>Objective
<span class="k">-</span><span class="w"> </span>Test design
<span class="k">-</span><span class="w"> </span>Success criteria

<span class="gu">## 4. Metrics &amp; KPIs</span>
<span class="k">-</span><span class="w"> </span>Concurrent connections
<span class="k">-</span><span class="w"> </span>Message latency (p95, p99)
<span class="k">-</span><span class="w"> </span>Error rates

<span class="gu">## 5. Tools &amp; Infrastructure</span>
<span class="k">-</span><span class="w"> </span>k6 scripts
<span class="k">-</span><span class="w"> </span>Test data
<span class="k">-</span><span class="w"> </span>Monitoring setup

<span class="gu">## 6. Results &amp; Recommendations</span>
<span class="k">-</span><span class="w"> </span>Findings
<span class="k">-</span><span class="w"> </span>Bottlenecks identified
<span class="k">-</span><span class="w"> </span>Optimization suggestions
</code></pre></div>
<h4 id="document-2-security-checklist-for-real-time-messaging">Document 2: Security Checklist for Real-time Messaging<a class="headerlink" href="#document-2-security-checklist-for-real-time-messaging" title="Permanent link">&para;</a></h4>
<p><strong>Template:</strong></p>
<div class="highlight"><pre><span></span><code><span class="gh"># Security Checklist: Real-time Chat Application</span>

<span class="gu">## Authentication &amp; Authorization</span>
<span class="k">- [ ]</span> Tokens expire properly
<span class="k">- [ ]</span> Reconnection requires re-auth
<span class="k">- [ ]</span> Tokens not in URL
<span class="k">- [ ]</span> Role-based access control works

<span class="gu">## IDOR Prevention</span>
<span class="k">- [ ]</span> Users cannot join unauthorized rooms
<span class="k">- [ ]</span> Users cannot read other users&#39; messages
<span class="k">- [ ]</span> Users cannot impersonate others
<span class="k">- [ ]</span> Room permissions verified server-side

<span class="gu">## Encryption &amp; Privacy</span>
<span class="k">- [ ]</span> WebSocket uses WSS (not WS)
<span class="k">- [ ]</span> E2EE implemented (if required)
<span class="k">- [ ]</span> No sensitive data in logs
<span class="k">- [ ]</span> Error messages don&#39;t leak info

<span class="gu">## Rate Limiting</span>
<span class="k">- [ ]</span> Message rate limiting
<span class="k">- [ ]</span> Connection rate limiting
<span class="k">- [ ]</span> Prevents spam/DoS

<span class="gu">## Data Protection</span>
<span class="k">- [ ]</span> Messages encrypted at rest
<span class="k">- [ ]</span> Backup encryption
<span class="k">- [ ]</span> GDPR compliance (if applicable)
</code></pre></div>
<h4 id="document-3-real-time-failure-mode-analysis-fma">Document 3: Real-time Failure Mode Analysis (FMA)<a class="headerlink" href="#document-3-real-time-failure-mode-analysis-fma" title="Permanent link">&para;</a></h4>
<p><strong>Template:</strong></p>
<div class="highlight"><pre><span></span><code><span class="gh"># Failure Mode Analysis: Chat Application</span>

<span class="gu">## Failure Scenarios</span>

<span class="gu">### Scenario 1: Single Node Failure</span>
<span class="k">-</span><span class="w"> </span><span class="gs">**Impact**</span>: High
<span class="k">-</span><span class="w"> </span><span class="gs">**Probability**</span>: Medium
<span class="k">-</span><span class="w"> </span><span class="gs">**Detection**</span>: Automated monitoring
<span class="k">-</span><span class="w"> </span><span class="gs">**Recovery**</span>: Auto-failover to standby node
<span class="k">-</span><span class="w"> </span><span class="gs">**User Impact**</span>: Temporary disconnection (&lt; 5 seconds)

<span class="gu">### Scenario 2: Database Failure</span>
<span class="k">-</span><span class="w"> </span><span class="gs">**Impact**</span>: Critical
<span class="k">-</span><span class="w"> </span><span class="gs">**Probability**</span>: Low
<span class="k">-</span><span class="w"> </span><span class="gs">**Detection**</span>: Health checks
<span class="k">-</span><span class="w"> </span><span class="gs">**Recovery**</span>: Database replication, failover
<span class="k">-</span><span class="w"> </span><span class="gs">**User Impact**</span>: No message history until recovery

<span class="gu">### Scenario 3: Network Partition</span>
<span class="k">-</span><span class="w"> </span><span class="gs">**Impact**</span>: High
<span class="k">-</span><span class="w"> </span><span class="gs">**Probability**</span>: Low
<span class="k">-</span><span class="w"> </span><span class="gs">**Detection**</span>: Heartbeat monitoring
<span class="k">-</span><span class="w"> </span><span class="gs">**Recovery**</span>: Automatic reconnection
<span class="k">-</span><span class="w"> </span><span class="gs">**User Impact**</span>: Messages queued, delivered after reconnection

<span class="gu">## Mitigation Strategies</span>
<span class="k">-</span><span class="w"> </span>Redundancy
<span class="k">-</span><span class="w"> </span>Monitoring &amp; Alerting
<span class="k">-</span><span class="w"> </span>Graceful Degradation
</code></pre></div>
<h3 id="learning-path-for-phase-4">ğŸ“š Learning Path for Phase 4<a class="headerlink" href="#learning-path-for-phase-4" title="Permanent link">&para;</a></h3>
<p><strong>Week 14-16: System Design</strong>
- Study distributed systems basics
- Learn about message queues (RabbitMQ, Kafka)
- Understand load balancing and failover</p>
<p><strong>Week 17-20: Create Deliverables</strong>
- Write Performance Test Strategy
- Create Security Checklist
- Document Failure Mode Analysis</p>
<p><strong>Week 21-24: Present &amp; Refine</strong>
- Present to team/stakeholders
- Get feedback
- Refine documents
- Build portfolio</p>
<hr />
<h1 id="realistic-timeline-summary">â³ Realistic Timeline Summary<a class="headerlink" href="#realistic-timeline-summary" title="Permanent link">&para;</a></h1>
<div class="highlight"><pre><span></span><code>Timeline Overview:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Month 1: Foundation                                 â”‚
â”‚ âœ… Understand WebSocket/Socket.io                   â”‚
â”‚ âœ… Grasp real-time concepts                         â”‚
â”‚ âœ… Test basic chat functionality                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Month 2-3: Performance Testing                      â”‚
â”‚ âœ… Set up k6                                        â”‚
â”‚ âœ… Write performance test scripts                   â”‚
â”‚ âœ… Execute spike, soak, burst tests                 â”‚
â”‚ âœ… Analyze results                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Month 4: Security Testing                           â”‚
â”‚ âœ… Learn security testing tools                     â”‚
â”‚ âœ… Test IDOR vulnerabilities                        â”‚
â”‚ âœ… Test authentication/authorization                â”‚
â”‚ âœ… Create security checklist                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Month 5-6: Advanced (Optional)                      â”‚
â”‚ âœ… System design thinking                           â”‚
â”‚ âœ… Create comprehensive documents                   â”‚
â”‚ âœ… Become specialized Chat QA                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</code></pre></div>
<hr />
<h1 id="quick-reference-guide">ğŸ“– Quick Reference Guide<a class="headerlink" href="#quick-reference-guide" title="Permanent link">&para;</a></h1>
<h2 id="key-metrics-cheat-sheet">Key Metrics Cheat Sheet<a class="headerlink" href="#key-metrics-cheat-sheet" title="Permanent link">&para;</a></h2>
<table>
<thead>
<tr>
<th style="text-align: left;">Metric</th>
<th style="text-align: left;">What It Measures</th>
<th style="text-align: left;">Good Value</th>
<th style="text-align: left;">How to Measure</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><strong>Concurrent Connections</strong></td>
<td style="text-align: left;">Users connected simultaneously</td>
<td style="text-align: left;">10,000+</td>
<td style="text-align: left;">Count active WebSocket connections</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Message Throughput</strong></td>
<td style="text-align: left;">Messages processed per second</td>
<td style="text-align: left;">50,000+ msg/sec</td>
<td style="text-align: left;">Messages sent Ã· time</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Message Latency (p95)</strong></td>
<td style="text-align: left;">95% of messages delivered within</td>
<td style="text-align: left;">&lt; 100ms</td>
<td style="text-align: left;">Time from send to receive</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Drop Rate</strong></td>
<td style="text-align: left;">Percentage of failed connections</td>
<td style="text-align: left;">&lt; 0.1%</td>
<td style="text-align: left;">Failed connections / Total attempts</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Reconnect Rate</strong></td>
<td style="text-align: left;">Time to reconnect after disconnect</td>
<td style="text-align: left;">&lt; 2 seconds</td>
<td style="text-align: left;">Time from disconnect to reconnect</td>
</tr>
</tbody>
</table>
<h2 id="common-test-scenarios">Common Test Scenarios<a class="headerlink" href="#common-test-scenarios" title="Permanent link">&para;</a></h2>
<ol>
<li><strong>Spike Test</strong>: 0 â†’ 10k users in 1 minute</li>
<li><strong>Soak Test</strong>: 5k users for 8 hours</li>
<li><strong>Burst Test</strong>: 1 user sends 100 messages/second</li>
</ol>
<h2 id="security-test-checklist">Security Test Checklist<a class="headerlink" href="#security-test-checklist" title="Permanent link">&para;</a></h2>
<ul>
<li>[ ] IDOR: Can users access unauthorized rooms?</li>
<li>[ ] IDOR: Can users read other users' messages?</li>
<li>[ ] Auth: Do tokens expire?</li>
<li>[ ] Auth: Is reconnection authenticated?</li>
<li>[ ] Encryption: Is WSS used (not WS)?</li>
<li>[ ] Encryption: Are messages encrypted?</li>
<li>[ ] Data Leak: Are error messages safe?</li>
</ul>
<h2 id="tools-quick-reference">Tools Quick Reference<a class="headerlink" href="#tools-quick-reference" title="Permanent link">&para;</a></h2>
<ul>
<li><strong>k6</strong>: Performance testing (recommended)</li>
<li><strong>Burp Suite</strong>: Security testing</li>
<li><strong>DevTools</strong>: Manual inspection</li>
<li><strong>Postman</strong>: WebSocket client testing</li>
</ul>
<hr />
<h1 id="conclusion">ğŸ“ Conclusion<a class="headerlink" href="#conclusion" title="Permanent link">&para;</a></h1>
<p>Chat application testing requires a completely different mindset from traditional web testing. Focus on:</p>
<ol>
<li><strong>Understanding real-time concepts</strong> (WebSocket, persistent connections)</li>
<li><strong>Performance metrics</strong> (concurrent connections, not just TPS)</li>
<li><strong>Security vulnerabilities</strong> (IDOR is very common in chat)</li>
<li><strong>System thinking</strong> (how does it work under the hood?)</li>
</ol>
<p><strong>Remember</strong>: Chat QA is a specialized skill. Master this, and you'll be in high demand! ğŸš€</p>
<hr />
<h2 id="additional-resources">ğŸ“š Additional Resources<a class="headerlink" href="#additional-resources" title="Permanent link">&para;</a></h2>
<ul>
<li><a href="https://developer.mozilla.org/en-US/docs/Web/API/WebSocket">WebSocket API - MDN</a></li>
<li><a href="https://socket.io/docs/v4/">Socket.io Documentation</a></li>
<li><a href="https://k6.io/docs/javascript-api/k6-ws/">k6 WebSocket Testing</a></li>
<li><a href="https://owasp.org/www-project-top-ten/">OWASP Top 10</a></li>
<li><a href="https://www.guru99.com/real-time-testing.html">Real-time Systems Testing Guide</a></li>
</ul>
<hr />
<h1 id="lo-trinh-hoc-ung-dung-chat-tu-con-so-0-en-chuyen-gia-qasdet-tieng-viet">ğŸ—ºï¸ Lá»˜ TRÃŒNH Há»ŒC á»¨NG Dá»¤NG CHAT Tá»ª CON Sá» 0 Äáº¾N CHUYÃŠN GIA QA/SDET (TIáº¾NG VIá»†T)<a class="headerlink" href="#lo-trinh-hoc-ung-dung-chat-tu-con-so-0-en-chuyen-gia-qasdet-tieng-viet" title="Permanent link">&para;</a></h1>
<h2 id="phan-0-thiet-lap-tu-duy-ung-chat-khac-web-thong-thuong">ğŸ¯ PHáº¦N 0: THIáº¾T Láº¬P TÆ¯ DUY ÄÃšNG - CHAT KHÃC WEB THÃ”NG THÆ¯á»œNG<a class="headerlink" href="#phan-0-thiet-lap-tu-duy-ung-chat-khac-web-thong-thuong" title="Permanent link">&para;</a></h2>
<h3 id="su-khac-biet-cot-loi-mot-vi-du-thuc-te">Sá»± KhÃ¡c Biá»‡t Cá»‘t LÃµi: Má»™t VÃ­ Dá»¥ Thá»±c Táº¿<a class="headerlink" href="#su-khac-biet-cot-loi-mot-vi-du-thuc-te" title="Permanent link">&para;</a></h3>
<p>HÃ£y tÆ°á»Ÿng tÆ°á»£ng báº¡n cÃ³ hai cÃ¡ch Ä‘á»ƒ liÃªn láº¡c vá»›i Ä‘á»“ng nghiá»‡p:</p>
<table>
<thead>
<tr>
<th style="text-align: left;">Giao Tiáº¿p ThÃ´ng ThÆ°á»ng (HTTP)</th>
<th style="text-align: left;">Giao Tiáº¿p Real-time (WebSocket)</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;">Giá»‘ng nhÆ° gá»­i email: Báº¡n viáº¿t thÆ° â†’ gá»­i Ä‘i â†’ chá» Ä‘á»£i â†’ Ä‘á»“ng nghiá»‡p nháº­n Ä‘Æ°á»£c â†’ há» viáº¿t thÆ° tráº£ lá»i â†’ gá»­i láº¡i â†’ báº¡n nháº­n Ä‘Æ°á»£c. Má»—i láº§n trao Ä‘á»•i lÃ  má»™t quy trÃ¬nh Ä‘á»™c láº­p.</td>
<td style="text-align: left;">Giá»‘ng nhÆ° gá»i Ä‘iá»‡n thoáº¡i: Báº¡n nháº¥c mÃ¡y â†’ thiáº¿t láº­p cuá»™c gá»i â†’ giá»¯ Ä‘Æ°á»ng dÃ¢y má»Ÿ â†’ nÃ³i chuyá»‡n qua láº¡i ngay láº­p tá»©c â†’ khi xong thÃ¬ táº¯t mÃ¡y. Káº¿t ná»‘i Ä‘Æ°á»£c duy trÃ¬.</td>
</tr>
</tbody>
</table>
<h3 id="bang-so-sanh-ky-thuat-chi-tiet">Báº£ng So SÃ¡nh Ká»¹ Thuáº­t Chi Tiáº¿t<a class="headerlink" href="#bang-so-sanh-ky-thuat-chi-tiet" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th style="text-align: left;">TiÃªu ChÃ­</th>
<th style="text-align: left;">Web ThÃ´ng ThÆ°á»ng (HTTP)</th>
<th style="text-align: left;">Chat Real-time</th>
<th style="text-align: left;">Ã NghÄ©a Trong Kiá»ƒm Thá»­</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><strong>MÃ´ hÃ¬nh</strong></td>
<td style="text-align: left;">Request/Response (Client luÃ´n chá»§ Ä‘á»™ng)</td>
<td style="text-align: left;">Persistent Connection (Káº¿t ná»‘i liÃªn tá»¥c, 2 chiá»u)</td>
<td style="text-align: left;">Thay vÃ¬ test API endpoint, báº¡n test káº¿t ná»‘i vÃ  luá»“ng sá»± kiá»‡n</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Tráº¡ng thÃ¡i</strong></td>
<td style="text-align: left;">Stateless (Má»—i request Ä‘á»™c láº­p)</td>
<td style="text-align: left;">Stateful (Server biáº¿t client nÃ o Ä‘ang káº¿t ná»‘i)</td>
<td style="text-align: left;">Cáº§n test duy trÃ¬ tráº¡ng thÃ¡i user trong room, session timeout</td>
</tr>
<tr>
<td style="text-align: left;"><strong>ÄÆ¡n vá»‹ Ä‘o</strong></td>
<td style="text-align: left;">TPS (Transactions Per Second)</td>
<td style="text-align: left;">Concurrent Connections + Messages Per Second</td>
<td style="text-align: left;">10,000 TPS â‰  10,000 user chat cÃ¹ng lÃºc. Chat cáº§n giá»¯ 10,000 káº¿t ná»‘i Ä‘á»“ng thá»i</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Äá»™ trá»…</strong></td>
<td style="text-align: left;">Page Load Time (vÃ i giÃ¢y)</td>
<td style="text-align: left;">Message Latency (vÃ i trÄƒm mili giÃ¢y)</td>
<td style="text-align: left;">NgÆ°á»i dÃ¹ng nháº­n tháº¥y ngay náº¿u tin nháº¯n cháº­m 1-2 giÃ¢y</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Giao thá»©c</strong></td>
<td style="text-align: left;">HTTP/HTTPS</td>
<td style="text-align: left;">WebSocket (ws://, wss://), thÆ°á»ng qua Socket.IO</td>
<td style="text-align: left;">CÃ´ng cá»¥ test pháº£i há»— trá»£ WebSocket, khÃ´ng dÃ¹ng Ä‘Æ°á»£c tool HTTP thÃ´ng thÆ°á»ng</td>
</tr>
</tbody>
</table>
<p><strong>VÃ­ dá»¥ thá»±c táº¿ vá» sá»± khÃ¡c biá»‡t:</strong></p>
<ul>
<li>Khi báº¡n vÃ o Facebook, trÃ¬nh duyá»‡t gá»­i 1 request Ä‘á»ƒ láº¥y news feed.</li>
<li>Khi báº¡n chat trÃªn Messenger, trÃ¬nh duyá»‡t má»Ÿ 1 káº¿t ná»‘i WebSocket vÃ  giá»¯ nÃ³ trong nhiá»u giá», qua Ä‘Ã³ nháº­n Ä‘Æ°á»£c tin nháº¯n má»›i ngay láº­p tá»©c mÃ  khÃ´ng cáº§n refresh.</li>
</ul>
<hr />
<h2 id="phan-1-nen-tang-web-socket-socketio-3-4-tuan">ğŸ”§ PHáº¦N 1: Ná»€N Táº¢NG WEB SOCKET &amp; SOCKET.IO (3-4 TUáº¦N)<a class="headerlink" href="#phan-1-nen-tang-web-socket-socketio-3-4-tuan" title="Permanent link">&para;</a></h2>
<h3 id="tuan-1-websocket-hieu-tu-goc-re">Tuáº§n 1: WebSocket - Hiá»ƒu Tá»« Gá»‘c Rá»…<a class="headerlink" href="#tuan-1-websocket-hieu-tu-goc-re" title="Permanent link">&para;</a></h3>
<h4 id="11-lifecycle-cua-websocket-vong-oi-ket-noi">1.1. Lifecycle cá»§a WebSocket (VÃ²ng Äá»i Káº¿t Ná»‘i)<a class="headerlink" href="#11-lifecycle-cua-websocket-vong-oi-ket-noi" title="Permanent link">&para;</a></h4>
<p><strong>QUÃ TRÃŒNH HANDSHAKE (Báº®T TAY):</strong></p>
<div class="highlight"><pre><span></span><code><span class="c1">// Client gá»­i HTTP request Ä‘áº·c biá»‡t</span>
<span class="nx">GET</span><span class="w"> </span><span class="o">/</span><span class="nx">chat</span><span class="w"> </span><span class="nx">HTTP</span><span class="o">/</span><span class="mf">1.1</span>
<span class="nx">Host</span><span class="o">:</span><span class="w"> </span><span class="nx">server</span><span class="p">.</span><span class="nx">example</span><span class="p">.</span><span class="nx">com</span>
<span class="nx">Upgrade</span><span class="o">:</span><span class="w"> </span><span class="nx">websocket</span><span class="w">          </span><span class="c1">// &quot;TÃ´i muá»‘n nÃ¢ng cáº¥p lÃªn WebSocket&quot;</span>
<span class="nx">Connection</span><span class="o">:</span><span class="w"> </span><span class="nx">Upgrade</span>
<span class="nx">Sec</span><span class="o">-</span><span class="nx">WebSocket</span><span class="o">-</span><span class="nx">Key</span><span class="o">:</span><span class="w"> </span><span class="nx">dGhlIHNhbXBsZSBub25jZQ</span><span class="o">==</span>
<span class="nx">Sec</span><span class="o">-</span><span class="nx">WebSocket</span><span class="o">-</span><span class="nx">Version</span><span class="o">:</span><span class="w"> </span><span class="mf">13</span>

<span class="c1">// Server tráº£ lá»i</span>
<span class="nx">HTTP</span><span class="o">/</span><span class="mf">1.1</span><span class="w"> </span><span class="mf">101</span><span class="w"> </span><span class="nx">Switching</span><span class="w"> </span><span class="nx">Protocols</span>
<span class="nx">Upgrade</span><span class="o">:</span><span class="w"> </span><span class="nx">websocket</span><span class="w">          </span><span class="c1">// &quot;Äá»“ng Ã½ nÃ¢ng cáº¥p!&quot;</span>
<span class="nx">Connection</span><span class="o">:</span><span class="w"> </span><span class="nx">Upgrade</span>
<span class="nx">Sec</span><span class="o">-</span><span class="nx">WebSocket</span><span class="o">-</span><span class="nx">Accept</span><span class="o">:</span><span class="w"> </span><span class="nx">s3pPLMBiTxaQ9kYGzzhZRbK</span><span class="o">+</span><span class="nx">xOo</span><span class="o">=</span>

<span class="c1">// Tá»« Ä‘Ã¢y, káº¿t ná»‘i Ä‘Ã£ &quot;nÃ¢ng cáº¥p&quot; tá»« HTTP sang WebSocket</span>
<span class="c1">// Client vÃ  server cÃ³ thá»ƒ gá»­i/nháº­n data tá»± do</span>
</code></pre></div>
<p><strong>VÃ­ dá»¥ thá»±c táº¿ Ä‘á»ƒ hiá»ƒu Handshake:</strong></p>
<ul>
<li>Giá»‘ng nhÆ° báº¡n gá»i cho khÃ¡ch sáº¡n: "Alo, tÃ´i muá»‘n Ä‘áº·t phÃ²ng" (HTTP request)</li>
<li>Lá»… tÃ¢n tráº£ lá»i: "VÃ¢ng, tÃ´i chuyá»ƒn mÃ¡y cho bá»™ pháº­n Ä‘áº·t phÃ²ng" (101 Switching Protocols)</li>
<li>Sau Ä‘Ã³ báº¡n nÃ³i chuyá»‡n trá»±c tiáº¿p vá»›i nhÃ¢n viÃªn Ä‘áº·t phÃ²ng mÃ  khÃ´ng cáº§n thÃ´ng qua lá»… tÃ¢n ná»¯a (WebSocket connection)</li>
</ul>
<h4 id="12-cau-truc-mot-frame-websocket">1.2. Cáº¥u trÃºc má»™t Frame WebSocket<a class="headerlink" href="#12-cau-truc-mot-frame-websocket" title="Permanent link">&para;</a></h4>
<p>Má»—i tin nháº¯n qua WebSocket Ä‘Æ°á»£c Ä‘Ã³ng gÃ³i trong "frame":</p>
<div class="highlight"><pre><span></span><code>0                   1                   2                   3
0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
+-+-+-+-+-------+-+-------------+-------------------------------+
|F|R|R|R| opcode|M| Payload len |    Extended payload length    |
|I|S|S|S|  (4)  |A|     (7)     |             (16/64)           |
|N|V|V|V|       |S|             |   (if payload len==126/127)   |
| |1|2|3|       |K|             |                               |
+-+-+-+-+-------+-+-------------+ - - - - - - - - - - - - - - - +
|     Extended payload length continued, if payload len == 127  |
+ - - - - - - - - - - - - - - - +-------------------------------+
|                               |Masking-key, if MASK set to 1  |
+-------------------------------+-------------------------------+
| Masking-key (continued)       |          Payload Data         |
+-------------------------------- - - - - - - - - - - - - - - - +
:                     Payload Data continued ...                :
+ - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - +
|                     Payload Data continued ...                |
+---------------------------------------------------------------+
</code></pre></div>
<p><strong>Ã nghÄ©a thá»±c táº¿:</strong></p>
<ul>
<li><strong>FIN bit</strong>: Cho biáº¿t Ä‘Ã¢y lÃ  frame cuá»‘i cÃ¹ng cá»§a message</li>
<li><strong>Opcode</strong>: 1 = text, 2 = binary (gá»­i file, hÃ¬nh áº£nh)</li>
<li><strong>Mask</strong>: Client pháº£i mask payload Ä‘á»ƒ báº£o máº­t</li>
<li><strong>Payload length</strong>: Äá»™ dÃ i thá»±c táº¿ cá»§a dá»¯ liá»‡u</li>
</ul>
<p><strong>VÃ­ dá»¥ debug thá»±c táº¿:</strong></p>
<ol>
<li>Má»Ÿ Chrome DevTools (F12)</li>
<li>VÃ o tab Network â†’ WS (WebSocket)</li>
<li>Click vÃ o má»™t káº¿t ná»‘i WebSocket</li>
<li>Báº¡n sáº½ tháº¥y cÃ¡c frame Ä‘Æ°á»£c hiá»ƒn thá»‹ real-time:</li>
</ol>
<div class="highlight"><pre><span></span><code>â–¼ Frame 45 (sent from client, 15 bytes)
  Message: {&quot;type&quot;:&quot;chat&quot;,&quot;text&quot;:&quot;Hello!&quot;}

â–¼ Frame 46 (received from server, 32 bytes)  
  Message: {&quot;type&quot;:&quot;chat&quot;,&quot;from&quot;:&quot;user123&quot;,&quot;text&quot;:&quot;Hi there!&quot;}
</code></pre></div>
<hr />
<h3 id="tuan-2-socketio-thu-vien-thong-minh-hon-websocket-thuan">Tuáº§n 2: Socket.IO - ThÆ° Viá»‡n "ThÃ´ng Minh" HÆ¡n WebSocket Thuáº§n<a class="headerlink" href="#tuan-2-socketio-thu-vien-thong-minh-hon-websocket-thuan" title="Permanent link">&para;</a></h3>
<h4 id="21-tai-sao-can-socketio">2.1. Táº¡i Sao Cáº§n Socket.IO?<a class="headerlink" href="#21-tai-sao-can-socketio" title="Permanent link">&para;</a></h4>
<p><strong>Váº¥n Ä‘á» vá»›i WebSocket thuáº§n:</strong></p>
<ul>
<li>âŒ KhÃ´ng tá»± reconnect: Náº¿u máº¡ng yáº¿u, káº¿t ná»‘i Ä‘á»©t â†’ user pháº£i refresh trang</li>
<li>âŒ KhÃ´ng fallback: TrÆ°á»ng há»£p firewall cháº·n WebSocket â†’ á»©ng dá»¥ng khÃ´ng hoáº¡t Ä‘á»™ng</li>
<li>âŒ KhÃ´ng cÃ³ room/namespace: Pháº£i tá»± implement cÆ¡ cháº¿ nhÃ³m chat</li>
</ul>
<p><strong>Giáº£i phÃ¡p Socket.IO:</strong></p>
<div class="highlight"><pre><span></span><code><span class="c1">// Server Ä‘Æ¡n giáº£n nháº¥t vá»›i Socket.IO</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">express</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">require</span><span class="p">(</span><span class="s1">&#39;express&#39;</span><span class="p">);</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">http</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">require</span><span class="p">(</span><span class="s1">&#39;http&#39;</span><span class="p">);</span>
<span class="kd">const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">Server</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">require</span><span class="p">(</span><span class="s1">&#39;socket.io&#39;</span><span class="p">);</span>

<span class="kd">const</span><span class="w"> </span><span class="nx">app</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">express</span><span class="p">();</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">server</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">http</span><span class="p">.</span><span class="nx">createServer</span><span class="p">(</span><span class="nx">app</span><span class="p">);</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">io</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">Server</span><span class="p">(</span><span class="nx">server</span><span class="p">);</span>

<span class="c1">// Khi cÃ³ client káº¿t ná»‘i</span>
<span class="nx">io</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;connection&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="nx">socket</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;User connected:&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">socket</span><span class="p">.</span><span class="nx">id</span><span class="p">);</span>

<span class="w">  </span><span class="c1">// Gá»­i message riÃªng cho user nÃ y</span>
<span class="w">  </span><span class="nx">socket</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;welcome&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">message</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;ChÃ o má»«ng!&#39;</span><span class="w"> </span><span class="p">});</span>

<span class="w">  </span><span class="c1">// Khi client gá»­i &#39;chat message&#39;</span>
<span class="w">  </span><span class="nx">socket</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;chat message&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="nx">msg</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;Message from&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">socket</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;:&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">msg</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// Gá»­i tin nháº¯n cho Táº¤T Cáº¢ client Ä‘ang káº¿t ná»‘i</span>
<span class="w">    </span><span class="nx">io</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;chat message&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="kr">from</span><span class="o">:</span><span class="w"> </span><span class="nx">socket</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span>
<span class="w">      </span><span class="nx">text</span><span class="o">:</span><span class="w"> </span><span class="nx">msg</span><span class="p">,</span>
<span class="w">      </span><span class="nx">timestamp</span><span class="o">:</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nb">Date</span><span class="p">()</span>
<span class="w">    </span><span class="p">});</span>
<span class="w">  </span><span class="p">});</span>

<span class="w">  </span><span class="c1">// Khi client ngáº¯t káº¿t ná»‘i</span>
<span class="w">  </span><span class="nx">socket</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;disconnect&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;User disconnected:&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">socket</span><span class="p">.</span><span class="nx">id</span><span class="p">);</span>
<span class="w">  </span><span class="p">});</span>
<span class="p">});</span>

<span class="nx">server</span><span class="p">.</span><span class="nx">listen</span><span class="p">(</span><span class="mf">3000</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;Server running on port 3000&#39;</span><span class="p">);</span>
<span class="p">});</span>
</code></pre></div>
<h4 id="22-co-che-fallback-thuc-te-socketio-linh-hoat">2.2. CÆ¡ Cháº¿ Fallback Thá»±c Táº¿ - Socket.IO "Linh Hoáº¡t"<a class="headerlink" href="#22-co-che-fallback-thuc-te-socketio-linh-hoat" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>Client muá»‘n káº¿t ná»‘i tá»›i Server
         â†“
Thá»­ káº¿t ná»‘i WebSocket (ws://)
         â†“
    [ThÃ nh cÃ´ng?]
         â†“
     /        \
   YES        NO (bá»‹ cháº·n/firewall)
    â†“           â†“
DÃ¹ng WebSocket  Thá»­ HTTP Long-Polling
                â†“
           [ThÃ nh cÃ´ng?]
                â†“
            /        \
          YES        NO
           â†“           â†“
    DÃ¹ng Long-Polling  Lá»—i káº¿t ná»‘i
</code></pre></div>
<p><strong>VÃ­ dá»¥ thá»±c táº¿ vá» fallback:</strong></p>
<ul>
<li>Báº¡n dÃ¹ng chat app trong tÃ²a nhÃ  vÄƒn phÃ²ng (firewall nghiÃªm ngáº·t)</li>
<li>á»¨ng dá»¥ng tá»± Ä‘á»™ng chuyá»ƒn sang cháº¿ Ä‘á»™ "compatible" (long-polling)</li>
<li>Báº¡n váº«n chat Ä‘Æ°á»£c, nhÆ°ng Ä‘á»™ trá»… cao hÆ¡n (1-2 giÃ¢y thay vÃ¬ vÃ i trÄƒm ms)</li>
<li>Khi vá» nhÃ , á»©ng dá»¥ng tá»± Ä‘á»™ng nÃ¢ng cáº¥p lÃªn WebSocket</li>
</ul>
<h4 id="23-cac-khai-niem-quan-trong-trong-socketio">2.3. CÃ¡c KhÃ¡i Niá»‡m Quan Trá»ng Trong Socket.IO<a class="headerlink" href="#23-cac-khai-niem-quan-trong-trong-socketio" title="Permanent link">&para;</a></h4>
<p><strong>a) Namespace (KhÃ´ng gian tÃªn):</strong></p>
<div class="highlight"><pre><span></span><code><span class="c1">// Táº¡o namespace riÃªng cho admin</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">adminNamespace</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">io</span><span class="p">.</span><span class="k">of</span><span class="p">(</span><span class="s1">&#39;/admin&#39;</span><span class="p">);</span>

<span class="nx">adminNamespace</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;connection&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="nx">socket</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// Chá»‰ nhá»¯ng client káº¿t ná»‘i Ä‘áº¿n &#39;/admin&#39; má»›i vÃ o Ä‘Æ°á»£c Ä‘Ã¢y</span>
<span class="w">  </span><span class="nx">socket</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;adminLog&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Welcome to admin panel&#39;</span><span class="p">);</span>
<span class="p">});</span>

<span class="c1">// Client káº¿t ná»‘i Ä‘áº¿n namespace</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">socket</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">io</span><span class="p">(</span><span class="s1">&#39;http://localhost:3000/admin&#39;</span><span class="p">);</span>
</code></pre></div>
<p><strong>VÃ­ dá»¥ thá»±c táº¿:</strong> Giá»‘ng nhÆ° má»™t tÃ²a nhÃ  cÃ³ nhiá»u phÃ²ng ban:</p>
<ul>
<li><code>/</code> - Lobby chung (chat cÃ´ng khai)</li>
<li><code>/admin</code> - PhÃ²ng admin (quáº£n lÃ½ user, xÃ³a tin nháº¯n)</li>
<li><code>/support</code> - PhÃ²ng há»— trá»£ khÃ¡ch hÃ ng</li>
</ul>
<p><strong>b) Room (PhÃ²ng chat):</strong></p>
<div class="highlight"><pre><span></span><code><span class="c1">// User tham gia phÃ²ng</span>
<span class="nx">socket</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;join room&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="nx">roomId</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// Rá»i táº¥t cáº£ phÃ²ng trÆ°á»›c Ä‘Ã³</span>
<span class="w">  </span><span class="nx">socket</span><span class="p">.</span><span class="nx">leaveAll</span><span class="p">();</span>

<span class="w">  </span><span class="c1">// Tham gia phÃ²ng má»›i</span>
<span class="w">  </span><span class="nx">socket</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="nx">roomId</span><span class="p">);</span>
<span class="w">  </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`User </span><span class="si">${</span><span class="nx">socket</span><span class="p">.</span><span class="nx">id</span><span class="si">}</span><span class="sb"> joined room </span><span class="si">${</span><span class="nx">roomId</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>

<span class="w">  </span><span class="c1">// ThÃ´ng bÃ¡o cho má»i ngÆ°á»i trong phÃ²ng (TRá»ª ngÆ°á»i vá»«a join)</span>
<span class="w">  </span><span class="nx">socket</span><span class="p">.</span><span class="nx">to</span><span class="p">(</span><span class="nx">roomId</span><span class="p">).</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;user joined&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">userId</span><span class="o">:</span><span class="w"> </span><span class="nx">socket</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span>
<span class="w">    </span><span class="nx">roomId</span><span class="o">:</span><span class="w"> </span><span class="nx">roomId</span>
<span class="w">  </span><span class="p">});</span>
<span class="p">});</span>

<span class="c1">// Gá»­i tin nháº¯n Ä‘áº¿n 1 phÃ²ng cá»¥ thá»ƒ</span>
<span class="nx">socket</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;send to room&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="nx">data</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// Chá»‰ gá»­i Ä‘áº¿n user trong room &#39;data.roomId&#39;</span>
<span class="w">  </span><span class="nx">io</span><span class="p">.</span><span class="nx">to</span><span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">roomId</span><span class="p">).</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;new message&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kr">from</span><span class="o">:</span><span class="w"> </span><span class="nx">socket</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span>
<span class="w">    </span><span class="nx">text</span><span class="o">:</span><span class="w"> </span><span class="nx">data</span><span class="p">.</span><span class="nx">text</span><span class="p">,</span>
<span class="w">    </span><span class="nx">room</span><span class="o">:</span><span class="w"> </span><span class="nx">data</span><span class="p">.</span><span class="nx">roomId</span>
<span class="w">  </span><span class="p">});</span>
<span class="p">});</span>
</code></pre></div>
<p><strong>VÃ­ dá»¥ thá»±c táº¿ vá» room:</strong></p>
<ul>
<li>Slack: Má»—i channel (#general, #random) lÃ  má»™t room</li>
<li>Zoom: Má»—i phÃ²ng há»p lÃ  má»™t room</li>
<li>Game online: Má»—i phÃ²ng chÆ¡i lÃ  má»™t room</li>
</ul>
<p><strong>c) Broadcast (PhÃ¡t sÃ³ng):</strong></p>
<div class="highlight"><pre><span></span><code><span class="c1">// 1. Gá»­i cho táº¥t cáº£ client (ká»ƒ cáº£ ngÆ°á»i gá»­i)</span>
<span class="nx">io</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;event&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">data</span><span class="p">);</span>

<span class="c1">// 2. Gá»­i cho táº¥t cáº£ client (TRá»ª ngÆ°á»i gá»­i)</span>
<span class="nx">socket</span><span class="p">.</span><span class="nx">broadcast</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;event&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">data</span><span class="p">);</span>

<span class="c1">// 3. Gá»­i cho táº¥t cáº£ client trong namespace (TRá»ª ngÆ°á»i gá»­i)</span>
<span class="nx">socket</span><span class="p">.</span><span class="nx">broadcast</span><span class="p">.</span><span class="nx">to</span><span class="p">(</span><span class="s1">&#39;roomName&#39;</span><span class="p">).</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;event&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">data</span><span class="p">);</span>

<span class="c1">// 4. Gá»­i cho táº¥t cáº£ client trong room (ká»ƒ cáº£ ngÆ°á»i gá»­i)</span>
<span class="nx">io</span><span class="p">.</span><span class="nx">to</span><span class="p">(</span><span class="s1">&#39;roomName&#39;</span><span class="p">).</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;event&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">data</span><span class="p">);</span>
</code></pre></div>
<hr />
<h3 id="tuan-3-4-xay-dung-ung-dung-chat-thuc-te">Tuáº§n 3-4: XÃ¢y Dá»±ng á»¨ng Dá»¥ng Chat Thá»±c Táº¿<a class="headerlink" href="#tuan-3-4-xay-dung-ung-dung-chat-thuc-te" title="Permanent link">&para;</a></h3>
<h4 id="31-ung-dung-chat-ay-u-tinh-nang">3.1. á»¨ng Dá»¥ng Chat Äáº§y Äá»§ TÃ­nh NÄƒng<a class="headerlink" href="#31-ung-dung-chat-ay-u-tinh-nang" title="Permanent link">&para;</a></h4>
<p><strong>Server (server.js):</strong></p>
<div class="highlight"><pre><span></span><code><span class="c1">// server.js - Server hoÃ n chá»‰nh</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">express</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">require</span><span class="p">(</span><span class="s1">&#39;express&#39;</span><span class="p">);</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">http</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">require</span><span class="p">(</span><span class="s1">&#39;http&#39;</span><span class="p">);</span>
<span class="kd">const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">Server</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">require</span><span class="p">(</span><span class="s1">&#39;socket.io&#39;</span><span class="p">);</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">cors</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">require</span><span class="p">(</span><span class="s1">&#39;cors&#39;</span><span class="p">);</span>

<span class="kd">const</span><span class="w"> </span><span class="nx">app</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">express</span><span class="p">();</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">cors</span><span class="p">());</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">express</span><span class="p">.</span><span class="k">static</span><span class="p">(</span><span class="s1">&#39;public&#39;</span><span class="p">));</span>

<span class="kd">const</span><span class="w"> </span><span class="nx">server</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">http</span><span class="p">.</span><span class="nx">createServer</span><span class="p">(</span><span class="nx">app</span><span class="p">);</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">io</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">Server</span><span class="p">(</span><span class="nx">server</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">cors</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">origin</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;http://localhost:3000&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nx">methods</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;GET&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;POST&quot;</span><span class="p">]</span>
<span class="w">  </span><span class="p">},</span>
<span class="w">  </span><span class="c1">// Cáº¥u hÃ¬nh quan trá»ng cho production</span>
<span class="w">  </span><span class="nx">pingTimeout</span><span class="o">:</span><span class="w"> </span><span class="mf">60000</span><span class="p">,</span><span class="w"> </span><span class="c1">// 60 giÃ¢y khÃ´ng pháº£n há»“i thÃ¬ timeout</span>
<span class="w">  </span><span class="nx">pingInterval</span><span class="o">:</span><span class="w"> </span><span class="mf">25000</span><span class="p">,</span><span class="w"> </span><span class="c1">// Má»—i 25 giÃ¢y gá»­i ping má»™t láº§n</span>
<span class="p">});</span>

<span class="c1">// LÆ°u trá»¯ táº¡m thá»i</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">users</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nb">Map</span><span class="p">();</span><span class="w"> </span><span class="c1">// socket.id â†’ user info</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">rooms</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nb">Map</span><span class="p">();</span><span class="w"> </span><span class="c1">// roomId â†’ { users: [], messages: [] }</span>

<span class="nx">io</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;connection&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="nx">socket</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;New connection:&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">socket</span><span class="p">.</span><span class="nx">id</span><span class="p">);</span>

<span class="w">  </span><span class="c1">// 1. XÃC THá»°C USER</span>
<span class="w">  </span><span class="nx">socket</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;authenticate&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="nx">authData</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// Trong thá»±c táº¿: verify JWT token</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">user</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="nx">socket</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span>
<span class="w">      </span><span class="nx">username</span><span class="o">:</span><span class="w"> </span><span class="nx">authData</span><span class="p">.</span><span class="nx">username</span><span class="p">,</span>
<span class="w">      </span><span class="nx">joinedAt</span><span class="o">:</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nb">Date</span><span class="p">()</span>
<span class="w">    </span><span class="p">};</span>

<span class="w">    </span><span class="nx">users</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="nx">socket</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span><span class="w"> </span><span class="nx">user</span><span class="p">);</span>
<span class="w">    </span><span class="nx">socket</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;authenticated&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">success</span><span class="o">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w"> </span><span class="nx">user</span><span class="w"> </span><span class="p">});</span>

<span class="w">    </span><span class="c1">// ThÃ´ng bÃ¡o cÃ³ user má»›i (cho má»i ngÆ°á»i trá»« user nÃ y)</span>
<span class="w">    </span><span class="nx">socket</span><span class="p">.</span><span class="nx">broadcast</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;user online&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">user</span><span class="p">);</span>
<span class="w">  </span><span class="p">});</span>

<span class="w">  </span><span class="c1">// 2. THAM GIA/THOÃT PHÃ’NG</span>
<span class="w">  </span><span class="nx">socket</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;join room&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="nx">roomId</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">user</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">users</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">socket</span><span class="p">.</span><span class="nx">id</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// Rá»i phÃ²ng cÅ© (náº¿u cÃ³)</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">socket</span><span class="p">.</span><span class="nx">rooms</span><span class="p">.</span><span class="nx">size</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">oldRoom</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Array</span><span class="p">.</span><span class="kr">from</span><span class="p">(</span><span class="nx">socket</span><span class="p">.</span><span class="nx">rooms</span><span class="p">).</span><span class="nx">find</span><span class="p">(</span><span class="nx">r</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">r</span><span class="w"> </span><span class="o">!==</span><span class="w"> </span><span class="nx">socket</span><span class="p">.</span><span class="nx">id</span><span class="p">);</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">oldRoom</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">socket</span><span class="p">.</span><span class="nx">leave</span><span class="p">(</span><span class="nx">oldRoom</span><span class="p">);</span>
<span class="w">        </span><span class="nx">socket</span><span class="p">.</span><span class="nx">to</span><span class="p">(</span><span class="nx">oldRoom</span><span class="p">).</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;user left&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="nx">userId</span><span class="o">:</span><span class="w"> </span><span class="nx">socket</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span>
<span class="w">          </span><span class="nx">username</span><span class="o">:</span><span class="w"> </span><span class="nx">user</span><span class="p">.</span><span class="nx">username</span>
<span class="w">        </span><span class="p">});</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// Tham gia phÃ²ng má»›i</span>
<span class="w">    </span><span class="nx">socket</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="nx">roomId</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// Khá»Ÿi táº¡o phÃ²ng náº¿u chÆ°a cÃ³</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">rooms</span><span class="p">.</span><span class="nx">has</span><span class="p">(</span><span class="nx">roomId</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">rooms</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="nx">roomId</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="nx">roomId</span><span class="p">,</span>
<span class="w">        </span><span class="nx">users</span><span class="o">:</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nb">Set</span><span class="p">(),</span>
<span class="w">        </span><span class="nx">messages</span><span class="o">:</span><span class="w"> </span><span class="p">[]</span>
<span class="w">      </span><span class="p">});</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">room</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">rooms</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">roomId</span><span class="p">);</span>
<span class="w">    </span><span class="nx">room</span><span class="p">.</span><span class="nx">users</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nx">socket</span><span class="p">.</span><span class="nx">id</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// Gá»­i lá»‹ch sá»­ chat cho user má»›i</span>
<span class="w">    </span><span class="nx">socket</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;room history&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">roomId</span><span class="p">,</span>
<span class="w">      </span><span class="nx">messages</span><span class="o">:</span><span class="w"> </span><span class="nx">room</span><span class="p">.</span><span class="nx">messages</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="o">-</span><span class="mf">50</span><span class="p">)</span><span class="w"> </span><span class="c1">// 50 tin nháº¯n gáº§n nháº¥t</span>
<span class="w">    </span><span class="p">});</span>

<span class="w">    </span><span class="c1">// ThÃ´ng bÃ¡o cho phÃ²ng</span>
<span class="w">    </span><span class="nx">socket</span><span class="p">.</span><span class="nx">to</span><span class="p">(</span><span class="nx">roomId</span><span class="p">).</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;user joined&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">userId</span><span class="o">:</span><span class="w"> </span><span class="nx">socket</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span>
<span class="w">      </span><span class="nx">username</span><span class="o">:</span><span class="w"> </span><span class="nx">user</span><span class="p">.</span><span class="nx">username</span><span class="p">,</span>
<span class="w">      </span><span class="nx">roomId</span>
<span class="w">    </span><span class="p">});</span>
<span class="w">  </span><span class="p">});</span>

<span class="w">  </span><span class="c1">// 3. Gá»¬I TIN NHáº®N</span>
<span class="w">  </span><span class="nx">socket</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;send message&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="nx">data</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">user</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">users</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">socket</span><span class="p">.</span><span class="nx">id</span><span class="p">);</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">roomId</span><span class="p">,</span><span class="w"> </span><span class="nx">text</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">data</span><span class="p">;</span>

<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">message</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="nb">Date</span><span class="p">.</span><span class="nx">now</span><span class="p">().</span><span class="nx">toString</span><span class="p">(),</span>
<span class="w">      </span><span class="kr">from</span><span class="o">:</span><span class="w"> </span><span class="nx">socket</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span>
<span class="w">      </span><span class="nx">username</span><span class="o">:</span><span class="w"> </span><span class="nx">user</span><span class="p">.</span><span class="nx">username</span><span class="p">,</span>
<span class="w">      </span><span class="nx">text</span><span class="p">,</span>
<span class="w">      </span><span class="nx">timestamp</span><span class="o">:</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nb">Date</span><span class="p">(),</span>
<span class="w">      </span><span class="nx">roomId</span>
<span class="w">    </span><span class="p">};</span>

<span class="w">    </span><span class="c1">// LÆ°u vÃ o lá»‹ch sá»­ phÃ²ng</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">room</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">rooms</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">roomId</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">room</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">room</span><span class="p">.</span><span class="nx">messages</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">message</span><span class="p">);</span>

<span class="w">      </span><span class="c1">// Giá»›i háº¡n lá»‹ch sá»­ (1000 tin nháº¯n má»—i phÃ²ng)</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">room</span><span class="p">.</span><span class="nx">messages</span><span class="p">.</span><span class="nx">length</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">1000</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">room</span><span class="p">.</span><span class="nx">messages</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">room</span><span class="p">.</span><span class="nx">messages</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="o">-</span><span class="mf">1000</span><span class="p">);</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// Gá»­i Ä‘áº¿n táº¥t cáº£ user trong phÃ²ng</span>
<span class="w">    </span><span class="nx">io</span><span class="p">.</span><span class="nx">to</span><span class="p">(</span><span class="nx">roomId</span><span class="p">).</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;new message&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">message</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// Log Ä‘á»ƒ debug</span>
<span class="w">    </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`[</span><span class="si">${</span><span class="nx">roomId</span><span class="si">}</span><span class="sb">] </span><span class="si">${</span><span class="nx">user</span><span class="p">.</span><span class="nx">username</span><span class="si">}</span><span class="sb">: </span><span class="si">${</span><span class="nx">text</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>
<span class="w">  </span><span class="p">});</span>

<span class="w">  </span><span class="c1">// 4. TYPING INDICATOR (Ä‘ang gÃµ...)</span>
<span class="w">  </span><span class="nx">socket</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;typing&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="nx">roomId</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">user</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">users</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">socket</span><span class="p">.</span><span class="nx">id</span><span class="p">);</span>
<span class="w">    </span><span class="nx">socket</span><span class="p">.</span><span class="nx">to</span><span class="p">(</span><span class="nx">roomId</span><span class="p">).</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;user typing&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">userId</span><span class="o">:</span><span class="w"> </span><span class="nx">socket</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span>
<span class="w">      </span><span class="nx">username</span><span class="o">:</span><span class="w"> </span><span class="nx">user</span><span class="p">.</span><span class="nx">username</span>
<span class="w">    </span><span class="p">});</span>
<span class="w">  </span><span class="p">});</span>

<span class="w">  </span><span class="c1">// 5. Xá»¬ LÃ NGáº®T Káº¾T Ná»I</span>
<span class="w">  </span><span class="nx">socket</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;disconnect&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="nx">reason</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">user</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">users</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">socket</span><span class="p">.</span><span class="nx">id</span><span class="p">);</span>
<span class="w">    </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`User disconnected: </span><span class="si">${</span><span class="nx">socket</span><span class="p">.</span><span class="nx">id</span><span class="si">}</span><span class="sb">, reason: </span><span class="si">${</span><span class="nx">reason</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">user</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="c1">// ThÃ´ng bÃ¡o user offline</span>
<span class="w">      </span><span class="nx">io</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;user offline&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">userId</span><span class="o">:</span><span class="w"> </span><span class="nx">socket</span><span class="p">.</span><span class="nx">id</span><span class="w"> </span><span class="p">});</span>

<span class="w">      </span><span class="c1">// XÃ³a khá»i táº¥t cáº£ phÃ²ng</span>
<span class="w">      </span><span class="nx">rooms</span><span class="p">.</span><span class="nx">forEach</span><span class="p">((</span><span class="nx">room</span><span class="p">,</span><span class="w"> </span><span class="nx">roomId</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">room</span><span class="p">.</span><span class="nx">users</span><span class="p">.</span><span class="nx">has</span><span class="p">(</span><span class="nx">socket</span><span class="p">.</span><span class="nx">id</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="nx">room</span><span class="p">.</span><span class="nx">users</span><span class="p">.</span><span class="ow">delete</span><span class="p">(</span><span class="nx">socket</span><span class="p">.</span><span class="nx">id</span><span class="p">);</span>
<span class="w">          </span><span class="nx">io</span><span class="p">.</span><span class="nx">to</span><span class="p">(</span><span class="nx">roomId</span><span class="p">).</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;user left&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">userId</span><span class="o">:</span><span class="w"> </span><span class="nx">socket</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span>
<span class="w">            </span><span class="nx">username</span><span class="o">:</span><span class="w"> </span><span class="nx">user</span><span class="p">.</span><span class="nx">username</span>
<span class="w">          </span><span class="p">});</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">      </span><span class="p">});</span>

<span class="w">      </span><span class="nx">users</span><span class="p">.</span><span class="ow">delete</span><span class="p">(</span><span class="nx">socket</span><span class="p">.</span><span class="nx">id</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">});</span>
<span class="p">});</span>

<span class="c1">// API Ä‘á»ƒ láº¥y thÃ´ng tin server</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;/api/stats&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="nx">req</span><span class="p">,</span><span class="w"> </span><span class="nx">res</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">res</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span>
<span class="w">    </span><span class="nx">totalConnections</span><span class="o">:</span><span class="w"> </span><span class="nx">io</span><span class="p">.</span><span class="nx">engine</span><span class="p">.</span><span class="nx">clientsCount</span><span class="p">,</span>
<span class="w">    </span><span class="nx">totalUsers</span><span class="o">:</span><span class="w"> </span><span class="nx">users</span><span class="p">.</span><span class="nx">size</span><span class="p">,</span>
<span class="w">    </span><span class="nx">totalRooms</span><span class="o">:</span><span class="w"> </span><span class="nx">rooms</span><span class="p">.</span><span class="nx">size</span><span class="p">,</span>
<span class="w">    </span><span class="nx">uptime</span><span class="o">:</span><span class="w"> </span><span class="nx">process</span><span class="p">.</span><span class="nx">uptime</span><span class="p">()</span>
<span class="w">  </span><span class="p">});</span>
<span class="p">});</span>

<span class="nx">server</span><span class="p">.</span><span class="nx">listen</span><span class="p">(</span><span class="mf">3000</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;Server running at http://localhost:3000&#39;</span><span class="p">);</span>
<span class="w">  </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;WebSocket endpoint: ws://localhost:3000&#39;</span><span class="p">);</span>
<span class="p">});</span>
</code></pre></div>
<h4 id="32-client-htmljs-ay-u">3.2. Client HTML/JS Äáº§y Äá»§<a class="headerlink" href="#32-client-htmljs-ay-u" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="cm">&lt;!-- public/index.html --&gt;</span>
<span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="p">&lt;</span><span class="nt">html</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">head</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">title</span><span class="p">&gt;</span>Real-time Chat App<span class="p">&lt;/</span><span class="nt">title</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">style</span><span class="p">&gt;</span>
<span class="w">    </span><span class="o">*</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">margin</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="k">padding</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="k">box-sizing</span><span class="p">:</span><span class="w"> </span><span class="kc">border-box</span><span class="p">;</span><span class="w"> </span><span class="p">}</span>
<span class="w">    </span><span class="nt">body</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">font-family</span><span class="p">:</span><span class="w"> </span><span class="n">Arial</span><span class="p">,</span><span class="w"> </span><span class="kc">sans-serif</span><span class="p">;</span><span class="w"> </span><span class="p">}</span>

<span class="w">    </span><span class="p">#</span><span class="nn">app</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">max-width</span><span class="p">:</span><span class="w"> </span><span class="mi">800</span><span class="kt">px</span><span class="p">;</span>
<span class="w">      </span><span class="k">margin</span><span class="p">:</span><span class="w"> </span><span class="mi">20</span><span class="kt">px</span><span class="w"> </span><span class="kc">auto</span><span class="p">;</span>
<span class="w">      </span><span class="k">padding</span><span class="p">:</span><span class="w"> </span><span class="mi">20</span><span class="kt">px</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="p">.</span><span class="nc">auth-section</span><span class="o">,</span><span class="w"> </span><span class="p">.</span><span class="nc">chat-section</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">background</span><span class="p">:</span><span class="w"> </span><span class="mh">#f5f5f5</span><span class="p">;</span>
<span class="w">      </span><span class="k">padding</span><span class="p">:</span><span class="w"> </span><span class="mi">20</span><span class="kt">px</span><span class="p">;</span>
<span class="w">      </span><span class="k">border-radius</span><span class="p">:</span><span class="w"> </span><span class="mi">10</span><span class="kt">px</span><span class="p">;</span>
<span class="w">      </span><span class="k">margin-bottom</span><span class="p">:</span><span class="w"> </span><span class="mi">20</span><span class="kt">px</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="p">.</span><span class="nc">room-list</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">display</span><span class="p">:</span><span class="w"> </span><span class="kc">flex</span><span class="p">;</span>
<span class="w">      </span><span class="k">gap</span><span class="p">:</span><span class="w"> </span><span class="mi">10</span><span class="kt">px</span><span class="p">;</span>
<span class="w">      </span><span class="k">margin</span><span class="p">:</span><span class="w"> </span><span class="mi">10</span><span class="kt">px</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="p">.</span><span class="nc">room-btn</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">padding</span><span class="p">:</span><span class="w"> </span><span class="mi">8</span><span class="kt">px</span><span class="w"> </span><span class="mi">16</span><span class="kt">px</span><span class="p">;</span>
<span class="w">      </span><span class="k">background</span><span class="p">:</span><span class="w"> </span><span class="mh">#4CAF50</span><span class="p">;</span>
<span class="w">      </span><span class="k">color</span><span class="p">:</span><span class="w"> </span><span class="kc">white</span><span class="p">;</span>
<span class="w">      </span><span class="k">border</span><span class="p">:</span><span class="w"> </span><span class="kc">none</span><span class="p">;</span>
<span class="w">      </span><span class="k">border-radius</span><span class="p">:</span><span class="w"> </span><span class="mi">5</span><span class="kt">px</span><span class="p">;</span>
<span class="w">      </span><span class="k">cursor</span><span class="p">:</span><span class="w"> </span><span class="kc">pointer</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="p">.</span><span class="nc">room-btn</span><span class="p">.</span><span class="nc">active</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">background</span><span class="p">:</span><span class="w"> </span><span class="mh">#2E7D32</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="p">.</span><span class="nc">chat-container</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">display</span><span class="p">:</span><span class="w"> </span><span class="kc">flex</span><span class="p">;</span>
<span class="w">      </span><span class="k">gap</span><span class="p">:</span><span class="w"> </span><span class="mi">20</span><span class="kt">px</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="p">.</span><span class="nc">messages</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">flex</span><span class="p">:</span><span class="w"> </span><span class="mi">3</span><span class="p">;</span>
<span class="w">      </span><span class="k">height</span><span class="p">:</span><span class="w"> </span><span class="mi">400</span><span class="kt">px</span><span class="p">;</span>
<span class="w">      </span><span class="k">overflow-y</span><span class="p">:</span><span class="w"> </span><span class="kc">auto</span><span class="p">;</span>
<span class="w">      </span><span class="k">background</span><span class="p">:</span><span class="w"> </span><span class="kc">white</span><span class="p">;</span>
<span class="w">      </span><span class="k">padding</span><span class="p">:</span><span class="w"> </span><span class="mi">15</span><span class="kt">px</span><span class="p">;</span>
<span class="w">      </span><span class="k">border-radius</span><span class="p">:</span><span class="w"> </span><span class="mi">5</span><span class="kt">px</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="p">.</span><span class="nc">users</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">flex</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">      </span><span class="k">background</span><span class="p">:</span><span class="w"> </span><span class="kc">white</span><span class="p">;</span>
<span class="w">      </span><span class="k">padding</span><span class="p">:</span><span class="w"> </span><span class="mi">15</span><span class="kt">px</span><span class="p">;</span>
<span class="w">      </span><span class="k">border-radius</span><span class="p">:</span><span class="w"> </span><span class="mi">5</span><span class="kt">px</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="p">.</span><span class="nc">message</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">margin</span><span class="p">:</span><span class="w"> </span><span class="mi">10</span><span class="kt">px</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">      </span><span class="k">padding</span><span class="p">:</span><span class="w"> </span><span class="mi">8</span><span class="kt">px</span><span class="p">;</span>
<span class="w">      </span><span class="k">background</span><span class="p">:</span><span class="w"> </span><span class="mh">#e3f2fd</span><span class="p">;</span>
<span class="w">      </span><span class="k">border-radius</span><span class="p">:</span><span class="w"> </span><span class="mi">5</span><span class="kt">px</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="p">.</span><span class="nc">message</span><span class="p">.</span><span class="nc">own</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">background</span><span class="p">:</span><span class="w"> </span><span class="mh">#c8e6c9</span><span class="p">;</span>
<span class="w">      </span><span class="k">text-align</span><span class="p">:</span><span class="w"> </span><span class="kc">right</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="p">.</span><span class="nc">typing-indicator</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">font-style</span><span class="p">:</span><span class="w"> </span><span class="kc">italic</span><span class="p">;</span>
<span class="w">      </span><span class="k">color</span><span class="p">:</span><span class="w"> </span><span class="mh">#666</span><span class="p">;</span>
<span class="w">      </span><span class="k">font-size</span><span class="p">:</span><span class="w"> </span><span class="mf">0.9</span><span class="kt">em</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="nt">input</span><span class="o">,</span><span class="w"> </span><span class="nt">button</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">padding</span><span class="p">:</span><span class="w"> </span><span class="mi">10</span><span class="kt">px</span><span class="p">;</span>
<span class="w">      </span><span class="k">margin</span><span class="p">:</span><span class="w"> </span><span class="mi">5</span><span class="kt">px</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">      </span><span class="k">width</span><span class="p">:</span><span class="w"> </span><span class="mi">100</span><span class="kt">%</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">&lt;/</span><span class="nt">style</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">head</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">body</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">div</span> <span class="na">id</span><span class="o">=</span><span class="s">&quot;app&quot;</span><span class="p">&gt;</span>
    <span class="cm">&lt;!-- Pháº§n xÃ¡c thá»±c --&gt;</span>
    <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;auth-section&quot;</span> <span class="na">id</span><span class="o">=</span><span class="s">&quot;authSection&quot;</span><span class="p">&gt;</span>
      <span class="p">&lt;</span><span class="nt">h2</span><span class="p">&gt;</span>ÄÄƒng nháº­p vÃ o Chat<span class="p">&lt;/</span><span class="nt">h2</span><span class="p">&gt;</span>
      <span class="p">&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">&quot;text&quot;</span> <span class="na">id</span><span class="o">=</span><span class="s">&quot;usernameInput&quot;</span> <span class="na">placeholder</span><span class="o">=</span><span class="s">&quot;TÃªn cá»§a báº¡n&quot;</span><span class="p">&gt;</span>
      <span class="p">&lt;</span><span class="nt">button</span> <span class="na">onclick</span><span class="o">=</span><span class="s">&quot;login()&quot;</span><span class="p">&gt;</span>VÃ o Chat<span class="p">&lt;/</span><span class="nt">button</span><span class="p">&gt;</span>
    <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>

    <span class="cm">&lt;!-- Pháº§n chat (áº©n lÃºc Ä‘áº§u) --&gt;</span>
    <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;chat-section&quot;</span> <span class="na">id</span><span class="o">=</span><span class="s">&quot;chatSection&quot;</span> <span class="na">style</span><span class="o">=</span><span class="s">&quot;display: none;&quot;</span><span class="p">&gt;</span>
      <span class="p">&lt;</span><span class="nt">h2</span><span class="p">&gt;</span>Chat Room<span class="p">&lt;/</span><span class="nt">h2</span><span class="p">&gt;</span>

      <span class="cm">&lt;!-- Danh sÃ¡ch phÃ²ng --&gt;</span>
      <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;room-list&quot;</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">button</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;room-btn active&quot;</span> <span class="na">onclick</span><span class="o">=</span><span class="s">&quot;joinRoom(&#39;general&#39;)&quot;</span><span class="p">&gt;</span>#general<span class="p">&lt;/</span><span class="nt">button</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">button</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;room-btn&quot;</span> <span class="na">onclick</span><span class="o">=</span><span class="s">&quot;joinRoom(&#39;random&#39;)&quot;</span><span class="p">&gt;</span>#random<span class="p">&lt;/</span><span class="nt">button</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">button</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;room-btn&quot;</span> <span class="na">onclick</span><span class="o">=</span><span class="s">&quot;joinRoom(&#39;support&#39;)&quot;</span><span class="p">&gt;</span>#support<span class="p">&lt;/</span><span class="nt">button</span><span class="p">&gt;</span>
      <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>

      <span class="cm">&lt;!-- Khu vá»±c chat --&gt;</span>
      <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;chat-container&quot;</span><span class="p">&gt;</span>
        <span class="cm">&lt;!-- Tin nháº¯n --&gt;</span>
        <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;messages&quot;</span> <span class="na">id</span><span class="o">=</span><span class="s">&quot;messages&quot;</span><span class="p">&gt;</span>
          <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;message system&quot;</span><span class="p">&gt;</span>ChÃ o má»«ng Ä‘áº¿n vá»›i chat!<span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
        <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>

        <span class="cm">&lt;!-- Danh sÃ¡ch user online --&gt;</span>
        <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;users&quot;</span> <span class="na">id</span><span class="o">=</span><span class="s">&quot;usersList&quot;</span><span class="p">&gt;</span>
          <span class="p">&lt;</span><span class="nt">h3</span><span class="p">&gt;</span>Online Users (<span class="p">&lt;</span><span class="nt">span</span> <span class="na">id</span><span class="o">=</span><span class="s">&quot;onlineCount&quot;</span><span class="p">&gt;</span>0<span class="p">&lt;/</span><span class="nt">span</span><span class="p">&gt;</span>)<span class="p">&lt;/</span><span class="nt">h3</span><span class="p">&gt;</span>
          <span class="p">&lt;</span><span class="nt">div</span> <span class="na">id</span><span class="o">=</span><span class="s">&quot;users&quot;</span><span class="p">&gt;&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
        <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
      <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>

      <span class="cm">&lt;!-- Input tin nháº¯n --&gt;</span>
      <span class="p">&lt;</span><span class="nt">div</span> <span class="na">style</span><span class="o">=</span><span class="s">&quot;margin-top: 20px;&quot;</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">div</span> <span class="na">id</span><span class="o">=</span><span class="s">&quot;typingIndicator&quot;</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;typing-indicator&quot;</span><span class="p">&gt;&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">div</span> <span class="na">style</span><span class="o">=</span><span class="s">&quot;display: flex; gap: 10px;&quot;</span><span class="p">&gt;</span>
          <span class="p">&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">&quot;text&quot;</span> <span class="na">id</span><span class="o">=</span><span class="s">&quot;messageInput&quot;</span> <span class="na">placeholder</span><span class="o">=</span><span class="s">&quot;Nháº­p tin nháº¯n...&quot;</span> 
                 <span class="na">onkeyup</span><span class="o">=</span><span class="s">&quot;handleTyping(event)&quot;</span>
                 <span class="na">onkeypress</span><span class="o">=</span><span class="s">&quot;if(event.key==&#39;Enter&#39;) sendMessage()&quot;</span><span class="p">&gt;</span>
          <span class="p">&lt;</span><span class="nt">button</span> <span class="na">onclick</span><span class="o">=</span><span class="s">&quot;sendMessage()&quot;</span> <span class="na">style</span><span class="o">=</span><span class="s">&quot;width: auto;&quot;</span><span class="p">&gt;</span>Gá»­i<span class="p">&lt;/</span><span class="nt">button</span><span class="p">&gt;</span>
        <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
      <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
    <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
  <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>

  <span class="p">&lt;</span><span class="nt">script</span> <span class="na">src</span><span class="o">=</span><span class="s">&quot;/socket.io/socket.io.js&quot;</span><span class="p">&gt;&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">script</span><span class="p">&gt;</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="nx">socket</span><span class="p">;</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="nx">currentUser</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="nx">currentRoom</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;general&#39;</span><span class="p">;</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="nx">typingTimeout</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// HÃ m Ä‘Äƒng nháº­p</span>
<span class="w">    </span><span class="kd">function</span><span class="w"> </span><span class="nx">login</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">username</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">&#39;usernameInput&#39;</span><span class="p">).</span><span class="nx">value</span><span class="p">.</span><span class="nx">trim</span><span class="p">();</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">username</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nx">alert</span><span class="p">(</span><span class="s1">&#39;Vui lÃ²ng nháº­p tÃªn&#39;</span><span class="p">);</span>

<span class="w">      </span><span class="c1">// Káº¿t ná»‘i Socket.IO</span>
<span class="w">      </span><span class="nx">socket</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">io</span><span class="p">(</span><span class="s1">&#39;http://localhost:3000&#39;</span><span class="p">);</span>

<span class="w">      </span><span class="c1">// Láº¯ng nghe cÃ¡c sá»± kiá»‡n</span>
<span class="w">      </span><span class="nx">socket</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;connect&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;Connected with ID:&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">socket</span><span class="p">.</span><span class="nx">id</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// Gá»­i thÃ´ng tin xÃ¡c thá»±c</span>
<span class="w">        </span><span class="nx">socket</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;authenticate&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">username</span><span class="w"> </span><span class="p">});</span>
<span class="w">      </span><span class="p">});</span>

<span class="w">      </span><span class="nx">socket</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;authenticated&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="nx">data</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">success</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="nx">currentUser</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">data</span><span class="p">.</span><span class="nx">user</span><span class="p">;</span>

<span class="w">          </span><span class="c1">// Hiá»ƒn thá»‹ giao diá»‡n chat</span>
<span class="w">          </span><span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">&#39;authSection&#39;</span><span class="p">).</span><span class="nx">style</span><span class="p">.</span><span class="nx">display</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;none&#39;</span><span class="p">;</span>
<span class="w">          </span><span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">&#39;chatSection&#39;</span><span class="p">).</span><span class="nx">style</span><span class="p">.</span><span class="nx">display</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;block&#39;</span><span class="p">;</span>

<span class="w">          </span><span class="c1">// Tham gia phÃ²ng máº·c Ä‘á»‹nh</span>
<span class="w">          </span><span class="nx">joinRoom</span><span class="p">(</span><span class="s1">&#39;general&#39;</span><span class="p">);</span>

<span class="w">          </span><span class="c1">// Hiá»ƒn thá»‹ thÃ´ng bÃ¡o</span>
<span class="w">          </span><span class="nx">addSystemMessage</span><span class="p">(</span><span class="sb">`Báº¡n Ä‘Ã£ Ä‘Äƒng nháº­p vá»›i tÃªn: </span><span class="si">${</span><span class="nx">username</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">      </span><span class="p">});</span>

<span class="w">      </span><span class="nx">socket</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;user online&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="nx">user</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">addSystemMessage</span><span class="p">(</span><span class="sb">`</span><span class="si">${</span><span class="nx">user</span><span class="p">.</span><span class="nx">username</span><span class="si">}</span><span class="sb"> Ä‘Ã£ online`</span><span class="p">);</span>
<span class="w">        </span><span class="nx">updateOnlineUsers</span><span class="p">();</span>
<span class="w">      </span><span class="p">});</span>

<span class="w">      </span><span class="nx">socket</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;user offline&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="nx">data</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">addSystemMessage</span><span class="p">(</span><span class="sb">`User </span><span class="si">${</span><span class="nx">data</span><span class="p">.</span><span class="nx">userId</span><span class="si">}</span><span class="sb"> Ä‘Ã£ offline`</span><span class="p">);</span>
<span class="w">        </span><span class="nx">updateOnlineUsers</span><span class="p">();</span>
<span class="w">      </span><span class="p">});</span>

<span class="w">      </span><span class="nx">socket</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;room history&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="nx">data</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// Hiá»ƒn thá»‹ lá»‹ch sá»­ chat</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">messagesDiv</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">&#39;messages&#39;</span><span class="p">);</span>
<span class="w">        </span><span class="nx">messagesDiv</span><span class="p">.</span><span class="nx">innerHTML</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">;</span>

<span class="w">        </span><span class="nx">data</span><span class="p">.</span><span class="nx">messages</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="nx">msg</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="nx">addMessage</span><span class="p">(</span><span class="nx">msg</span><span class="p">,</span><span class="w"> </span><span class="nx">msg</span><span class="p">.</span><span class="kr">from</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="nx">socket</span><span class="p">.</span><span class="nx">id</span><span class="p">);</span>
<span class="w">        </span><span class="p">});</span>

<span class="w">        </span><span class="c1">// Cuá»™n xuá»‘ng dÆ°á»›i cÃ¹ng</span>
<span class="w">        </span><span class="nx">messagesDiv</span><span class="p">.</span><span class="nx">scrollTop</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">messagesDiv</span><span class="p">.</span><span class="nx">scrollHeight</span><span class="p">;</span>
<span class="w">      </span><span class="p">});</span>

<span class="w">      </span><span class="nx">socket</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;new message&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="nx">message</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">addMessage</span><span class="p">(</span><span class="nx">message</span><span class="p">,</span><span class="w"> </span><span class="nx">message</span><span class="p">.</span><span class="kr">from</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="nx">socket</span><span class="p">.</span><span class="nx">id</span><span class="p">);</span>
<span class="w">      </span><span class="p">});</span>

<span class="w">      </span><span class="nx">socket</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;user joined&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="nx">data</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">roomId</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="nx">currentRoom</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="nx">addSystemMessage</span><span class="p">(</span><span class="sb">`</span><span class="si">${</span><span class="nx">data</span><span class="p">.</span><span class="nx">username</span><span class="si">}</span><span class="sb"> Ä‘Ã£ tham gia phÃ²ng`</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">      </span><span class="p">});</span>

<span class="w">      </span><span class="nx">socket</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;user left&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="nx">data</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">currentRoom</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="nx">data</span><span class="p">.</span><span class="nx">roomId</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="nx">addSystemMessage</span><span class="p">(</span><span class="sb">`</span><span class="si">${</span><span class="nx">data</span><span class="p">.</span><span class="nx">username</span><span class="si">}</span><span class="sb"> Ä‘Ã£ rá»i phÃ²ng`</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">      </span><span class="p">});</span>

<span class="w">      </span><span class="nx">socket</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;user typing&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="nx">data</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">userId</span><span class="w"> </span><span class="o">!==</span><span class="w"> </span><span class="nx">socket</span><span class="p">.</span><span class="nx">id</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="kd">const</span><span class="w"> </span><span class="nx">indicator</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">&#39;typingIndicator&#39;</span><span class="p">);</span>
<span class="w">          </span><span class="nx">indicator</span><span class="p">.</span><span class="nx">textContent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sb">`</span><span class="si">${</span><span class="nx">data</span><span class="p">.</span><span class="nx">username</span><span class="si">}</span><span class="sb"> Ä‘ang nháº­p...`</span><span class="p">;</span>

<span class="w">          </span><span class="c1">// Clear sau 2 giÃ¢y</span>
<span class="w">          </span><span class="nx">clearTimeout</span><span class="p">(</span><span class="nx">typingTimeout</span><span class="p">);</span>
<span class="w">          </span><span class="nx">typingTimeout</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">setTimeout</span><span class="p">(()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">indicator</span><span class="p">.</span><span class="nx">textContent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">;</span>
<span class="w">          </span><span class="p">},</span><span class="w"> </span><span class="mf">2000</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">      </span><span class="p">});</span>

<span class="w">      </span><span class="nx">socket</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;disconnect&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="nx">reason</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">addSystemMessage</span><span class="p">(</span><span class="sb">`Máº¥t káº¿t ná»‘i: </span><span class="si">${</span><span class="nx">reason</span><span class="si">}</span><span class="sb">. Äang thá»­ káº¿t ná»‘i láº¡i...`</span><span class="p">);</span>
<span class="w">      </span><span class="p">});</span>

<span class="w">      </span><span class="nx">socket</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;connect_error&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="nx">error</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s1">&#39;Connection error:&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">error</span><span class="p">);</span>
<span class="w">        </span><span class="nx">addSystemMessage</span><span class="p">(</span><span class="s1">&#39;Lá»—i káº¿t ná»‘i Ä‘áº¿n server&#39;</span><span class="p">);</span>
<span class="w">      </span><span class="p">});</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// Tham gia phÃ²ng</span>
<span class="w">    </span><span class="kd">function</span><span class="w"> </span><span class="nx">joinRoom</span><span class="p">(</span><span class="nx">roomId</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">socket</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">currentRoom</span><span class="w"> </span><span class="o">!==</span><span class="w"> </span><span class="nx">roomId</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// Cáº­p nháº­t UI</span>
<span class="w">        </span><span class="nb">document</span><span class="p">.</span><span class="nx">querySelectorAll</span><span class="p">(</span><span class="s1">&#39;.room-btn&#39;</span><span class="p">).</span><span class="nx">forEach</span><span class="p">(</span><span class="nx">btn</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="nx">btn</span><span class="p">.</span><span class="nx">classList</span><span class="p">.</span><span class="nx">remove</span><span class="p">(</span><span class="s1">&#39;active&#39;</span><span class="p">);</span>
<span class="w">        </span><span class="p">});</span>
<span class="w">        </span><span class="nx">event</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">classList</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="s1">&#39;active&#39;</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// Gá»­i yÃªu cáº§u tham gia phÃ²ng</span>
<span class="w">        </span><span class="nx">socket</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;join room&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">roomId</span><span class="p">);</span>
<span class="w">        </span><span class="nx">currentRoom</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">roomId</span><span class="p">;</span>

<span class="w">        </span><span class="c1">// Clear messages</span>
<span class="w">        </span><span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">&#39;messages&#39;</span><span class="p">).</span><span class="nx">innerHTML</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>
<span class="w">          </span><span class="sb">`&lt;div class=&quot;message system&quot;&gt;ÄÃ£ tham gia phÃ²ng: </span><span class="si">${</span><span class="nx">roomId</span><span class="si">}</span><span class="sb">&lt;/div&gt;`</span><span class="p">;</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// Gá»­i tin nháº¯n</span>
<span class="w">    </span><span class="kd">function</span><span class="w"> </span><span class="nx">sendMessage</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">input</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">&#39;messageInput&#39;</span><span class="p">);</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">text</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">input</span><span class="p">.</span><span class="nx">value</span><span class="p">.</span><span class="nx">trim</span><span class="p">();</span>

<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">text</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">socket</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">socket</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;send message&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="nx">roomId</span><span class="o">:</span><span class="w"> </span><span class="nx">currentRoom</span><span class="p">,</span>
<span class="w">          </span><span class="nx">text</span><span class="o">:</span><span class="w"> </span><span class="nx">text</span>
<span class="w">        </span><span class="p">});</span>

<span class="w">        </span><span class="nx">input</span><span class="p">.</span><span class="nx">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">;</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// Xá»­ lÃ½ typing indicator</span>
<span class="w">    </span><span class="kd">function</span><span class="w"> </span><span class="nx">handleTyping</span><span class="p">(</span><span class="nx">event</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">event</span><span class="p">.</span><span class="nx">key</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;Enter&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">sendMessage</span><span class="p">();</span>
<span class="w">      </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">socket</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">socket</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;typing&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">currentRoom</span><span class="p">);</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// ThÃªm tin nháº¯n vÃ o UI</span>
<span class="w">    </span><span class="kd">function</span><span class="w"> </span><span class="nx">addMessage</span><span class="p">(</span><span class="nx">message</span><span class="p">,</span><span class="w"> </span><span class="nx">isOwn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">messagesDiv</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">&#39;messages&#39;</span><span class="p">);</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">messageDiv</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s1">&#39;div&#39;</span><span class="p">);</span>

<span class="w">      </span><span class="nx">messageDiv</span><span class="p">.</span><span class="nx">className</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sb">`message </span><span class="si">${</span><span class="nx">isOwn</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="s1">&#39;own&#39;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="si">}</span><span class="sb">`</span><span class="p">;</span>
<span class="w">      </span><span class="nx">messageDiv</span><span class="p">.</span><span class="nx">innerHTML</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sb">`</span>
<span class="sb">        &lt;strong&gt;</span><span class="si">${</span><span class="nx">message</span><span class="p">.</span><span class="nx">username</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;Unknown&#39;</span><span class="si">}</span><span class="sb">&lt;/strong&gt;</span>
<span class="sb">        &lt;span style=&quot;font-size: 0.8em; color: #666;&quot;&gt;</span>
<span class="sb">          (</span><span class="si">${</span><span class="ow">new</span><span class="w"> </span><span class="nb">Date</span><span class="p">(</span><span class="nx">message</span><span class="p">.</span><span class="nx">timestamp</span><span class="p">).</span><span class="nx">toLocaleTimeString</span><span class="p">()</span><span class="si">}</span><span class="sb">)</span>
<span class="sb">        &lt;/span&gt;</span>
<span class="sb">        &lt;div&gt;</span><span class="si">${</span><span class="nx">message</span><span class="p">.</span><span class="nx">text</span><span class="si">}</span><span class="sb">&lt;/div&gt;</span>
<span class="sb">      `</span><span class="p">;</span>

<span class="w">      </span><span class="nx">messagesDiv</span><span class="p">.</span><span class="nx">appendChild</span><span class="p">(</span><span class="nx">messageDiv</span><span class="p">);</span>
<span class="w">      </span><span class="nx">messagesDiv</span><span class="p">.</span><span class="nx">scrollTop</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">messagesDiv</span><span class="p">.</span><span class="nx">scrollHeight</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kd">function</span><span class="w"> </span><span class="nx">addSystemMessage</span><span class="p">(</span><span class="nx">text</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">messagesDiv</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">&#39;messages&#39;</span><span class="p">);</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">messageDiv</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s1">&#39;div&#39;</span><span class="p">);</span>

<span class="w">      </span><span class="nx">messageDiv</span><span class="p">.</span><span class="nx">className</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;message system&#39;</span><span class="p">;</span>
<span class="w">      </span><span class="nx">messageDiv</span><span class="p">.</span><span class="nx">textContent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">text</span><span class="p">;</span>

<span class="w">      </span><span class="nx">messagesDiv</span><span class="p">.</span><span class="nx">appendChild</span><span class="p">(</span><span class="nx">messageDiv</span><span class="p">);</span>
<span class="w">      </span><span class="nx">messagesDiv</span><span class="p">.</span><span class="nx">scrollTop</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">messagesDiv</span><span class="p">.</span><span class="nx">scrollHeight</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kd">function</span><span class="w"> </span><span class="nx">updateOnlineUsers</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="c1">// Trong thá»±c táº¿, server sáº½ gá»­i danh sÃ¡ch user</span>
<span class="w">      </span><span class="c1">// á» Ä‘Ã¢y chá»‰ minh há»a</span>
<span class="w">      </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;Updating online users...&#39;</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">body</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">html</span><span class="p">&gt;</span>
</code></pre></div>
<h3 id="bai-tap-thuc-hanh-tuan-3-4">BÃ i Táº­p Thá»±c HÃ nh Tuáº§n 3-4<a class="headerlink" href="#bai-tap-thuc-hanh-tuan-3-4" title="Permanent link">&para;</a></h3>
<h4 id="bai-tap-1-chay-ung-dung-co-ban">BÃ i táº­p 1: Cháº¡y á»©ng dá»¥ng cÆ¡ báº£n<a class="headerlink" href="#bai-tap-1-chay-ung-dung-co-ban" title="Permanent link">&para;</a></h4>
<ol>
<li>CÃ i Ä‘áº·t Node.js</li>
<li>Táº¡o thÆ° má»¥c <code>chat-app</code></li>
<li>Cháº¡y <code>npm init -y</code></li>
<li>CÃ i Ä‘áº·t dependencies: <code>npm install express socket.io cors</code></li>
<li>Copy code <code>server.js</code> vÃ o</li>
<li>Táº¡o thÆ° má»¥c <code>public</code>, copy file <code>index.html</code> vÃ o</li>
<li>Cháº¡y <code>node server.js</code></li>
<li>Má»Ÿ 2 tab trÃ¬nh duyá»‡t á»Ÿ <code>http://localhost:3000</code></li>
<li>Test chat giá»¯a 2 tab</li>
</ol>
<h4 id="bai-tap-2-them-tinh-nang">BÃ i táº­p 2: ThÃªm tÃ­nh nÄƒng<a class="headerlink" href="#bai-tap-2-them-tinh-nang" title="Permanent link">&para;</a></h4>
<ul>
<li>ThÃªm nÃºt "Create Room" Ä‘á»ƒ táº¡o phÃ²ng má»›i</li>
<li>ThÃªm tÃ­nh nÄƒng gá»­i hÃ¬nh áº£nh (dÃ¹ng base64)</li>
<li>ThÃªm notification sound khi cÃ³ tin nháº¯n má»›i</li>
<li>ThÃªm chá»©c nÄƒng "seen" (Ä‘Ã£ xem)</li>
</ul>
<h4 id="bai-tap-3-debug-voi-devtools">BÃ i táº­p 3: Debug vá»›i DevTools<a class="headerlink" href="#bai-tap-3-debug-voi-devtools" title="Permanent link">&para;</a></h4>
<ol>
<li>Má»Ÿ DevTools â†’ Network â†’ WS</li>
<li>Quan sÃ¡t handshake WebSocket</li>
<li>Xem cÃ¡c frame message Ä‘Æ°á»£c gá»­i/nháº­n</li>
<li>Thá»­ táº¯t WiFi Ä‘á»ƒ xem Socket.IO reconnect tháº¿ nÃ o</li>
<li>Check memory usage trong tab Memory</li>
</ol>
<hr />
<h2 id="phan-2-kiem-thu-hieu-nang-cho-chat-chi-tiet">âš¡ PHáº¦N 2: KIá»‚M THá»¬ HIá»†U NÄ‚NG CHO CHAT - CHI TIáº¾T<a class="headerlink" href="#phan-2-kiem-thu-hieu-nang-cho-chat-chi-tiet" title="Permanent link">&para;</a></h2>
<h3 id="chuong-1-cac-metrics-ac-thu-cua-chat-application">ğŸ“Š CHÆ¯Æ NG 1: CÃC METRICS Äáº¶C THÃ™ Cá»¦A CHAT APPLICATION<a class="headerlink" href="#chuong-1-cac-metrics-ac-thu-cua-chat-application" title="Permanent link">&para;</a></h3>
<h4 id="11-concurrent-connections-vs-tps-hieu-sai-la-that-bai">1.1. Concurrent Connections vs TPS: Hiá»ƒu Sai LÃ  Tháº¥t Báº¡i<a class="headerlink" href="#11-concurrent-connections-vs-tps-hieu-sai-la-that-bai" title="Permanent link">&para;</a></h4>
<p>VÃ­ dá»¥ thá»±c táº¿ Ä‘á»ƒ phÃ¢n biá»‡t:</p>
<ul>
<li>
<p><strong>Web bÃ¡n hÃ ng (E-commerce)</strong>: 10,000 TPS cÃ³ nghÄ©a 10,000 giao dá»‹ch/giÃ¢y (mua hÃ ng, xem sáº£n pháº©m). Má»—i giao dá»‹ch kÃ©o dÃ i 0.1-0.5 giÃ¢y.</p>
</li>
<li>
<p><strong>Chat application</strong>: 10,000 Concurrent Connections cÃ³ nghÄ©a 10,000 ngÆ°á»i online cÃ¹ng lÃºc, má»—i ngÆ°á»i giá»¯ káº¿t ná»‘i 30 phÃºt Ä‘áº¿n 8 giá».</p>
</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="c1">// Äo lÆ°á»ng thá»±c táº¿ trong code</span>
<span class="kd">class</span><span class="w"> </span><span class="nx">ChatMetrics</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kr">constructor</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// METRICS QUAN TRá»ŒNG</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">metrics</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="c1">// 1. Sá»‘ káº¿t ná»‘i Ä‘á»“ng thá»i</span>
<span class="w">      </span><span class="nx">concurrentConnections</span><span class="o">:</span><span class="w"> </span><span class="mf">0</span><span class="p">,</span>

<span class="w">      </span><span class="c1">// 2. ThÃ´ng lÆ°á»£ng tin nháº¯n</span>
<span class="w">      </span><span class="nx">messagesPerSecond</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">current</span><span class="o">:</span><span class="w"> </span><span class="mf">0</span><span class="p">,</span>
<span class="w">        </span><span class="nx">max</span><span class="o">:</span><span class="w"> </span><span class="mf">0</span><span class="p">,</span>
<span class="w">        </span><span class="nx">history</span><span class="o">:</span><span class="w"> </span><span class="p">[]</span><span class="w"> </span><span class="c1">// LÆ°u má»—i giÃ¢y</span>
<span class="w">      </span><span class="p">},</span>

<span class="w">      </span><span class="c1">// 3. Äá»™ trá»… tin nháº¯n (milisecond)</span>
<span class="w">      </span><span class="nx">messageLatency</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">p50</span><span class="o">:</span><span class="w"> </span><span class="mf">0</span><span class="p">,</span><span class="w">   </span><span class="c1">// 50% tin nháº¯n dÆ°á»›i giÃ¡ trá»‹ nÃ y</span>
<span class="w">        </span><span class="nx">p95</span><span class="o">:</span><span class="w"> </span><span class="mf">0</span><span class="p">,</span><span class="w">   </span><span class="c1">// 95% tin nháº¯n dÆ°á»›i giÃ¡ trá»‹ nÃ y</span>
<span class="w">        </span><span class="nx">p99</span><span class="o">:</span><span class="w"> </span><span class="mf">0</span><span class="p">,</span><span class="w">   </span><span class="c1">// 99% tin nháº¯n dÆ°á»›i giÃ¡ trá»‹ nÃ y</span>
<span class="w">        </span><span class="nx">p999</span><span class="o">:</span><span class="w"> </span><span class="mf">0</span><span class="p">,</span><span class="w">  </span><span class="c1">// 99.9% tin nháº¯n dÆ°á»›i giÃ¡ trá»‹ nÃ y</span>
<span class="w">        </span><span class="nx">samples</span><span class="o">:</span><span class="w"> </span><span class="p">[]</span><span class="w"> </span><span class="c1">// Máº«u Ä‘á»™ trá»… thá»±c táº¿</span>
<span class="w">      </span><span class="p">},</span>

<span class="w">      </span><span class="c1">// 4. Tá»· lá»‡ tháº¥t báº¡i</span>
<span class="w">      </span><span class="nx">failureRates</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">connection</span><span class="o">:</span><span class="w"> </span><span class="mf">0</span><span class="p">,</span><span class="w">    </span><span class="c1">// % káº¿t ná»‘i tháº¥t báº¡i</span>
<span class="w">        </span><span class="nx">authentication</span><span class="o">:</span><span class="w"> </span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="c1">// % xÃ¡c thá»±c tháº¥t báº¡i</span>
<span class="w">        </span><span class="nx">messageSend</span><span class="o">:</span><span class="w"> </span><span class="mf">0</span><span class="p">,</span><span class="w">   </span><span class="c1">// % gá»­i tin tháº¥t báº¡i</span>
<span class="w">        </span><span class="nx">messageReceive</span><span class="o">:</span><span class="w"> </span><span class="mf">0</span><span class="w"> </span><span class="c1">// % nháº­n tin tháº¥t báº¡i</span>
<span class="w">      </span><span class="p">},</span>

<span class="w">      </span><span class="c1">// 5. Tá»· lá»‡ reconnect</span>
<span class="w">      </span><span class="nx">reconnectStats</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">attempts</span><span class="o">:</span><span class="w"> </span><span class="mf">0</span><span class="p">,</span>
<span class="w">        </span><span class="nx">successes</span><span class="o">:</span><span class="w"> </span><span class="mf">0</span><span class="p">,</span>
<span class="w">        </span><span class="nx">avgTime</span><span class="o">:</span><span class="w"> </span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="c1">// Thá»i gian reconnect trung bÃ¬nh</span>
<span class="w">        </span><span class="nx">failures</span><span class="o">:</span><span class="w"> </span><span class="mf">0</span>
<span class="w">      </span><span class="p">},</span>

<span class="w">      </span><span class="c1">// 6. TÃ i nguyÃªn server</span>
<span class="w">      </span><span class="nx">serverResources</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">memoryUsage</span><span class="o">:</span><span class="w"> </span><span class="mf">0</span><span class="p">,</span><span class="w">    </span><span class="c1">// MB</span>
<span class="w">        </span><span class="nx">cpuUsage</span><span class="o">:</span><span class="w"> </span><span class="mf">0</span><span class="p">,</span><span class="w">       </span><span class="c1">// %</span>
<span class="w">        </span><span class="nx">activeThreads</span><span class="o">:</span><span class="w"> </span><span class="mf">0</span><span class="p">,</span>
<span class="w">        </span><span class="nx">queueBacklog</span><span class="o">:</span><span class="w"> </span><span class="mf">0</span><span class="w">    </span><span class="c1">// Sá»‘ tin nháº¯n chá» xá»­ lÃ½</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">};</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="c1">// VÃ­ dá»¥ tÃ­nh Ä‘á»™ trá»… p95</span>
<span class="w">  </span><span class="nx">calculateLatencyPercentiles</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">sortedLatencies</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[...</span><span class="k">this</span><span class="p">.</span><span class="nx">metrics</span><span class="p">.</span><span class="nx">messageLatency</span><span class="p">.</span><span class="nx">samples</span><span class="p">].</span><span class="nx">sort</span><span class="p">((</span><span class="nx">a</span><span class="p">,</span><span class="w"> </span><span class="nx">b</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">a</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nx">b</span><span class="p">);</span>

<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">metrics</span><span class="p">.</span><span class="nx">messageLatency</span><span class="p">.</span><span class="nx">p50</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">getPercentile</span><span class="p">(</span><span class="nx">sortedLatencies</span><span class="p">,</span><span class="w"> </span><span class="mf">50</span><span class="p">);</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">metrics</span><span class="p">.</span><span class="nx">messageLatency</span><span class="p">.</span><span class="nx">p95</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">getPercentile</span><span class="p">(</span><span class="nx">sortedLatencies</span><span class="p">,</span><span class="w"> </span><span class="mf">95</span><span class="p">);</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">metrics</span><span class="p">.</span><span class="nx">messageLatency</span><span class="p">.</span><span class="nx">p99</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">getPercentile</span><span class="p">(</span><span class="nx">sortedLatencies</span><span class="p">,</span><span class="w"> </span><span class="mf">99</span><span class="p">);</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">metrics</span><span class="p">.</span><span class="nx">messageLatency</span><span class="p">.</span><span class="nx">p999</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">getPercentile</span><span class="p">(</span><span class="nx">sortedLatencies</span><span class="p">,</span><span class="w"> </span><span class="mf">99.9</span><span class="p">);</span>

<span class="w">    </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`Äá»™ trá»… p95: </span><span class="si">${</span><span class="k">this</span><span class="p">.</span><span class="nx">metrics</span><span class="p">.</span><span class="nx">messageLatency</span><span class="p">.</span><span class="nx">p95</span><span class="si">}</span><span class="sb">ms`</span><span class="p">);</span>
<span class="w">    </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`Äá»™ trá»… p99: </span><span class="si">${</span><span class="k">this</span><span class="p">.</span><span class="nx">metrics</span><span class="p">.</span><span class="nx">messageLatency</span><span class="p">.</span><span class="nx">p99</span><span class="si">}</span><span class="sb">ms`</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nx">getPercentile</span><span class="p">(</span><span class="nx">sortedArray</span><span class="p">,</span><span class="w"> </span><span class="nx">percentile</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">index</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">ceil</span><span class="p">((</span><span class="nx">percentile</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mf">100</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">sortedArray</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mf">1</span><span class="p">;</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">sortedArray</span><span class="p">[</span><span class="nb">Math</span><span class="p">.</span><span class="nx">max</span><span class="p">(</span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="nx">index</span><span class="p">)]</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<h4 id="12-tai-sao-p95p99-quan-trong-hon-average">1.2. Táº¡i Sao p95/p99 Quan Trá»ng HÆ¡n Average?<a class="headerlink" href="#12-tai-sao-p95p99-quan-trong-hon-average" title="Permanent link">&para;</a></h4>
<p>VÃ­ dá»¥ thá»±c táº¿ tá»« production:</p>
<div class="highlight"><pre><span></span><code><span class="c1">// Giáº£ sá»­ cÃ³ 100 tin nháº¯n vá»›i Ä‘á»™ trá»…:</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">latencies</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span>
<span class="w">  </span><span class="mf">10</span><span class="p">,</span><span class="w"> </span><span class="mf">12</span><span class="p">,</span><span class="w"> </span><span class="mf">15</span><span class="p">,</span><span class="w"> </span><span class="mf">18</span><span class="p">,</span><span class="w"> </span><span class="mf">20</span><span class="p">,</span><span class="w">  </span><span class="c1">// 95 tin nháº¯n Ä‘áº§u: 10-20ms</span>
<span class="w">  </span><span class="mf">150</span><span class="p">,</span><span class="w"> </span><span class="mf">200</span><span class="p">,</span><span class="w"> </span><span class="mf">300</span><span class="p">,</span><span class="w"> </span><span class="mf">500</span><span class="p">,</span><span class="w"> </span><span class="mf">1000</span><span class="w">  </span><span class="c1">// 5 tin nháº¯n cuá»‘i: ráº¥t cháº­m</span>
<span class="p">];</span>

<span class="c1">// TÃ­nh toÃ¡n:</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">average</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">latencies</span><span class="p">.</span><span class="nx">reduce</span><span class="p">((</span><span class="nx">a</span><span class="p">,</span><span class="w"> </span><span class="nx">b</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">a</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">b</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="nx">latencies</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span><span class="w"> </span><span class="c1">// 72.5ms</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">p95</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">20</span><span class="p">;</span><span class="w">  </span><span class="c1">// 95% tin nháº¯n dÆ°á»›i 20ms</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">p99</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">150</span><span class="p">;</span><span class="w"> </span><span class="c1">// 99% tin nháº¯n dÆ°á»›i 150ms</span>

<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;Náº¿u chá»‰ nhÃ¬n average (72.5ms): &#39;á»’, tá»‘t quÃ¡!&#39;&quot;</span><span class="p">);</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;NhÆ°ng thá»±c táº¿: 5% user tháº¥y Ä‘á»™ trá»… 150ms-1000ms â†’ sáº½ complaint!&quot;</span><span class="p">);</span>
</code></pre></div>
<p><strong>BÃ i há»c</strong>: Trong chat, chá»‰ cáº§n 5% tin nháº¯n cháº­m lÃ  Ä‘á»§ Ä‘á»ƒ user cáº£m tháº¥y á»©ng dá»¥ng "lag", "cháº­m".</p>
<hr />
<h3 id="chuong-2-k6-cong-cu-test-web-socket-sieu-manh">ğŸ› ï¸ CHÆ¯Æ NG 2: K6 - CÃ”NG Cá»¤ TEST WEB SOCKET SIÃŠU Máº NH<a class="headerlink" href="#chuong-2-k6-cong-cu-test-web-socket-sieu-manh" title="Permanent link">&para;</a></h3>
<h4 id="21-cai-at-chi-tiet-tung-buoc">2.1. CÃ i Äáº·t Chi Tiáº¿t Tá»«ng BÆ°á»›c<a class="headerlink" href="#21-cai-at-chi-tiet-tung-buoc" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1"># BÆ°á»›c 1: CÃ i Ä‘áº·t k6 (macOS vá»›i Homebrew)</span>
brew<span class="w"> </span>install<span class="w"> </span>k6

<span class="c1"># BÆ°á»›c 2: Kiá»ƒm tra phiÃªn báº£n</span>
k6<span class="w"> </span>version

<span class="c1"># BÆ°á»›c 3: Táº¡o thÆ° má»¥c dá»± Ã¡n</span>
mkdir<span class="w"> </span>k6-chat-tests
<span class="nb">cd</span><span class="w"> </span>k6-chat-tests

<span class="c1"># BÆ°á»›c 4: Khá»Ÿi táº¡o npm project (khÃ´ng báº¯t buá»™c nhÆ°ng khuyáº¿n khÃ­ch)</span>
npm<span class="w"> </span>init<span class="w"> </span>-y

<span class="c1"># BÆ°á»›c 5: CÃ i Ä‘áº·t thÆ° viá»‡n há»— trá»£ WebSocket cho k6</span>
npm<span class="w"> </span>install<span class="w"> </span>k6<span class="w"> </span>k6/websockets<span class="w"> </span>--save

<span class="c1"># BÆ°á»›c 6: Cáº¥u hÃ¬nh Visual Studio Code Ä‘á»ƒ debug k6</span>
<span class="c1"># Táº¡o file .vscode/launch.json</span>
mkdir<span class="w"> </span>.vscode
cat<span class="w"> </span>&gt;<span class="w"> </span>.vscode/launch.json<span class="w"> </span><span class="s">&lt;&lt; EOF</span>
<span class="s">{</span>
<span class="s">  &quot;version&quot;: &quot;0.2.0&quot;,</span>
<span class="s">  &quot;configurations&quot;: [</span>
<span class="s">    {</span>
<span class="s">      &quot;type&quot;: &quot;node&quot;,</span>
<span class="s">      &quot;request&quot;: &quot;launch&quot;,</span>
<span class="s">      &quot;name&quot;: &quot;K6 Debug&quot;,</span>
<span class="s">      &quot;runtimeExecutable&quot;: &quot;k6&quot;,</span>
<span class="s">      &quot;args&quot;: [&quot;run&quot;, &quot;--verbose&quot;, &quot;\${file}&quot;],</span>
<span class="s">      &quot;console&quot;: &quot;integratedTerminal&quot;</span>
<span class="s">    }</span>
<span class="s">  ]</span>
<span class="s">}</span>
<span class="s">EOF</span>
</code></pre></div>
<h4 id="22-script-k6-co-ban-cho-websocket">2.2. Script K6 CÆ¡ Báº£n Cho WebSocket<a class="headerlink" href="#22-script-k6-co-ban-cho-websocket" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1">// test-websocket-basic.js</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">WebSocket</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;k6/ws&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">check</span><span class="p">,</span><span class="w"> </span><span class="nx">sleep</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;k6&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">Counter</span><span class="p">,</span><span class="w"> </span><span class="nx">Trend</span><span class="p">,</span><span class="w"> </span><span class="nx">Rate</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;k6/metrics&#39;</span><span class="p">;</span>

<span class="c1">// 1. Äá»‹nh nghÄ©a custom metrics</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">messageLatency</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">Trend</span><span class="p">(</span><span class="s1">&#39;message_latency_ms&#39;</span><span class="p">);</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">connectionErrors</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">Counter</span><span class="p">(</span><span class="s1">&#39;connection_errors&#39;</span><span class="p">);</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">messageErrors</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">Counter</span><span class="p">(</span><span class="s1">&#39;message_errors&#39;</span><span class="p">);</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">successRate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">Rate</span><span class="p">(</span><span class="s1">&#39;success_rate&#39;</span><span class="p">);</span>

<span class="c1">// 2. Cáº¥u hÃ¬nh test</span>
<span class="k">export</span><span class="w"> </span><span class="kd">const</span><span class="w"> </span><span class="nx">options</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">stages</span><span class="o">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">    </span><span class="c1">// Giai Ä‘oáº¡n 1: TÄƒng tá»« 0 Ä‘áº¿n 100 user trong 30 giÃ¢y</span>
<span class="w">    </span><span class="p">{</span><span class="w"> </span><span class="nx">duration</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;30s&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">target</span><span class="o">:</span><span class="w"> </span><span class="mf">100</span><span class="w"> </span><span class="p">},</span>

<span class="w">    </span><span class="c1">// Giai Ä‘oáº¡n 2: Giá»¯ 100 user trong 1 phÃºt</span>
<span class="w">    </span><span class="p">{</span><span class="w"> </span><span class="nx">duration</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;1m&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">target</span><span class="o">:</span><span class="w"> </span><span class="mf">100</span><span class="w"> </span><span class="p">},</span>

<span class="w">    </span><span class="c1">// Giai Ä‘oáº¡n 3: TÄƒng lÃªn 500 user trong 1 phÃºt</span>
<span class="w">    </span><span class="p">{</span><span class="w"> </span><span class="nx">duration</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;1m&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">target</span><span class="o">:</span><span class="w"> </span><span class="mf">500</span><span class="w"> </span><span class="p">},</span>

<span class="w">    </span><span class="c1">// Giai Ä‘oáº¡n 4: Giáº£m vá» 0 trong 30 giÃ¢y</span>
<span class="w">    </span><span class="p">{</span><span class="w"> </span><span class="nx">duration</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;30s&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">target</span><span class="o">:</span><span class="w"> </span><span class="mf">0</span><span class="w"> </span><span class="p">}</span>
<span class="w">  </span><span class="p">],</span>

<span class="w">  </span><span class="c1">// NgÆ°á»¡ng tháº¥t báº¡i</span>
<span class="w">  </span><span class="nx">thresholds</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">message_latency_ms</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="s1">&#39;p(95) &lt; 100&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;p(99) &lt; 250&#39;</span><span class="p">],</span>
<span class="w">    </span><span class="nx">connection_errors</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="s1">&#39;count &lt; 10&#39;</span><span class="p">],</span>
<span class="w">    </span><span class="nx">success_rate</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="s1">&#39;rate &gt; 0.95&#39;</span><span class="p">]</span>
<span class="w">  </span><span class="p">},</span>

<span class="w">  </span><span class="c1">// Thá»i gian timeout</span>
<span class="w">  </span><span class="nx">timeouts</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">connect</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;10s&#39;</span><span class="p">,</span><span class="w">    </span><span class="c1">// Timeout káº¿t ná»‘i</span>
<span class="w">    </span><span class="nx">handshake</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;5s&#39;</span><span class="p">,</span><span class="w">   </span><span class="c1">// Timeout handshake WebSocket</span>
<span class="w">    </span><span class="nx">message</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;30s&#39;</span><span class="w">     </span><span class="c1">// Timeout gá»­i/nháº­n message</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">};</span>

<span class="c1">// 3. HÃ m chÃ­nh - má»—i VU (Virtual User) cháº¡y hÃ m nÃ y</span>
<span class="k">export</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">url</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;ws://localhost:3000&#39;</span><span class="p">;</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">params</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">headers</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="s1">&#39;User-Agent&#39;</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;k6-websocket-test/1.0&#39;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">};</span>

<span class="w">  </span><span class="c1">// 3.1. Má»Ÿ káº¿t ná»‘i WebSocket</span>
<span class="w">  </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`[VU </span><span class="si">${</span><span class="nx">__VU</span><span class="si">}</span><span class="sb">] Äang káº¿t ná»‘i Ä‘áº¿n </span><span class="si">${</span><span class="nx">url</span><span class="si">}</span><span class="sb">...`</span><span class="p">);</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">ws</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">WebSocket</span><span class="p">.</span><span class="nx">connect</span><span class="p">(</span><span class="nx">url</span><span class="p">,</span><span class="w"> </span><span class="nx">params</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="nx">socket</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// Callback khi káº¿t ná»‘i thÃ nh cÃ´ng</span>

<span class="w">    </span><span class="c1">// 3.2. Láº¯ng nghe tin nháº¯n tá»« server</span>
<span class="w">    </span><span class="nx">socket</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;open&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`[VU </span><span class="si">${</span><span class="nx">__VU</span><span class="si">}</span><span class="sb">] ÄÃ£ káº¿t ná»‘i, socket ID: </span><span class="si">${</span><span class="nx">socket</span><span class="p">.</span><span class="nx">id</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>

<span class="w">      </span><span class="c1">// Gá»­i tin nháº¯n Ä‘áº§u tiÃªn (authentication)</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">authMessage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">({</span>
<span class="w">        </span><span class="nx">type</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;auth&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="nx">username</span><span class="o">:</span><span class="w"> </span><span class="sb">`test_user_</span><span class="si">${</span><span class="nx">__VU</span><span class="si">}</span><span class="sb">`</span><span class="p">,</span>
<span class="w">        </span><span class="nx">timestamp</span><span class="o">:</span><span class="w"> </span><span class="nb">Date</span><span class="p">.</span><span class="nx">now</span><span class="p">()</span>
<span class="w">      </span><span class="p">});</span>

<span class="w">      </span><span class="nx">socket</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="nx">authMessage</span><span class="p">);</span>
<span class="w">      </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`[VU </span><span class="si">${</span><span class="nx">__VU</span><span class="si">}</span><span class="sb">] ÄÃ£ gá»­i auth message`</span><span class="p">);</span>
<span class="w">    </span><span class="p">});</span>

<span class="w">    </span><span class="c1">// 3.3. Xá»­ lÃ½ tin nháº¯n nháº­n Ä‘Æ°á»£c</span>
<span class="w">    </span><span class="nx">socket</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;message&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="nx">data</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">endTime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Date</span><span class="p">.</span><span class="nx">now</span><span class="p">();</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">message</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span>

<span class="w">      </span><span class="c1">// TÃ­nh Ä‘á»™ trá»… náº¿u message cÃ³ startTime</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">message</span><span class="p">.</span><span class="nx">startTime</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">latency</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">endTime</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nx">message</span><span class="p">.</span><span class="nx">startTime</span><span class="p">;</span>
<span class="w">        </span><span class="nx">messageLatency</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nx">latency</span><span class="p">);</span>

<span class="w">        </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`[VU </span><span class="si">${</span><span class="nx">__VU</span><span class="si">}</span><span class="sb">] Nháº­n message sau </span><span class="si">${</span><span class="nx">latency</span><span class="si">}</span><span class="sb">ms:`</span><span class="p">,</span><span class="w"> </span>
<span class="w">                   </span><span class="nx">message</span><span class="p">.</span><span class="nx">type</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;unknown&#39;</span><span class="p">);</span>
<span class="w">      </span><span class="p">}</span>

<span class="w">      </span><span class="c1">// Kiá»ƒm tra loáº¡i message</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">checks</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">check</span><span class="p">(</span><span class="nx">data</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="s1">&#39;message is valid JSON&#39;</span><span class="o">:</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nb">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span>
<span class="w">          </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span>
<span class="w">          </span><span class="p">}</span>
<span class="w">        </span><span class="p">},</span>
<span class="w">        </span><span class="s1">&#39;has message type&#39;</span><span class="o">:</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">message</span><span class="p">.</span><span class="nx">type</span><span class="w"> </span><span class="o">!==</span><span class="w"> </span><span class="kc">undefined</span><span class="p">,</span>
<span class="w">        </span><span class="s1">&#39;auth success if auth response&#39;</span><span class="o">:</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">message</span><span class="p">.</span><span class="nx">type</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;auth_response&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="nx">message</span><span class="p">.</span><span class="nx">success</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span>
<span class="w">          </span><span class="p">}</span>
<span class="w">          </span><span class="k">return</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">      </span><span class="p">});</span>

<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">checks</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">messageErrors</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="mf">1</span><span class="p">);</span>
<span class="w">      </span><span class="p">}</span>

<span class="w">      </span><span class="nx">successRate</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nx">checks</span><span class="p">);</span>
<span class="w">    </span><span class="p">});</span>

<span class="w">    </span><span class="c1">// 3.4. Xá»­ lÃ½ lá»—i</span>
<span class="w">    </span><span class="nx">socket</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="nx">error</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="sb">`[VU </span><span class="si">${</span><span class="nx">__VU</span><span class="si">}</span><span class="sb">] Lá»—i WebSocket:`</span><span class="p">,</span><span class="w"> </span><span class="nx">error</span><span class="p">);</span>
<span class="w">      </span><span class="nx">connectionErrors</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="mf">1</span><span class="p">);</span>
<span class="w">    </span><span class="p">});</span>

<span class="w">    </span><span class="c1">// 3.5. Xá»­ lÃ½ Ä‘Ã³ng káº¿t ná»‘i</span>
<span class="w">    </span><span class="nx">socket</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;close&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`[VU </span><span class="si">${</span><span class="nx">__VU</span><span class="si">}</span><span class="sb">] ÄÃ£ ngáº¯t káº¿t ná»‘i`</span><span class="p">);</span>
<span class="w">    </span><span class="p">});</span>

<span class="w">    </span><span class="c1">// 3.6. Gá»­i tin nháº¯n Ä‘á»‹nh ká»³ (simulate chat)</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="nx">messageCount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">interval</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">setInterval</span><span class="p">(()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">messageCount</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mf">10</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="c1">// Má»—i user gá»­i 10 tin nháº¯n</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">chatMessage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">({</span>
<span class="w">          </span><span class="nx">type</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;chat&#39;</span><span class="p">,</span>
<span class="w">          </span><span class="nx">text</span><span class="o">:</span><span class="w"> </span><span class="sb">`Tin nháº¯n thá»© </span><span class="si">${</span><span class="nx">messageCount</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">1</span><span class="si">}</span><span class="sb"> tá»« VU </span><span class="si">${</span><span class="nx">__VU</span><span class="si">}</span><span class="sb">`</span><span class="p">,</span>
<span class="w">          </span><span class="nx">startTime</span><span class="o">:</span><span class="w"> </span><span class="nb">Date</span><span class="p">.</span><span class="nx">now</span><span class="p">(),</span>
<span class="w">          </span><span class="nx">room</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;general&#39;</span>
<span class="w">        </span><span class="p">});</span>

<span class="w">        </span><span class="nx">socket</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="nx">chatMessage</span><span class="p">);</span>
<span class="w">        </span><span class="nx">messageCount</span><span class="o">++</span><span class="p">;</span>
<span class="w">      </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">clearInterval</span><span class="p">(</span><span class="nx">interval</span><span class="p">);</span>
<span class="w">        </span><span class="nx">socket</span><span class="p">.</span><span class="nx">close</span><span class="p">();</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">},</span><span class="w"> </span><span class="mf">2000</span><span class="p">);</span><span class="w"> </span><span class="c1">// Gá»­i má»—i 2 giÃ¢y</span>
<span class="w">  </span><span class="p">});</span>

<span class="w">  </span><span class="c1">// Kiá»ƒm tra káº¿t ná»‘i thÃ nh cÃ´ng</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">connectionCheck</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">check</span><span class="p">(</span><span class="nx">ws</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="s1">&#39;websocket connection is open&#39;</span><span class="o">:</span><span class="w"> </span><span class="p">(</span><span class="nx">w</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">w</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">w</span><span class="p">.</span><span class="nx">readyState</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="mf">1</span>
<span class="w">  </span><span class="p">});</span>

<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">connectionCheck</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">connectionErrors</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="mf">1</span><span class="p">);</span>
<span class="w">    </span><span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="sb">`[VU </span><span class="si">${</span><span class="nx">__VU</span><span class="si">}</span><span class="sb">] Káº¿t ná»‘i tháº¥t báº¡i`</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="c1">// Äá»£i má»™t chÃºt trÆ°á»›c khi káº¿t thÃºc</span>
<span class="w">  </span><span class="nx">sleep</span><span class="p">(</span><span class="mf">1</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>
<h4 id="23-chay-test-va-phan-tich-ket-qua">2.3. Cháº¡y Test vÃ  PhÃ¢n TÃ­ch Káº¿t Quáº£<a class="headerlink" href="#23-chay-test-va-phan-tich-ket-qua" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1"># Cháº¡y test vá»›i output chi tiáº¿t</span>
k6<span class="w"> </span>run<span class="w"> </span>--out<span class="w"> </span><span class="nv">json</span><span class="o">=</span>results.json<span class="w"> </span>--summary-export<span class="o">=</span>summary.json<span class="w"> </span>test-websocket-basic.js

<span class="c1"># Cháº¡y vá»›i áº£nh hÆ°á»Ÿng tháº¥p Ä‘áº¿n há»‡ thá»‘ng</span>
k6<span class="w"> </span>run<span class="w"> </span>--paused<span class="w"> </span>test-websocket-basic.js

<span class="c1"># Cháº¡y vÃ  xuáº¥t káº¿t quáº£ dáº¡ng dashboard</span>
k6<span class="w"> </span>run<span class="w"> </span>--out<span class="w"> </span><span class="nv">dashboard</span><span class="o">=</span><span class="nv">period</span><span class="o">=</span>5s<span class="w"> </span>test-websocket-basic.js

<span class="c1"># Cháº¡y vá»›i tags Ä‘á»ƒ filter káº¿t quáº£</span>
k6<span class="w"> </span>run<span class="w"> </span>--tag<span class="w"> </span><span class="nv">testtype</span><span class="o">=</span>websocket<span class="w"> </span>--tag<span class="w"> </span><span class="nv">env</span><span class="o">=</span>staging<span class="w"> </span>test-websocket-basic.js
</code></pre></div>
<p><strong>File cáº¥u hÃ¬nh k6 chi tiáº¿t</strong> (<code>k6.config.js</code>):</p>
<div class="highlight"><pre><span></span><code><span class="c1">// k6.config.js - Cáº¥u hÃ¬nh nÃ¢ng cao</span>
<span class="k">export</span><span class="w"> </span><span class="kd">const</span><span class="w"> </span><span class="nx">sharedOptions</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// Cáº¥u hÃ¬nh execution</span>
<span class="w">  </span><span class="nx">batch</span><span class="o">:</span><span class="w"> </span><span class="mf">20</span><span class="p">,</span><span class="w">                     </span><span class="c1">// Sá»‘ VU táº¡o cÃ¹ng lÃºc</span>
<span class="w">  </span><span class="nx">batchPerHost</span><span class="o">:</span><span class="w"> </span><span class="mf">10</span><span class="p">,</span><span class="w">              </span><span class="c1">// Sá»‘ VU trÃªn má»—i host</span>
<span class="w">  </span><span class="nx">rps</span><span class="o">:</span><span class="w"> </span><span class="mf">100</span><span class="p">,</span><span class="w">                      </span><span class="c1">// Request per second tá»‘i Ä‘a</span>

<span class="w">  </span><span class="c1">// Cáº¥u hÃ¬nh há»‡ thá»‘ng</span>
<span class="w">  </span><span class="nx">systemTags</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="s1">&#39;proto&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;subproto&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;status&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;method&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;url&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;name&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;group&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;check&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;error&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;error_code&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;tls_version&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;ocsp_status&#39;</span><span class="p">],</span>

<span class="w">  </span><span class="c1">// Blacklist/IP whitelist</span>
<span class="w">  </span><span class="nx">blacklistIPs</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="s1">&#39;10.0.0.0/8&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;192.168.0.0/16&#39;</span><span class="p">],</span>

<span class="w">  </span><span class="c1">// User Agent</span>
<span class="w">  </span><span class="nx">userAgent</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;k6-load-test/v1.0&#39;</span><span class="p">,</span>

<span class="w">  </span><span class="c1">// Timeouts</span>
<span class="w">  </span><span class="nx">setupTimeout</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;60s&#39;</span><span class="p">,</span>
<span class="w">  </span><span class="nx">teardownTimeout</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;60s&#39;</span><span class="p">,</span>

<span class="w">  </span><span class="c1">// SSL/TLS</span>
<span class="w">  </span><span class="nx">tlsCipherSuites</span><span class="o">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">    </span><span class="s1">&#39;TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="s1">&#39;TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384&#39;</span>
<span class="w">  </span><span class="p">],</span>
<span class="w">  </span><span class="nx">tlsVersion</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">min</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;tls1.2&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="nx">max</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;tls1.3&#39;</span>
<span class="w">  </span><span class="p">},</span>

<span class="w">  </span><span class="c1">// Debug</span>
<span class="w">  </span><span class="nx">debug</span><span class="o">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span>
<span class="w">  </span><span class="nx">insecureSkipTLSVerify</span><span class="o">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span>
<span class="w">  </span><span class="k">throw</span><span class="o">:</span><span class="w"> </span><span class="kc">true</span>
<span class="p">};</span>

<span class="k">export</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">getScenario</span><span class="p">(</span><span class="nx">name</span><span class="p">,</span><span class="w"> </span><span class="nx">target</span><span class="p">,</span><span class="w"> </span><span class="nx">duration</span><span class="p">,</span><span class="w"> </span><span class="nx">stages</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">executor</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;ramping-vus&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="nx">startVUs</span><span class="o">:</span><span class="w"> </span><span class="mf">0</span><span class="p">,</span>
<span class="w">    </span><span class="nx">stages</span><span class="o">:</span><span class="w"> </span><span class="nx">stages</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="p">[</span>
<span class="w">      </span><span class="p">{</span><span class="w"> </span><span class="nx">duration</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;30s&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">target</span><span class="o">:</span><span class="w"> </span><span class="nx">target</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">0.1</span><span class="w"> </span><span class="p">},</span>
<span class="w">      </span><span class="p">{</span><span class="w"> </span><span class="nx">duration</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;1m&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">target</span><span class="o">:</span><span class="w"> </span><span class="nx">target</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">0.5</span><span class="w"> </span><span class="p">},</span>
<span class="w">      </span><span class="p">{</span><span class="w"> </span><span class="nx">duration</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;2m&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">target</span><span class="o">:</span><span class="w"> </span><span class="nx">target</span><span class="w"> </span><span class="p">},</span>
<span class="w">      </span><span class="p">{</span><span class="w"> </span><span class="nx">duration</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;1m&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">target</span><span class="o">:</span><span class="w"> </span><span class="nx">target</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">0.2</span><span class="w"> </span><span class="p">},</span>
<span class="w">      </span><span class="p">{</span><span class="w"> </span><span class="nx">duration</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;30s&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">target</span><span class="o">:</span><span class="w"> </span><span class="mf">0</span><span class="w"> </span><span class="p">}</span>
<span class="w">    </span><span class="p">],</span>
<span class="w">    </span><span class="nx">gracefulRampDown</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;30s&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="nx">tags</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">scenario</span><span class="o">:</span><span class="w"> </span><span class="nx">name</span><span class="w"> </span><span class="p">}</span>
<span class="w">  </span><span class="p">};</span>
<span class="p">}</span>
</code></pre></div>
<hr />
<h3 id="chuong-3-5-kich-ban-test-thuc-te-voi-code-ay-u">ğŸ”¥ CHÆ¯Æ NG 3: 5 Ká»ŠCH Báº¢N TEST THá»°C Táº¾ Vá»šI CODE Äáº¦Y Äá»¦<a class="headerlink" href="#chuong-3-5-kich-ban-test-thuc-te-voi-code-ay-u" title="Permanent link">&para;</a></h3>
<h4 id="kich-ban-1-spike-test-tin-hot-lan-truyen">Ká»‹ch Báº£n 1: Spike Test - "Tin Hot Lan Truyá»n"<a class="headerlink" href="#kich-ban-1-spike-test-tin-hot-lan-truyen" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1">// test-spike-connections.js</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">WebSocket</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;k6/ws&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">check</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;k6&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">Trend</span><span class="p">,</span><span class="w"> </span><span class="nx">Counter</span><span class="p">,</span><span class="w"> </span><span class="nx">Rate</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;k6/metrics&#39;</span><span class="p">;</span>

<span class="kd">const</span><span class="w"> </span><span class="nx">spikeLatency</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">Trend</span><span class="p">(</span><span class="s1">&#39;spike_message_latency&#39;</span><span class="p">);</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">spikeErrors</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">Counter</span><span class="p">(</span><span class="s1">&#39;spike_connection_errors&#39;</span><span class="p">);</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">spikeSuccess</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">Rate</span><span class="p">(</span><span class="s1">&#39;spike_success_rate&#39;</span><span class="p">);</span>

<span class="k">export</span><span class="w"> </span><span class="kd">const</span><span class="w"> </span><span class="nx">options</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">scenarios</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">spike_scenario</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">executor</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;per-vu-iterations&#39;</span><span class="p">,</span>
<span class="w">      </span><span class="nx">vus</span><span class="o">:</span><span class="w"> </span><span class="mf">10000</span><span class="p">,</span><span class="w">           </span><span class="c1">// 10,000 user áº£o</span>
<span class="w">      </span><span class="nx">iterations</span><span class="o">:</span><span class="w"> </span><span class="mf">1</span><span class="p">,</span><span class="w">        </span><span class="c1">// Má»—i user chá»‰ káº¿t ná»‘i 1 láº§n</span>
<span class="w">      </span><span class="nx">maxDuration</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;2m&#39;</span><span class="p">,</span><span class="w">    </span><span class="c1">// Táº¥t cáº£ pháº£i hoÃ n thÃ nh trong 2 phÃºt</span>
<span class="w">      </span><span class="nx">gracefulStop</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;30s&#39;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">},</span>
<span class="w">  </span><span class="nx">thresholds</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">spike_message_latency</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="s1">&#39;p(95) &lt; 500&#39;</span><span class="p">],</span><span class="w"> </span><span class="c1">// Cho phÃ©p cháº­m hÆ¡n bÃ¬nh thÆ°á»ng</span>
<span class="w">    </span><span class="nx">spike_success_rate</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="s1">&#39;rate &gt; 0.85&#39;</span><span class="p">]</span><span class="w">     </span><span class="c1">// 85% thÃ nh cÃ´ng lÃ  Ä‘áº¡t</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">};</span>

<span class="k">export</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">url</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;ws://localhost:3000&#39;</span><span class="p">;</span>

<span class="w">  </span><span class="c1">// ThÃªm random delay Ä‘á»ƒ simulate user vÃ o khÃ´ng cÃ¹ng lÃºc</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">randomDelay</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">random</span><span class="p">()</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">1000</span><span class="p">;</span>
<span class="w">  </span><span class="nx">sleep</span><span class="p">(</span><span class="nx">randomDelay</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mf">1000</span><span class="p">);</span>

<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">ws</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">WebSocket</span><span class="p">.</span><span class="nx">connect</span><span class="p">(</span><span class="nx">url</span><span class="p">,</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="nx">socket</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="nx">connected</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span>

<span class="w">    </span><span class="nx">socket</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;open&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">connected</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span>
<span class="w">      </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`[SPIKE] VU </span><span class="si">${</span><span class="nx">__VU</span><span class="si">}</span><span class="sb"> connected`</span><span class="p">);</span>

<span class="w">      </span><span class="c1">// Gá»­i ngay 1 tin nháº¯n</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">message</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">type</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;spike_message&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="nx">content</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;CÃ³ tin HOT!&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="nx">vu</span><span class="o">:</span><span class="w"> </span><span class="nx">__VU</span><span class="p">,</span>
<span class="w">        </span><span class="nx">timestamp</span><span class="o">:</span><span class="w"> </span><span class="nb">Date</span><span class="p">.</span><span class="nx">now</span><span class="p">()</span>
<span class="w">      </span><span class="p">};</span>

<span class="w">      </span><span class="nx">socket</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="nb">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">message</span><span class="p">));</span>

<span class="w">      </span><span class="c1">// ÄÃ³ng káº¿t ná»‘i ngay sau khi gá»­i (simulate user xem rá»“i out)</span>
<span class="w">      </span><span class="nx">setTimeout</span><span class="p">(()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">socket</span><span class="p">.</span><span class="nx">close</span><span class="p">();</span>
<span class="w">      </span><span class="p">},</span><span class="w"> </span><span class="mf">5000</span><span class="p">);</span>
<span class="w">    </span><span class="p">});</span>

<span class="w">    </span><span class="nx">socket</span><span class="p">.</span><span class="nx">setTimeout</span><span class="p">(()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">connected</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="sb">`[SPIKE] VU </span><span class="si">${</span><span class="nx">__VU</span><span class="si">}</span><span class="sb"> timeout khi káº¿t ná»‘i`</span><span class="p">);</span>
<span class="w">        </span><span class="nx">spikeErrors</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="mf">1</span><span class="p">);</span>
<span class="w">        </span><span class="nx">socket</span><span class="p">.</span><span class="nx">close</span><span class="p">();</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">},</span><span class="w"> </span><span class="mf">5000</span><span class="p">);</span>

<span class="w">    </span><span class="nx">socket</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;message&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="nx">data</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">endTime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Date</span><span class="p">.</span><span class="nx">now</span><span class="p">();</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">msg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span>

<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">msg</span><span class="p">.</span><span class="nx">timestamp</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">latency</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">endTime</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nx">msg</span><span class="p">.</span><span class="nx">timestamp</span><span class="p">;</span>
<span class="w">        </span><span class="nx">spikeLatency</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nx">latency</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// Log náº¿u quÃ¡ cháº­m</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">latency</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">1000</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="nx">console</span><span class="p">.</span><span class="nx">warn</span><span class="p">(</span><span class="sb">`[SPIKE] VU </span><span class="si">${</span><span class="nx">__VU</span><span class="si">}</span><span class="sb"> nháº­n message cháº­m: </span><span class="si">${</span><span class="nx">latency</span><span class="si">}</span><span class="sb">ms`</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">});</span>
<span class="w">  </span><span class="p">});</span>

<span class="w">  </span><span class="nx">check</span><span class="p">(</span><span class="nx">ws</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="s1">&#39;spike connection successful&#39;</span><span class="o">:</span><span class="w"> </span><span class="p">(</span><span class="nx">w</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">w</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">w</span><span class="p">.</span><span class="nx">readyState</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="mf">1</span>
<span class="w">  </span><span class="p">});</span>
<span class="p">}</span>
</code></pre></div>
<p><strong>PhÃ¢n tÃ­ch káº¿t quáº£ Spike Test:</strong></p>
<div class="highlight"><pre><span></span><code><span class="c1">// analyze-spike-results.js</span>
<span class="kd">function</span><span class="w"> </span><span class="nx">analyzeSpikeTest</span><span class="p">(</span><span class="nx">results</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">analysis</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// 1. PhÃ¢n tÃ­ch káº¿t ná»‘i</span>
<span class="w">    </span><span class="nx">connectionAnalysis</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">totalAttempts</span><span class="o">:</span><span class="w"> </span><span class="nx">results</span><span class="p">.</span><span class="nx">metrics</span><span class="p">.</span><span class="nx">vus</span><span class="p">.</span><span class="nx">values</span><span class="p">.</span><span class="nx">count</span><span class="p">,</span>
<span class="w">      </span><span class="nx">successfulConnections</span><span class="o">:</span><span class="w"> </span><span class="nx">results</span><span class="p">.</span><span class="nx">metrics</span><span class="p">.</span><span class="nx">spike_success_rate</span><span class="p">.</span><span class="nx">values</span><span class="p">.</span><span class="nx">rate</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">results</span><span class="p">.</span><span class="nx">metrics</span><span class="p">.</span><span class="nx">vus</span><span class="p">.</span><span class="nx">values</span><span class="p">.</span><span class="nx">count</span><span class="p">,</span>
<span class="w">      </span><span class="nx">failureRate</span><span class="o">:</span><span class="w"> </span><span class="mf">1</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nx">results</span><span class="p">.</span><span class="nx">metrics</span><span class="p">.</span><span class="nx">spike_success_rate</span><span class="p">.</span><span class="nx">values</span><span class="p">.</span><span class="nx">rate</span><span class="p">,</span>
<span class="w">      </span><span class="nx">peakConnectionsPerSecond</span><span class="o">:</span><span class="w"> </span><span class="nx">calculatePeakConnections</span><span class="p">(</span><span class="nx">results</span><span class="p">),</span>

<span class="w">      </span><span class="c1">// PhÃ¢n loáº¡i lá»—i</span>
<span class="w">      </span><span class="nx">errorBreakdown</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">handshakeTimeout</span><span class="o">:</span><span class="w"> </span><span class="nx">countErrorsByType</span><span class="p">(</span><span class="nx">results</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;handshake_timeout&#39;</span><span class="p">),</span>
<span class="w">        </span><span class="nx">authenticationFailed</span><span class="o">:</span><span class="w"> </span><span class="nx">countErrorsByType</span><span class="p">(</span><span class="nx">results</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;auth_failed&#39;</span><span class="p">),</span>
<span class="w">        </span><span class="nx">serverOverload</span><span class="o">:</span><span class="w"> </span><span class="nx">countErrorsByType</span><span class="p">(</span><span class="nx">results</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;server_busy&#39;</span><span class="p">),</span>
<span class="w">        </span><span class="nx">networkError</span><span class="o">:</span><span class="w"> </span><span class="nx">countErrorsByType</span><span class="p">(</span><span class="nx">results</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;network_error&#39;</span><span class="p">)</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">},</span>

<span class="w">    </span><span class="c1">// 2. PhÃ¢n tÃ­ch Ä‘á»™ trá»…</span>
<span class="w">    </span><span class="nx">latencyAnalysis</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">p50</span><span class="o">:</span><span class="w"> </span><span class="nx">results</span><span class="p">.</span><span class="nx">metrics</span><span class="p">.</span><span class="nx">spike_message_latency</span><span class="p">.</span><span class="nx">values</span><span class="p">[</span><span class="s1">&#39;p(50)&#39;</span><span class="p">],</span>
<span class="w">      </span><span class="nx">p95</span><span class="o">:</span><span class="w"> </span><span class="nx">results</span><span class="p">.</span><span class="nx">metrics</span><span class="p">.</span><span class="nx">spike_message_latency</span><span class="p">.</span><span class="nx">values</span><span class="p">[</span><span class="s1">&#39;p(95)&#39;</span><span class="p">],</span>
<span class="w">      </span><span class="nx">p99</span><span class="o">:</span><span class="w"> </span><span class="nx">results</span><span class="p">.</span><span class="nx">metrics</span><span class="p">.</span><span class="nx">spike_message_latency</span><span class="p">.</span><span class="nx">values</span><span class="p">[</span><span class="s1">&#39;p(99)&#39;</span><span class="p">],</span>
<span class="w">      </span><span class="nx">maxLatency</span><span class="o">:</span><span class="w"> </span><span class="nx">results</span><span class="p">.</span><span class="nx">metrics</span><span class="p">.</span><span class="nx">spike_message_latency</span><span class="p">.</span><span class="nx">values</span><span class="p">.</span><span class="nx">max</span><span class="p">,</span>

<span class="w">      </span><span class="c1">// PhÃ¢n bá»‘ Ä‘á»™ trá»…</span>
<span class="w">      </span><span class="nx">latencyDistribution</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">under100ms</span><span class="o">:</span><span class="w"> </span><span class="nx">calculatePercentageUnder</span><span class="p">(</span><span class="nx">results</span><span class="p">,</span><span class="w"> </span><span class="mf">100</span><span class="p">),</span>
<span class="w">        </span><span class="nx">under500ms</span><span class="o">:</span><span class="w"> </span><span class="nx">calculatePercentageUnder</span><span class="p">(</span><span class="nx">results</span><span class="p">,</span><span class="w"> </span><span class="mf">500</span><span class="p">),</span>
<span class="w">        </span><span class="nx">under1000ms</span><span class="o">:</span><span class="w"> </span><span class="nx">calculatePercentageUnder</span><span class="p">(</span><span class="nx">results</span><span class="p">,</span><span class="w"> </span><span class="mf">1000</span><span class="p">),</span>
<span class="w">        </span><span class="nx">over1000ms</span><span class="o">:</span><span class="w"> </span><span class="nx">calculatePercentageOver</span><span class="p">(</span><span class="nx">results</span><span class="p">,</span><span class="w"> </span><span class="mf">1000</span><span class="p">)</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">},</span>

<span class="w">    </span><span class="c1">// 3. PhÃ¢n tÃ­ch tÃ i nguyÃªn server</span>
<span class="w">    </span><span class="nx">serverResourceAnalysis</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="c1">// Dá»¯ liá»‡u tá»« monitoring server</span>
<span class="w">      </span><span class="nx">cpuPeak</span><span class="o">:</span><span class="w"> </span><span class="nx">getServerMetric</span><span class="p">(</span><span class="s1">&#39;cpu_peak&#39;</span><span class="p">),</span>
<span class="w">      </span><span class="nx">memoryPeak</span><span class="o">:</span><span class="w"> </span><span class="nx">getServerMetric</span><span class="p">(</span><span class="s1">&#39;memory_peak&#39;</span><span class="p">),</span>
<span class="w">      </span><span class="nx">threadPoolExhaustion</span><span class="o">:</span><span class="w"> </span><span class="nx">checkThreadPoolExhaustion</span><span class="p">(</span><span class="nx">results</span><span class="p">),</span>

<span class="w">      </span><span class="c1">// Connection tracking</span>
<span class="w">      </span><span class="nx">connectionsPerSecond</span><span class="o">:</span><span class="w"> </span><span class="nx">calculateConnectionsTimeSeries</span><span class="p">(</span><span class="nx">results</span><span class="p">),</span>
<span class="w">      </span><span class="nx">messagesPerSecond</span><span class="o">:</span><span class="w"> </span><span class="nx">calculateMessagesTimeSeries</span><span class="p">(</span><span class="nx">results</span><span class="p">)</span>
<span class="w">    </span><span class="p">},</span>

<span class="w">    </span><span class="c1">// 4. Äá» xuáº¥t cáº£i thiá»‡n</span>
<span class="w">    </span><span class="nx">recommendations</span><span class="o">:</span><span class="w"> </span><span class="p">[]</span>
<span class="w">  </span><span class="p">};</span>

<span class="w">  </span><span class="c1">// Tá»± Ä‘á»™ng Ä‘á» xuáº¥t dá»±a trÃªn káº¿t quáº£</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">analysis</span><span class="p">.</span><span class="nx">connectionAnalysis</span><span class="p">.</span><span class="nx">failureRate</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">0.15</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">analysis</span><span class="p">.</span><span class="nx">recommendations</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span>
<span class="w">      </span><span class="nx">severity</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;HIGH&#39;</span><span class="p">,</span>
<span class="w">      </span><span class="nx">issue</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Tá»· lá»‡ káº¿t ná»‘i tháº¥t báº¡i quÃ¡ cao (&gt;15%)&#39;</span><span class="p">,</span>
<span class="w">      </span><span class="nx">suggestion</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;1. TÄƒng timeout handshake\n2. Scale horizontal thÃªm server\n3. Optimize authentication flow&#39;</span>
<span class="w">    </span><span class="p">});</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">analysis</span><span class="p">.</span><span class="nx">latencyAnalysis</span><span class="p">.</span><span class="nx">p95</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">500</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">analysis</span><span class="p">.</span><span class="nx">recommendations</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span>
<span class="w">      </span><span class="nx">severity</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;MEDIUM&#39;</span><span class="p">,</span>
<span class="w">      </span><span class="nx">issue</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Äá»™ trá»… p95 &gt; 500ms&#39;</span><span class="p">,</span>
<span class="w">      </span><span class="nx">suggestion</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;1. Review message queue\n2. Optimize database queries\n3. Cache tin nháº¯n gáº§n Ä‘Ã¢y&#39;</span>
<span class="w">    </span><span class="p">});</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">analysis</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// VÃ­ dá»¥ káº¿t quáº£ phÃ¢n tÃ­ch</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">sampleResults</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">metrics</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">spike_success_rate</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">values</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">rate</span><span class="o">:</span><span class="w"> </span><span class="mf">0.87</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">},</span>
<span class="w">    </span><span class="nx">spike_message_latency</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span>
<span class="w">      </span><span class="nx">values</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span>
<span class="w">        </span><span class="s1">&#39;p(50)&#39;</span><span class="o">:</span><span class="w"> </span><span class="mf">120</span><span class="p">,</span>
<span class="w">        </span><span class="s1">&#39;p(95)&#39;</span><span class="o">:</span><span class="w"> </span><span class="mf">450</span><span class="p">,</span>
<span class="w">        </span><span class="s1">&#39;p(99)&#39;</span><span class="o">:</span><span class="w"> </span><span class="mf">1200</span><span class="p">,</span>
<span class="w">        </span><span class="nx">max</span><span class="o">:</span><span class="w"> </span><span class="mf">3500</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">},</span>
<span class="w">    </span><span class="nx">vus</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">values</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">count</span><span class="o">:</span><span class="w"> </span><span class="mf">10000</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">};</span>

<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;Káº¿t quáº£ phÃ¢n tÃ­ch Spike Test:&#39;</span><span class="p">);</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nb">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">analyzeSpikeTest</span><span class="p">(</span><span class="nx">sampleResults</span><span class="p">),</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w"> </span><span class="mf">2</span><span class="p">));</span>
</code></pre></div>
<h4 id="kich-ban-2-soak-test-chat-qua-em">Ká»‹ch Báº£n 2: Soak Test - "Chat Qua ÄÃªm"<a class="headerlink" href="#kich-ban-2-soak-test-chat-qua-em" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1">// test-soak-8hours.js</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">WebSocket</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;k6/ws&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">check</span><span class="p">,</span><span class="w"> </span><span class="nx">sleep</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;k6&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">Trend</span><span class="p">,</span><span class="w"> </span><span class="nx">Gauge</span><span class="p">,</span><span class="w"> </span><span class="nx">Counter</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;k6/metrics&#39;</span><span class="p">;</span>

<span class="c1">// Metrics cho soak test</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">memoryUsage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">Gauge</span><span class="p">(</span><span class="s1">&#39;memory_usage_mb&#39;</span><span class="p">);</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">activeConnections</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">Gauge</span><span class="p">(</span><span class="s1">&#39;active_connections&#39;</span><span class="p">);</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">messageLatencyLong</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">Trend</span><span class="p">(</span><span class="s1">&#39;long_term_latency&#39;</span><span class="p">);</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">reconnectCount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">Counter</span><span class="p">(</span><span class="s1">&#39;reconnect_attempts&#39;</span><span class="p">);</span>

<span class="k">export</span><span class="w"> </span><span class="kd">const</span><span class="w"> </span><span class="nx">options</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">scenarios</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">soak_scenario</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">executor</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;constant-vus&#39;</span><span class="p">,</span>
<span class="w">      </span><span class="nx">vus</span><span class="o">:</span><span class="w"> </span><span class="mf">1000</span><span class="p">,</span><span class="w">           </span><span class="c1">// 1000 user liÃªn tá»¥c</span>
<span class="w">      </span><span class="nx">duration</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;8h&#39;</span><span class="p">,</span><span class="w">      </span><span class="c1">// Cháº¡y 8 giá»</span>
<span class="w">      </span><span class="nx">gracefulStop</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;5m&#39;</span><span class="p">,</span>

<span class="w">      </span><span class="c1">// Tags Ä‘áº·c biá»‡t</span>
<span class="w">      </span><span class="nx">tags</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">test_type</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;soak&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">duration</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;8h&#39;</span><span class="w"> </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">},</span>

<span class="w">  </span><span class="c1">// Thresholds cho soak test</span>
<span class="w">  </span><span class="nx">thresholds</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">long_term_latency</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="s1">&#39;p(95) &lt; 200&#39;</span><span class="p">],</span><span class="w"> </span><span class="c1">// Pháº£i á»•n Ä‘á»‹nh lÃ¢u dÃ i</span>
<span class="w">    </span><span class="nx">memory_usage_mb</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="s1">&#39;value &lt; 1024&#39;</span><span class="p">],</span><span class="w">  </span><span class="c1">// Memory &lt; 1GB</span>
<span class="w">    </span><span class="nx">reconnect_attempts</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="s1">&#39;count &lt; 50&#39;</span><span class="p">]</span><span class="w">   </span><span class="c1">// Ãt hÆ¡n 50 láº§n reconnect</span>
<span class="w">  </span><span class="p">},</span>

<span class="w">  </span><span class="c1">// Cáº¥u hÃ¬nh há»‡ thá»‘ng</span>
<span class="w">  </span><span class="nx">systemTags</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="s1">&#39;vu&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;iter&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;url&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;name&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;check&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;error&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;status&#39;</span><span class="p">],</span>
<span class="w">  </span><span class="nx">teardownTimeout</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;10m&#39;</span>
<span class="p">};</span>

<span class="c1">// HÃ m láº¥y memory usage tá»« server (giáº£ láº­p)</span>
<span class="kd">function</span><span class="w"> </span><span class="nx">fetchServerMetrics</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// Trong thá»±c táº¿, gá»i API metrics cá»§a server</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">memory</span><span class="o">:</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">random</span><span class="p">()</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">500</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">300</span><span class="p">,</span><span class="w"> </span><span class="c1">// 300-800 MB</span>
<span class="w">    </span><span class="nx">connections</span><span class="o">:</span><span class="w"> </span><span class="mf">950</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">random</span><span class="p">()</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">100</span><span class="p">,</span><span class="w"> </span><span class="c1">// 950-1050 connections</span>
<span class="w">    </span><span class="nx">cpu</span><span class="o">:</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">random</span><span class="p">()</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">30</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">20</span><span class="w"> </span><span class="c1">// 20-50%</span>
<span class="w">  </span><span class="p">};</span>
<span class="p">}</span>

<span class="k">export</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">url</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;ws://localhost:3000&#39;</span><span class="p">;</span>
<span class="w">  </span><span class="kd">let</span><span class="w"> </span><span class="nx">reconnectAttempts</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span>
<span class="w">  </span><span class="kd">let</span><span class="w"> </span><span class="nx">lastMessageTime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Date</span><span class="p">.</span><span class="nx">now</span><span class="p">();</span>

<span class="w">  </span><span class="kd">function</span><span class="w"> </span><span class="nx">connectWebSocket</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`[SOAK] VU </span><span class="si">${</span><span class="nx">__VU</span><span class="si">}</span><span class="sb"> Ä‘ang káº¿t ná»‘i (attempt </span><span class="si">${</span><span class="nx">reconnectAttempts</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">1</span><span class="si">}</span><span class="sb">)`</span><span class="p">);</span>

<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">ws</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">WebSocket</span><span class="p">.</span><span class="nx">connect</span><span class="p">(</span><span class="nx">url</span><span class="p">,</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="nx">socket</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="kd">let</span><span class="w"> </span><span class="nx">isAlive</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span>

<span class="w">      </span><span class="c1">// Heartbeat interval</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">heartbeatInterval</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">setInterval</span><span class="p">(()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">isAlive</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="nx">socket</span><span class="p">.</span><span class="nx">ping</span><span class="p">();</span>
<span class="w">          </span><span class="nx">lastMessageTime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Date</span><span class="p">.</span><span class="nx">now</span><span class="p">();</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">      </span><span class="p">},</span><span class="w"> </span><span class="mf">30000</span><span class="p">);</span><span class="w"> </span><span class="c1">// 30 giÃ¢y 1 láº§n</span>

<span class="w">      </span><span class="nx">socket</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;open&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`[SOAK] VU </span><span class="si">${</span><span class="nx">__VU</span><span class="si">}</span><span class="sb"> connected`</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// Authentication</span>
<span class="w">        </span><span class="nx">socket</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="nb">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">({</span>
<span class="w">          </span><span class="nx">type</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;auth&#39;</span><span class="p">,</span>
<span class="w">          </span><span class="nx">username</span><span class="o">:</span><span class="w"> </span><span class="sb">`soak_user_</span><span class="si">${</span><span class="nx">__VU</span><span class="si">}</span><span class="sb">`</span><span class="p">,</span>
<span class="w">          </span><span class="nx">userId</span><span class="o">:</span><span class="w"> </span><span class="nx">__VU</span>
<span class="w">        </span><span class="p">}));</span>

<span class="w">        </span><span class="c1">// Join room</span>
<span class="w">        </span><span class="nx">socket</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="nb">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">({</span>
<span class="w">          </span><span class="nx">type</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;join&#39;</span><span class="p">,</span>
<span class="w">          </span><span class="nx">room</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;general&#39;</span>
<span class="w">        </span><span class="p">}));</span>
<span class="w">      </span><span class="p">});</span>

<span class="w">      </span><span class="nx">socket</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;message&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="nx">data</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">message</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span>
<span class="w">        </span><span class="nx">lastMessageTime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Date</span><span class="p">.</span><span class="nx">now</span><span class="p">();</span>

<span class="w">        </span><span class="c1">// Ghi nháº­n Ä‘á»™ trá»…</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">message</span><span class="p">.</span><span class="nx">sentAt</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="kd">const</span><span class="w"> </span><span class="nx">latency</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Date</span><span class="p">.</span><span class="nx">now</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nx">message</span><span class="p">.</span><span class="nx">sentAt</span><span class="p">;</span>
<span class="w">          </span><span class="nx">messageLatencyLong</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nx">latency</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="c1">// Pháº£n há»“i náº¿u lÃ  ping</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">message</span><span class="p">.</span><span class="nx">type</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;ping&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="nx">socket</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="nb">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">({</span>
<span class="w">            </span><span class="nx">type</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;pong&#39;</span><span class="p">,</span>
<span class="w">            </span><span class="nx">timestamp</span><span class="o">:</span><span class="w"> </span><span class="nb">Date</span><span class="p">.</span><span class="nx">now</span><span class="p">()</span>
<span class="w">          </span><span class="p">}));</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="c1">// Gá»­i tin nháº¯n ngáº«u nhiÃªn</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nx">random</span><span class="p">()</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">0.7</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="c1">// 30% kháº£ nÄƒng</span>
<span class="w">          </span><span class="nx">setTimeout</span><span class="p">(()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">isAlive</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">              </span><span class="nx">socket</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="nb">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">({</span>
<span class="w">                </span><span class="nx">type</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;chat&#39;</span><span class="p">,</span>
<span class="w">                </span><span class="nx">text</span><span class="o">:</span><span class="w"> </span><span class="sb">`Message from soak user </span><span class="si">${</span><span class="nx">__VU</span><span class="si">}</span><span class="sb"> at </span><span class="si">${</span><span class="ow">new</span><span class="w"> </span><span class="nb">Date</span><span class="p">().</span><span class="nx">toISOString</span><span class="p">()</span><span class="si">}</span><span class="sb">`</span><span class="p">,</span>
<span class="w">                </span><span class="nx">sentAt</span><span class="o">:</span><span class="w"> </span><span class="nb">Date</span><span class="p">.</span><span class="nx">now</span><span class="p">()</span>
<span class="w">              </span><span class="p">}));</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">          </span><span class="p">},</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">random</span><span class="p">()</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">10000</span><span class="p">);</span><span class="w"> </span><span class="c1">// Random 0-10 giÃ¢y</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">      </span><span class="p">});</span>

<span class="w">      </span><span class="nx">socket</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;pong&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">isAlive</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span>
<span class="w">      </span><span class="p">});</span>

<span class="w">      </span><span class="nx">socket</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="nx">error</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="sb">`[SOAK] VU </span><span class="si">${</span><span class="nx">__VU</span><span class="si">}</span><span class="sb"> error:`</span><span class="p">,</span><span class="w"> </span><span class="nx">error</span><span class="p">);</span>
<span class="w">        </span><span class="nx">clearInterval</span><span class="p">(</span><span class="nx">heartbeatInterval</span><span class="p">);</span>
<span class="w">        </span><span class="nx">isAlive</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span>

<span class="w">        </span><span class="c1">// Thá»­ reconnect sau 5 giÃ¢y</span>
<span class="w">        </span><span class="nx">setTimeout</span><span class="p">(()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="nx">reconnectAttempts</span><span class="o">++</span><span class="p">;</span>
<span class="w">          </span><span class="nx">reconnectCount</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="mf">1</span><span class="p">);</span>
<span class="w">          </span><span class="nx">connectWebSocket</span><span class="p">();</span>
<span class="w">        </span><span class="p">},</span><span class="w"> </span><span class="mf">5000</span><span class="p">);</span>
<span class="w">      </span><span class="p">});</span>

<span class="w">      </span><span class="nx">socket</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;close&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`[SOAK] VU </span><span class="si">${</span><span class="nx">__VU</span><span class="si">}</span><span class="sb"> disconnected`</span><span class="p">);</span>
<span class="w">        </span><span class="nx">clearInterval</span><span class="p">(</span><span class="nx">heartbeatInterval</span><span class="p">);</span>
<span class="w">        </span><span class="nx">isAlive</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span>
<span class="w">      </span><span class="p">});</span>

<span class="w">      </span><span class="c1">// Check timeout (khÃ´ng cÃ³ message trong 2 phÃºt)</span>
<span class="w">      </span><span class="nx">setInterval</span><span class="p">(()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">Date</span><span class="p">.</span><span class="nx">now</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nx">lastMessageTime</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">120000</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="c1">// 2 phÃºt</span>
<span class="w">          </span><span class="nx">console</span><span class="p">.</span><span class="nx">warn</span><span class="p">(</span><span class="sb">`[SOAK] VU </span><span class="si">${</span><span class="nx">__VU</span><span class="si">}</span><span class="sb"> timeout, reconnecting...`</span><span class="p">);</span>
<span class="w">          </span><span class="nx">socket</span><span class="p">.</span><span class="nx">close</span><span class="p">();</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">      </span><span class="p">},</span><span class="w"> </span><span class="mf">60000</span><span class="p">);</span><span class="w"> </span><span class="c1">// Check má»—i phÃºt</span>
<span class="w">    </span><span class="p">});</span>

<span class="w">    </span><span class="c1">// Kiá»ƒm tra káº¿t ná»‘i</span>
<span class="w">    </span><span class="nx">check</span><span class="p">(</span><span class="nx">ws</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="s1">&#39;soak connection established&#39;</span><span class="o">:</span><span class="w"> </span><span class="p">(</span><span class="nx">w</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">w</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">w</span><span class="p">.</span><span class="nx">readyState</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="mf">1</span>
<span class="w">    </span><span class="p">});</span>

<span class="w">    </span><span class="c1">// Láº¥y server metrics Ä‘á»‹nh ká»³</span>
<span class="w">    </span><span class="nx">setInterval</span><span class="p">(()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">metrics</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">fetchServerMetrics</span><span class="p">();</span>
<span class="w">      </span><span class="nx">memoryUsage</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nx">metrics</span><span class="p">.</span><span class="nx">memory</span><span class="p">);</span>
<span class="w">      </span><span class="nx">activeConnections</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nx">metrics</span><span class="p">.</span><span class="nx">connections</span><span class="p">);</span>

<span class="w">      </span><span class="c1">// Log náº¿u memory cao</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">metrics</span><span class="p">.</span><span class="nx">memory</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">800</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">console</span><span class="p">.</span><span class="nx">warn</span><span class="p">(</span><span class="sb">`[SOAK] Memory usage high: </span><span class="si">${</span><span class="nx">metrics</span><span class="p">.</span><span class="nx">memory</span><span class="si">}</span><span class="sb">MB`</span><span class="p">);</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">},</span><span class="w"> </span><span class="mf">60000</span><span class="p">);</span><span class="w"> </span><span class="c1">// Má»—i phÃºt</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="c1">// Báº¯t Ä‘áº§u káº¿t ná»‘i</span>
<span class="w">  </span><span class="nx">connectWebSocket</span><span class="p">();</span>

<span class="w">  </span><span class="c1">// Giá»¯ VU sá»‘ng trong toÃ n bá»™ test</span>
<span class="w">  </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="kc">true</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">sleep</span><span class="p">(</span><span class="mf">60</span><span class="p">);</span><span class="w"> </span><span class="c1">// Sleep 60 giÃ¢y</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>

<span class="c1">// Setup vÃ  teardown</span>
<span class="k">export</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">setup</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;ğŸš€ Báº¯t Ä‘áº§u Soak Test 8 giá»&#39;</span><span class="p">);</span>
<span class="w">  </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;Thá»i gian báº¯t Ä‘áº§u:&#39;</span><span class="p">,</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nb">Date</span><span class="p">().</span><span class="nx">toISOString</span><span class="p">());</span>
<span class="w">  </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;Sá»‘ VU:&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">options</span><span class="p">.</span><span class="nx">scenarios</span><span class="p">.</span><span class="nx">soak_scenario</span><span class="p">.</span><span class="nx">vus</span><span class="p">);</span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">startTime</span><span class="o">:</span><span class="w"> </span><span class="nb">Date</span><span class="p">.</span><span class="nx">now</span><span class="p">(),</span>
<span class="w">    </span><span class="nx">testId</span><span class="o">:</span><span class="w"> </span><span class="sb">`soak_test_</span><span class="si">${</span><span class="nb">Date</span><span class="p">.</span><span class="nx">now</span><span class="p">()</span><span class="si">}</span><span class="sb">`</span>
<span class="w">  </span><span class="p">};</span>
<span class="p">}</span>

<span class="k">export</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">teardown</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">duration</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Date</span><span class="p">.</span><span class="nx">now</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nx">data</span><span class="p">.</span><span class="nx">startTime</span><span class="p">;</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">hours</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">duration</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="p">(</span><span class="mf">1000</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">60</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">60</span><span class="p">)).</span><span class="nx">toFixed</span><span class="p">(</span><span class="mf">2</span><span class="p">);</span>

<span class="w">  </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;âœ… Káº¿t thÃºc Soak Test&#39;</span><span class="p">);</span>
<span class="w">  </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;Thá»i gian káº¿t thÃºc:&#39;</span><span class="p">,</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nb">Date</span><span class="p">().</span><span class="nx">toISOString</span><span class="p">());</span>
<span class="w">  </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`Tá»•ng thá»i gian cháº¡y: </span><span class="si">${</span><span class="nx">hours</span><span class="si">}</span><span class="sb"> giá»`</span><span class="p">);</span>
<span class="w">  </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`Test ID: </span><span class="si">${</span><span class="nx">data</span><span class="p">.</span><span class="nx">testId</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>

<span class="w">  </span><span class="c1">// Generate report</span>
<span class="w">  </span><span class="nx">generateSoakTestReport</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span>
<span class="p">}</span>

<span class="kd">function</span><span class="w"> </span><span class="nx">generateSoakTestReport</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">report</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">testId</span><span class="o">:</span><span class="w"> </span><span class="nx">data</span><span class="p">.</span><span class="nx">testId</span><span class="p">,</span>
<span class="w">    </span><span class="nx">duration</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;8 hours&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="nx">vus</span><span class="o">:</span><span class="w"> </span><span class="mf">1000</span><span class="p">,</span>
<span class="w">    </span><span class="nx">summary</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="c1">// CÃ¡c metrics quan trá»ng sáº½ Ä‘Æ°á»£c Ä‘iá»n sau khi test xong</span>
<span class="w">      </span><span class="nx">averageLatency</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;N/A&#39;</span><span class="p">,</span>
<span class="w">      </span><span class="nx">maxMemoryUsage</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;N/A&#39;</span><span class="p">,</span>
<span class="w">      </span><span class="nx">totalReconnects</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;N/A&#39;</span><span class="p">,</span>
<span class="w">      </span><span class="nx">successRate</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;N/A&#39;</span>
<span class="w">    </span><span class="p">},</span>
<span class="w">    </span><span class="nx">findings</span><span class="o">:</span><span class="w"> </span><span class="p">[],</span>
<span class="w">    </span><span class="nx">recommendations</span><span class="o">:</span><span class="w"> </span><span class="p">[]</span>
<span class="w">  </span><span class="p">};</span>

<span class="w">  </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;ğŸ“Š Soak Test Report:&#39;</span><span class="p">,</span><span class="w"> </span><span class="nb">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">report</span><span class="p">,</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w"> </span><span class="mf">2</span><span class="p">));</span>
<span class="p">}</span>
</code></pre></div>
<p><strong>PhÃ¢n tÃ­ch Memory Leak trong Soak Test:</strong></p>
<div class="highlight"><pre><span></span><code><span class="c1">// memory-leak-detector.js</span>
<span class="kd">class</span><span class="w"> </span><span class="nx">MemoryLeakDetector</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kr">constructor</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">samples</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[];</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">leakThreshold</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.1</span><span class="p">;</span><span class="w"> </span><span class="c1">// 10% increase per hour</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nx">addSample</span><span class="p">(</span><span class="nx">memoryUsage</span><span class="p">,</span><span class="w"> </span><span class="nx">timestamp</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">samples</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span><span class="w"> </span><span class="nx">memory</span><span class="o">:</span><span class="w"> </span><span class="nx">memoryUsage</span><span class="p">,</span><span class="w"> </span><span class="nx">time</span><span class="o">:</span><span class="w"> </span><span class="nx">timestamp</span><span class="w"> </span><span class="p">});</span>

<span class="w">    </span><span class="c1">// Giá»¯ 100 máº«u gáº§n nháº¥t</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">samples</span><span class="p">.</span><span class="nx">length</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">100</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">this</span><span class="p">.</span><span class="nx">samples</span><span class="p">.</span><span class="nx">shift</span><span class="p">();</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// PhÃ¡t hiá»‡n leak náº¿u cÃ³ Ä‘á»§ samples</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">samples</span><span class="p">.</span><span class="nx">length</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mf">10</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">this</span><span class="p">.</span><span class="nx">detectLeak</span><span class="p">();</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nx">detectLeak</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">firstHour</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">samples</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="mf">20</span><span class="p">);</span><span class="w"> </span><span class="c1">// Giáº£ sá»­ 20 samples = 1 giá»</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">lastHour</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">samples</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="o">-</span><span class="mf">20</span><span class="p">);</span>

<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">avgFirstHour</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">calculateAverage</span><span class="p">(</span><span class="nx">firstHour</span><span class="p">);</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">avgLastHour</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">calculateAverage</span><span class="p">(</span><span class="nx">lastHour</span><span class="p">);</span>

<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">increasePercentage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">avgLastHour</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nx">avgFirstHour</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="nx">avgFirstHour</span><span class="p">;</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">increasePercentage</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">leakThreshold</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="sb">`âš ï¸ PHÃT HIá»†N MEMORY LEAK!`</span><span class="p">);</span>
<span class="w">      </span><span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="sb">`Memory tÄƒng </span><span class="si">${</span><span class="p">(</span><span class="nx">increasePercentage</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">100</span><span class="p">).</span><span class="nx">toFixed</span><span class="p">(</span><span class="mf">2</span><span class="p">)</span><span class="si">}</span><span class="sb">% sau 1 giá»`</span><span class="p">);</span>
<span class="w">      </span><span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="sb">`Tá»« </span><span class="si">${</span><span class="nx">avgFirstHour</span><span class="p">.</span><span class="nx">toFixed</span><span class="p">(</span><span class="mf">2</span><span class="p">)</span><span class="si">}</span><span class="sb">MB lÃªn </span><span class="si">${</span><span class="nx">avgLastHour</span><span class="p">.</span><span class="nx">toFixed</span><span class="p">(</span><span class="mf">2</span><span class="p">)</span><span class="si">}</span><span class="sb">MB`</span><span class="p">);</span>

<span class="w">      </span><span class="c1">// PhÃ¢n tÃ­ch pattern</span>
<span class="w">      </span><span class="k">this</span><span class="p">.</span><span class="nx">analyzeLeakPattern</span><span class="p">();</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nx">analyzeLeakPattern</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// PhÃ¢n tÃ­ch xem leak xáº£y ra khi nÃ o</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">timestamps</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">samples</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">s</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">s</span><span class="p">.</span><span class="nx">time</span><span class="p">);</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">memories</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">samples</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">s</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">s</span><span class="p">.</span><span class="nx">memory</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// TÃ¬m correlation vá»›i sá»‘ lÆ°á»£ng tin nháº¯n</span>
<span class="w">    </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;ğŸ” PhÃ¢n tÃ­ch pattern leak:&#39;</span><span class="p">);</span>
<span class="w">    </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;- Memory tÄƒng Ä‘á»u hay Ä‘á»™t biáº¿n?&#39;</span><span class="p">);</span>
<span class="w">    </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;- CÃ³ trÃ¹ng vá»›i peak traffic khÃ´ng?&#39;</span><span class="p">);</span>
<span class="w">    </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;- CÃ³ connection nÃ o khÃ´ng Ä‘Æ°á»£c cleanup?&#39;</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nx">calculateAverage</span><span class="p">(</span><span class="nx">samples</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">samples</span><span class="p">.</span><span class="nx">reduce</span><span class="p">((</span><span class="nx">sum</span><span class="p">,</span><span class="w"> </span><span class="nx">s</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">sum</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">s</span><span class="p">.</span><span class="nx">memory</span><span class="p">,</span><span class="w"> </span><span class="mf">0</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="nx">samples</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>

<span class="c1">// Sá»­ dá»¥ng trong test</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">leakDetector</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">MemoryLeakDetector</span><span class="p">();</span>

<span class="c1">// Trong vÃ²ng láº·p chÃ­nh cá»§a soak test</span>
<span class="nx">setInterval</span><span class="p">(()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">metrics</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">fetchServerMetrics</span><span class="p">();</span>
<span class="w">  </span><span class="nx">leakDetector</span><span class="p">.</span><span class="nx">addSample</span><span class="p">(</span><span class="nx">metrics</span><span class="p">.</span><span class="nx">memory</span><span class="p">,</span><span class="w"> </span><span class="nb">Date</span><span class="p">.</span><span class="nx">now</span><span class="p">());</span>
<span class="p">},</span><span class="w"> </span><span class="mf">300000</span><span class="p">);</span><span class="w"> </span><span class="c1">// Má»—i 5 phÃºt</span>
</code></pre></div>
<h4 id="kich-ban-3-burst-message-test-spam-tin-nhan">Ká»‹ch Báº£n 3: Burst Message Test - "Spam Tin Nháº¯n"<a class="headerlink" href="#kich-ban-3-burst-message-test-spam-tin-nhan" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1">// test-burst-messages.js</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">WebSocket</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;k6/ws&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">check</span><span class="p">,</span><span class="w"> </span><span class="nx">sleep</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;k6&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">Rate</span><span class="p">,</span><span class="w"> </span><span class="nx">Counter</span><span class="p">,</span><span class="w"> </span><span class="nx">Trend</span><span class="p">,</span><span class="w"> </span><span class="nx">Gauge</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;k6/metrics&#39;</span><span class="p">;</span>

<span class="kd">const</span><span class="w"> </span><span class="nx">burstSuccess</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">Rate</span><span class="p">(</span><span class="s1">&#39;burst_success_rate&#39;</span><span class="p">);</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">rateLimitHits</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">Counter</span><span class="p">(</span><span class="s1">&#39;rate_limit_hits&#39;</span><span class="p">);</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">queueBacklog</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">Gauge</span><span class="p">(</span><span class="s1">&#39;queue_backlog&#39;</span><span class="p">);</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">burstLatency</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">Trend</span><span class="p">(</span><span class="s1">&#39;burst_message_latency&#39;</span><span class="p">);</span>

<span class="k">export</span><span class="w"> </span><span class="kd">const</span><span class="w"> </span><span class="nx">options</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">scenarios</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">burst_scenario</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">executor</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;constant-vus&#39;</span><span class="p">,</span>
<span class="w">      </span><span class="nx">vus</span><span class="o">:</span><span class="w"> </span><span class="mf">50</span><span class="p">,</span><span class="w">              </span><span class="c1">// 50 user spam</span>
<span class="w">      </span><span class="nx">duration</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;5m&#39;</span><span class="p">,</span><span class="w">       </span><span class="c1">// Spam trong 5 phÃºt</span>

<span class="w">      </span><span class="c1">// Má»—i VU sáº½ gá»­i ráº¥t nhiá»u message</span>
<span class="w">      </span><span class="nx">exec</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;burstMessageSend&#39;</span>
<span class="w">    </span><span class="p">},</span>

<span class="w">    </span><span class="c1">// ThÃªm scenario cho normal users bá»‹ áº£nh hÆ°á»Ÿng</span>
<span class="w">    </span><span class="nx">normal_users</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">executor</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;constant-vus&#39;</span><span class="p">,</span>
<span class="w">      </span><span class="nx">vus</span><span class="o">:</span><span class="w"> </span><span class="mf">100</span><span class="p">,</span><span class="w">             </span><span class="c1">// 100 user bÃ¬nh thÆ°á»ng</span>
<span class="w">      </span><span class="nx">duration</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;5m&#39;</span><span class="p">,</span>
<span class="w">      </span><span class="nx">exec</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;normalUserBehavior&#39;</span><span class="p">,</span>
<span class="w">      </span><span class="nx">startTime</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;1m&#39;</span><span class="w">       </span><span class="c1">// Báº¯t Ä‘áº§u sau 1 phÃºt</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">};</span>

<span class="c1">// User spam tin nháº¯n</span>
<span class="k">export</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">burstMessageSend</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">url</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;ws://localhost:3000&#39;</span><span class="p">;</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">ws</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">WebSocket</span><span class="p">.</span><span class="nx">connect</span><span class="p">(</span><span class="nx">url</span><span class="p">,</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="nx">socket</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">socket</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;open&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`[BURST] Spammer </span><span class="si">${</span><span class="nx">__VU</span><span class="si">}</span><span class="sb"> connected`</span><span class="p">);</span>

<span class="w">      </span><span class="c1">// Authentication</span>
<span class="w">      </span><span class="nx">socket</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="nb">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">({</span>
<span class="w">        </span><span class="nx">type</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;auth&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="nx">username</span><span class="o">:</span><span class="w"> </span><span class="sb">`spammer_</span><span class="si">${</span><span class="nx">__VU</span><span class="si">}</span><span class="sb">`</span>
<span class="w">      </span><span class="p">}));</span>

<span class="w">      </span><span class="c1">// Báº¯t Ä‘áº§u spam</span>
<span class="w">      </span><span class="kd">let</span><span class="w"> </span><span class="nx">messageCount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">spamInterval</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">setInterval</span><span class="p">(()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">messageCount</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mf">1000</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="c1">// Má»—i spammer gá»­i tá»‘i Ä‘a 1000 tin</span>
<span class="w">          </span><span class="kd">const</span><span class="w"> </span><span class="nx">message</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">type</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;chat&#39;</span><span class="p">,</span>
<span class="w">            </span><span class="nx">text</span><span class="o">:</span><span class="w"> </span><span class="sb">`SPAM </span><span class="si">${</span><span class="nx">messageCount</span><span class="si">}</span><span class="sb"> tá»« spammer </span><span class="si">${</span><span class="nx">__VU</span><span class="si">}</span><span class="sb">`</span><span class="p">,</span>
<span class="w">            </span><span class="nx">timestamp</span><span class="o">:</span><span class="w"> </span><span class="nb">Date</span><span class="p">.</span><span class="nx">now</span><span class="p">(),</span>
<span class="w">            </span><span class="nx">room</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;general&#39;</span>
<span class="w">          </span><span class="p">};</span>

<span class="w">          </span><span class="nx">socket</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="nb">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">message</span><span class="p">));</span>
<span class="w">          </span><span class="nx">messageCount</span><span class="o">++</span><span class="p">;</span>

<span class="w">          </span><span class="c1">// Theo dÃµi rate</span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">messageCount</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="mf">100</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="mf">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`[BURST] Spammer </span><span class="si">${</span><span class="nx">__VU</span><span class="si">}</span><span class="sb"> Ä‘Ã£ gá»­i </span><span class="si">${</span><span class="nx">messageCount</span><span class="si">}</span><span class="sb"> tin`</span><span class="p">);</span>
<span class="w">          </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="nx">clearInterval</span><span class="p">(</span><span class="nx">spamInterval</span><span class="p">);</span>
<span class="w">          </span><span class="nx">socket</span><span class="p">.</span><span class="nx">close</span><span class="p">();</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">      </span><span class="p">},</span><span class="w"> </span><span class="mf">10</span><span class="p">);</span><span class="w"> </span><span class="c1">// Gá»­i má»—i 10ms = 100 msg/giÃ¢y</span>
<span class="w">    </span><span class="p">});</span>

<span class="w">    </span><span class="nx">socket</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;message&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="nx">data</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">response</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span>

<span class="w">      </span><span class="c1">// Check rate limit response</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">response</span><span class="p">.</span><span class="nx">type</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;rate_limit_exceeded&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">rateLimitHits</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="mf">1</span><span class="p">);</span>
<span class="w">        </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`[BURST] Spammer </span><span class="si">${</span><span class="nx">__VU</span><span class="si">}</span><span class="sb"> bá»‹ rate limit`</span><span class="p">);</span>
<span class="w">      </span><span class="p">}</span>

<span class="w">      </span><span class="c1">// TÃ­nh latency</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">response</span><span class="p">.</span><span class="nx">originalTimestamp</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">latency</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Date</span><span class="p">.</span><span class="nx">now</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nx">response</span><span class="p">.</span><span class="nx">originalTimestamp</span><span class="p">;</span>
<span class="w">        </span><span class="nx">burstLatency</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nx">latency</span><span class="p">);</span>

<span class="w">        </span><span class="nx">burstSuccess</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nx">latency</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mf">1000</span><span class="p">);</span><span class="w"> </span><span class="c1">// ThÃ nh cÃ´ng náº¿u &lt; 1s</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">});</span>

<span class="w">    </span><span class="nx">socket</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="nx">error</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="sb">`[BURST] Spammer </span><span class="si">${</span><span class="nx">__VU</span><span class="si">}</span><span class="sb"> error:`</span><span class="p">,</span><span class="w"> </span><span class="nx">error</span><span class="p">);</span>
<span class="w">      </span><span class="nx">burstSuccess</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="kc">false</span><span class="p">);</span>
<span class="w">    </span><span class="p">});</span>
<span class="w">  </span><span class="p">});</span>
<span class="p">}</span>

<span class="c1">// User bÃ¬nh thÆ°á»ng bá»‹ áº£nh hÆ°á»Ÿng</span>
<span class="k">export</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">normalUserBehavior</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">url</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;ws://localhost:3000&#39;</span><span class="p">;</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">ws</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">WebSocket</span><span class="p">.</span><span class="nx">connect</span><span class="p">(</span><span class="nx">url</span><span class="p">,</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="nx">socket</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">socket</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;open&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`[NORMAL] User </span><span class="si">${</span><span class="nx">__VU</span><span class="si">}</span><span class="sb"> connected`</span><span class="p">);</span>

<span class="w">      </span><span class="c1">// Authentication vÃ  join room</span>
<span class="w">      </span><span class="nx">socket</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="nb">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">({</span>
<span class="w">        </span><span class="nx">type</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;auth&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="nx">username</span><span class="o">:</span><span class="w"> </span><span class="sb">`normal_user_</span><span class="si">${</span><span class="nx">__VU</span><span class="si">}</span><span class="sb">`</span>
<span class="w">      </span><span class="p">}));</span>

<span class="w">      </span><span class="nx">socket</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="nb">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">({</span>
<span class="w">        </span><span class="nx">type</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;join&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="nx">room</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;general&#39;</span>
<span class="w">      </span><span class="p">}));</span>

<span class="w">      </span><span class="c1">// Gá»­i tin nháº¯n bÃ¬nh thÆ°á»ng</span>
<span class="w">      </span><span class="nx">setInterval</span><span class="p">(()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">message</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="nx">type</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;chat&#39;</span><span class="p">,</span>
<span class="w">          </span><span class="nx">text</span><span class="o">:</span><span class="w"> </span><span class="sb">`Tin nháº¯n bÃ¬nh thÆ°á»ng tá»« user </span><span class="si">${</span><span class="nx">__VU</span><span class="si">}</span><span class="sb">`</span><span class="p">,</span>
<span class="w">          </span><span class="nx">timestamp</span><span class="o">:</span><span class="w"> </span><span class="nb">Date</span><span class="p">.</span><span class="nx">now</span><span class="p">(),</span>
<span class="w">          </span><span class="nx">room</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;general&#39;</span>
<span class="w">        </span><span class="p">};</span>

<span class="w">        </span><span class="nx">socket</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="nb">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">message</span><span class="p">));</span>
<span class="w">      </span><span class="p">},</span><span class="w"> </span><span class="mf">5000</span><span class="p">);</span><span class="w"> </span><span class="c1">// Má»—i 5 giÃ¢y</span>
<span class="w">    </span><span class="p">});</span>

<span class="w">    </span><span class="nx">socket</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;message&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="nx">data</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">message</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span>

<span class="w">      </span><span class="c1">// Äo Ä‘á»™ trá»… cho user bÃ¬nh thÆ°á»ng</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">message</span><span class="p">.</span><span class="nx">timestamp</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">message</span><span class="p">.</span><span class="nx">type</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;chat&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">latency</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Date</span><span class="p">.</span><span class="nx">now</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nx">message</span><span class="p">.</span><span class="nx">timestamp</span><span class="p">;</span>

<span class="w">        </span><span class="c1">// Cáº£nh bÃ¡o náº¿u Ä‘á»™ trá»… cao</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">latency</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">2000</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="sb">`[NORMAL] User </span><span class="si">${</span><span class="nx">__VU</span><span class="si">}</span><span class="sb"> nháº­n tin cháº­m: </span><span class="si">${</span><span class="nx">latency</span><span class="si">}</span><span class="sb">ms`</span><span class="p">);</span>
<span class="w">          </span><span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="sb">`Ná»™i dung: </span><span class="si">${</span><span class="nx">message</span><span class="p">.</span><span class="nx">text</span><span class="p">.</span><span class="nx">substring</span><span class="p">(</span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="mf">50</span><span class="p">)</span><span class="si">}</span><span class="sb">...`</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">});</span>
<span class="w">  </span><span class="p">});</span>
<span class="p">}</span>

<span class="k">export</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">setup</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;ğŸš€ Báº¯t Ä‘áº§u Burst Message Test&#39;</span><span class="p">);</span>
<span class="w">  </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;50 spammer sáº½ gá»­i 100 msg/giÃ¢y&#39;</span><span class="p">);</span>
<span class="w">  </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;100 normal user sáº½ bá»‹ áº£nh hÆ°á»Ÿng&#39;</span><span class="p">);</span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">startTime</span><span class="o">:</span><span class="w"> </span><span class="nb">Date</span><span class="p">.</span><span class="nx">now</span><span class="p">(),</span>
<span class="w">    </span><span class="nx">expectedMessages</span><span class="o">:</span><span class="w"> </span><span class="mf">50</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">100</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">300</span><span class="w"> </span><span class="c1">// 50 spammer * 100 msg/s * 300s</span>
<span class="w">  </span><span class="p">};</span>
<span class="p">}</span>

<span class="k">export</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">teardown</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;âœ… Káº¿t thÃºc Burst Test&#39;</span><span class="p">);</span>
<span class="w">  </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`Tá»•ng sá»‘ tin nháº¯n dá»± kiáº¿n: </span><span class="si">${</span><span class="nx">data</span><span class="p">.</span><span class="nx">expectedMessages</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>

<span class="w">  </span><span class="c1">// PhÃ¢n tÃ­ch impact lÃªn normal users</span>
<span class="w">  </span><span class="nx">analyzeImpactOnNormalUsers</span><span class="p">();</span>
<span class="p">}</span>

<span class="kd">function</span><span class="w"> </span><span class="nx">analyzeImpactOnNormalUsers</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// PhÃ¢n tÃ­ch xem spam áº£nh hÆ°á»Ÿng tháº¿ nÃ o Ä‘áº¿n user bÃ¬nh thÆ°á»ng</span>
<span class="w">  </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;ğŸ“Š PhÃ¢n tÃ­ch impact cá»§a spam:&#39;</span><span class="p">);</span>
<span class="w">  </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;1. Äá»™ trá»… cá»§a normal users tÄƒng bao nhiÃªu?&#39;</span><span class="p">);</span>
<span class="w">  </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;2. CÃ³ tin nháº¯n nÃ o bá»‹ máº¥t khÃ´ng?&#39;</span><span class="p">);</span>
<span class="w">  </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;3. Rate limiting cÃ³ hoáº¡t Ä‘á»™ng khÃ´ng?&#39;</span><span class="p">);</span>
<span class="w">  </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;4. Message queue cÃ³ bá»‹ quÃ¡ táº£i?&#39;</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>
<h4 id="kich-ban-4-reconnection-stress-test-mang-chap-chon">Ká»‹ch Báº£n 4: Reconnection Stress Test - "Máº¡ng Cháº­p Chá»n"<a class="headerlink" href="#kich-ban-4-reconnection-stress-test-mang-chap-chon" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1">// test-reconnection-stress.js</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">WebSocket</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;k6/ws&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">check</span><span class="p">,</span><span class="w"> </span><span class="nx">sleep</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;k6&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">Trend</span><span class="p">,</span><span class="w"> </span><span class="nx">Rate</span><span class="p">,</span><span class="w"> </span><span class="nx">Counter</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;k6/metrics&#39;</span><span class="p">;</span>

<span class="kd">const</span><span class="w"> </span><span class="nx">reconnectTime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">Trend</span><span class="p">(</span><span class="s1">&#39;reconnect_time_ms&#39;</span><span class="p">);</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">reconnectSuccess</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">Rate</span><span class="p">(</span><span class="s1">&#39;reconnect_success_rate&#39;</span><span class="p">);</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">sessionLoss</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">Counter</span><span class="p">(</span><span class="s1">&#39;session_loss_count&#39;</span><span class="p">);</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">messageLoss</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">Counter</span><span class="p">(</span><span class="s1">&#39;message_loss_count&#39;</span><span class="p">);</span>

<span class="k">export</span><span class="w"> </span><span class="kd">const</span><span class="w"> </span><span class="nx">options</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">scenarios</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">reconnection_stress</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">executor</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;per-vu-iterations&#39;</span><span class="p">,</span>
<span class="w">      </span><span class="nx">vus</span><span class="o">:</span><span class="w"> </span><span class="mf">500</span><span class="p">,</span>
<span class="w">      </span><span class="nx">iterations</span><span class="o">:</span><span class="w"> </span><span class="mf">10</span><span class="p">,</span><span class="w">       </span><span class="c1">// Má»—i VU reconnect 10 láº§n</span>
<span class="w">      </span><span class="nx">maxDuration</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;10m&#39;</span><span class="p">,</span>

<span class="w">      </span><span class="c1">// Tags</span>
<span class="w">      </span><span class="nx">tags</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">test_type</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;reconnection&#39;</span><span class="w"> </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">},</span>
<span class="w">  </span><span class="nx">thresholds</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">reconnect_time_ms</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="s1">&#39;p(95) &lt; 5000&#39;</span><span class="p">],</span><span class="w"> </span><span class="c1">// Reconnect &lt; 5s</span>
<span class="w">    </span><span class="nx">reconnect_success_rate</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="s1">&#39;rate &gt; 0.98&#39;</span><span class="p">],</span><span class="w"> </span><span class="c1">// 98% thÃ nh cÃ´ng</span>
<span class="w">    </span><span class="nx">session_loss_count</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="s1">&#39;count &lt; 10&#39;</span><span class="p">]</span><span class="w">       </span><span class="c1">// Ãt hÆ¡n 10 session bá»‹ máº¥t</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">};</span>

<span class="k">export</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">url</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;ws://localhost:3000&#39;</span><span class="p">;</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">userId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sb">`user_</span><span class="si">${</span><span class="nx">__VU</span><span class="si">}</span><span class="sb">_</span><span class="si">${</span><span class="nx">__ITER</span><span class="si">}</span><span class="sb">`</span><span class="p">;</span>
<span class="w">  </span><span class="kd">let</span><span class="w"> </span><span class="nx">sessionId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span>
<span class="w">  </span><span class="kd">let</span><span class="w"> </span><span class="nx">messagesSent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[];</span>
<span class="w">  </span><span class="kd">let</span><span class="w"> </span><span class="nx">messagesReceived</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[];</span>

<span class="w">  </span><span class="kd">function</span><span class="w"> </span><span class="nx">connectWithReconnect</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">startTime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Date</span><span class="p">.</span><span class="nx">now</span><span class="p">();</span>

<span class="w">    </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`[RECONNECT] </span><span class="si">${</span><span class="nx">userId</span><span class="si">}</span><span class="sb"> Ä‘ang káº¿t ná»‘i...`</span><span class="p">);</span>

<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">ws</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">WebSocket</span><span class="p">.</span><span class="nx">connect</span><span class="p">(</span><span class="nx">url</span><span class="p">,</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="nx">socket</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="kd">let</span><span class="w"> </span><span class="nx">connected</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span>

<span class="w">      </span><span class="nx">socket</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;open&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">connected</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">connectTime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Date</span><span class="p">.</span><span class="nx">now</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nx">startTime</span><span class="p">;</span>
<span class="w">        </span><span class="nx">reconnectTime</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nx">connectTime</span><span class="p">);</span>

<span class="w">        </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`[RECONNECT] </span><span class="si">${</span><span class="nx">userId</span><span class="si">}</span><span class="sb"> connected in </span><span class="si">${</span><span class="nx">connectTime</span><span class="si">}</span><span class="sb">ms`</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// Authentication</span>
<span class="w">        </span><span class="nx">socket</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="nb">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">({</span>
<span class="w">          </span><span class="nx">type</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;auth&#39;</span><span class="p">,</span>
<span class="w">          </span><span class="nx">username</span><span class="o">:</span><span class="w"> </span><span class="nx">userId</span><span class="p">,</span>
<span class="w">          </span><span class="nx">sessionId</span><span class="o">:</span><span class="w"> </span><span class="nx">sessionId</span><span class="p">,</span><span class="w"> </span><span class="c1">// Gá»­i sessionId cÅ© náº¿u cÃ³</span>
<span class="w">          </span><span class="nx">timestamp</span><span class="o">:</span><span class="w"> </span><span class="nb">Date</span><span class="p">.</span><span class="nx">now</span><span class="p">()</span>
<span class="w">        </span><span class="p">}));</span>
<span class="w">      </span><span class="p">});</span>

<span class="w">      </span><span class="nx">socket</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;message&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="nx">data</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">message</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">message</span><span class="p">.</span><span class="nx">type</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;auth_response&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">message</span><span class="p">.</span><span class="nx">success</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">reconnectSuccess</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span>
<span class="w">            </span><span class="nx">sessionId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">message</span><span class="p">.</span><span class="nx">newSessionId</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nx">sessionId</span><span class="p">;</span>

<span class="w">            </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`[RECONNECT] </span><span class="si">${</span><span class="nx">userId</span><span class="si">}</span><span class="sb"> authenticated, session: </span><span class="si">${</span><span class="nx">sessionId</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>

<span class="w">            </span><span class="c1">// Kiá»ƒm tra message loss</span>
<span class="w">            </span><span class="nx">checkMessageLoss</span><span class="p">(</span><span class="nx">messagesSent</span><span class="p">,</span><span class="w"> </span><span class="nx">messagesReceived</span><span class="p">);</span>

<span class="w">            </span><span class="c1">// Gá»­i test message</span>
<span class="w">            </span><span class="kd">const</span><span class="w"> </span><span class="nx">testMsg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">              </span><span class="nx">type</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;test&#39;</span><span class="p">,</span>
<span class="w">              </span><span class="nx">content</span><span class="o">:</span><span class="w"> </span><span class="sb">`Test tá»« </span><span class="si">${</span><span class="nx">userId</span><span class="si">}</span><span class="sb"> sau reconnect`</span><span class="p">,</span>
<span class="w">              </span><span class="nx">messageId</span><span class="o">:</span><span class="w"> </span><span class="sb">`msg_</span><span class="si">${</span><span class="nb">Date</span><span class="p">.</span><span class="nx">now</span><span class="p">()</span><span class="si">}</span><span class="sb">_</span><span class="si">${</span><span class="nx">__VU</span><span class="si">}</span><span class="sb">`</span><span class="p">,</span>
<span class="w">              </span><span class="nx">timestamp</span><span class="o">:</span><span class="w"> </span><span class="nb">Date</span><span class="p">.</span><span class="nx">now</span><span class="p">()</span>
<span class="w">            </span><span class="p">};</span>

<span class="w">            </span><span class="nx">messagesSent</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">testMsg</span><span class="p">);</span>
<span class="w">            </span><span class="nx">socket</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="nb">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">testMsg</span><span class="p">));</span>

<span class="w">            </span><span class="c1">// ÄÃ³ng káº¿t ná»‘i ngay (Ä‘á»ƒ test reconnect láº§n sau)</span>
<span class="w">            </span><span class="nx">setTimeout</span><span class="p">(()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">              </span><span class="nx">socket</span><span class="p">.</span><span class="nx">close</span><span class="p">();</span>
<span class="w">            </span><span class="p">},</span><span class="w"> </span><span class="mf">1000</span><span class="p">);</span>

<span class="w">          </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">reconnectSuccess</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="kc">false</span><span class="p">);</span>
<span class="w">            </span><span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="sb">`[RECONNECT] </span><span class="si">${</span><span class="nx">userId</span><span class="si">}</span><span class="sb"> auth failed`</span><span class="p">);</span>
<span class="w">          </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="c1">// LÆ°u message nháº­n Ä‘Æ°á»£c</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">message</span><span class="p">.</span><span class="nx">type</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;test_response&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="nx">messagesReceived</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">message</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">      </span><span class="p">});</span>

<span class="w">      </span><span class="nx">socket</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="nx">error</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="sb">`[RECONNECT] </span><span class="si">${</span><span class="nx">userId</span><span class="si">}</span><span class="sb"> error:`</span><span class="p">,</span><span class="w"> </span><span class="nx">error</span><span class="p">.</span><span class="nx">message</span><span class="p">);</span>
<span class="w">        </span><span class="nx">reconnectSuccess</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="kc">false</span><span class="p">);</span>
<span class="w">      </span><span class="p">});</span>

<span class="w">      </span><span class="nx">socket</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;close&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`[RECONNECT] </span><span class="si">${</span><span class="nx">userId</span><span class="si">}</span><span class="sb"> disconnected`</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// Simulate network instability - random delay trÆ°á»›c khi reconnect</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">delay</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">random</span><span class="p">()</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">3000</span><span class="p">;</span><span class="w"> </span><span class="c1">// 0-3 giÃ¢y</span>
<span class="w">        </span><span class="nx">setTimeout</span><span class="p">(()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">__ITER</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mf">9</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="c1">// Chá»‰ reconnect 9 láº§n</span>
<span class="w">            </span><span class="nx">connectWithReconnect</span><span class="p">();</span>
<span class="w">          </span><span class="p">}</span>
<span class="w">        </span><span class="p">},</span><span class="w"> </span><span class="nx">delay</span><span class="p">);</span>
<span class="w">      </span><span class="p">});</span>

<span class="w">      </span><span class="c1">// Timeout</span>
<span class="w">      </span><span class="nx">socket</span><span class="p">.</span><span class="nx">setTimeout</span><span class="p">(()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">connected</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="sb">`[RECONNECT] </span><span class="si">${</span><span class="nx">userId</span><span class="si">}</span><span class="sb"> connection timeout`</span><span class="p">);</span>
<span class="w">          </span><span class="nx">socket</span><span class="p">.</span><span class="nx">close</span><span class="p">();</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">      </span><span class="p">},</span><span class="w"> </span><span class="mf">10000</span><span class="p">);</span>
<span class="w">    </span><span class="p">});</span>

<span class="w">    </span><span class="nx">check</span><span class="p">(</span><span class="nx">ws</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="s1">&#39;reconnection attempt initiated&#39;</span><span class="o">:</span><span class="w"> </span><span class="p">(</span><span class="nx">w</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">w</span><span class="w"> </span><span class="o">!==</span><span class="w"> </span><span class="kc">null</span>
<span class="w">    </span><span class="p">});</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="c1">// Báº¯t Ä‘áº§u láº§n káº¿t ná»‘i Ä‘áº§u tiÃªn</span>
<span class="w">  </span><span class="nx">connectWithReconnect</span><span class="p">();</span>

<span class="w">  </span><span class="c1">// Giá»¯ VU sá»‘ng Ä‘á»§ lÃ¢u</span>
<span class="w">  </span><span class="nx">sleep</span><span class="p">(</span><span class="mf">60</span><span class="p">);</span>
<span class="p">}</span>

<span class="kd">function</span><span class="w"> </span><span class="nx">checkMessageLoss</span><span class="p">(</span><span class="nx">sent</span><span class="p">,</span><span class="w"> </span><span class="nx">received</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">sentIds</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">sent</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">m</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">m</span><span class="p">.</span><span class="nx">messageId</span><span class="p">);</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">receivedIds</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">received</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">m</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">m</span><span class="p">.</span><span class="nx">originalMessageId</span><span class="p">);</span>

<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">lostMessages</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">sentIds</span><span class="p">.</span><span class="nx">filter</span><span class="p">(</span><span class="nx">id</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="o">!</span><span class="nx">receivedIds</span><span class="p">.</span><span class="nx">includes</span><span class="p">(</span><span class="nx">id</span><span class="p">));</span>

<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">lostMessages</span><span class="p">.</span><span class="nx">length</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="sb">`[RECONNECT] Máº¥t </span><span class="si">${</span><span class="nx">lostMessages</span><span class="p">.</span><span class="nx">length</span><span class="si">}</span><span class="sb"> tin nháº¯n:`</span><span class="p">,</span><span class="w"> </span><span class="nx">lostMessages</span><span class="p">);</span>
<span class="w">    </span><span class="nx">messageLoss</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nx">lostMessages</span><span class="p">.</span><span class="nx">length</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// PhÃ¢n tÃ­ch nguyÃªn nhÃ¢n</span>
<span class="w">    </span><span class="nx">analyzeMessageLoss</span><span class="p">(</span><span class="nx">sent</span><span class="p">,</span><span class="w"> </span><span class="nx">received</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>

<span class="kd">function</span><span class="w"> </span><span class="nx">analyzeMessageLoss</span><span class="p">(</span><span class="nx">sent</span><span class="p">,</span><span class="w"> </span><span class="nx">received</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;ğŸ” PhÃ¢n tÃ­ch message loss:&#39;</span><span class="p">);</span>
<span class="w">  </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`- Sent: </span><span class="si">${</span><span class="nx">sent</span><span class="p">.</span><span class="nx">length</span><span class="si">}</span><span class="sb"> messages`</span><span class="p">);</span>
<span class="w">  </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`- Received: </span><span class="si">${</span><span class="nx">received</span><span class="p">.</span><span class="nx">length</span><span class="si">}</span><span class="sb"> messages`</span><span class="p">);</span>

<span class="w">  </span><span class="c1">// Kiá»ƒm tra pattern</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">lastSent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">sent</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="o">-</span><span class="mf">5</span><span class="p">);</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">lastReceived</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">received</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="o">-</span><span class="mf">5</span><span class="p">);</span>

<span class="w">  </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;5 tin nháº¯n gá»­i cuá»‘i:&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">lastSent</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">m</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">m</span><span class="p">.</span><span class="nx">messageId</span><span class="p">));</span>
<span class="w">  </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;5 tin nháº¯n nháº­n cuá»‘i:&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">lastReceived</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">m</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">m</span><span class="p">.</span><span class="nx">originalMessageId</span><span class="p">));</span>

<span class="w">  </span><span class="c1">// Gá»£i Ã½ nguyÃªn nhÃ¢n</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">sent</span><span class="p">.</span><span class="nx">length</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">0</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">received</span><span class="p">.</span><span class="nx">length</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="mf">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;âš ï¸ CÃ³ thá»ƒ do:&#39;</span><span class="p">);</span>
<span class="w">    </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;1. Message queue bá»‹ xÃ³a khi reconnect&#39;</span><span class="p">);</span>
<span class="w">    </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;2. Session khÃ´ng Ä‘Æ°á»£c khÃ´i phá»¥c Ä‘Ãºng&#39;</span><span class="p">);</span>
<span class="w">    </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;3. Server khÃ´ng xá»­ lÃ½ offline messages&#39;</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>

<span class="k">export</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">setup</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;ğŸš€ Báº¯t Ä‘áº§u Reconnection Stress Test&#39;</span><span class="p">);</span>
<span class="w">  </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;500 VUs, má»—i VU reconnect 10 láº§n&#39;</span><span class="p">);</span>
<span class="w">  </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;Tá»•ng sá»‘ reconnect dá»± kiáº¿n: 5000&#39;</span><span class="p">);</span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">startTime</span><span class="o">:</span><span class="w"> </span><span class="nb">Date</span><span class="p">.</span><span class="nx">now</span><span class="p">(),</span>
<span class="w">    </span><span class="nx">totalVUs</span><span class="o">:</span><span class="w"> </span><span class="mf">500</span><span class="p">,</span>
<span class="w">    </span><span class="nx">reconnectsPerVU</span><span class="o">:</span><span class="w"> </span><span class="mf">10</span>
<span class="w">  </span><span class="p">};</span>
<span class="p">}</span>

<span class="k">export</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">teardown</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">duration</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Date</span><span class="p">.</span><span class="nx">now</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nx">data</span><span class="p">.</span><span class="nx">startTime</span><span class="p">;</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">expectedReconnects</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">data</span><span class="p">.</span><span class="nx">totalVUs</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">data</span><span class="p">.</span><span class="nx">reconnectsPerVU</span><span class="p">;</span>

<span class="w">  </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;âœ… Káº¿t thÃºc Reconnection Test&#39;</span><span class="p">);</span>
<span class="w">  </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`Thá»i gian cháº¡y: </span><span class="si">${</span><span class="p">(</span><span class="nx">duration</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mf">1000</span><span class="p">).</span><span class="nx">toFixed</span><span class="p">(</span><span class="mf">2</span><span class="p">)</span><span class="si">}</span><span class="sb">s`</span><span class="p">);</span>
<span class="w">  </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`Sá»‘ reconnect dá»± kiáº¿n: </span><span class="si">${</span><span class="nx">expectedReconnects</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>

<span class="w">  </span><span class="c1">// Äá» xuáº¥t cáº£i thiá»‡n</span>
<span class="w">  </span><span class="nx">suggestReconnectionImprovements</span><span class="p">();</span>
<span class="p">}</span>

<span class="kd">function</span><span class="w"> </span><span class="nx">suggestReconnectionImprovements</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;ğŸ’¡ Äá» xuáº¥t cáº£i thiá»‡n reconnect:&#39;</span><span class="p">);</span>
<span class="w">  </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;1. Implement exponential backoff cho reconnect&#39;</span><span class="p">);</span>
<span class="w">  </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;2. LÆ°u tin nháº¯n offline khi disconnect&#39;</span><span class="p">);</span>
<span class="w">  </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;3. DÃ¹ng session tokens thay vÃ¬ connection-based auth&#39;</span><span class="p">);</span>
<span class="w">  </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;4. Optimize handshake process&#39;</span><span class="p">);</span>
<span class="w">  </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;5. ThÃªm health checks thÆ°á»ng xuyÃªn&#39;</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>
<h4 id="kich-ban-5-mixed-real-world-scenario-mo-phong-thuc-te">Ká»‹ch Báº£n 5: Mixed Real-World Scenario - "MÃ´ Phá»ng Thá»±c Táº¿"<a class="headerlink" href="#kich-ban-5-mixed-real-world-scenario-mo-phong-thuc-te" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1">// test-mixed-realworld.js</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">WebSocket</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;k6/ws&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">check</span><span class="p">,</span><span class="w"> </span><span class="nx">sleep</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;k6&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">Trend</span><span class="p">,</span><span class="w"> </span><span class="nx">Rate</span><span class="p">,</span><span class="w"> </span><span class="nx">Counter</span><span class="p">,</span><span class="w"> </span><span class="nx">Gauge</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;k6/metrics&#39;</span><span class="p">;</span>

<span class="c1">// Táº¥t cáº£ metrics</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">metrics</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">latency</span><span class="o">:</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">Trend</span><span class="p">(</span><span class="s1">&#39;message_latency_ms&#39;</span><span class="p">),</span>
<span class="w">  </span><span class="nx">success</span><span class="o">:</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">Rate</span><span class="p">(</span><span class="s1">&#39;success_rate&#39;</span><span class="p">),</span>
<span class="w">  </span><span class="nx">errors</span><span class="o">:</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">Counter</span><span class="p">(</span><span class="s1">&#39;total_errors&#39;</span><span class="p">),</span>
<span class="w">  </span><span class="nx">connections</span><span class="o">:</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">Gauge</span><span class="p">(</span><span class="s1">&#39;active_connections&#39;</span><span class="p">),</span>
<span class="w">  </span><span class="nx">cpu</span><span class="o">:</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">Gauge</span><span class="p">(</span><span class="s1">&#39;server_cpu_percent&#39;</span><span class="p">),</span>
<span class="w">  </span><span class="nx">memory</span><span class="o">:</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">Gauge</span><span class="p">(</span><span class="s1">&#39;server_memory_mb&#39;</span><span class="p">),</span>
<span class="w">  </span><span class="nx">throughput</span><span class="o">:</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">Trend</span><span class="p">(</span><span class="s1">&#39;messages_per_second&#39;</span><span class="p">),</span>
<span class="w">  </span><span class="nx">userSatisfaction</span><span class="o">:</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">Rate</span><span class="p">(</span><span class="s1">&#39;user_satisfaction&#39;</span><span class="p">)</span>
<span class="p">};</span>

<span class="c1">// User profiles</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">USER_PROFILES</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">ACTIVE_CHATTER</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">weight</span><span class="o">:</span><span class="w"> </span><span class="mf">0.3</span><span class="p">,</span><span class="w"> </span><span class="c1">// 30% users</span>
<span class="w">    </span><span class="nx">behavior</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;active&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="nx">messageInterval</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="mf">1000</span><span class="p">,</span><span class="w"> </span><span class="mf">5000</span><span class="p">],</span><span class="w"> </span><span class="c1">// 1-5 giÃ¢y</span>
<span class="w">    </span><span class="nx">onlineDuration</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="mf">300000</span><span class="p">,</span><span class="w"> </span><span class="mf">1800000</span><span class="p">]</span><span class="w"> </span><span class="c1">// 5-30 phÃºt</span>
<span class="w">  </span><span class="p">},</span>
<span class="w">  </span><span class="nx">OBSERVER</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">weight</span><span class="o">:</span><span class="w"> </span><span class="mf">0.5</span><span class="p">,</span><span class="w"> </span><span class="c1">// 50% users</span>
<span class="w">    </span><span class="nx">behavior</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;observer&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="nx">messageInterval</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="mf">30000</span><span class="p">,</span><span class="w"> </span><span class="mf">120000</span><span class="p">],</span><span class="w"> </span><span class="c1">// 30-120 giÃ¢y</span>
<span class="w">    </span><span class="nx">onlineDuration</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="mf">600000</span><span class="p">,</span><span class="w"> </span><span class="mf">3600000</span><span class="p">]</span><span class="w"> </span><span class="c1">// 10-60 phÃºt</span>
<span class="w">  </span><span class="p">},</span>
<span class="w">  </span><span class="nx">SPAMMER</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">weight</span><span class="o">:</span><span class="w"> </span><span class="mf">0.1</span><span class="p">,</span><span class="w"> </span><span class="c1">// 10% users</span>
<span class="w">    </span><span class="nx">behavior</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;spammer&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="nx">messageInterval</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="mf">100</span><span class="p">,</span><span class="w"> </span><span class="mf">1000</span><span class="p">],</span><span class="w"> </span><span class="c1">// 0.1-1 giÃ¢y</span>
<span class="w">    </span><span class="nx">onlineDuration</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="mf">120000</span><span class="p">,</span><span class="w"> </span><span class="mf">600000</span><span class="p">]</span><span class="w"> </span><span class="c1">// 2-10 phÃºt</span>
<span class="w">  </span><span class="p">},</span>
<span class="w">  </span><span class="nx">UNSTABLE_NETWORK</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">weight</span><span class="o">:</span><span class="w"> </span><span class="mf">0.1</span><span class="p">,</span><span class="w"> </span><span class="c1">// 10% users</span>
<span class="w">    </span><span class="nx">behavior</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;unstable&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="nx">messageInterval</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="mf">2000</span><span class="p">,</span><span class="w"> </span><span class="mf">10000</span><span class="p">],</span>
<span class="w">    </span><span class="nx">onlineDuration</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="mf">180000</span><span class="p">,</span><span class="w"> </span><span class="mf">900000</span><span class="p">],</span><span class="w"> </span><span class="c1">// 3-15 phÃºt</span>
<span class="w">    </span><span class="nx">disconnectProbability</span><span class="o">:</span><span class="w"> </span><span class="mf">0.1</span><span class="w"> </span><span class="c1">// 10% chance disconnect</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">};</span>

<span class="k">export</span><span class="w"> </span><span class="kd">const</span><span class="w"> </span><span class="nx">options</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">scenarios</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// Scenario 1: Ramp up buá»•i sÃ¡ng</span>
<span class="w">    </span><span class="nx">morning_ramp_up</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">executor</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;ramping-vus&#39;</span><span class="p">,</span>
<span class="w">      </span><span class="nx">startVUs</span><span class="o">:</span><span class="w"> </span><span class="mf">10</span><span class="p">,</span>
<span class="w">      </span><span class="nx">stages</span><span class="o">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">        </span><span class="p">{</span><span class="w"> </span><span class="nx">duration</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;5m&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">target</span><span class="o">:</span><span class="w"> </span><span class="mf">1000</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="c1">// 6:00-6:05</span>
<span class="w">        </span><span class="p">{</span><span class="w"> </span><span class="nx">duration</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;15m&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">target</span><span class="o">:</span><span class="w"> </span><span class="mf">5000</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="c1">// 6:05-6:20</span>
<span class="w">        </span><span class="p">{</span><span class="w"> </span><span class="nx">duration</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;10m&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">target</span><span class="o">:</span><span class="w"> </span><span class="mf">8000</span><span class="w"> </span><span class="p">}</span><span class="w">  </span><span class="c1">// 6:20-6:30</span>
<span class="w">      </span><span class="p">],</span>
<span class="w">      </span><span class="nx">startTime</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;0s&#39;</span><span class="p">,</span>
<span class="w">      </span><span class="nx">gracefulRampDown</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;2m&#39;</span><span class="p">,</span>
<span class="w">      </span><span class="nx">exec</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;userBehavior&#39;</span><span class="p">,</span>
<span class="w">      </span><span class="nx">tags</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">period</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;morning&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">time</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;6:00-6:30&#39;</span><span class="w"> </span><span class="p">}</span>
<span class="w">    </span><span class="p">},</span>

<span class="w">    </span><span class="c1">// Scenario 2: Giá» cao Ä‘iá»ƒm</span>
<span class="w">    </span><span class="nx">peak_hours</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">executor</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;constant-vus&#39;</span><span class="p">,</span>
<span class="w">      </span><span class="nx">vus</span><span class="o">:</span><span class="w"> </span><span class="mf">10000</span><span class="p">,</span>
<span class="w">      </span><span class="nx">duration</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;2h&#39;</span><span class="p">,</span>
<span class="w">      </span><span class="nx">startTime</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;30m&#39;</span><span class="p">,</span>
<span class="w">      </span><span class="nx">exec</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;userBehavior&#39;</span><span class="p">,</span>
<span class="w">      </span><span class="nx">tags</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">period</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;peak&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">time</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;6:30-8:30&#39;</span><span class="w"> </span><span class="p">}</span>
<span class="w">    </span><span class="p">},</span>

<span class="w">    </span><span class="c1">// Scenario 3: Sá»± kiá»‡n Ä‘áº·c biá»‡t (live stream)</span>
<span class="w">    </span><span class="nx">special_event</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">executor</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;ramping-arrival-rate&#39;</span><span class="p">,</span>
<span class="w">      </span><span class="nx">startRate</span><span class="o">:</span><span class="w"> </span><span class="mf">100</span><span class="p">,</span>
<span class="w">      </span><span class="nx">timeUnit</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;1s&#39;</span><span class="p">,</span>
<span class="w">      </span><span class="nx">stages</span><span class="o">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">        </span><span class="p">{</span><span class="w"> </span><span class="nx">target</span><span class="o">:</span><span class="w"> </span><span class="mf">1000</span><span class="p">,</span><span class="w"> </span><span class="nx">duration</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;30s&#39;</span><span class="w"> </span><span class="p">},</span><span class="w">  </span><span class="c1">// Spike nhanh</span>
<span class="w">        </span><span class="p">{</span><span class="w"> </span><span class="nx">target</span><span class="o">:</span><span class="w"> </span><span class="mf">5000</span><span class="p">,</span><span class="w"> </span><span class="nx">duration</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;1m&#39;</span><span class="w"> </span><span class="p">},</span>
<span class="w">        </span><span class="p">{</span><span class="w"> </span><span class="nx">target</span><span class="o">:</span><span class="w"> </span><span class="mf">20000</span><span class="p">,</span><span class="w"> </span><span class="nx">duration</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;2m&#39;</span><span class="w"> </span><span class="p">},</span><span class="w">  </span><span class="c1">// Peak event</span>
<span class="w">        </span><span class="p">{</span><span class="w"> </span><span class="nx">target</span><span class="o">:</span><span class="w"> </span><span class="mf">1000</span><span class="p">,</span><span class="w"> </span><span class="nx">duration</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;1m&#39;</span><span class="w"> </span><span class="p">}</span><span class="w">    </span><span class="c1">// Giáº£m dáº§n</span>
<span class="w">      </span><span class="p">],</span>
<span class="w">      </span><span class="nx">preAllocatedVUs</span><span class="o">:</span><span class="w"> </span><span class="mf">5000</span><span class="p">,</span>
<span class="w">      </span><span class="nx">maxVUs</span><span class="o">:</span><span class="w"> </span><span class="mf">25000</span><span class="p">,</span>
<span class="w">      </span><span class="nx">startTime</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;3h&#39;</span><span class="p">,</span>
<span class="w">      </span><span class="nx">exec</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;eventParticipant&#39;</span><span class="p">,</span>
<span class="w">      </span><span class="nx">tags</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">period</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;event&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">type</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;live_stream&#39;</span><span class="w"> </span><span class="p">}</span>
<span class="w">    </span><span class="p">},</span>

<span class="w">    </span><span class="c1">// Scenario 4: Buá»•i tá»‘i</span>
<span class="w">    </span><span class="nx">evening_slow</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">executor</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;ramping-vus&#39;</span><span class="p">,</span>
<span class="w">      </span><span class="nx">startVUs</span><span class="o">:</span><span class="w"> </span><span class="mf">5000</span><span class="p">,</span>
<span class="w">      </span><span class="nx">stages</span><span class="o">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">        </span><span class="p">{</span><span class="w"> </span><span class="nx">duration</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;1h&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">target</span><span class="o">:</span><span class="w"> </span><span class="mf">2000</span><span class="w"> </span><span class="p">},</span>
<span class="w">        </span><span class="p">{</span><span class="w"> </span><span class="nx">duration</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;2h&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">target</span><span class="o">:</span><span class="w"> </span><span class="mf">500</span><span class="w"> </span><span class="p">}</span>
<span class="w">      </span><span class="p">],</span>
<span class="w">      </span><span class="nx">startTime</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;5h&#39;</span><span class="p">,</span>
<span class="w">      </span><span class="nx">exec</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;userBehavior&#39;</span><span class="p">,</span>
<span class="w">      </span><span class="nx">tags</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">period</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;evening&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">time</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;20:00-23:00&#39;</span><span class="w"> </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">},</span>

<span class="w">  </span><span class="c1">// Thresholds tá»•ng há»£p</span>
<span class="w">  </span><span class="nx">thresholds</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="s1">&#39;message_latency_ms{period:morning}&#39;</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="s1">&#39;p(95) &lt; 100&#39;</span><span class="p">],</span>
<span class="w">    </span><span class="s1">&#39;message_latency_ms{period:peak}&#39;</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="s1">&#39;p(95) &lt; 150&#39;</span><span class="p">],</span>
<span class="w">    </span><span class="s1">&#39;message_latency_ms{period:event}&#39;</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="s1">&#39;p(95) &lt; 200&#39;</span><span class="p">],</span>
<span class="w">    </span><span class="s1">&#39;success_rate&#39;</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="s1">&#39;rate &gt; 0.99&#39;</span><span class="p">],</span>
<span class="w">    </span><span class="s1">&#39;active_connections&#39;</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="s1">&#39;value &lt; 25000&#39;</span><span class="p">]</span>
<span class="w">  </span><span class="p">},</span>

<span class="w">  </span><span class="c1">// Tags toÃ n cá»¥c</span>
<span class="w">  </span><span class="nx">tags</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">project</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;chat_application&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="nx">environment</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;staging&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="nx">test_type</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;mixed_realworld&#39;</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">};</span>

<span class="c1">// HÃ nh vi user bÃ¬nh thÆ°á»ng</span>
<span class="k">export</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">userBehavior</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">profile</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">selectUserProfile</span><span class="p">();</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">userId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sb">`user_</span><span class="si">${</span><span class="nx">__VU</span><span class="si">}</span><span class="sb">_</span><span class="si">${</span><span class="nx">__ITER</span><span class="si">}</span><span class="sb">`</span><span class="p">;</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">duration</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">randomBetween</span><span class="p">(...</span><span class="nx">profile</span><span class="p">.</span><span class="nx">onlineDuration</span><span class="p">);</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">endTime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Date</span><span class="p">.</span><span class="nx">now</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">duration</span><span class="p">;</span>

<span class="w">  </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`[</span><span class="si">${</span><span class="nx">profile</span><span class="p">.</span><span class="nx">behavior</span><span class="p">.</span><span class="nx">toUpperCase</span><span class="p">()</span><span class="si">}</span><span class="sb">] </span><span class="si">${</span><span class="nx">userId</span><span class="si">}</span><span class="sb"> online for </span><span class="si">${</span><span class="nx">duration</span><span class="o">/</span><span class="mf">1000</span><span class="si">}</span><span class="sb">s`</span><span class="p">);</span>

<span class="w">  </span><span class="nx">connectAndChat</span><span class="p">(</span><span class="nx">userId</span><span class="p">,</span><span class="w"> </span><span class="nx">profile</span><span class="p">,</span><span class="w"> </span><span class="nx">endTime</span><span class="p">);</span>
<span class="p">}</span>

<span class="c1">// HÃ nh vi tham gia event</span>
<span class="k">export</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">eventParticipant</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">userId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sb">`event_user_</span><span class="si">${</span><span class="nx">__VU</span><span class="si">}</span><span class="sb">`</span><span class="p">;</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">profile</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">behavior</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;event_participant&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="nx">messageInterval</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="mf">500</span><span class="p">,</span><span class="w"> </span><span class="mf">2000</span><span class="p">],</span><span class="w"> </span><span class="c1">// Ráº¥t active</span>
<span class="w">    </span><span class="nx">reactions</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="s1">&#39;like&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;heart&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;laugh&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;wow&#39;</span><span class="p">]</span>
<span class="w">  </span><span class="p">};</span>

<span class="w">  </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`[EVENT] </span><span class="si">${</span><span class="nx">userId</span><span class="si">}</span><span class="sb"> joining live stream`</span><span class="p">);</span>

<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">ws</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">connectWebSocket</span><span class="p">(</span><span class="nx">userId</span><span class="p">);</span>
<span class="w">  </span><span class="kd">let</span><span class="w"> </span><span class="nx">messageCount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">endTime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Date</span><span class="p">.</span><span class="nx">now</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">300000</span><span class="p">;</span><span class="w"> </span><span class="c1">// 5 phÃºt</span>

<span class="w">  </span><span class="c1">// Join event room</span>
<span class="w">  </span><span class="nx">ws</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="nb">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">({</span>
<span class="w">    </span><span class="nx">type</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;join_event&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="nx">eventId</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;live_stream_123&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="nx">userId</span><span class="o">:</span><span class="w"> </span><span class="nx">userId</span>
<span class="w">  </span><span class="p">}));</span>

<span class="w">  </span><span class="c1">// Gá»­i message vÃ  reactions</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">interval</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">setInterval</span><span class="p">(()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">Date</span><span class="p">.</span><span class="nx">now</span><span class="p">()</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="nx">endTime</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">clearInterval</span><span class="p">(</span><span class="nx">interval</span><span class="p">);</span>
<span class="w">      </span><span class="nx">ws</span><span class="p">.</span><span class="nx">close</span><span class="p">();</span>
<span class="w">      </span><span class="k">return</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// 70% tin nháº¯n, 30% reaction</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nx">random</span><span class="p">()</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">0.3</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">message</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">type</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;event_chat&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="nx">text</span><span class="o">:</span><span class="w"> </span><span class="nx">generateEventMessage</span><span class="p">(),</span>
<span class="w">        </span><span class="nx">eventId</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;live_stream_123&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="nx">timestamp</span><span class="o">:</span><span class="w"> </span><span class="nb">Date</span><span class="p">.</span><span class="nx">now</span><span class="p">()</span>
<span class="w">      </span><span class="p">};</span>
<span class="w">      </span><span class="nx">ws</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="nb">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">message</span><span class="p">));</span>
<span class="w">      </span><span class="nx">messageCount</span><span class="o">++</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">reaction</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">type</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;reaction&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="nx">reaction</span><span class="o">:</span><span class="w"> </span><span class="nx">profile</span><span class="p">.</span><span class="nx">reactions</span><span class="p">[</span><span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span><span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nx">random</span><span class="p">()</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">profile</span><span class="p">.</span><span class="nx">reactions</span><span class="p">.</span><span class="nx">length</span><span class="p">)],</span>
<span class="w">        </span><span class="nx">targetMessageId</span><span class="o">:</span><span class="w"> </span><span class="sb">`msg_</span><span class="si">${</span><span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span><span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nx">random</span><span class="p">()</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">1000</span><span class="p">)</span><span class="si">}</span><span class="sb">`</span><span class="p">,</span>
<span class="w">        </span><span class="nx">timestamp</span><span class="o">:</span><span class="w"> </span><span class="nb">Date</span><span class="p">.</span><span class="nx">now</span><span class="p">()</span>
<span class="w">      </span><span class="p">};</span>
<span class="w">      </span><span class="nx">ws</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="nb">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">reaction</span><span class="p">));</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// Log progress</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">messageCount</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="mf">50</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="mf">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`[EVENT] </span><span class="si">${</span><span class="nx">userId</span><span class="si">}</span><span class="sb"> Ä‘Ã£ gá»­i </span><span class="si">${</span><span class="nx">messageCount</span><span class="si">}</span><span class="sb"> tin`</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">},</span><span class="w"> </span><span class="nx">randomBetween</span><span class="p">(...</span><span class="nx">profile</span><span class="p">.</span><span class="nx">messageInterval</span><span class="p">));</span>
<span class="p">}</span>

<span class="c1">// Helper functions</span>
<span class="kd">function</span><span class="w"> </span><span class="nx">selectUserProfile</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">rand</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">random</span><span class="p">();</span>
<span class="w">  </span><span class="kd">let</span><span class="w"> </span><span class="nx">cumulative</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span>

<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">const</span><span class="w"> </span><span class="p">[</span><span class="nx">name</span><span class="p">,</span><span class="w"> </span><span class="nx">profile</span><span class="p">]</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="nb">Object</span><span class="p">.</span><span class="nx">entries</span><span class="p">(</span><span class="nx">USER_PROFILES</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">cumulative</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="nx">profile</span><span class="p">.</span><span class="nx">weight</span><span class="p">;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">rand</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="nx">cumulative</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="p">...</span><span class="nx">profile</span><span class="p">,</span><span class="w"> </span><span class="nx">name</span><span class="w"> </span><span class="p">};</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">USER_PROFILES</span><span class="p">.</span><span class="nx">OBSERVER</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">function</span><span class="w"> </span><span class="nx">connectAndChat</span><span class="p">(</span><span class="nx">userId</span><span class="p">,</span><span class="w"> </span><span class="nx">profile</span><span class="p">,</span><span class="w"> </span><span class="nx">endTime</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">ws</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">connectWebSocket</span><span class="p">(</span><span class="nx">userId</span><span class="p">);</span>
<span class="w">  </span><span class="kd">let</span><span class="w"> </span><span class="nx">isConnected</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span>

<span class="w">  </span><span class="c1">// Authentication</span>
<span class="w">  </span><span class="nx">ws</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="nb">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">({</span>
<span class="w">    </span><span class="nx">type</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;auth&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="nx">username</span><span class="o">:</span><span class="w"> </span><span class="nx">userId</span><span class="p">,</span>
<span class="w">    </span><span class="nx">profile</span><span class="o">:</span><span class="w"> </span><span class="nx">profile</span><span class="p">.</span><span class="nx">name</span>
<span class="w">  </span><span class="p">}));</span>

<span class="w">  </span><span class="c1">// Join random room</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">rooms</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="s1">&#39;general&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;random&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;support&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;tech&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;music&#39;</span><span class="p">];</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">room</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">rooms</span><span class="p">[</span><span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span><span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nx">random</span><span class="p">()</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">rooms</span><span class="p">.</span><span class="nx">length</span><span class="p">)];</span>
<span class="w">  </span><span class="nx">ws</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="nb">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">({</span>
<span class="w">    </span><span class="nx">type</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;join&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="nx">room</span><span class="o">:</span><span class="w"> </span><span class="nx">room</span>
<span class="w">  </span><span class="p">}));</span>

<span class="w">  </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`[</span><span class="si">${</span><span class="nx">profile</span><span class="p">.</span><span class="nx">name</span><span class="si">}</span><span class="sb">] </span><span class="si">${</span><span class="nx">userId</span><span class="si">}</span><span class="sb"> joined </span><span class="si">${</span><span class="nx">room</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>

<span class="w">  </span><span class="c1">// Chat loop</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">chatInterval</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">setInterval</span><span class="p">(()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">isConnected</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nb">Date</span><span class="p">.</span><span class="nx">now</span><span class="p">()</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="nx">endTime</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">clearInterval</span><span class="p">(</span><span class="nx">chatInterval</span><span class="p">);</span>
<span class="w">      </span><span class="nx">ws</span><span class="p">.</span><span class="nx">close</span><span class="p">();</span>
<span class="w">      </span><span class="k">return</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// Simulate network issues for unstable users</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">profile</span><span class="p">.</span><span class="nx">name</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;UNSTABLE_NETWORK&#39;</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">random</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="nx">profile</span><span class="p">.</span><span class="nx">disconnectProbability</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`[UNSTABLE] </span><span class="si">${</span><span class="nx">userId</span><span class="si">}</span><span class="sb"> simulating network drop`</span><span class="p">);</span>
<span class="w">      </span><span class="nx">ws</span><span class="p">.</span><span class="nx">close</span><span class="p">();</span>
<span class="w">      </span><span class="nx">isConnected</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span>

<span class="w">      </span><span class="c1">// Reconnect after delay</span>
<span class="w">      </span><span class="nx">setTimeout</span><span class="p">(()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`[UNSTABLE] </span><span class="si">${</span><span class="nx">userId</span><span class="si">}</span><span class="sb"> reconnecting...`</span><span class="p">);</span>
<span class="w">        </span><span class="nx">connectAndChat</span><span class="p">(</span><span class="nx">userId</span><span class="p">,</span><span class="w"> </span><span class="nx">profile</span><span class="p">,</span><span class="w"> </span><span class="nx">endTime</span><span class="p">);</span>
<span class="w">      </span><span class="p">},</span><span class="w"> </span><span class="nx">randomBetween</span><span class="p">(</span><span class="mf">2000</span><span class="p">,</span><span class="w"> </span><span class="mf">10000</span><span class="p">));</span>

<span class="w">      </span><span class="k">return</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// Send message based on profile</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">message</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">type</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;chat&#39;</span><span class="p">,</span>
<span class="w">      </span><span class="nx">text</span><span class="o">:</span><span class="w"> </span><span class="nx">generateMessage</span><span class="p">(</span><span class="nx">profile</span><span class="p">.</span><span class="nx">behavior</span><span class="p">),</span>
<span class="w">      </span><span class="nx">room</span><span class="o">:</span><span class="w"> </span><span class="nx">room</span><span class="p">,</span>
<span class="w">      </span><span class="nx">timestamp</span><span class="o">:</span><span class="w"> </span><span class="nb">Date</span><span class="p">.</span><span class="nx">now</span><span class="p">(),</span>
<span class="w">      </span><span class="nx">userId</span><span class="o">:</span><span class="w"> </span><span class="nx">userId</span>
<span class="w">    </span><span class="p">};</span>

<span class="w">    </span><span class="nx">ws</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="nb">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">message</span><span class="p">));</span>
<span class="w">    </span><span class="nx">metrics</span><span class="p">.</span><span class="nx">throughput</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="mf">1</span><span class="p">);</span>

<span class="w">  </span><span class="p">},</span><span class="w"> </span><span class="nx">randomBetween</span><span class="p">(...</span><span class="nx">profile</span><span class="p">.</span><span class="nx">messageInterval</span><span class="p">));</span>

<span class="w">  </span><span class="c1">// Handle messages</span>
<span class="w">  </span><span class="nx">ws</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;message&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="nx">data</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">message</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// Calculate latency</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">message</span><span class="p">.</span><span class="nx">originalTimestamp</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">latency</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Date</span><span class="p">.</span><span class="nx">now</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nx">message</span><span class="p">.</span><span class="nx">originalTimestamp</span><span class="p">;</span>
<span class="w">      </span><span class="nx">metrics</span><span class="p">.</span><span class="nx">latency</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nx">latency</span><span class="p">);</span>

<span class="w">      </span><span class="c1">// User satisfaction (latency &lt; 200ms = satisfied)</span>
<span class="w">      </span><span class="nx">metrics</span><span class="p">.</span><span class="nx">userSatisfaction</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nx">latency</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mf">200</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// Check for errors</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">message</span><span class="p">.</span><span class="nx">type</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;error&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">metrics</span><span class="p">.</span><span class="nx">errors</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="mf">1</span><span class="p">);</span>
<span class="w">      </span><span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="sb">`[</span><span class="si">${</span><span class="nx">profile</span><span class="p">.</span><span class="nx">name</span><span class="si">}</span><span class="sb">] </span><span class="si">${</span><span class="nx">userId</span><span class="si">}</span><span class="sb"> error:`</span><span class="p">,</span><span class="w"> </span><span class="nx">message</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">});</span>

<span class="w">  </span><span class="nx">ws</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="nx">error</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="sb">`[</span><span class="si">${</span><span class="nx">profile</span><span class="p">.</span><span class="nx">name</span><span class="si">}</span><span class="sb">] </span><span class="si">${</span><span class="nx">userId</span><span class="si">}</span><span class="sb"> connection error:`</span><span class="p">,</span><span class="w"> </span><span class="nx">error</span><span class="p">);</span>
<span class="w">    </span><span class="nx">metrics</span><span class="p">.</span><span class="nx">errors</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="mf">1</span><span class="p">);</span>
<span class="w">    </span><span class="nx">isConnected</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span>
<span class="w">  </span><span class="p">});</span>

<span class="w">  </span><span class="nx">ws</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;close&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`[</span><span class="si">${</span><span class="nx">profile</span><span class="p">.</span><span class="nx">name</span><span class="si">}</span><span class="sb">] </span><span class="si">${</span><span class="nx">userId</span><span class="si">}</span><span class="sb"> disconnected`</span><span class="p">);</span>
<span class="w">    </span><span class="nx">isConnected</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span>
<span class="w">  </span><span class="p">});</span>
<span class="p">}</span>

<span class="kd">function</span><span class="w"> </span><span class="nx">connectWebSocket</span><span class="p">(</span><span class="nx">userId</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">url</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;ws://localhost:3000&#39;</span><span class="p">;</span>

<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">ws</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">WebSocket</span><span class="p">.</span><span class="nx">connect</span><span class="p">(</span><span class="nx">url</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">headers</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="s1">&#39;X-User-ID&#39;</span><span class="o">:</span><span class="w"> </span><span class="nx">userId</span><span class="p">,</span>
<span class="w">      </span><span class="s1">&#39;X-Client-Version&#39;</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;1.0.0&#39;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">},</span><span class="w"> </span><span class="p">(</span><span class="nx">socket</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">metrics</span><span class="p">.</span><span class="nx">connections</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="mf">1</span><span class="p">);</span>

<span class="w">    </span><span class="nx">socket</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;open&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">metrics</span><span class="p">.</span><span class="nx">success</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span>
<span class="w">    </span><span class="p">});</span>
<span class="w">  </span><span class="p">});</span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">ws</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">function</span><span class="w"> </span><span class="nx">generateMessage</span><span class="p">(</span><span class="nx">behavior</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">messages</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">active</span><span class="o">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">      </span><span class="s2">&quot;Hello má»i ngÆ°á»i!&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="s2">&quot;Ai online khÃ´ng?&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="s2">&quot;HÃ´m nay tháº¿ nÃ o?&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="s2">&quot;CÃ³ tin gÃ¬ má»›i khÃ´ng?&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="s2">&quot;TÃ´i Ä‘á»“ng Ã½ vá»›i báº¡n!&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="s2">&quot;Báº¡n nghÄ© sao vá» Ä‘iá»u nÃ y?&quot;</span>
<span class="w">    </span><span class="p">],</span>
<span class="w">    </span><span class="nx">observer</span><span class="o">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">      </span><span class="s2">&quot;...&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="s2">&quot;ok&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="s2">&quot;hi&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="s2">&quot;ğŸ‘&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="s2">&quot;ğŸ‘Œ&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="s2">&quot;ğŸ˜‚&quot;</span>
<span class="w">    </span><span class="p">],</span>
<span class="w">    </span><span class="nx">spammer</span><span class="o">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">      </span><span class="s2">&quot;BUY NOW! LIMITED OFFER!&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="s2">&quot;CLICK HERE: http://spam.com&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="s2">&quot;EARN $1000 DAILY!!!&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="s2">&quot;FREE BITCOINS!&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="s2">&quot;URGENT MESSAGE!&quot;</span>
<span class="w">    </span><span class="p">]</span>
<span class="w">  </span><span class="p">};</span>

<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">list</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">messages</span><span class="p">[</span><span class="nx">behavior</span><span class="p">]</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nx">messages</span><span class="p">.</span><span class="nx">observer</span><span class="p">;</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">list</span><span class="p">[</span><span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span><span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nx">random</span><span class="p">()</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">list</span><span class="p">.</span><span class="nx">length</span><span class="p">)];</span>
<span class="p">}</span>

<span class="kd">function</span><span class="w"> </span><span class="nx">generateEventMessage</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">messages</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span>
<span class="w">    </span><span class="s2">&quot;WOW AMAZING! ğŸ”¥&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="s2">&quot;LOVE THIS! â¤ï¸&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="s2">&quot;GO GO GO! ğŸš€&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="s2">&quot;BEST STREAM EVER!&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="s2">&quot;THANK YOU! ğŸ™&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="s2">&quot;HYPEEEE! ğŸ‰&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="s2">&quot;OMGGGG! ğŸ˜±&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="s2">&quot;LET&#39;S GOOO! ğŸ’ª&quot;</span>
<span class="w">  </span><span class="p">];</span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">messages</span><span class="p">[</span><span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span><span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nx">random</span><span class="p">()</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">messages</span><span class="p">.</span><span class="nx">length</span><span class="p">)];</span>
<span class="p">}</span>

<span class="kd">function</span><span class="w"> </span><span class="nx">randomBetween</span><span class="p">(</span><span class="nx">min</span><span class="p">,</span><span class="w"> </span><span class="nx">max</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span><span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nx">random</span><span class="p">()</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="nx">max</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nx">min</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">1</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">min</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// Setup vÃ  teardown chi tiáº¿t</span>
<span class="k">export</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">setup</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;ğŸš€ Báº®T Äáº¦U MIXED REAL-WORLD TEST&#39;</span><span class="p">);</span>
<span class="w">  </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;ğŸ“… Lá»‹ch trÃ¬nh:&#39;</span><span class="p">);</span>
<span class="w">  </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;  6:00-6:30  - Morning ramp up&#39;</span><span class="p">);</span>
<span class="w">  </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;  6:30-8:30  - Peak hours&#39;</span><span class="p">);</span>
<span class="w">  </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;  9:00-9:05  - Special event (live stream)&#39;</span><span class="p">);</span>
<span class="w">  </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;  20:00-23:00 - Evening slow period&#39;</span><span class="p">);</span>

<span class="w">  </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;ğŸ‘¥ User profiles:&#39;</span><span class="p">);</span>
<span class="w">  </span><span class="nb">Object</span><span class="p">.</span><span class="nx">entries</span><span class="p">(</span><span class="nx">USER_PROFILES</span><span class="p">).</span><span class="nx">forEach</span><span class="p">(([</span><span class="nx">name</span><span class="p">,</span><span class="w"> </span><span class="nx">profile</span><span class="p">])</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`  </span><span class="si">${</span><span class="nx">name</span><span class="si">}</span><span class="sb">: </span><span class="si">${</span><span class="nx">profile</span><span class="p">.</span><span class="nx">weight</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">100</span><span class="si">}</span><span class="sb">% - </span><span class="si">${</span><span class="nx">profile</span><span class="p">.</span><span class="nx">behavior</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>
<span class="w">  </span><span class="p">});</span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">startTime</span><span class="o">:</span><span class="w"> </span><span class="nb">Date</span><span class="p">.</span><span class="nx">now</span><span class="p">(),</span>
<span class="w">    </span><span class="nx">testId</span><span class="o">:</span><span class="w"> </span><span class="sb">`mixed_test_</span><span class="si">${</span><span class="nb">Date</span><span class="p">.</span><span class="nx">now</span><span class="p">()</span><span class="si">}</span><span class="sb">`</span><span class="p">,</span>
<span class="w">    </span><span class="nx">expectedPattern</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;simulated_24h_compressed&#39;</span>
<span class="w">  </span><span class="p">};</span>
<span class="p">}</span>

<span class="k">export</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">teardown</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">duration</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Date</span><span class="p">.</span><span class="nx">now</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nx">data</span><span class="p">.</span><span class="nx">startTime</span><span class="p">;</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">hours</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">duration</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="p">(</span><span class="mf">1000</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">60</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">60</span><span class="p">)).</span><span class="nx">toFixed</span><span class="p">(</span><span class="mf">1</span><span class="p">);</span>

<span class="w">  </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;âœ… Káº¾T THÃšC MIXED REAL-WORLD TEST&#39;</span><span class="p">);</span>
<span class="w">  </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`â±ï¸  Tá»•ng thá»i gian: </span><span class="si">${</span><span class="nx">hours</span><span class="si">}</span><span class="sb"> giá»`</span><span class="p">);</span>
<span class="w">  </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`ğŸ†” Test ID: </span><span class="si">${</span><span class="nx">data</span><span class="p">.</span><span class="nx">testId</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>

<span class="w">  </span><span class="c1">// Generate comprehensive report</span>
<span class="w">  </span><span class="nx">generateFinalReport</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span>
<span class="p">}</span>

<span class="kd">function</span><span class="w"> </span><span class="nx">generateFinalReport</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">report</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">summary</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">testId</span><span class="o">:</span><span class="w"> </span><span class="nx">data</span><span class="p">.</span><span class="nx">testId</span><span class="p">,</span>
<span class="w">      </span><span class="nx">duration</span><span class="o">:</span><span class="w"> </span><span class="sb">`</span><span class="si">${</span><span class="nx">data</span><span class="p">.</span><span class="nx">duration</span><span class="si">}</span><span class="sb">`</span><span class="p">,</span>
<span class="w">      </span><span class="nx">scenarios</span><span class="o">:</span><span class="w"> </span><span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">scenarios</span><span class="p">).</span><span class="nx">length</span><span class="p">,</span>
<span class="w">      </span><span class="nx">userProfiles</span><span class="o">:</span><span class="w"> </span><span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">USER_PROFILES</span><span class="p">).</span><span class="nx">length</span>
<span class="w">    </span><span class="p">},</span>
<span class="w">    </span><span class="nx">performanceInsights</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="c1">// Sáº½ Ä‘Æ°á»£c Ä‘iá»n tá»« metrics thá»±c táº¿</span>
<span class="w">      </span><span class="nx">peakConcurrentUsers</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;N/A&#39;</span><span class="p">,</span>
<span class="w">      </span><span class="nx">averageLatency</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;N/A&#39;</span><span class="p">,</span>
<span class="w">      </span><span class="nx">worstCaseLatency</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;N/A&#39;</span><span class="p">,</span>
<span class="w">      </span><span class="nx">successRate</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;N/A&#39;</span>
<span class="w">    </span><span class="p">},</span>
<span class="w">    </span><span class="nx">systemLimitations</span><span class="o">:</span><span class="w"> </span><span class="p">[],</span>
<span class="w">    </span><span class="nx">recommendations</span><span class="o">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">      </span><span class="s2">&quot;1. Scale horizontally khi concurrent users &gt; 15,000&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="s2">&quot;2. Optimize database queries cho phÃ²ng chat Ä‘Ã´ng&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="s2">&quot;3. Implement rate limiting cho spam prevention&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="s2">&quot;4. Add connection pooling cho peak hours&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="s2">&quot;5. Monitor memory usage cho long-running connections&quot;</span>
<span class="w">    </span><span class="p">],</span>
<span class="w">    </span><span class="nx">nextSteps</span><span class="o">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">      </span><span class="s2">&quot;Run test trÃªn production-like environment&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="s2">&quot;Test vá»›i geographical distribution&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="s2">&quot;Test failure scenarios (server crash, network partition)&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="s2">&quot;Load test vá»›i media messages (images, videos)&quot;</span>
<span class="w">    </span><span class="p">]</span>
<span class="w">  </span><span class="p">};</span>

<span class="w">  </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;ğŸ“Š FINAL TEST REPORT:&#39;</span><span class="p">);</span>
<span class="w">  </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nb">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">report</span><span class="p">,</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w"> </span><span class="mf">2</span><span class="p">));</span>
<span class="p">}</span>

<span class="c1">// HÃ m handle káº¿t quáº£</span>
<span class="k">export</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">handleSummary</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">summary</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="s2">&quot;mixed_realworld_test.json&quot;</span><span class="o">:</span><span class="w"> </span><span class="nb">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">data</span><span class="p">),</span>
<span class="w">    </span><span class="s2">&quot;stdout&quot;</span><span class="o">:</span><span class="w"> </span><span class="nx">textSummary</span><span class="p">(</span><span class="nx">data</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">indent</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot; &quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">enableColors</span><span class="o">:</span><span class="w"> </span><span class="kc">true</span><span class="w"> </span><span class="p">})</span>
<span class="w">  </span><span class="p">};</span>

<span class="w">  </span><span class="c1">// TÃ­nh cÃ¡c metrics tá»•ng há»£p</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">calculatedMetrics</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">calculateDerivedMetrics</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span>
<span class="w">  </span><span class="nx">summary</span><span class="p">[</span><span class="s2">&quot;calculated_metrics.json&quot;</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">calculatedMetrics</span><span class="p">);</span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">summary</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">function</span><span class="w"> </span><span class="nx">calculateDerivedMetrics</span><span class="p">(</span><span class="nx">rawData</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">derivedMetrics</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">userExperienceScore</span><span class="o">:</span><span class="w"> </span><span class="nx">calculateUXScore</span><span class="p">(</span><span class="nx">rawData</span><span class="p">),</span>
<span class="w">      </span><span class="nx">systemStabilityIndex</span><span class="o">:</span><span class="w"> </span><span class="nx">calculateStabilityIndex</span><span class="p">(</span><span class="nx">rawData</span><span class="p">),</span>
<span class="w">      </span><span class="nx">costPerUser</span><span class="o">:</span><span class="w"> </span><span class="nx">estimateInfrastructureCost</span><span class="p">(</span><span class="nx">rawData</span><span class="p">),</span>
<span class="w">      </span><span class="nx">scalabilityPotential</span><span class="o">:</span><span class="w"> </span><span class="nx">assessScalability</span><span class="p">(</span><span class="nx">rawData</span><span class="p">)</span>
<span class="w">    </span><span class="p">},</span>
<span class="w">    </span><span class="nx">businessMetrics</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">potentialUserCapacity</span><span class="o">:</span><span class="w"> </span><span class="nx">estimateMaxUsers</span><span class="p">(</span><span class="nx">rawData</span><span class="p">),</span>
<span class="w">      </span><span class="nx">requiredInfrastructure</span><span class="o">:</span><span class="w"> </span><span class="nx">estimateInfrastructureNeeds</span><span class="p">(</span><span class="nx">rawData</span><span class="p">),</span>
<span class="w">      </span><span class="nx">slaCompliance</span><span class="o">:</span><span class="w"> </span><span class="nx">checkSLACompliance</span><span class="p">(</span><span class="nx">rawData</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">};</span>
<span class="p">}</span>

<span class="kd">function</span><span class="w"> </span><span class="nx">calculateUXScore</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// TÃ­nh Ä‘iá»ƒm tráº£i nghiá»‡m user dá»±a trÃªn latency, success rate, v.v.</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">latencyScore</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">data</span><span class="p">.</span><span class="nx">metrics</span><span class="p">.</span><span class="nx">message_latency_ms</span><span class="p">.</span><span class="nx">values</span><span class="p">.</span><span class="nx">p95</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mf">150</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="mf">100</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="mf">50</span><span class="p">;</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">successScore</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">data</span><span class="p">.</span><span class="nx">metrics</span><span class="p">.</span><span class="nx">success_rate</span><span class="p">.</span><span class="nx">values</span><span class="p">.</span><span class="nx">rate</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">100</span><span class="p">;</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">satisfactionScore</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">data</span><span class="p">.</span><span class="nx">metrics</span><span class="p">.</span><span class="nx">user_satisfaction</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nx">data</span><span class="p">.</span><span class="nx">metrics</span><span class="p">.</span><span class="nx">user_satisfaction</span><span class="p">.</span><span class="nx">values</span><span class="p">.</span><span class="nx">rate</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">100</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="mf">80</span><span class="p">;</span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">(</span><span class="nx">latencyScore</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">0.4</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">successScore</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">0.4</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">satisfactionScore</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">0.2</span><span class="p">);</span>
<span class="p">}</span>

<span class="kd">function</span><span class="w"> </span><span class="nx">calculateStabilityIndex</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// TÃ­nh chá»‰ sá»‘ á»•n Ä‘á»‹nh há»‡ thá»‘ng</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="mf">85</span><span class="p">;</span><span class="w"> </span><span class="c1">// Giáº£ láº­p</span>
<span class="p">}</span>

<span class="kd">function</span><span class="w"> </span><span class="nx">estimateInfrastructureCost</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// Æ¯á»›c tÃ­nh chi phÃ­ infrastructure</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="s1">&#39;$0.05 per user/month&#39;</span><span class="p">;</span><span class="w"> </span><span class="c1">// Giáº£ láº­p</span>
<span class="p">}</span>

<span class="kd">function</span><span class="w"> </span><span class="nx">assessScalability</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// ÄÃ¡nh giÃ¡ kháº£ nÄƒng scale</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="s1">&#39;Good - can handle 2x current load&#39;</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">function</span><span class="w"> </span><span class="nx">estimateMaxUsers</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// Æ¯á»›c tÃ­nh sá»‘ user tá»‘i Ä‘a</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="mf">25000</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">function</span><span class="w"> </span><span class="nx">estimateInfrastructureNeeds</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// Æ¯á»›c tÃ­nh nhu cáº§u infrastructure</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="s1">&#39;5 servers, 2 load balancers&#39;</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">function</span><span class="w"> </span><span class="nx">checkSLACompliance</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// Kiá»ƒm tra SLA</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="s1">&#39;99.9% uptime - compliant&#39;</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// HÃ m monitor server resources</span>
<span class="kd">function</span><span class="w"> </span><span class="nx">monitorServerResources</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">setInterval</span><span class="p">(</span><span class="k">async</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="c1">// Gá»i API metrics cá»§a server (giáº£ láº­p)</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">serverMetrics</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">fetchServerMetrics</span><span class="p">();</span>

<span class="w">      </span><span class="nx">metrics</span><span class="p">.</span><span class="nx">cpu</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nx">serverMetrics</span><span class="p">.</span><span class="nx">cpu_percent</span><span class="p">);</span>
<span class="w">      </span><span class="nx">metrics</span><span class="p">.</span><span class="nx">memory</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nx">serverMetrics</span><span class="p">.</span><span class="nx">memory_mb</span><span class="p">);</span>

<span class="w">      </span><span class="c1">// Cáº£nh bÃ¡o náº¿u vÆ°á»£t ngÆ°á»¡ng</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">serverMetrics</span><span class="p">.</span><span class="nx">cpu_percent</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">80</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">console</span><span class="p">.</span><span class="nx">warn</span><span class="p">(</span><span class="sb">`âš ï¸ CPU usage high: </span><span class="si">${</span><span class="nx">serverMetrics</span><span class="p">.</span><span class="nx">cpu_percent</span><span class="si">}</span><span class="sb">%`</span><span class="p">);</span>
<span class="w">      </span><span class="p">}</span>

<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">serverMetrics</span><span class="p">.</span><span class="nx">memory_mb</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">800</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">console</span><span class="p">.</span><span class="nx">warn</span><span class="p">(</span><span class="sb">`âš ï¸ Memory usage high: </span><span class="si">${</span><span class="nx">serverMetrics</span><span class="p">.</span><span class="nx">memory_mb</span><span class="si">}</span><span class="sb">MB`</span><span class="p">);</span>
<span class="w">      </span><span class="p">}</span>

<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="nx">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s1">&#39;Failed to fetch server metrics:&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">error</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">},</span><span class="w"> </span><span class="mf">30000</span><span class="p">);</span><span class="w"> </span><span class="c1">// Má»—i 30 giÃ¢y</span>
<span class="p">}</span>

<span class="c1">// Khá»Ÿi Ä‘á»™ng monitoring</span>
<span class="nx">monitorServerResources</span><span class="p">();</span>

<span class="kd">function</span><span class="w"> </span><span class="nx">fetchServerMetrics</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// Giáº£ láº­p fetch metrics</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nb">Promise</span><span class="p">.</span><span class="nx">resolve</span><span class="p">({</span>
<span class="w">    </span><span class="nx">cpu_percent</span><span class="o">:</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">random</span><span class="p">()</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">100</span><span class="p">,</span>
<span class="w">    </span><span class="nx">memory_mb</span><span class="o">:</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">random</span><span class="p">()</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">1000</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">200</span>
<span class="w">  </span><span class="p">});</span>
<span class="p">}</span>

<span class="kd">function</span><span class="w"> </span><span class="nx">textSummary</span><span class="p">(</span><span class="nx">data</span><span class="p">,</span><span class="w"> </span><span class="nx">options</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// Giáº£ láº­p text summary</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="s1">&#39;Test summary...&#39;</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<hr />
<h3 id="chuong-4-phan-tich-ket-qua-va-toi-uu-hieu-nang">ğŸ“ˆ CHÆ¯Æ NG 4: PHÃ‚N TÃCH Káº¾T QUáº¢ VÃ€ Tá»I Æ¯U HIá»†U NÄ‚NG<a class="headerlink" href="#chuong-4-phan-tich-ket-qua-va-toi-uu-hieu-nang" title="Permanent link">&para;</a></h3>
<h4 id="41-phan-tich-ket-qua-chi-tiet">4.1. PhÃ¢n TÃ­ch Káº¿t Quáº£ Chi Tiáº¿t<a class="headerlink" href="#41-phan-tich-ket-qua-chi-tiet" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1">// performance-analyzer.js</span>
<span class="kd">class</span><span class="w"> </span><span class="nx">PerformanceAnalyzer</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kr">constructor</span><span class="p">(</span><span class="nx">testResults</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">results</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">testResults</span><span class="p">;</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">insights</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[];</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">bottlenecks</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[];</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">recommendations</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[];</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nx">analyze</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">analyzeLatency</span><span class="p">();</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">analyzeThroughput</span><span class="p">();</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">analyzeErrorPatterns</span><span class="p">();</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">analyzeResourceUsage</span><span class="p">();</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">identifyBottlenecks</span><span class="p">();</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">generateRecommendations</span><span class="p">();</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">generateReport</span><span class="p">();</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nx">analyzeLatency</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">latency</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">results</span><span class="p">.</span><span class="nx">metrics</span><span class="p">.</span><span class="nx">message_latency_ms</span><span class="p">;</span>

<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">insights</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span>
<span class="w">      </span><span class="nx">type</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;latency&#39;</span><span class="p">,</span>
<span class="w">      </span><span class="nx">summary</span><span class="o">:</span><span class="w"> </span><span class="sb">`Äá»™ trá»… p95: </span><span class="si">${</span><span class="nx">latency</span><span class="p">.</span><span class="nx">values</span><span class="p">[</span><span class="s1">&#39;p(95)&#39;</span><span class="p">]</span><span class="si">}</span><span class="sb">ms, p99: </span><span class="si">${</span><span class="nx">latency</span><span class="p">.</span><span class="nx">values</span><span class="p">[</span><span class="s1">&#39;p(99)&#39;</span><span class="p">]</span><span class="si">}</span><span class="sb">ms`</span><span class="p">,</span>

<span class="w">      </span><span class="c1">// PhÃ¢n tÃ­ch chi tiáº¿t</span>
<span class="w">      </span><span class="nx">details</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">acceptable</span><span class="o">:</span><span class="w"> </span><span class="nx">latency</span><span class="p">.</span><span class="nx">values</span><span class="p">[</span><span class="s1">&#39;p(95)&#39;</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mf">100</span><span class="p">,</span>
<span class="w">        </span><span class="nx">good</span><span class="o">:</span><span class="w"> </span><span class="nx">latency</span><span class="p">.</span><span class="nx">values</span><span class="p">[</span><span class="s1">&#39;p(95)&#39;</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mf">50</span><span class="p">,</span>
<span class="w">        </span><span class="nx">excellent</span><span class="o">:</span><span class="w"> </span><span class="nx">latency</span><span class="p">.</span><span class="nx">values</span><span class="p">[</span><span class="s1">&#39;p(95)&#39;</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mf">20</span><span class="p">,</span>

<span class="w">        </span><span class="c1">// PhÃ¢n bá»‘</span>
<span class="w">        </span><span class="nx">distribution</span><span class="o">:</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">calculateLatencyDistribution</span><span class="p">(</span><span class="nx">latency</span><span class="p">)</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">});</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nx">calculateLatencyDistribution</span><span class="p">(</span><span class="nx">latencyMetric</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// Giáº£ sá»­ cÃ³ histogram data</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">under_10ms</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;15%&#39;</span><span class="p">,</span>
<span class="w">      </span><span class="nx">under_50ms</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;60%&#39;</span><span class="p">,</span>
<span class="w">      </span><span class="nx">under_100ms</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;85%&#39;</span><span class="p">,</span>
<span class="w">      </span><span class="nx">under_500ms</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;98%&#39;</span><span class="p">,</span>
<span class="w">      </span><span class="nx">over_500ms</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;2%&#39;</span>
<span class="w">    </span><span class="p">};</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nx">analyzeThroughput</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">messagesPerSecond</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">calculateThroughput</span><span class="p">();</span>

<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">insights</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span>
<span class="w">      </span><span class="nx">type</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;throughput&#39;</span><span class="p">,</span>
<span class="w">      </span><span class="nx">summary</span><span class="o">:</span><span class="w"> </span><span class="sb">`Throughput trung bÃ¬nh: </span><span class="si">${</span><span class="nx">messagesPerSecond</span><span class="p">.</span><span class="nx">average</span><span class="si">}</span><span class="sb"> msg/s, peak: </span><span class="si">${</span><span class="nx">messagesPerSecond</span><span class="p">.</span><span class="nx">peak</span><span class="si">}</span><span class="sb"> msg/s`</span><span class="p">,</span>

<span class="w">      </span><span class="nx">details</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">capacityUtilization</span><span class="o">:</span><span class="w"> </span><span class="sb">`</span><span class="si">${</span><span class="p">((</span><span class="nx">messagesPerSecond</span><span class="p">.</span><span class="nx">average</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="nx">messagesPerSecond</span><span class="p">.</span><span class="nx">peak</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">100</span><span class="p">).</span><span class="nx">toFixed</span><span class="p">(</span><span class="mf">1</span><span class="p">)</span><span class="si">}</span><span class="sb">%`</span><span class="p">,</span>
<span class="w">        </span><span class="nx">sustainableLevel</span><span class="o">:</span><span class="w"> </span><span class="nx">messagesPerSecond</span><span class="p">.</span><span class="nx">average</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">1.5</span><span class="p">,</span>

<span class="w">        </span><span class="c1">// PhÃ¢n tÃ­ch theo thá»i gian</span>
<span class="w">        </span><span class="nx">timeSeriesAnalysis</span><span class="o">:</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">analyzeThroughputOverTime</span><span class="p">()</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">});</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nx">analyzeThroughputOverTime</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">trend</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;stable&#39;</span><span class="p">,</span>
<span class="w">      </span><span class="nx">peakHours</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="s1">&#39;6:30-8:30&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;12:00-13:00&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;18:00-20:00&#39;</span><span class="p">]</span>
<span class="w">    </span><span class="p">};</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nx">calculateThroughput</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">average</span><span class="o">:</span><span class="w"> </span><span class="mf">150</span><span class="p">,</span>
<span class="w">      </span><span class="nx">peak</span><span class="o">:</span><span class="w"> </span><span class="mf">500</span>
<span class="w">    </span><span class="p">};</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nx">analyzeErrorPatterns</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">errors</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">results</span><span class="p">.</span><span class="nx">metrics</span><span class="p">.</span><span class="nx">total_errors</span><span class="p">;</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">errors</span><span class="p">.</span><span class="nx">values</span><span class="p">.</span><span class="nx">count</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">this</span><span class="p">.</span><span class="nx">insights</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span>
<span class="w">        </span><span class="nx">type</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;errors&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="nx">severity</span><span class="o">:</span><span class="w"> </span><span class="nx">errors</span><span class="p">.</span><span class="nx">values</span><span class="p">.</span><span class="nx">count</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">100</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="s1">&#39;HIGH&#39;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;MEDIUM&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="nx">summary</span><span class="o">:</span><span class="w"> </span><span class="sb">`Tá»•ng sá»‘ lá»—i: </span><span class="si">${</span><span class="nx">errors</span><span class="p">.</span><span class="nx">values</span><span class="p">.</span><span class="nx">count</span><span class="si">}</span><span class="sb">`</span><span class="p">,</span>

<span class="w">        </span><span class="nx">patterns</span><span class="o">:</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">identifyErrorPatterns</span><span class="p">(),</span>

<span class="w">        </span><span class="c1">// PhÃ¢n loáº¡i lá»—i</span>
<span class="w">        </span><span class="nx">categories</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="nx">connection_errors</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;45%&#39;</span><span class="p">,</span>
<span class="w">          </span><span class="nx">authentication_errors</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;25%&#39;</span><span class="p">,</span>
<span class="w">          </span><span class="nx">timeout_errors</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;20%&#39;</span><span class="p">,</span>
<span class="w">          </span><span class="nx">other_errors</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;10%&#39;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">      </span><span class="p">});</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nx">identifyErrorPatterns</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// PhÃ¢n tÃ­ch pattern lá»—i theo thá»i gian, loáº¡i user, v.v.</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">temporal</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Lá»—i táº­p trung vÃ o peak hours&#39;</span><span class="p">,</span>
<span class="w">      </span><span class="nx">userBased</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Unstable users cÃ³ tá»· lá»‡ lá»—i cao hÆ¡n 3x&#39;</span><span class="p">,</span>
<span class="w">      </span><span class="nx">messageBased</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Spam messages cÃ³ tá»· lá»‡ timeout cao&#39;</span><span class="p">,</span>

<span class="w">      </span><span class="c1">// Correlation analysis</span>
<span class="w">      </span><span class="nx">correlations</span><span class="o">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">        </span><span class="s1">&#39;Lá»—i tÄƒng khi concurrent connections &gt; 15,000&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="s1">&#39;Timeout xáº£y ra khi message rate &gt; 500 msg/s&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="s1">&#39;Memory errors sau 4+ giá» cháº¡y&#39;</span>
<span class="w">      </span><span class="p">]</span>
<span class="w">    </span><span class="p">};</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nx">analyzeResourceUsage</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// PhÃ¢n tÃ­ch resource usage</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">insights</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span>
<span class="w">      </span><span class="nx">type</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;resources&#39;</span><span class="p">,</span>
<span class="w">      </span><span class="nx">summary</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Resource usage analysis&#39;</span>
<span class="w">    </span><span class="p">});</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nx">identifyBottlenecks</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">bottlenecks</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[];</span>

<span class="w">    </span><span class="c1">// 1. Database bottlenecks</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">results</span><span class="p">.</span><span class="nx">metrics</span><span class="p">.</span><span class="nx">database_query_time</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">bottlenecks</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span>
<span class="w">        </span><span class="nx">type</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;database&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="nx">location</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Message persistence layer&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="nx">symptom</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Query time increases exponentially with connection count&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="nx">impact</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Message latency increases during peak hours&#39;</span>
<span class="w">      </span><span class="p">});</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// 2. Network bottlenecks</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">results</span><span class="p">.</span><span class="nx">metrics</span><span class="p">.</span><span class="nx">network_throughput</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">bottlenecks</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span>
<span class="w">        </span><span class="nx">type</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;network&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="nx">location</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;WebSocket message broadcasting&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="nx">symptom</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Fan-out operations slow with large rooms&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="nx">impact</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Users in large rooms experience higher latency&#39;</span>
<span class="w">      </span><span class="p">});</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// 3. Memory bottlenecks</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">results</span><span class="p">.</span><span class="nx">metrics</span><span class="p">.</span><span class="nx">memory_usage_mb</span><span class="o">?</span><span class="p">.</span><span class="nx">values</span><span class="p">.</span><span class="nx">max</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">1024</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">bottlenecks</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span>
<span class="w">        </span><span class="nx">type</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;memory&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="nx">location</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Connection tracking and message caching&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="nx">symptom</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Memory leak during long-running connections&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="nx">impact</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Server requires restart every 8-12 hours&#39;</span>
<span class="w">      </span><span class="p">});</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">bottlenecks</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">bottlenecks</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nx">generateRecommendations</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">recommendations</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[];</span>

<span class="w">    </span><span class="c1">// Dá»±a trÃªn bottlenecks</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">bottlenecks</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="nx">bottleneck</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="nx">bottleneck</span><span class="p">.</span><span class="nx">type</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="s1">&#39;database&#39;</span><span class="o">:</span>
<span class="w">          </span><span class="nx">recommendations</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span>
<span class="w">            </span><span class="nx">priority</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;HIGH&#39;</span><span class="p">,</span>
<span class="w">            </span><span class="nx">action</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Implement database connection pooling&#39;</span><span class="p">,</span>
<span class="w">            </span><span class="nx">expectedImprovement</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Reduce query time by 40-60%&#39;</span><span class="p">,</span>
<span class="w">            </span><span class="nx">effort</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Medium (2-3 developer weeks)&#39;</span>
<span class="w">          </span><span class="p">});</span>
<span class="w">          </span><span class="k">break</span><span class="p">;</span>

<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="s1">&#39;network&#39;</span><span class="o">:</span>
<span class="w">          </span><span class="nx">recommendations</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span>
<span class="w">            </span><span class="nx">priority</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;MEDIUM&#39;</span><span class="p">,</span>
<span class="w">            </span><span class="nx">action</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Optimize WebSocket broadcast with room partitioning&#39;</span><span class="p">,</span>
<span class="w">            </span><span class="nx">expectedImprovement</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Reduce fan-out latency by 30%&#39;</span><span class="p">,</span>
<span class="w">            </span><span class="nx">effort</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;High (4-6 developer weeks)&#39;</span>
<span class="w">          </span><span class="p">});</span>
<span class="w">          </span><span class="k">break</span><span class="p">;</span>

<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="s1">&#39;memory&#39;</span><span class="o">:</span>
<span class="w">          </span><span class="nx">recommendations</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span>
<span class="w">            </span><span class="nx">priority</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;HIGH&#39;</span><span class="p">,</span>
<span class="w">            </span><span class="nx">action</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Fix memory leaks in connection management&#39;</span><span class="p">,</span>
<span class="w">            </span><span class="nx">expectedImprovement</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Enable 24/7 uptime without restarts&#39;</span><span class="p">,</span>
<span class="w">            </span><span class="nx">effort</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Medium (2-3 developer weeks)&#39;</span>
<span class="w">          </span><span class="p">});</span>
<span class="w">          </span><span class="k">break</span><span class="p">;</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">});</span>

<span class="w">    </span><span class="c1">// Dá»±a trÃªn insights</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">insights</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="nx">i</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">i</span><span class="p">.</span><span class="nx">type</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;latency&#39;</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="nx">i</span><span class="p">.</span><span class="nx">details</span><span class="p">.</span><span class="nx">acceptable</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">recommendations</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span>
<span class="w">        </span><span class="nx">priority</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;CRITICAL&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="nx">action</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Optimize message queue processing&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="nx">expectedImprovement</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Reduce p95 latency to under 100ms&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="nx">effort</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;High (3-4 developer weeks)&#39;</span>
<span class="w">      </span><span class="p">});</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">recommendations</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">recommendations</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nx">generateReport</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">executiveSummary</span><span class="o">:</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">generateExecutiveSummary</span><span class="p">(),</span>
<span class="w">      </span><span class="nx">detailedAnalysis</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">insights</span><span class="o">:</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">insights</span><span class="p">,</span>
<span class="w">        </span><span class="nx">bottlenecks</span><span class="o">:</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">bottlenecks</span><span class="p">,</span>
<span class="w">        </span><span class="nx">recommendations</span><span class="o">:</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">recommendations</span>
<span class="w">      </span><span class="p">},</span>
<span class="w">      </span><span class="nx">metricsSnapshot</span><span class="o">:</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">getMetricsSnapshot</span><span class="p">(),</span>
<span class="w">      </span><span class="nx">nextSteps</span><span class="o">:</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">getNextSteps</span><span class="p">()</span>
<span class="w">    </span><span class="p">};</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nx">generateExecutiveSummary</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">latencyInsight</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">insights</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="nx">i</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">i</span><span class="p">.</span><span class="nx">type</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;latency&#39;</span><span class="p">);</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">errorInsight</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">insights</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="nx">i</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">i</span><span class="p">.</span><span class="nx">type</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;errors&#39;</span><span class="p">);</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">overallStatus</span><span class="o">:</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">calculateOverallStatus</span><span class="p">(),</span>
<span class="w">      </span><span class="nx">keyFindings</span><span class="o">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">        </span><span class="nx">latencyInsight</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="sb">`Äá»™ trá»… p95: </span><span class="si">${</span><span class="nx">latencyInsight</span><span class="p">.</span><span class="nx">summary</span><span class="si">}</span><span class="sb">`</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Latency within acceptable range&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="nx">errorInsight</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="sb">`Lá»—i phÃ¡t hiá»‡n: </span><span class="si">${</span><span class="nx">errorInsight</span><span class="p">.</span><span class="nx">summary</span><span class="si">}</span><span class="sb">`</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Error rate within acceptable range&#39;</span>
<span class="w">      </span><span class="p">],</span>
<span class="w">      </span><span class="nx">riskAssessment</span><span class="o">:</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">assessRisks</span><span class="p">()</span>
<span class="w">    </span><span class="p">};</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nx">calculateOverallStatus</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="nx">score</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">100</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// Trá»« Ä‘iá»ƒm dá»±a trÃªn issues</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">latencyInsight</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">insights</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="nx">i</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">i</span><span class="p">.</span><span class="nx">type</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;latency&#39;</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">latencyInsight</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="nx">latencyInsight</span><span class="p">.</span><span class="nx">details</span><span class="p">.</span><span class="nx">acceptable</span><span class="p">)</span><span class="w"> </span><span class="nx">score</span><span class="w"> </span><span class="o">-=</span><span class="w"> </span><span class="mf">30</span><span class="p">;</span>

<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">errorInsight</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">insights</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="nx">i</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">i</span><span class="p">.</span><span class="nx">type</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;errors&#39;</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">errorInsight</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">errorInsight</span><span class="p">.</span><span class="nx">severity</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;HIGH&#39;</span><span class="p">)</span><span class="w"> </span><span class="nx">score</span><span class="w"> </span><span class="o">-=</span><span class="w"> </span><span class="mf">40</span><span class="p">;</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">bottlenecks</span><span class="p">.</span><span class="nx">length</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">2</span><span class="p">)</span><span class="w"> </span><span class="nx">score</span><span class="w"> </span><span class="o">-=</span><span class="w"> </span><span class="mf">20</span><span class="p">;</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">score</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mf">80</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="s1">&#39;EXCELLENT&#39;</span><span class="p">;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">score</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mf">60</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="s1">&#39;GOOD&#39;</span><span class="p">;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">score</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mf">40</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="s1">&#39;FAIR&#39;</span><span class="p">;</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="s1">&#39;POOR&#39;</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nx">assessRisks</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">risks</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[];</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">bottlenecks</span><span class="p">.</span><span class="nx">some</span><span class="p">(</span><span class="nx">b</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">b</span><span class="p">.</span><span class="nx">type</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;memory&#39;</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">risks</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span>
<span class="w">        </span><span class="nx">type</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Stability&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="nx">description</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Memory leak cÃ³ thá»ƒ gÃ¢y server crash trong vÃ²ng 12 giá»&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="nx">impact</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;HIGH&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="nx">probability</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;MEDIUM&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="nx">mitigation</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Priority fix memory management&#39;</span>
<span class="w">      </span><span class="p">});</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">insights</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="nx">i</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">i</span><span class="p">.</span><span class="nx">type</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;latency&#39;</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">i</span><span class="p">.</span><span class="nx">details</span><span class="p">.</span><span class="nx">p95</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">200</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">risks</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span>
<span class="w">        </span><span class="nx">type</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;User Experience&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="nx">description</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Äá»™ trá»… cao cÃ³ thá»ƒ khiáº¿n user chuyá»ƒn sang á»©ng dá»¥ng khÃ¡c&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="nx">impact</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;HIGH&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="nx">probability</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;HIGH&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="nx">mitigation</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Optimize message processing pipeline&#39;</span>
<span class="w">      </span><span class="p">});</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">risks</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nx">getMetricsSnapshot</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">performance</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">p95_latency</span><span class="o">:</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">results</span><span class="p">.</span><span class="nx">metrics</span><span class="p">.</span><span class="nx">message_latency_ms</span><span class="o">?</span><span class="p">.</span><span class="nx">values</span><span class="p">[</span><span class="s1">&#39;p(95)&#39;</span><span class="p">]</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;N/A&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="nx">p99_latency</span><span class="o">:</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">results</span><span class="p">.</span><span class="nx">metrics</span><span class="p">.</span><span class="nx">message_latency_ms</span><span class="o">?</span><span class="p">.</span><span class="nx">values</span><span class="p">[</span><span class="s1">&#39;p(99)&#39;</span><span class="p">]</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;N/A&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="nx">success_rate</span><span class="o">:</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">results</span><span class="p">.</span><span class="nx">metrics</span><span class="p">.</span><span class="nx">success_rate</span><span class="o">?</span><span class="p">.</span><span class="nx">values</span><span class="p">.</span><span class="nx">rate</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;N/A&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="nx">throughput</span><span class="o">:</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">calculateThroughput</span><span class="p">()</span>
<span class="w">      </span><span class="p">},</span>
<span class="w">      </span><span class="nx">resources</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">peak_memory</span><span class="o">:</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">results</span><span class="p">.</span><span class="nx">metrics</span><span class="p">.</span><span class="nx">memory_usage_mb</span><span class="o">?</span><span class="p">.</span><span class="nx">values</span><span class="p">.</span><span class="nx">max</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;N/A&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="nx">peak_cpu</span><span class="o">:</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">results</span><span class="p">.</span><span class="nx">metrics</span><span class="p">.</span><span class="nx">server_cpu_percent</span><span class="o">?</span><span class="p">.</span><span class="nx">values</span><span class="p">.</span><span class="nx">max</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;N/A&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="nx">peak_connections</span><span class="o">:</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">results</span><span class="p">.</span><span class="nx">metrics</span><span class="p">.</span><span class="nx">active_connections</span><span class="o">?</span><span class="p">.</span><span class="nx">values</span><span class="p">.</span><span class="nx">max</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;N/A&#39;</span>
<span class="w">      </span><span class="p">},</span>
<span class="w">      </span><span class="nx">reliability</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">total_errors</span><span class="o">:</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">results</span><span class="p">.</span><span class="nx">metrics</span><span class="p">.</span><span class="nx">total_errors</span><span class="o">?</span><span class="p">.</span><span class="nx">values</span><span class="p">.</span><span class="nx">count</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="mf">0</span><span class="p">,</span>
<span class="w">        </span><span class="nx">error_rate</span><span class="o">:</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">calculateErrorRate</span><span class="p">(),</span>
<span class="w">        </span><span class="nx">uptime_sla</span><span class="o">:</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">calculateSLACompliance</span><span class="p">()</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">};</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nx">calculateErrorRate</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">total</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">results</span><span class="p">.</span><span class="nx">metrics</span><span class="p">.</span><span class="nx">vus</span><span class="o">?</span><span class="p">.</span><span class="nx">values</span><span class="p">.</span><span class="nx">count</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="mf">1</span><span class="p">;</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">errors</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">results</span><span class="p">.</span><span class="nx">metrics</span><span class="p">.</span><span class="nx">total_errors</span><span class="o">?</span><span class="p">.</span><span class="nx">values</span><span class="p">.</span><span class="nx">count</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="sb">`</span><span class="si">${</span><span class="p">(</span><span class="nx">errors</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="nx">total</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">100</span><span class="p">).</span><span class="nx">toFixed</span><span class="p">(</span><span class="mf">2</span><span class="p">)</span><span class="si">}</span><span class="sb">%`</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nx">calculateSLACompliance</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">successRate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">results</span><span class="p">.</span><span class="nx">metrics</span><span class="p">.</span><span class="nx">success_rate</span><span class="o">?</span><span class="p">.</span><span class="nx">values</span><span class="p">.</span><span class="nx">rate</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">successRate</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mf">0.999</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="s1">&#39;99.9% - Compliant&#39;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Below SLA&#39;</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nx">getNextSteps</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">[</span>
<span class="w">      </span><span class="p">{</span>
<span class="w">        </span><span class="nx">immediate</span><span class="o">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">          </span><span class="s1">&#39;Fix critical bottlenecks (priority HIGH)&#39;</span><span class="p">,</span>
<span class="w">          </span><span class="s1">&#39;Address any stability risks&#39;</span><span class="p">,</span>
<span class="w">          </span><span class="s1">&#39;Update monitoring alerts based on findings&#39;</span>
<span class="w">        </span><span class="p">]</span>
<span class="w">      </span><span class="p">},</span>
<span class="w">      </span><span class="p">{</span>
<span class="w">        </span><span class="nx">short_term</span><span class="o">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">          </span><span class="s1">&#39;Implement performance optimizations&#39;</span><span class="p">,</span>
<span class="w">          </span><span class="s1">&#39;Update capacity planning based on test results&#39;</span><span class="p">,</span>
<span class="w">          </span><span class="s1">&#39;Schedule follow-up tests for verification&#39;</span>
<span class="w">        </span><span class="p">]</span>
<span class="w">      </span><span class="p">},</span>
<span class="w">      </span><span class="p">{</span>
<span class="w">        </span><span class="nx">long_term</span><span class="o">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">          </span><span class="s1">&#39;Architecture review for scalability&#39;</span><span class="p">,</span>
<span class="w">          </span><span class="s1">&#39;Consider microservices decomposition&#39;</span><span class="p">,</span>
<span class="w">          </span><span class="s1">&#39;Plan for 10x growth&#39;</span>
<span class="w">        </span><span class="p">]</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">];</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>

<span class="c1">// Sá»­ dá»¥ng analyzer</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">sampleResults</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">metrics</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">message_latency_ms</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">values</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="s1">&#39;p(50)&#39;</span><span class="o">:</span><span class="w"> </span><span class="mf">45</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;p(95)&#39;</span><span class="o">:</span><span class="w"> </span><span class="mf">120</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;p(99)&#39;</span><span class="o">:</span><span class="w"> </span><span class="mf">250</span><span class="p">,</span><span class="w"> </span><span class="nx">max</span><span class="o">:</span><span class="w"> </span><span class="mf">1200</span><span class="w"> </span><span class="p">}</span>
<span class="w">    </span><span class="p">},</span>
<span class="w">    </span><span class="nx">success_rate</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">values</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">rate</span><span class="o">:</span><span class="w"> </span><span class="mf">0.992</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">},</span>
<span class="w">    </span><span class="nx">total_errors</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">values</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">count</span><span class="o">:</span><span class="w"> </span><span class="mf">85</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">},</span>
<span class="w">    </span><span class="nx">memory_usage_mb</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">values</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">max</span><span class="o">:</span><span class="w"> </span><span class="mf">1100</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">},</span>
<span class="w">    </span><span class="nx">active_connections</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">values</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">max</span><span class="o">:</span><span class="w"> </span><span class="mf">18500</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">},</span>
<span class="w">    </span><span class="nx">vus</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">values</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">count</span><span class="o">:</span><span class="w"> </span><span class="mf">10000</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">};</span>

<span class="kd">const</span><span class="w"> </span><span class="nx">analyzer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">PerformanceAnalyzer</span><span class="p">(</span><span class="nx">sampleResults</span><span class="p">);</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">report</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">analyzer</span><span class="p">.</span><span class="nx">analyze</span><span class="p">();</span>

<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;ğŸ“Š PERFORMANCE ANALYSIS REPORT:&#39;</span><span class="p">);</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nb">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">report</span><span class="p">,</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w"> </span><span class="mf">2</span><span class="p">));</span>
</code></pre></div>
<h4 id="42-toi-uu-hieu-nang-dua-tren-ket-qua">4.2. Tá»‘i Æ¯u Hiá»‡u NÄƒng Dá»±a TrÃªn Káº¿t Quáº£<a class="headerlink" href="#42-toi-uu-hieu-nang-dua-tren-ket-qua" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1">// performance-optimizations.js</span>
<span class="kd">class</span><span class="w"> </span><span class="nx">ChatOptimizer</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kr">constructor</span><span class="p">(</span><span class="nx">analysisReport</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">report</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">analysisReport</span><span class="p">;</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">optimizations</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[];</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nx">suggestOptimizations</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// 1. Optimizations cho latency</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">optimizeLatency</span><span class="p">();</span>

<span class="w">    </span><span class="c1">// 2. Optimizations cho throughput</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">optimizeThroughput</span><span class="p">();</span>

<span class="w">    </span><span class="c1">// 3. Optimizations cho memory</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">optimizeMemory</span><span class="p">();</span>

<span class="w">    </span><span class="c1">// 4. Optimizations cho reliability</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">optimizeReliability</span><span class="p">();</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">optimizations</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nx">optimizeLatency</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">latency</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">report</span><span class="p">.</span><span class="nx">detailedAnalysis</span><span class="p">.</span><span class="nx">insights</span>
<span class="w">      </span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="nx">i</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">i</span><span class="p">.</span><span class="nx">type</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;latency&#39;</span><span class="p">);</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">latency</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">latency</span><span class="p">.</span><span class="nx">details</span><span class="p">.</span><span class="nx">p95</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">100</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">this</span><span class="p">.</span><span class="nx">optimizations</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span>
<span class="w">        </span><span class="nx">category</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;LATENCY&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="nx">optimizations</span><span class="o">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">          </span><span class="p">{</span>
<span class="w">            </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Message Batching&#39;</span><span class="p">,</span>
<span class="w">            </span><span class="nx">description</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Batch small messages thay vÃ¬ gá»­i tá»«ng cÃ¡i&#39;</span><span class="p">,</span>
<span class="w">            </span><span class="nx">implementation</span><span class="o">:</span><span class="w"> </span><span class="sb">`</span>
<span class="sb">// Thay vÃ¬:</span>
<span class="sb">socket.emit(&#39;message&#39;, { text: &#39;Hi&#39; });</span>
<span class="sb">socket.emit(&#39;message&#39;, { text: &#39;How&#39; });</span>
<span class="sb">socket.emit(&#39;message&#39;, { text: &#39;Are you?&#39; });</span>

<span class="sb">// Batch messages:</span>
<span class="sb">socket.emit(&#39;batch&#39;, [</span>
<span class="sb">  { text: &#39;Hi&#39; },</span>
<span class="sb">  { text: &#39;How&#39; },</span>
<span class="sb">  { text: &#39;Are you?&#39; }</span>
<span class="sb">]);</span>
<span class="sb">            `</span><span class="p">,</span>
<span class="w">            </span><span class="nx">expectedImprovement</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Giáº£m 30-50% WebSocket frames&#39;</span>
<span class="w">          </span><span class="p">},</span>
<span class="w">          </span><span class="p">{</span>
<span class="w">            </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Connection Pooling&#39;</span><span class="p">,</span>
<span class="w">            </span><span class="nx">description</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;DÃ¹ng connection pool cho database queries&#39;</span><span class="p">,</span>
<span class="w">            </span><span class="nx">implementation</span><span class="o">:</span><span class="w"> </span><span class="sb">`</span>
<span class="sb">// Sá»­ dá»¥ng pool thay vÃ¬ connection tá»«ng cÃ¡i</span>
<span class="sb">const pool = mysql.createPool({</span>
<span class="sb">  connectionLimit: 10,</span>
<span class="sb">  host: &#39;localhost&#39;,</span>
<span class="sb">  user: &#39;root&#39;,</span>
<span class="sb">  password: &#39;password&#39;,</span>
<span class="sb">  database: &#39;chat_db&#39;</span>
<span class="sb">});</span>

<span class="sb">// Khi cáº§n query:</span>
<span class="sb">pool.query(&#39;SELECT * FROM messages WHERE room = ?&#39;, [roomId], callback);</span>
<span class="sb">            `</span><span class="p">,</span>
<span class="w">            </span><span class="nx">expectedImprovement</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Giáº£m 40-60% query latency&#39;</span>
<span class="w">          </span><span class="p">},</span>
<span class="w">          </span><span class="p">{</span>
<span class="w">            </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Caching Layer&#39;</span><span class="p">,</span>
<span class="w">            </span><span class="nx">description</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Cache tin nháº¯n gáº§n Ä‘Ã¢y vÃ  user sessions&#39;</span><span class="p">,</span>
<span class="w">            </span><span class="nx">implementation</span><span class="o">:</span><span class="w"> </span><span class="sb">`</span>
<span class="sb">// Sá»­ dá»¥ng Redis cho caching</span>
<span class="sb">const redisClient = redis.createClient();</span>

<span class="sb">// Cache recent messages</span>
<span class="sb">async function getRoomMessages(roomId) {</span>
<span class="sb">  const cacheKey = \`messages:\${roomId}\`;</span>
<span class="sb">  const cached = await redisClient.get(cacheKey);</span>

<span class="sb">  if (cached) {</span>
<span class="sb">    return JSON.parse(cached);</span>
<span class="sb">  }</span>

<span class="sb">  // Náº¿u khÃ´ng cÃ³ cache, query database</span>
<span class="sb">  const messages = await db.query(&#39;SELECT * FROM messages...&#39;);</span>

<span class="sb">  // Cache trong 5 phÃºt</span>
<span class="sb">  await redisClient.setex(cacheKey, 300, JSON.stringify(messages));</span>

<span class="sb">  return messages;</span>
<span class="sb">}</span>
<span class="sb">            `</span><span class="p">,</span>
<span class="w">            </span><span class="nx">expectedImprovement</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Giáº£m 70-90% database load cho read operations&#39;</span>
<span class="w">          </span><span class="p">}</span>
<span class="w">        </span><span class="p">]</span>
<span class="w">      </span><span class="p">});</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nx">optimizeThroughput</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">optimizations</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span>
<span class="w">      </span><span class="nx">category</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;THROUGHPUT&#39;</span><span class="p">,</span>
<span class="w">      </span><span class="nx">optimizations</span><span class="o">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">          </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Horizontal Scaling&#39;</span><span class="p">,</span>
<span class="w">          </span><span class="nx">description</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Scale ra nhiá»u server vá»›i load balancer&#39;</span><span class="p">,</span>
<span class="w">          </span><span class="nx">implementation</span><span class="o">:</span><span class="w"> </span><span class="sb">`</span>
<span class="sb">// Cáº¥u hÃ¬nh Socket.IO vá»›i Redis Adapter</span>
<span class="sb">const io = require(&#39;socket.io&#39;)(server);</span>
<span class="sb">const redisAdapter = require(&#39;socket.io-redis&#39;);</span>

<span class="sb">io.adapter(redisAdapter({</span>
<span class="sb">  host: &#39;redis-server&#39;,</span>
<span class="sb">  port: 6379</span>
<span class="sb">}));</span>

<span class="sb">// Load balancer configuration (nginx)</span>
<span class="sb">/*</span>
<span class="sb">upstream chat_backend {</span>
<span class="sb">  ip_hash; // Giá»¯ user trÃªn cÃ¹ng server</span>
<span class="sb">  server chat1.example.com;</span>
<span class="sb">  server chat2.example.com;</span>
<span class="sb">  server chat3.example.com;</span>
<span class="sb">}</span>
<span class="sb">*/</span>
<span class="sb">            `</span><span class="p">,</span>
<span class="w">          </span><span class="nx">expectedImprovement</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;TÄƒng throughput tuyáº¿n tÃ­nh vá»›i sá»‘ server&#39;</span>
<span class="w">        </span><span class="p">},</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">          </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Message Queue&#39;</span><span class="p">,</span>
<span class="w">          </span><span class="nx">description</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;DÃ¹ng message queue cho async processing&#39;</span><span class="p">,</span>
<span class="w">          </span><span class="nx">implementation</span><span class="o">:</span><span class="w"> </span><span class="sb">`</span>
<span class="sb">// Sá»­ dá»¥ng RabbitMQ/Kafka cho message processing</span>
<span class="sb">const amqp = require(&#39;amqplib&#39;);</span>

<span class="sb">async function processMessage(message) {</span>
<span class="sb">  const connection = await amqp.connect(&#39;amqp://localhost&#39;);</span>
<span class="sb">  const channel = await connection.createChannel();</span>

<span class="sb">  const queue = &#39;chat_messages&#39;;</span>
<span class="sb">  await channel.assertQueue(queue, { durable: true });</span>

<span class="sb">  // Gá»­i message Ä‘áº¿n queue</span>
<span class="sb">  channel.sendToQueue(queue, Buffer.from(JSON.stringify(message)), {</span>
<span class="sb">    persistent: true</span>
<span class="sb">  });</span>

<span class="sb">  // Worker xá»­ lÃ½ message async</span>
<span class="sb">  /*</span>
<span class="sb">  channel.consume(queue, (msg) =&gt; {</span>
<span class="sb">    const message = JSON.parse(msg.content.toString());</span>
<span class="sb">    // Process message (save to DB, analytics, etc.)</span>
<span class="sb">    channel.ack(msg);</span>
<span class="sb">  });</span>
<span class="sb">  */</span>
<span class="sb">}</span>
<span class="sb">            `</span><span class="p">,</span>
<span class="w">          </span><span class="nx">expectedImprovement</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;TÄƒng capacity lÃªn 5-10x&#39;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">      </span><span class="p">]</span>
<span class="w">    </span><span class="p">});</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nx">optimizeMemory</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">report</span><span class="p">.</span><span class="nx">metricsSnapshot</span><span class="p">.</span><span class="nx">resources</span><span class="p">.</span><span class="nx">peak_memory</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">800</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">this</span><span class="p">.</span><span class="nx">optimizations</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span>
<span class="w">        </span><span class="nx">category</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;MEMORY&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="nx">optimizations</span><span class="o">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">          </span><span class="p">{</span>
<span class="w">            </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Connection Cleanup&#39;</span><span class="p">,</span>
<span class="w">            </span><span class="nx">description</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Dá»n dáº¹p connection khÃ´ng hoáº¡t Ä‘á»™ng&#39;</span><span class="p">,</span>
<span class="w">            </span><span class="nx">implementation</span><span class="o">:</span><span class="w"> </span><span class="sb">`</span>
<span class="sb">// Heartbeat mechanism Ä‘á»ƒ phÃ¡t hiá»‡n zombie connections</span>
<span class="sb">const HEARTBEAT_INTERVAL = 30000; // 30 giÃ¢y</span>
<span class="sb">const HEARTBEAT_TIMEOUT = 120000; // 2 phÃºt</span>

<span class="sb">io.on(&#39;connection&#39;, (socket) =&gt; {</span>
<span class="sb">  let isAlive = true;</span>

<span class="sb">  socket.on(&#39;heartbeat&#39;, () =&gt; {</span>
<span class="sb">    isAlive = true;</span>
<span class="sb">  });</span>

<span class="sb">  const heartbeatInterval = setInterval(() =&gt; {</span>
<span class="sb">    if (!isAlive) {</span>
<span class="sb">      console.log(&#39;Zombie connection detected:&#39;, socket.id);</span>
<span class="sb">      socket.disconnect();</span>
<span class="sb">      return;</span>
<span class="sb">    }</span>

<span class="sb">    isAlive = false;</span>
<span class="sb">    socket.emit(&#39;ping&#39;);</span>
<span class="sb">  }, HEARTBEAT_INTERVAL);</span>

<span class="sb">  socket.on(&#39;pong&#39;, () =&gt; {</span>
<span class="sb">    isAlive = true;</span>
<span class="sb">  });</span>

<span class="sb">  socket.on(&#39;disconnect&#39;, () =&gt; {</span>
<span class="sb">    clearInterval(heartbeatInterval);</span>
<span class="sb">  });</span>
<span class="sb">});</span>
<span class="sb">            `</span><span class="p">,</span>
<span class="w">            </span><span class="nx">expectedImprovement</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Giáº£m 30-50% memory usage&#39;</span>
<span class="w">          </span><span class="p">},</span>
<span class="w">          </span><span class="p">{</span>
<span class="w">            </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Streaming Responses&#39;</span><span class="p">,</span>
<span class="w">            </span><span class="nx">description</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Stream dá»¯ liá»‡u thay vÃ¬ load táº¥t cáº£ vÃ o memory&#39;</span><span class="p">,</span>
<span class="w">            </span><span class="nx">implementation</span><span class="o">:</span><span class="w"> </span><span class="sb">`</span>
<span class="sb">// Thay vÃ¬:</span>
<span class="sb">const allMessages = await db.query(&#39;SELECT * FROM messages WHERE room = ?&#39;, [roomId]);</span>
<span class="sb">io.to(roomId).emit(&#39;history&#39;, allMessages); // CÃ³ thá»ƒ ráº¥t lá»›n</span>

<span class="sb">// Sá»­ dá»¥ng streaming:</span>
<span class="sb">function streamRoomHistory(socket, roomId) {</span>
<span class="sb">  const stream = db.queryStream(&#39;SELECT * FROM messages WHERE room = ? ORDER BY timestamp&#39;, [roomId]);</span>

<span class="sb">  let batch = [];</span>
<span class="sb">  stream.on(&#39;data&#39;, (message) =&gt; {</span>
<span class="sb">    batch.push(message);</span>

<span class="sb">    if (batch.length &gt;= 100) {</span>
<span class="sb">      socket.emit(&#39;history_batch&#39;, batch);</span>
<span class="sb">      batch = [];</span>
<span class="sb">    }</span>
<span class="sb">  });</span>

<span class="sb">  stream.on(&#39;end&#39;, () =&gt; {</span>
<span class="sb">    if (batch.length &gt; 0) {</span>
<span class="sb">      socket.emit(&#39;history_batch&#39;, batch);</span>
<span class="sb">    }</span>
<span class="sb">    socket.emit(&#39;history_complete&#39;);</span>
<span class="sb">  });</span>
<span class="sb">}</span>
<span class="sb">            `</span><span class="p">,</span>
<span class="w">            </span><span class="nx">expectedImprovement</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Giáº£m peak memory usage&#39;</span>
<span class="w">          </span><span class="p">}</span>
<span class="w">        </span><span class="p">]</span>
<span class="w">      </span><span class="p">});</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nx">optimizeReliability</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">optimizations</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span>
<span class="w">      </span><span class="nx">category</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;RELIABILITY&#39;</span><span class="p">,</span>
<span class="w">      </span><span class="nx">optimizations</span><span class="o">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">          </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Circuit Breaker Pattern&#39;</span><span class="p">,</span>
<span class="w">          </span><span class="nx">description</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;NgÄƒn cascade failure khi service phá»¥ thuá»™c bá»‹ lá»—i&#39;</span><span class="p">,</span>
<span class="w">          </span><span class="nx">implementation</span><span class="o">:</span><span class="w"> </span><span class="sb">`</span>
<span class="sb">class CircuitBreaker {</span>
<span class="sb">  constructor(failureThreshold = 5, resetTimeout = 60000) {</span>
<span class="sb">    this.failureThreshold = failureThreshold;</span>
<span class="sb">    this.resetTimeout = resetTimeout;</span>
<span class="sb">    this.failureCount = 0;</span>
<span class="sb">    this.state = &#39;CLOSED&#39;;</span>
<span class="sb">    this.nextAttempt = Date.now();</span>
<span class="sb">  }</span>

<span class="sb">  async execute(serviceCall) {</span>
<span class="sb">    if (this.state === &#39;OPEN&#39;) {</span>
<span class="sb">      if (Date.now() &gt; this.nextAttempt) {</span>
<span class="sb">        this.state = &#39;HALF_OPEN&#39;;</span>
<span class="sb">      } else {</span>
<span class="sb">        throw new Error(&#39;Circuit breaker is OPEN&#39;);</span>
<span class="sb">      }</span>
<span class="sb">    }</span>

<span class="sb">    try {</span>
<span class="sb">      const result = await serviceCall();</span>
<span class="sb">      this.success();</span>
<span class="sb">      return result;</span>
<span class="sb">    } catch (error) {</span>
<span class="sb">      this.failure();</span>
<span class="sb">      throw error;</span>
<span class="sb">    }</span>
<span class="sb">  }</span>

<span class="sb">  success() {</span>
<span class="sb">    this.failureCount = 0;</span>
<span class="sb">    this.state = &#39;CLOSED&#39;;</span>
<span class="sb">  }</span>

<span class="sb">  failure() {</span>
<span class="sb">    this.failureCount++;</span>
<span class="sb">    if (this.failureCount &gt;= this.failureThreshold) {</span>
<span class="sb">      this.state = &#39;OPEN&#39;;</span>
<span class="sb">      this.nextAttempt = Date.now() + this.resetTimeout;</span>
<span class="sb">    }</span>
<span class="sb">  }</span>
<span class="sb">}</span>

<span class="sb">// Sá»­ dá»¥ng</span>
<span class="sb">const breaker = new CircuitBreaker();</span>
<span class="sb">try {</span>
<span class="sb">  const userData = await breaker.execute(() =&gt; getUserService(userId));</span>
<span class="sb">  // Process user data</span>
<span class="sb">} catch (error) {</span>
<span class="sb">  // Fallback hoáº·c retry logic</span>
<span class="sb">}</span>
<span class="sb">            `</span><span class="p">,</span>
<span class="w">          </span><span class="nx">expectedImprovement</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;NgÄƒn cascade failures, tÄƒng system resilience&#39;</span>
<span class="w">        </span><span class="p">},</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">          </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Retry vá»›i Exponential Backoff&#39;</span><span class="p">,</span>
<span class="w">          </span><span class="nx">description</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Tá»± Ä‘á»™ng retry failed operations vá»›i delay tÄƒng dáº§n&#39;</span><span class="p">,</span>
<span class="w">          </span><span class="nx">implementation</span><span class="o">:</span><span class="w"> </span><span class="sb">`</span>
<span class="sb">async function retryWithBackoff(operation, maxRetries = 5) {</span>
<span class="sb">  let lastError;</span>

<span class="sb">  for (let attempt = 1; attempt &lt;= maxRetries; attempt++) {</span>
<span class="sb">    try {</span>
<span class="sb">      return await operation();</span>
<span class="sb">    } catch (error) {</span>
<span class="sb">      lastError = error;</span>

<span class="sb">      if (attempt === maxRetries) {</span>
<span class="sb">        break;</span>
<span class="sb">      }</span>

<span class="sb">      // Exponential backoff</span>
<span class="sb">      const delay = Math.min(1000 * Math.pow(2, attempt), 30000);</span>
<span class="sb">      console.log(\`Retry attempt \${attempt} after \${delay}ms\`);</span>

<span class="sb">      await new Promise(resolve =&gt; setTimeout(resolve, delay));</span>
<span class="sb">    }</span>
<span class="sb">  }</span>

<span class="sb">  throw lastError;</span>
<span class="sb">}</span>

<span class="sb">// Sá»­ dá»¥ng</span>
<span class="sb">try {</span>
<span class="sb">  const message = await retryWithBackoff(</span>
<span class="sb">    () =&gt; sendMessageToService(messageData),</span>
<span class="sb">    3</span>
<span class="sb">  );</span>
<span class="sb">} catch (error) {</span>
<span class="sb">  console.error(&#39;Failed after retries:&#39;, error);</span>
<span class="sb">}</span>
<span class="sb">            `</span><span class="p">,</span>
<span class="w">          </span><span class="nx">expectedImprovement</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;TÄƒng success rate cho transient failures&#39;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">      </span><span class="p">]</span>
<span class="w">    </span><span class="p">});</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>

<span class="c1">// Sá»­ dá»¥ng optimizer</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">optimizer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">ChatOptimizer</span><span class="p">(</span><span class="nx">report</span><span class="p">);</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">optimizations</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">optimizer</span><span class="p">.</span><span class="nx">suggestOptimizations</span><span class="p">();</span>

<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;ğŸ”§ SUGGESTED OPTIMIZATIONS:&#39;</span><span class="p">);</span>
<span class="nx">optimizations</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="nx">category</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`\n=== </span><span class="si">${</span><span class="nx">category</span><span class="p">.</span><span class="nx">category</span><span class="si">}</span><span class="sb"> ===`</span><span class="p">);</span>
<span class="w">  </span><span class="nx">category</span><span class="p">.</span><span class="nx">optimizations</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="nx">opt</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`\nğŸ“Œ </span><span class="si">${</span><span class="nx">opt</span><span class="p">.</span><span class="nx">name</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>
<span class="w">    </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`ğŸ“ </span><span class="si">${</span><span class="nx">opt</span><span class="p">.</span><span class="nx">description</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>
<span class="w">    </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`ğŸš€ Expected: </span><span class="si">${</span><span class="nx">opt</span><span class="p">.</span><span class="nx">expectedImprovement</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>
<span class="w">  </span><span class="p">});</span>
<span class="p">});</span>
</code></pre></div>
<hr />
<h3 id="chuong-5-checklist-va-template-cho-qasdet">ğŸ¯ CHÆ¯Æ NG 5: CHECKLIST VÃ€ TEMPLATE CHO QA/SDET<a class="headerlink" href="#chuong-5-checklist-va-template-cho-qasdet" title="Permanent link">&para;</a></h3>
<h4 id="51-performance-test-checklist">5.1. Performance Test Checklist<a class="headerlink" href="#51-performance-test-checklist" title="Permanent link">&para;</a></h4>
<p><strong>CHAT APPLICATION PERFORMANCE TEST CHECKLIST</strong></p>
<h5 id="pre-test-preparation">ğŸ—ï¸ PRE-TEST PREPARATION<a class="headerlink" href="#pre-test-preparation" title="Permanent link">&para;</a></h5>
<p><strong>Environment Setup</strong>
- [ ] Test environment mirroring production specs
- [ ] Database with representative data (1M+ messages, 100k+ users)
- [ ] Monitoring tools installed (Prometheus, Grafana, ELK Stack)
- [ ] Load balancer configured (if applicable)
- [ ] CDN/caching layers configured</p>
<p><strong>Test Data Preparation</strong>
- [ ] User accounts for different roles (admin, moderator, regular user)
- [ ] Chat rooms of various sizes (1:1, small group &lt;10, large group 10-100, broadcast 100+)
- [ ] Message history (last 30 days of activity)
- [ ] Media files for testing (images, videos, documents)</p>
<p><strong>Test Script Validation</strong>
- [ ] Smoke test passed with 10 VUs
- [ ] Script handles all expected message types (text, image, file, reaction)
- [ ] Authentication flow tested
- [ ] Error handling implemented
- [ ] Data validation in place</p>
<h5 id="test-execution">âš¡ TEST EXECUTION<a class="headerlink" href="#test-execution" title="Permanent link">&para;</a></h5>
<p><strong>Baseline Test (1 hour)</strong>
- [ ] 100 concurrent users
- [ ] Measure baseline latency (p95 &lt; 50ms)
- [ ] Measure baseline throughput
- [ ] Verify no errors
- [ ] Document CPU/Memory usage</p>
<p><strong>Load Test (2 hours)</strong>
- [ ] 1,000 concurrent users
- [ ] Ramp up over 30 minutes
- [ ] Sustain for 1 hour
- [ ] Ramp down over 30 minutes
- [ ] Verify p95 latency &lt; 100ms
- [ ] Document resource usage patterns</p>
<p><strong>Stress Test (4 hours)</strong>
- [ ] 10,000 concurrent users
- [ ] Spike to 20,000 for 5 minutes
- [ ] Verify system recovers after spike
- [ ] Check for memory leaks
- [ ] Document failure points</p>
<p><strong>Soak/Endurance Test (24+ hours)</strong>
- [ ] 5,000 concurrent users sustained
- [ ] Monitor for memory growth
- [ ] Check connection stability
- [ ] Verify message persistence
- [ ] Document any degradation over time</p>
<h5 id="metrics-validation">ğŸ“Š METRICS VALIDATION<a class="headerlink" href="#metrics-validation" title="Permanent link">&para;</a></h5>
<p><strong>Performance Metrics</strong>
- [ ] Message latency: p95 &lt; 100ms, p99 &lt; 250ms
- [ ] Connection establishment: &lt; 2 seconds
- [ ] Authentication time: &lt; 1 second
- [ ] Message throughput: Meets business requirements
- [ ] Error rate: &lt; 0.1%</p>
<p><strong>Resource Metrics</strong>
- [ ] CPU usage: &lt; 70% under peak load
- [ ] Memory usage: Stable over 24 hours
- [ ] Network throughput: Within infrastructure limits
- [ ] Database connections: Within pool limits
- [ ] Disk I/O: Within acceptable range</p>
<p><strong>Business Metrics</strong>
- [ ] User satisfaction score: &gt; 90%
- [ ] Message delivery rate: &gt; 99.9%
- [ ] Uptime during test: 100%
- [ ] Recovery time from failure: &lt; 5 minutes</p>
<h5 id="failure-scenarios-tested">ğŸ› FAILURE SCENARIOS TESTED<a class="headerlink" href="#failure-scenarios-tested" title="Permanent link">&para;</a></h5>
<p><strong>Network Issues</strong>
- [ ] Sudden connection loss
- [ ] Slow network (high latency)
- [ ] Packet loss (0.1%, 1%, 5%)
- [ ] DNS failure
- [ ] Load balancer failure</p>
<p><strong>Server Issues</strong>
- [ ] Single node failure
- [ ] Database connection loss
- [ ] Cache server failure
- [ ] File storage failure
- [ ] Service dependency failure</p>
<p><strong>Application Issues</strong>
- [ ] High memory consumption
- [ ] Database deadlock
- [ ] Message queue overflow
- [ ] Rate limiting triggers
- [ ] Authentication service outage</p>
<h5 id="post-test-analysis">ğŸ“ˆ POST-TEST ANALYSIS<a class="headerlink" href="#post-test-analysis" title="Permanent link">&para;</a></h5>
<p><strong>Data Collection</strong>
- [ ] All test logs archived
- [ ] Performance metrics exported
- [ ] Server monitoring data saved
- [ ] Error logs collected and categorized
- [ ] User experience feedback simulated</p>
<p><strong>Analysis</strong>
- [ ] Bottlenecks identified and documented
- [ ] Capacity limits established
- [ ] Scaling recommendations provided
- [ ] Cost projections updated
- [ ] Risk assessment completed</p>
<p><strong>Reporting</strong>
- [ ] Executive summary created
- [ ] Technical details documented
- [ ] Recommendations prioritized
- [ ] Action items assigned
- [ ] Follow-up tests scheduled</p>
<h5 id="continuous-testing">ğŸ”„ CONTINUOUS TESTING<a class="headerlink" href="#continuous-testing" title="Permanent link">&para;</a></h5>
<p><strong>Integration</strong>
- [ ] Tests integrated into CI/CD pipeline
- [ ] Automated daily performance tests
- [ ] Performance regression detection
- [ ] Alerting for performance degradation
- [ ] Capacity planning automation</p>
<p><strong>Maintenance</strong>
- [ ] Test scripts updated with new features
- [ ] Test data refreshed regularly
- [ ] Thresholds reviewed quarterly
- [ ] Tools and frameworks kept current
- [ ] Team training on performance testing</p>
<h4 id="52-security-test-template">5.2. Security Test Template<a class="headerlink" href="#52-security-test-template" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1">// security-test-template.js</span>
<span class="kd">class</span><span class="w"> </span><span class="nx">ChatSecurityTest</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kr">constructor</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">tests</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">authentication</span><span class="o">:</span><span class="w"> </span><span class="p">[],</span>
<span class="w">      </span><span class="nx">authorization</span><span class="o">:</span><span class="w"> </span><span class="p">[],</span>
<span class="w">      </span><span class="nx">dataProtection</span><span class="o">:</span><span class="w"> </span><span class="p">[],</span>
<span class="w">      </span><span class="nx">infrastructure</span><span class="o">:</span><span class="w"> </span><span class="p">[]</span>
<span class="w">    </span><span class="p">};</span>

<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">results</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">passed</span><span class="o">:</span><span class="w"> </span><span class="mf">0</span><span class="p">,</span>
<span class="w">      </span><span class="nx">failed</span><span class="o">:</span><span class="w"> </span><span class="mf">0</span><span class="p">,</span>
<span class="w">      </span><span class="nx">warnings</span><span class="o">:</span><span class="w"> </span><span class="mf">0</span><span class="p">,</span>
<span class="w">      </span><span class="nx">vulnerabilities</span><span class="o">:</span><span class="w"> </span><span class="p">[]</span>
<span class="w">    </span><span class="p">};</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nx">runAllTests</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;ğŸ”’ Báº®T Äáº¦U SECURITY TESTING&#39;</span><span class="p">);</span>

<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">testAuthentication</span><span class="p">();</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">testAuthorization</span><span class="p">();</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">testDataProtection</span><span class="p">();</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">testInfrastructure</span><span class="p">();</span>

<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">generateSecurityReport</span><span class="p">();</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nx">testAuthentication</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;\n=== AUTHENTICATION TESTS ===&#39;</span><span class="p">);</span>

<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">tests</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span>
<span class="w">      </span><span class="p">{</span>
<span class="w">        </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Token Validation&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="nx">description</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Verify JWT tokens are properly validated&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="nx">test</span><span class="o">:</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="c1">// Test vá»›i token háº¿t háº¡n</span>
<span class="w">          </span><span class="kd">const</span><span class="w"> </span><span class="nx">expiredToken</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9...&#39;</span><span class="p">;</span>
<span class="w">          </span><span class="kd">const</span><span class="w"> </span><span class="nx">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">authenticateWithToken</span><span class="p">(</span><span class="nx">expiredToken</span><span class="p">);</span>
<span class="w">          </span><span class="k">return</span><span class="w"> </span><span class="nx">result</span><span class="p">.</span><span class="nx">success</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span>
<span class="w">        </span><span class="p">},</span>
<span class="w">        </span><span class="nx">severity</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;HIGH&#39;</span>
<span class="w">      </span><span class="p">},</span>
<span class="w">      </span><span class="p">{</span>
<span class="w">        </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Token Replay Prevention&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="nx">description</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Prevent reuse of the same token&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="nx">test</span><span class="o">:</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="kd">const</span><span class="w"> </span><span class="nx">token</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">getValidToken</span><span class="p">();</span>

<span class="w">          </span><span class="c1">// Sá»­ dá»¥ng token nhiá»u láº§n</span>
<span class="w">          </span><span class="kd">const</span><span class="w"> </span><span class="nx">result1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">authenticateWithToken</span><span class="p">(</span><span class="nx">token</span><span class="p">);</span>
<span class="w">          </span><span class="kd">const</span><span class="w"> </span><span class="nx">result2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">authenticateWithToken</span><span class="p">(</span><span class="nx">token</span><span class="p">);</span>

<span class="w">          </span><span class="k">return</span><span class="w"> </span><span class="nx">result1</span><span class="p">.</span><span class="nx">success</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">result2</span><span class="p">.</span><span class="nx">success</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span>
<span class="w">        </span><span class="p">},</span>
<span class="w">        </span><span class="nx">severity</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;MEDIUM&#39;</span>
<span class="w">      </span><span class="p">},</span>
<span class="w">      </span><span class="p">{</span>
<span class="w">        </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Brute Force Protection&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="nx">description</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Rate limiting on authentication attempts&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="nx">test</span><span class="o">:</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="kd">const</span><span class="w"> </span><span class="nx">attempts</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[];</span>
<span class="w">          </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">let</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mf">10</span><span class="p">;</span><span class="w"> </span><span class="nx">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">attempts</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">authenticateWithToken</span><span class="p">(</span><span class="s1">&#39;invalid_token&#39;</span><span class="p">));</span>
<span class="w">          </span><span class="p">}</span>

<span class="w">          </span><span class="kd">const</span><span class="w"> </span><span class="nx">results</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nb">Promise</span><span class="p">.</span><span class="nx">all</span><span class="p">(</span><span class="nx">attempts</span><span class="p">);</span>
<span class="w">          </span><span class="kd">const</span><span class="w"> </span><span class="nx">blockedAttempts</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">results</span><span class="p">.</span><span class="nx">filter</span><span class="p">(</span><span class="nx">r</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">r</span><span class="p">.</span><span class="nx">blocked</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="kc">true</span><span class="p">);</span>

<span class="w">          </span><span class="k">return</span><span class="w"> </span><span class="nx">blockedAttempts</span><span class="p">.</span><span class="nx">length</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mf">5</span><span class="p">;</span><span class="w"> </span><span class="c1">// Ãt nháº¥t 5 láº§n bá»‹ block</span>
<span class="w">        </span><span class="p">},</span>
<span class="w">        </span><span class="nx">severity</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;HIGH&#39;</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">];</span>

<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">executeTests</span><span class="p">(</span><span class="nx">tests</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;authentication&#39;</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nx">testAuthorization</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;\n=== AUTHORIZATION TESTS ===&#39;</span><span class="p">);</span>

<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">tests</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span>
<span class="w">      </span><span class="p">{</span>
<span class="w">        </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Room Access Control&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="nx">description</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Users cannot access rooms they are not members of&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="nx">test</span><span class="o">:</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="c1">// User A thá»­ join room cá»§a User B</span>
<span class="w">          </span><span class="kd">const</span><span class="w"> </span><span class="nx">userAToken</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">getTokenForUser</span><span class="p">(</span><span class="s1">&#39;user_a&#39;</span><span class="p">);</span>
<span class="w">          </span><span class="kd">const</span><span class="w"> </span><span class="nx">userBRoom</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;private_room_user_b&#39;</span><span class="p">;</span>

<span class="w">          </span><span class="kd">const</span><span class="w"> </span><span class="nx">ws</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">connectWebSocket</span><span class="p">(</span><span class="nx">userAToken</span><span class="p">);</span>
<span class="w">          </span><span class="kd">const</span><span class="w"> </span><span class="nx">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">joinRoom</span><span class="p">(</span><span class="nx">ws</span><span class="p">,</span><span class="w"> </span><span class="nx">userBRoom</span><span class="p">);</span>

<span class="w">          </span><span class="k">return</span><span class="w"> </span><span class="nx">result</span><span class="p">.</span><span class="nx">success</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span>
<span class="w">        </span><span class="p">},</span>
<span class="w">        </span><span class="nx">severity</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;HIGH&#39;</span>
<span class="w">      </span><span class="p">},</span>
<span class="w">      </span><span class="p">{</span>
<span class="w">        </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Message Access Control&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="nx">description</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Users cannot read messages from private conversations&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="nx">test</span><span class="o">:</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="kd">const</span><span class="w"> </span><span class="nx">userAToken</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">getTokenForUser</span><span class="p">(</span><span class="s1">&#39;user_a&#39;</span><span class="p">);</span>
<span class="w">          </span><span class="kd">const</span><span class="w"> </span><span class="nx">messageId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;private_msg_user_b_to_user_c&#39;</span><span class="p">;</span>

<span class="w">          </span><span class="kd">const</span><span class="w"> </span><span class="nx">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">getMessage</span><span class="p">(</span><span class="nx">messageId</span><span class="p">,</span><span class="w"> </span><span class="nx">userAToken</span><span class="p">);</span>

<span class="w">          </span><span class="k">return</span><span class="w"> </span><span class="nx">result</span><span class="p">.</span><span class="nx">success</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span>
<span class="w">        </span><span class="p">},</span>
<span class="w">        </span><span class="nx">severity</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;HIGH&#39;</span>
<span class="w">      </span><span class="p">},</span>
<span class="w">      </span><span class="p">{</span>
<span class="w">        </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Admin Privilege Escalation&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="nx">description</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Regular users cannot perform admin actions&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="nx">test</span><span class="o">:</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="kd">const</span><span class="w"> </span><span class="nx">regularUserToken</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">getTokenForUser</span><span class="p">(</span><span class="s1">&#39;regular_user&#39;</span><span class="p">);</span>

<span class="w">          </span><span class="c1">// Thá»­ delete message (admin action)</span>
<span class="w">          </span><span class="kd">const</span><span class="w"> </span><span class="nx">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">deleteMessage</span><span class="p">(</span><span class="s1">&#39;any_message_id&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">regularUserToken</span><span class="p">);</span>

<span class="w">          </span><span class="k">return</span><span class="w"> </span><span class="nx">result</span><span class="p">.</span><span class="nx">success</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span>
<span class="w">        </span><span class="p">},</span>
<span class="w">        </span><span class="nx">severity</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;CRITICAL&#39;</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">];</span>

<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">executeTests</span><span class="p">(</span><span class="nx">tests</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;authorization&#39;</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nx">testDataProtection</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;\n=== DATA PROTECTION TESTS ===&#39;</span><span class="p">);</span>

<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">tests</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span>
<span class="w">      </span><span class="p">{</span>
<span class="w">        </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;End-to-End Encryption&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="nx">description</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Messages encrypted client-side&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="nx">test</span><span class="o">:</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="kd">const</span><span class="w"> </span><span class="nx">message</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;Sensitive information&#39;</span><span class="p">;</span>
<span class="w">          </span><span class="kd">const</span><span class="w"> </span><span class="nx">encrypted</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">encryptMessage</span><span class="p">(</span><span class="nx">message</span><span class="p">);</span>

<span class="w">          </span><span class="c1">// Server chá»‰ tháº¥y ciphertext</span>
<span class="w">          </span><span class="kd">const</span><span class="w"> </span><span class="nx">serverSees</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">sendMessageThroughServer</span><span class="p">(</span><span class="nx">encrypted</span><span class="p">);</span>

<span class="w">          </span><span class="k">return</span><span class="w"> </span><span class="nx">serverSees</span><span class="p">.</span><span class="nx">plaintext</span><span class="w"> </span><span class="o">!==</span><span class="w"> </span><span class="nx">message</span><span class="p">;</span>
<span class="w">        </span><span class="p">},</span>
<span class="w">        </span><span class="nx">severity</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;HIGH&#39;</span>
<span class="w">      </span><span class="p">},</span>
<span class="w">      </span><span class="p">{</span>
<span class="w">        </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Data at Rest Encryption&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="nx">description</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Database stores encrypted messages&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="nx">test</span><span class="o">:</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="c1">// Query database directly</span>
<span class="w">          </span><span class="kd">const</span><span class="w"> </span><span class="nx">dbResult</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">queryDatabase</span><span class="p">(</span><span class="s1">&#39;SELECT content FROM messages LIMIT 1&#39;</span><span class="p">);</span>
<span class="w">          </span><span class="kd">const</span><span class="w"> </span><span class="nx">messageContent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">dbResult</span><span class="p">.</span><span class="nx">rows</span><span class="p">[</span><span class="mf">0</span><span class="p">].</span><span class="nx">content</span><span class="p">;</span>

<span class="w">          </span><span class="c1">// Ná»™i dung pháº£i lÃ  ciphertext, khÃ´ng pháº£i plaintext</span>
<span class="w">          </span><span class="k">return</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">looksLikeCiphertext</span><span class="p">(</span><span class="nx">messageContent</span><span class="p">);</span>
<span class="w">        </span><span class="p">},</span>
<span class="w">        </span><span class="nx">severity</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;MEDIUM&#39;</span>
<span class="w">      </span><span class="p">},</span>
<span class="w">      </span><span class="p">{</span>
<span class="w">        </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Logging Security&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="nx">description</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Sensitive data not logged in plaintext&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="nx">test</span><span class="o">:</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="kd">const</span><span class="w"> </span><span class="nx">sensitiveMessage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;Credit card: 4111-1111-1111-1111&#39;</span><span class="p">;</span>
<span class="w">          </span><span class="k">await</span><span class="w"> </span><span class="nx">sendMessage</span><span class="p">(</span><span class="nx">sensitiveMessage</span><span class="p">);</span>

<span class="w">          </span><span class="c1">// Check application logs</span>
<span class="w">          </span><span class="kd">const</span><span class="w"> </span><span class="nx">logs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">getApplicationLogs</span><span class="p">();</span>
<span class="w">          </span><span class="kd">const</span><span class="w"> </span><span class="nx">containsSensitiveData</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">logs</span><span class="p">.</span><span class="nx">some</span><span class="p">(</span><span class="nx">log</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span>
<span class="w">            </span><span class="nx">log</span><span class="p">.</span><span class="nx">includes</span><span class="p">(</span><span class="s1">&#39;4111-1111-1111-1111&#39;</span><span class="p">)</span>
<span class="w">          </span><span class="p">);</span>

<span class="w">          </span><span class="k">return</span><span class="w"> </span><span class="o">!</span><span class="nx">containsSensitiveData</span><span class="p">;</span>
<span class="w">        </span><span class="p">},</span>
<span class="w">        </span><span class="nx">severity</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;HIGH&#39;</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">];</span>

<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">executeTests</span><span class="p">(</span><span class="nx">tests</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;dataProtection&#39;</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nx">testInfrastructure</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;\n=== INFRASTRUCTURE TESTS ===&#39;</span><span class="p">);</span>

<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">tests</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span>
<span class="w">      </span><span class="p">{</span>
<span class="w">        </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;WebSocket Security (WSS)&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="nx">description</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;WebSocket connections use TLS&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="nx">test</span><span class="o">:</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="kd">const</span><span class="w"> </span><span class="nx">response</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">fetch</span><span class="p">(</span><span class="s1">&#39;http://localhost:3000/socket.io/&#39;</span><span class="p">);</span>
<span class="w">          </span><span class="kd">const</span><span class="w"> </span><span class="nx">usesWSS</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">response</span><span class="p">.</span><span class="nx">url</span><span class="p">.</span><span class="nx">startsWith</span><span class="p">(</span><span class="s1">&#39;wss://&#39;</span><span class="p">);</span>

<span class="w">          </span><span class="k">return</span><span class="w"> </span><span class="nx">usesWSS</span><span class="p">;</span>
<span class="w">        </span><span class="p">},</span>
<span class="w">        </span><span class="nx">severity</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;HIGH&#39;</span>
<span class="w">      </span><span class="p">},</span>
<span class="w">      </span><span class="p">{</span>
<span class="w">        </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;CORS Configuration&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="nx">description</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Proper CORS headers to prevent CSRF&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="nx">test</span><span class="o">:</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="kd">const</span><span class="w"> </span><span class="nx">response</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">fetch</span><span class="p">(</span><span class="s1">&#39;http://localhost:3000/&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">headers</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">Origin</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;http://malicious-site.com&#39;</span><span class="w"> </span><span class="p">}</span>
<span class="w">          </span><span class="p">});</span>

<span class="w">          </span><span class="kd">const</span><span class="w"> </span><span class="nx">corsHeader</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">response</span><span class="p">.</span><span class="nx">headers</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;Access-Control-Allow-Origin&#39;</span><span class="p">);</span>
<span class="w">          </span><span class="k">return</span><span class="w"> </span><span class="nx">corsHeader</span><span class="w"> </span><span class="o">!==</span><span class="w"> </span><span class="s1">&#39;*&#39;</span><span class="p">;</span><span class="w"> </span><span class="c1">// KhÃ´ng Ä‘Æ°á»£c phÃ©p táº¥t cáº£ domains</span>
<span class="w">        </span><span class="p">},</span>
<span class="w">        </span><span class="nx">severity</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;MEDIUM&#39;</span>
<span class="w">      </span><span class="p">},</span>
<span class="w">      </span><span class="p">{</span>
<span class="w">        </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;DDoS Protection&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="nx">description</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Rate limiting on WebSocket connections&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="nx">test</span><span class="o">:</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="kd">const</span><span class="w"> </span><span class="nx">connections</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[];</span>
<span class="w">          </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">let</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mf">100</span><span class="p">;</span><span class="w"> </span><span class="nx">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">connections</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">connectWebSocket</span><span class="p">());</span>
<span class="w">          </span><span class="p">}</span>

<span class="w">          </span><span class="kd">const</span><span class="w"> </span><span class="nx">results</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nb">Promise</span><span class="p">.</span><span class="nx">allSettled</span><span class="p">(</span><span class="nx">connections</span><span class="p">);</span>
<span class="w">          </span><span class="kd">const</span><span class="w"> </span><span class="nx">rejected</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">results</span><span class="p">.</span><span class="nx">filter</span><span class="p">(</span><span class="nx">r</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">r</span><span class="p">.</span><span class="nx">status</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;rejected&#39;</span><span class="p">);</span>

<span class="w">          </span><span class="k">return</span><span class="w"> </span><span class="nx">rejected</span><span class="p">.</span><span class="nx">length</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span><span class="w"> </span><span class="c1">// Má»™t sá»‘ pháº£i bá»‹ reject</span>
<span class="w">        </span><span class="p">},</span>
<span class="w">        </span><span class="nx">severity</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;HIGH&#39;</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">];</span>

<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">executeTests</span><span class="p">(</span><span class="nx">tests</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;infrastructure&#39;</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">async</span><span class="w"> </span><span class="nx">executeTests</span><span class="p">(</span><span class="nx">testCases</span><span class="p">,</span><span class="w"> </span><span class="nx">category</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">const</span><span class="w"> </span><span class="nx">testCase</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="nx">testCases</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`\nRunning: </span><span class="si">${</span><span class="nx">testCase</span><span class="p">.</span><span class="nx">name</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>
<span class="w">        </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`Description: </span><span class="si">${</span><span class="nx">testCase</span><span class="p">.</span><span class="nx">description</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>

<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">testCase</span><span class="p">.</span><span class="nx">test</span><span class="p">();</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">result</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`âœ… PASSED: </span><span class="si">${</span><span class="nx">testCase</span><span class="p">.</span><span class="nx">name</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>
<span class="w">          </span><span class="k">this</span><span class="p">.</span><span class="nx">results</span><span class="p">.</span><span class="nx">passed</span><span class="o">++</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`âŒ FAILED: </span><span class="si">${</span><span class="nx">testCase</span><span class="p">.</span><span class="nx">name</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>
<span class="w">          </span><span class="k">this</span><span class="p">.</span><span class="nx">results</span><span class="p">.</span><span class="nx">failed</span><span class="o">++</span><span class="p">;</span>

<span class="w">          </span><span class="k">this</span><span class="p">.</span><span class="nx">results</span><span class="p">.</span><span class="nx">vulnerabilities</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span>
<span class="w">            </span><span class="nx">category</span><span class="p">,</span>
<span class="w">            </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="nx">testCase</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span>
<span class="w">            </span><span class="nx">severity</span><span class="o">:</span><span class="w"> </span><span class="nx">testCase</span><span class="p">.</span><span class="nx">severity</span><span class="p">,</span>
<span class="w">            </span><span class="nx">description</span><span class="o">:</span><span class="w"> </span><span class="nx">testCase</span><span class="p">.</span><span class="nx">description</span>
<span class="w">          </span><span class="p">});</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">      </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="nx">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`âš ï¸ ERROR in </span><span class="si">${</span><span class="nx">testCase</span><span class="p">.</span><span class="nx">name</span><span class="si">}</span><span class="sb">:`</span><span class="p">,</span><span class="w"> </span><span class="nx">error</span><span class="p">.</span><span class="nx">message</span><span class="p">);</span>
<span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="nx">results</span><span class="p">.</span><span class="nx">warnings</span><span class="o">++</span><span class="p">;</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nx">generateSecurityReport</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;\n&#39;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s1">&#39;=&#39;</span><span class="p">.</span><span class="nx">repeat</span><span class="p">(</span><span class="mf">50</span><span class="p">));</span>
<span class="w">    </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;ğŸ”’ SECURITY TEST REPORT&#39;</span><span class="p">);</span>
<span class="w">    </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="p">.</span><span class="nx">repeat</span><span class="p">(</span><span class="mf">50</span><span class="p">));</span>

<span class="w">    </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`\nğŸ“Š Summary:`</span><span class="p">);</span>
<span class="w">    </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`Passed: </span><span class="si">${</span><span class="k">this</span><span class="p">.</span><span class="nx">results</span><span class="p">.</span><span class="nx">passed</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>
<span class="w">    </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`Failed: </span><span class="si">${</span><span class="k">this</span><span class="p">.</span><span class="nx">results</span><span class="p">.</span><span class="nx">failed</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>
<span class="w">    </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`Warnings: </span><span class="si">${</span><span class="k">this</span><span class="p">.</span><span class="nx">results</span><span class="p">.</span><span class="nx">warnings</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">results</span><span class="p">.</span><span class="nx">vulnerabilities</span><span class="p">.</span><span class="nx">length</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`\nâš ï¸ VULNERABILITIES FOUND:`</span><span class="p">);</span>

<span class="w">      </span><span class="c1">// NhÃ³m theo severity</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">bySeverity</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">results</span><span class="p">.</span><span class="nx">vulnerabilities</span><span class="p">.</span><span class="nx">reduce</span><span class="p">((</span><span class="nx">acc</span><span class="p">,</span><span class="w"> </span><span class="nx">vuln</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">acc</span><span class="p">[</span><span class="nx">vuln</span><span class="p">.</span><span class="nx">severity</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">acc</span><span class="p">[</span><span class="nx">vuln</span><span class="p">.</span><span class="nx">severity</span><span class="p">]</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="p">[];</span>
<span class="w">        </span><span class="nx">acc</span><span class="p">[</span><span class="nx">vuln</span><span class="p">.</span><span class="nx">severity</span><span class="p">].</span><span class="nx">push</span><span class="p">(</span><span class="nx">vuln</span><span class="p">);</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nx">acc</span><span class="p">;</span>
<span class="w">      </span><span class="p">},</span><span class="w"> </span><span class="p">{});</span>

<span class="w">      </span><span class="c1">// In theo thá»© tá»± severity</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">severityOrder</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="s1">&#39;CRITICAL&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;HIGH&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;MEDIUM&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;LOW&#39;</span><span class="p">];</span>

<span class="w">      </span><span class="nx">severityOrder</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="nx">severity</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">bySeverity</span><span class="p">[</span><span class="nx">severity</span><span class="p">])</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`\n</span><span class="si">${</span><span class="s1">&#39;=&#39;</span><span class="p">.</span><span class="nx">repeat</span><span class="p">(</span><span class="mf">30</span><span class="p">)</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>
<span class="w">          </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`</span><span class="si">${</span><span class="nx">severity</span><span class="si">}</span><span class="sb"> SEVERITY (</span><span class="si">${</span><span class="nx">bySeverity</span><span class="p">[</span><span class="nx">severity</span><span class="p">].</span><span class="nx">length</span><span class="si">}</span><span class="sb"> found)`</span><span class="p">);</span>
<span class="w">          </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="p">.</span><span class="nx">repeat</span><span class="p">(</span><span class="mf">30</span><span class="p">));</span>

<span class="w">          </span><span class="nx">bySeverity</span><span class="p">[</span><span class="nx">severity</span><span class="p">].</span><span class="nx">forEach</span><span class="p">((</span><span class="nx">vuln</span><span class="p">,</span><span class="w"> </span><span class="nx">index</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`\n</span><span class="si">${</span><span class="nx">index</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">1</span><span class="si">}</span><span class="sb">. </span><span class="si">${</span><span class="nx">vuln</span><span class="p">.</span><span class="nx">name</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>
<span class="w">            </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`   Category: </span><span class="si">${</span><span class="nx">vuln</span><span class="p">.</span><span class="nx">category</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>
<span class="w">            </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`   Description: </span><span class="si">${</span><span class="nx">vuln</span><span class="p">.</span><span class="nx">description</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>
<span class="w">          </span><span class="p">});</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">      </span><span class="p">});</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// Recommendations</span>
<span class="w">    </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`\nğŸ’¡ RECOMMENDATIONS:`</span><span class="p">);</span>

<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">recommendations</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[];</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">results</span><span class="p">.</span><span class="nx">vulnerabilities</span><span class="p">.</span><span class="nx">some</span><span class="p">(</span><span class="nx">v</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">v</span><span class="p">.</span><span class="nx">severity</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;CRITICAL&#39;</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">recommendations</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span>
<span class="w">        </span><span class="nx">priority</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;IMMEDIATE&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="nx">action</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Fix critical vulnerabilities before deployment&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="nx">details</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Critical vulnerabilities can lead to complete system compromise&#39;</span>
<span class="w">      </span><span class="p">});</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">results</span><span class="p">.</span><span class="nx">vulnerabilities</span><span class="p">.</span><span class="nx">some</span><span class="p">(</span><span class="nx">v</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">v</span><span class="p">.</span><span class="nx">category</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;authentication&#39;</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">recommendations</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span>
<span class="w">        </span><span class="nx">priority</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;HIGH&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="nx">action</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Review and strengthen authentication mechanisms&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="nx">details</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Authentication vulnerabilities are primary attack vectors&#39;</span>
<span class="w">      </span><span class="p">});</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">results</span><span class="p">.</span><span class="nx">failed</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">results</span><span class="p">.</span><span class="nx">passed</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">recommendations</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span>
<span class="w">        </span><span class="nx">priority</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;HIGH&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="nx">action</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Conduct comprehensive security review&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="nx">details</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;High failure rate indicates systemic security issues&#39;</span>
<span class="w">      </span><span class="p">});</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="nx">recommendations</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="nx">rec</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`\n[</span><span class="si">${</span><span class="nx">rec</span><span class="p">.</span><span class="nx">priority</span><span class="si">}</span><span class="sb">] </span><span class="si">${</span><span class="nx">rec</span><span class="p">.</span><span class="nx">action</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>
<span class="w">      </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`   </span><span class="si">${</span><span class="nx">rec</span><span class="p">.</span><span class="nx">details</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>
<span class="w">    </span><span class="p">});</span>

<span class="w">    </span><span class="c1">// Overall assessment</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">securityScore</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">calculateSecurityScore</span><span class="p">();</span>
<span class="w">    </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`\nğŸ¯ OVERALL SECURITY SCORE: </span><span class="si">${</span><span class="nx">securityScore</span><span class="si">}</span><span class="sb">/100`</span><span class="p">);</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">securityScore</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mf">90</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;Status: EXCELLENT - Ready for production&#39;</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">securityScore</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mf">70</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;Status: GOOD - Address high severity issues&#39;</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">securityScore</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mf">50</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;Status: FAIR - Significant improvements needed&#39;</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;Status: POOR - Not production ready&#39;</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nx">calculateSecurityScore</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">totalTests</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">results</span><span class="p">.</span><span class="nx">passed</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">results</span><span class="p">.</span><span class="nx">failed</span><span class="p">;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">totalTests</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="mf">0</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="nx">score</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">results</span><span class="p">.</span><span class="nx">passed</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="nx">totalTests</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">100</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// Penalties for severity</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">severityPenalties</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="s1">&#39;CRITICAL&#39;</span><span class="o">:</span><span class="w"> </span><span class="mf">20</span><span class="p">,</span>
<span class="w">      </span><span class="s1">&#39;HIGH&#39;</span><span class="o">:</span><span class="w"> </span><span class="mf">10</span><span class="p">,</span>
<span class="w">      </span><span class="s1">&#39;MEDIUM&#39;</span><span class="o">:</span><span class="w"> </span><span class="mf">5</span><span class="p">,</span>
<span class="w">      </span><span class="s1">&#39;LOW&#39;</span><span class="o">:</span><span class="w"> </span><span class="mf">2</span>
<span class="w">    </span><span class="p">};</span>

<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">results</span><span class="p">.</span><span class="nx">vulnerabilities</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="nx">vuln</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">score</span><span class="w"> </span><span class="o">-=</span><span class="w"> </span><span class="nx">severityPenalties</span><span class="p">[</span><span class="nx">vuln</span><span class="p">.</span><span class="nx">severity</span><span class="p">]</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span>
<span class="w">    </span><span class="p">});</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">max</span><span class="p">(</span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">min</span><span class="p">(</span><span class="mf">100</span><span class="p">,</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">round</span><span class="p">(</span><span class="nx">score</span><span class="p">)));</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nx">looksLikeCiphertext</span><span class="p">(</span><span class="nx">text</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// ÄÆ¡n giáº£n kiá»ƒm tra xem cÃ³ pháº£i ciphertext khÃ´ng</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">text</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">text</span><span class="p">.</span><span class="nx">length</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">32</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="sr">/[A-Za-z0-9+/=]{32,}/</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">text</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>

<span class="c1">// Helper functions (giáº£ láº­p)</span>
<span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">authenticateWithToken</span><span class="p">(</span><span class="nx">token</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// Giáº£ láº­p authentication</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">success</span><span class="o">:</span><span class="w"> </span><span class="nx">token</span><span class="w"> </span><span class="o">!==</span><span class="w"> </span><span class="s1">&#39;invalid_token&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">blocked</span><span class="o">:</span><span class="w"> </span><span class="kc">false</span><span class="w"> </span><span class="p">};</span>
<span class="p">}</span>

<span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">getTokenForUser</span><span class="p">(</span><span class="nx">username</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="sb">`token_for_</span><span class="si">${</span><span class="nx">username</span><span class="si">}</span><span class="sb">`</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">connectWebSocket</span><span class="p">(</span><span class="nx">token</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// Giáº£ láº­p WebSocket connection</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">connected</span><span class="o">:</span><span class="w"> </span><span class="kc">true</span><span class="w"> </span><span class="p">};</span>
<span class="p">}</span>

<span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">joinRoom</span><span class="p">(</span><span class="nx">ws</span><span class="p">,</span><span class="w"> </span><span class="nx">roomId</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// Giáº£ láº­p join room</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">success</span><span class="o">:</span><span class="w"> </span><span class="nx">roomId</span><span class="p">.</span><span class="nx">startsWith</span><span class="p">(</span><span class="s1">&#39;private_&#39;</span><span class="p">)</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="kc">false</span><span class="w"> </span><span class="p">};</span>
<span class="p">}</span>

<span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">getMessage</span><span class="p">(</span><span class="nx">messageId</span><span class="p">,</span><span class="w"> </span><span class="nx">token</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">success</span><span class="o">:</span><span class="w"> </span><span class="kc">false</span><span class="w"> </span><span class="p">};</span>
<span class="p">}</span>

<span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">deleteMessage</span><span class="p">(</span><span class="nx">messageId</span><span class="p">,</span><span class="w"> </span><span class="nx">token</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">success</span><span class="o">:</span><span class="w"> </span><span class="kc">false</span><span class="w"> </span><span class="p">};</span>
<span class="p">}</span>

<span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">encryptMessage</span><span class="p">(</span><span class="nx">message</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="s1">&#39;encrypted_&#39;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">message</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">sendMessageThroughServer</span><span class="p">(</span><span class="nx">encrypted</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">plaintext</span><span class="o">:</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="p">};</span>
<span class="p">}</span>

<span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">queryDatabase</span><span class="p">(</span><span class="nx">query</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">rows</span><span class="o">:</span><span class="w"> </span><span class="p">[{</span><span class="w"> </span><span class="nx">content</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;encrypted_content_abc123...&#39;</span><span class="w"> </span><span class="p">}]</span><span class="w"> </span><span class="p">};</span>
<span class="p">}</span>

<span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">sendMessage</span><span class="p">(</span><span class="nx">message</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// Giáº£ láº­p send message</span>
<span class="p">}</span>

<span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">getApplicationLogs</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">[</span><span class="s1">&#39;Log entry 1&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Log entry 2&#39;</span><span class="p">];</span>
<span class="p">}</span>

<span class="c1">// Cháº¡y security tests</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">securityTest</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">ChatSecurityTest</span><span class="p">();</span>
<span class="nx">securityTest</span><span class="p">.</span><span class="nx">runAllTests</span><span class="p">();</span>
</code></pre></div>
<hr />
<h2 id="ket-luan-va-lo-trinh-tiep-theo">ğŸš€ Káº¾T LUáº¬N VÃ€ Lá»˜ TRÃŒNH TIáº¾P THEO<a class="headerlink" href="#ket-luan-va-lo-trinh-tiep-theo" title="Permanent link">&para;</a></h2>
<h3 id="tong-ket-lo-trinh-a-hoc">Tá»•ng Káº¿t Lá»™ TrÃ¬nh ÄÃ£ Há»c<a class="headerlink" href="#tong-ket-lo-trinh-a-hoc" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th style="text-align: left;">Thá»i Gian</th>
<th style="text-align: left;">Ná»™i Dung</th>
<th style="text-align: left;">Káº¿t Quáº£</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><strong>ThÃ¡ng 1-2</strong></td>
<td style="text-align: left;">Náº¯m vá»¯ng WebSocket, Socket.IO, xÃ¢y dá»±ng á»©ng dá»¥ng chat cÆ¡ báº£n</td>
<td style="text-align: left;">Hiá»ƒu rÃµ real-time concepts, cÃ³ thá»ƒ build chat app Ä‘Æ¡n giáº£n</td>
</tr>
<tr>
<td style="text-align: left;"><strong>ThÃ¡ng 3-4</strong></td>
<td style="text-align: left;">Hiá»ƒu sÃ¢u vá» performance testing vá»›i k6, cÃ¡c metrics Ä‘áº·c thÃ¹</td>
<td style="text-align: left;">Viáº¿t Ä‘Æ°á»£c performance test scripts, Ä‘o Ä‘Æ°á»£c cÃ¡c metrics quan trá»ng</td>
</tr>
<tr>
<td style="text-align: left;"><strong>ThÃ¡ng 5-6</strong></td>
<td style="text-align: left;">Thá»±c hÃ nh 5 ká»‹ch báº£n test thá»±c táº¿, phÃ¢n tÃ­ch káº¿t quáº£</td>
<td style="text-align: left;">ThÃ nh tháº¡o cÃ¡c test scenarios: spike, soak, burst</td>
</tr>
<tr>
<td style="text-align: left;"><strong>ThÃ¡ng 7-8</strong></td>
<td style="text-align: left;">Security testing, optimization, trá»Ÿ thÃ nh QA/SDET chuyÃªn sÃ¢u</td>
<td style="text-align: left;">Master security testing, cÃ³ thá»ƒ consult vá»›i backend/security teams</td>
</tr>
</tbody>
</table>
<h3 id="tiep-theo">ğŸ“ˆ Tiáº¿p Theo<a class="headerlink" href="#tiep-theo" title="Permanent link">&para;</a></h3>
<p>Sau khi hoÃ n thÃ nh lá»™ trÃ¬nh nÃ y, báº¡n cÃ³ thá»ƒ:</p>
<ul>
<li>âœ… <strong>Thiáº¿t káº¿ Performance Test</strong> cho cÃ¡c á»©ng dá»¥ng real-time khÃ¡c (gaming, collaboration tools)</li>
<li>âœ… <strong>ÄÃ o sÃ¢u vÃ o Security Testing</strong> vá»›i OWASP Top 10 cho WebSocket</li>
<li>âœ… <strong>Há»c thÃªm vá» Distributed Systems</strong> (message queues, load balancing)</li>
<li>âœ… <strong>Má»Ÿ rá»™ng sang Mobile Chat Testing</strong> (native apps, push notifications)</li>
<li>âœ… <strong>Trá»Ÿ thÃ nh Consultant</strong> vá» Real-time Application Testing</li>
</ul>
<p><strong>ChÃºc báº¡n thÃ nh cÃ´ng trÃªn con Ä‘Æ°á»ng trá»Ÿ thÃ nh QA/SDET chuyÃªn gia vá» Chat Application! ğŸ‰</strong></p>
<hr />
<h2 id="phan-3-tich-hop-vao-cicd-monitoring">ğŸš€ PHáº¦N 3: TÃCH Há»¢P VÃ€O CI/CD &amp; MONITORING<a class="headerlink" href="#phan-3-tich-hop-vao-cicd-monitoring" title="Permanent link">&para;</a></h2>
<h3 id="tich-hop-performance-test-vao-cicd-pipeline">ğŸš€ TÃ­ch Há»£p Performance Test vÃ o CI/CD Pipeline<a class="headerlink" href="#tich-hop-performance-test-vao-cicd-pipeline" title="Permanent link">&para;</a></h3>
<h4 id="11-kien-truc-cicd-cho-chat-application">1.1 Kiáº¿n TrÃºc CI/CD Cho Chat Application<a class="headerlink" href="#11-kien-truc-cicd-cho-chat-application" title="Permanent link">&para;</a></h4>
<p><strong>MÃ´ hÃ¬nh CI/CD pipeline hoÃ n chá»‰nh:</strong></p>
<div class="highlight"><pre><span></span><code>Git Repository (GitHub/GitLab/Bitbucket)
        â†“
    Webhook Trigger
        â†“
    CI/CD Server (Jenkins/GitHub Actions/GitLab CI)
        â†“
        â”œâ”€â”€ Stage 1: Code Quality
        â”‚   â”œâ”€â”€ ESLint/Prettier
        â”‚   â”œâ”€â”€ Unit Tests (Jest/Mocha)
        â”‚   â””â”€â”€ Security Scan (SAST)
        â”‚
        â”œâ”€â”€ Stage 2: Build &amp; Containerize
        â”‚   â”œâ”€â”€ Build Docker Image
        â”‚   â”œâ”€â”€ Push to Container Registry
        â”‚   â””â”€â”€ Generate Version Tag
        â”‚
        â”œâ”€â”€ Stage 3: Performance Gate
        â”‚   â”œâ”€â”€ Deploy to Test Environment
        â”‚   â”œâ”€â”€ Run Smoke Tests (k6)
        â”‚   â”œâ”€â”€ Run Load Tests (k6)
        â”‚   â””â”€â”€ Performance Threshold Check
        â”‚
        â”œâ”€â”€ Stage 4: Staging Deployment
        â”‚   â”œâ”€â”€ Deploy to Staging
        â”‚   â”œâ”€â”€ Run Integration Tests
        â”‚   â””â”€â”€ Security Tests (DAST)
        â”‚
        â””â”€â”€ Stage 5: Production Deployment
            â”œâ”€â”€ Blue-Green Deployment
            â”œâ”€â”€ Canary Release (10% â†’ 50% â†’ 100%)
            â””â”€â”€ Post-Deployment Validation
</code></pre></div>
<p><strong>VÃ­ dá»¥ cá»¥ thá»ƒ vá»›i GitHub Actions:</strong></p>
<div class="highlight"><pre><span></span><code><span class="c1"># .github/workflows/chat-performance.yml</span>
<span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Chat Application Performance CI/CD</span>

<span class="nt">on</span><span class="p">:</span>
<span class="w">  </span><span class="nt">push</span><span class="p">:</span>
<span class="w">    </span><span class="nt">branches</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="w"> </span><span class="nv">main</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">develop</span><span class="w"> </span><span class="p p-Indicator">]</span>
<span class="w">  </span><span class="nt">pull_request</span><span class="p">:</span>
<span class="w">    </span><span class="nt">branches</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="w"> </span><span class="nv">main</span><span class="w"> </span><span class="p p-Indicator">]</span>
<span class="w">  </span><span class="nt">schedule</span><span class="p">:</span>
<span class="w">    </span><span class="c1"># Cháº¡y performance test hÃ ng ngÃ y lÃºc 2AM</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">cron</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;0</span><span class="nv"> </span><span class="s">2</span><span class="nv"> </span><span class="s">*</span><span class="nv"> </span><span class="s">*</span><span class="nv"> </span><span class="s">*&#39;</span>

<span class="nt">env</span><span class="p">:</span>
<span class="w">  </span><span class="nt">REGISTRY</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ghcr.io</span>
<span class="w">  </span><span class="nt">IMAGE_NAME</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">${{ github.repository }}</span>

<span class="nt">jobs</span><span class="p">:</span>
<span class="w">  </span><span class="c1"># JOB 1: BUILD AND UNIT TESTS</span>
<span class="w">  </span><span class="nt">build-and-test</span><span class="p">:</span>
<span class="w">    </span><span class="nt">runs-on</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ubuntu-latest</span>
<span class="w">    </span><span class="nt">outputs</span><span class="p">:</span>
<span class="w">      </span><span class="nt">image_tag</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">${{ steps.meta.outputs.tags }}</span>

<span class="w">    </span><span class="nt">steps</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">uses</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">actions/checkout@v3</span>

<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Setup Node.js</span>
<span class="w">      </span><span class="nt">uses</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">actions/setup-node@v3</span>
<span class="w">      </span><span class="nt">with</span><span class="p">:</span>
<span class="w">        </span><span class="nt">node-version</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;18&#39;</span>
<span class="w">        </span><span class="nt">cache</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;npm&#39;</span>

<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Install dependencies</span>
<span class="w">      </span><span class="nt">run</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">npm ci</span>

<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Run unit tests</span>
<span class="w">      </span><span class="nt">run</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|</span>
<span class="w">        </span><span class="no">npm test</span>
<span class="w">        </span><span class="no">npm run test:coverage</span>

<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Build Docker image</span>
<span class="w">      </span><span class="nt">run</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|</span>
<span class="w">        </span><span class="no">docker build -t chat-app:${{ github.sha }} .</span>

<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Run security scan</span>
<span class="w">      </span><span class="nt">uses</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">aquasecurity/trivy-action@master</span>
<span class="w">      </span><span class="nt">with</span><span class="p">:</span>
<span class="w">        </span><span class="nt">image-ref</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;chat-app:${{</span><span class="nv"> </span><span class="s">github.sha</span><span class="nv"> </span><span class="s">}}&#39;</span>
<span class="w">        </span><span class="nt">format</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;sarif&#39;</span>
<span class="w">        </span><span class="nt">output</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;trivy-results.sarif&#39;</span>

<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Upload security results</span>
<span class="w">      </span><span class="nt">uses</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">github/codeql-action/upload-sarif@v2</span>
<span class="w">      </span><span class="nt">with</span><span class="p">:</span>
<span class="w">        </span><span class="nt">sarif_file</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;trivy-results.sarif&#39;</span>

<span class="w">  </span><span class="c1"># JOB 2: PERFORMANCE TEST GATE</span>
<span class="w">  </span><span class="nt">performance-gate</span><span class="p">:</span>
<span class="w">    </span><span class="nt">runs-on</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ubuntu-latest</span>
<span class="w">    </span><span class="nt">needs</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">build-and-test</span>
<span class="w">    </span><span class="nt">services</span><span class="p">:</span>
<span class="w">      </span><span class="c1"># Khá»Ÿi Ä‘á»™ng dependencies cho test</span>
<span class="w">      </span><span class="nt">redis</span><span class="p">:</span>
<span class="w">        </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">redis:alpine</span>
<span class="w">        </span><span class="nt">ports</span><span class="p">:</span>
<span class="w">          </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">6379:6379</span>
<span class="w">      </span><span class="nt">postgres</span><span class="p">:</span>
<span class="w">        </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">postgres:14</span>
<span class="w">        </span><span class="nt">env</span><span class="p">:</span>
<span class="w">          </span><span class="nt">POSTGRES_PASSWORD</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">testpassword</span>
<span class="w">        </span><span class="nt">ports</span><span class="p">:</span>
<span class="w">          </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">5432:5432</span>
<span class="w">        </span><span class="nt">options</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">&gt;-</span>
<span class="w">          </span><span class="no">--health-cmd pg_isready</span>
<span class="w">          </span><span class="no">--health-interval 10s</span>
<span class="w">          </span><span class="no">--health-timeout 5s</span>
<span class="w">          </span><span class="no">--health-retries 5</span>

<span class="w">    </span><span class="nt">steps</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">uses</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">actions/checkout@v3</span>

<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Start chat application</span>
<span class="w">      </span><span class="nt">run</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|</span>
<span class="w">        </span><span class="no">docker run -d \</span>
<span class="w">          </span><span class="no">--name chat-app-test \</span>
<span class="w">          </span><span class="no">-p 3000:3000 \</span>
<span class="w">          </span><span class="no">-e REDIS_URL=redis://localhost:6379 \</span>
<span class="w">          </span><span class="no">-e DATABASE_URL=postgresql://postgres:testpassword@localhost:5432/testdb \</span>
<span class="w">          </span><span class="no">chat-app:${{ github.sha }}</span>

<span class="w">        </span><span class="no"># Chá» á»©ng dá»¥ng khá»Ÿi Ä‘á»™ng</span>
<span class="w">        </span><span class="no">timeout 60 bash -c &#39;until curl -s http://localhost:3000/health &gt; /dev/null; do sleep 1; done&#39;</span>

<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Install k6</span>
<span class="w">      </span><span class="nt">uses</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">grafana/k6-action@v0.3.0</span>
<span class="w">      </span><span class="nt">with</span><span class="p">:</span>
<span class="w">        </span><span class="nt">install-only</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>

<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Run smoke test (fast feedback)</span>
<span class="w">      </span><span class="nt">run</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|</span>
<span class="w">        </span><span class="no">k6 run --out json=smoke-results.json \</span>
<span class="w">          </span><span class="no">--summary-export=smoke-summary.json \</span>
<span class="w">          </span><span class="no">tests/performance/smoke-test.js</span>

<span class="w">        </span><span class="no"># Kiá»ƒm tra káº¿t quáº£ cÆ¡ báº£n</span>
<span class="w">        </span><span class="no">if ! node scripts/check-smoke-results.js smoke-summary.json; then</span>
<span class="w">          </span><span class="no">echo &quot;âŒ Smoke test failed&quot;</span>
<span class="w">          </span><span class="no">exit 1</span>
<span class="w">        </span><span class="no">fi</span>

<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Run load test (pull request only)</span>
<span class="w">      </span><span class="nt">if</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">github.event_name == &#39;pull_request&#39;</span>
<span class="w">      </span><span class="nt">run</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|</span>
<span class="w">        </span><span class="no">k6 run --out json=load-results.json \</span>
<span class="w">          </span><span class="no">--out influxdb=http://localhost:8086/k6 \</span>
<span class="w">          </span><span class="no">tests/performance/load-test.js</span>

<span class="w">        </span><span class="no"># Generate performance report</span>
<span class="w">        </span><span class="no">node scripts/generate-performance-report.js load-results.json &gt; performance-report.md</span>

<span class="w">        </span><span class="no"># Upload report nhÆ° artifact</span>
<span class="w">        </span><span class="no">echo &quot;performance-report&lt;&lt;EOF&quot; &gt;&gt; $GITHUB_STEP_SUMMARY</span>
<span class="w">        </span><span class="no">cat performance-report.md &gt;&gt; $GITHUB_STEP_SUMMARY</span>
<span class="w">        </span><span class="no">echo &quot;EOF&quot; &gt;&gt; $GITHUB_STEP_SUMMARY</span>

<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Performance regression check</span>
<span class="w">      </span><span class="nt">run</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|</span>
<span class="w">        </span><span class="no"># So sÃ¡nh vá»›i baseline</span>
<span class="w">        </span><span class="no">node scripts/check-performance-regression.js \</span>
<span class="w">          </span><span class="no">--current load-results.json \</span>
<span class="w">          </span><span class="no">--baseline baseline-results.json \</span>
<span class="w">          </span><span class="no">--threshold 0.15  # Cho phÃ©p 15% degradation</span>

<span class="w">        </span><span class="no">if [ $? -ne 0 ]; then</span>
<span class="w">          </span><span class="no">echo &quot;::warning::Performance regression detected!&quot;</span>
<span class="w">          </span><span class="no">echo &quot;::warning title=Performance Regression::Check the performance report for details&quot;</span>
<span class="w">        </span><span class="no">fi</span>

<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Upload test results</span>
<span class="w">      </span><span class="nt">uses</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">actions/upload-artifact@v3</span>
<span class="w">      </span><span class="nt">with</span><span class="p">:</span>
<span class="w">        </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">performance-results</span>
<span class="w">        </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|</span>
<span class="w">          </span><span class="no">smoke-results.json</span>
<span class="w">          </span><span class="no">load-results.json</span>
<span class="w">          </span><span class="no">performance-report.md</span>
<span class="w">        </span><span class="nt">retention-days</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">30</span>

<span class="w">  </span><span class="c1"># JOB 3: DEPLOY TO STAGING (chá»‰ trÃªn main branch)</span>
<span class="w">  </span><span class="nt">deploy-staging</span><span class="p">:</span>
<span class="w">    </span><span class="nt">runs-on</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ubuntu-latest</span>
<span class="w">    </span><span class="nt">needs</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">build-and-test</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">performance-gate</span><span class="p p-Indicator">]</span>
<span class="w">    </span><span class="nt">if</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">github.ref == &#39;refs/heads/main&#39;</span>

<span class="w">    </span><span class="nt">steps</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Deploy to staging</span>
<span class="w">      </span><span class="nt">run</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|</span>
<span class="w">        </span><span class="no"># Deploy vá»›i Helm/Kubernetes</span>
<span class="w">        </span><span class="no">helm upgrade --install \</span>
<span class="w">          </span><span class="no">chat-app-staging \</span>
<span class="w">          </span><span class="no">./charts/chat-app \</span>
<span class="w">          </span><span class="no">--namespace staging \</span>
<span class="w">          </span><span class="no">--set image.tag=${{ github.sha }} \</span>
<span class="w">          </span><span class="no">--set replicaCount=3 \</span>
<span class="w">          </span><span class="no">--wait</span>

<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Run production-like load test</span>
<span class="w">      </span><span class="nt">run</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|</span>
<span class="w">        </span><span class="no"># Test vá»›i production-like traffic</span>
<span class="w">        </span><span class="no">k6 run \</span>
<span class="w">          </span><span class="no">--env STAGING_URL=https://staging.chat.example.com \</span>
<span class="w">          </span><span class="no">tests/performance/production-simulation.js \</span>
<span class="w">          </span><span class="no">--out cloud  # Gá»­i káº¿t quáº£ lÃªn k6 Cloud</span>

<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Wait for deployment stabilization</span>
<span class="w">      </span><span class="nt">run</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|</span>
<span class="w">        </span><span class="no"># Monitor deployment 5 phÃºt</span>
<span class="w">        </span><span class="no">timeout 300 bash -c &#39;</span>
<span class="w">          </span><span class="no">while true; do</span>
<span class="w">            </span><span class="no">healthy_pods=$(kubectl get pods -n staging -l app=chat-app \</span>
<span class="w">              </span><span class="no">--field-selector=status.phase=Running | grep &quot;2/2&quot; | wc -l)</span>
<span class="w">            </span><span class="no">if [ &quot;$healthy_pods&quot; -eq 3 ]; then</span>
<span class="w">              </span><span class="no">echo &quot;âœ… All pods healthy&quot;</span>
<span class="w">              </span><span class="no">break</span>
<span class="w">            </span><span class="no">fi</span>
<span class="w">            </span><span class="no">sleep 10</span>
<span class="w">          </span><span class="no">done</span>
<span class="w">        </span><span class="no">&#39;</span>

<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Generate deployment report</span>
<span class="w">      </span><span class="nt">run</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|</span>
<span class="w">        </span><span class="no">node scripts/generate-deployment-report.js &gt; deployment-report.md</span>
<span class="w">        </span><span class="no">cat deployment-report.md</span>

<span class="w">  </span><span class="c1"># JOB 4: CANARY DEPLOYMENT TO PRODUCTION</span>
<span class="w">  </span><span class="nt">canary-deployment</span><span class="p">:</span>
<span class="w">    </span><span class="nt">runs-on</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ubuntu-latest</span>
<span class="w">    </span><span class="nt">needs</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">deploy-staging</span>
<span class="w">    </span><span class="nt">if</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">github.ref == &#39;refs/heads/main&#39;</span>

<span class="w">    </span><span class="nt">steps</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Deploy 10% canary</span>
<span class="w">      </span><span class="nt">run</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|</span>
<span class="w">        </span><span class="no"># Deploy 10% traffic Ä‘áº¿n version má»›i</span>
<span class="w">        </span><span class="no">kubectl apply -f canary/10-percent.yaml</span>

<span class="w">        </span><span class="no"># Monitor canary 10 phÃºt</span>
<span class="w">        </span><span class="no">timeout 600 bash -c &#39;</span>
<span class="w">          </span><span class="no">while true; do</span>
<span class="w">            </span><span class="no">error_rate=$(node scripts/check-canary-metrics.js)</span>
<span class="w">            </span><span class="no">if (( $(echo &quot;$error_rate &gt; 0.05&quot; | bc -l) )); then</span>
<span class="w">              </span><span class="no">echo &quot;âŒ Canary error rate too high: $error_rate&quot;</span>
<span class="w">              </span><span class="no">kubectl apply -f canary/rollback.yaml</span>
<span class="w">              </span><span class="no">exit 1</span>
<span class="w">            </span><span class="no">fi</span>
<span class="w">            </span><span class="no">sleep 30</span>
<span class="w">          </span><span class="no">done</span>
<span class="w">        </span><span class="no">&#39;</span>

<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Deploy 50% canary</span>
<span class="w">      </span><span class="nt">if</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">success()</span>
<span class="w">      </span><span class="nt">run</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|</span>
<span class="w">        </span><span class="no">kubectl apply -f canary/50-percent.yaml</span>
<span class="w">        </span><span class="no">timeout 300 bash -c &#39;</span>
<span class="w">          </span><span class="no">while true; do</span>
<span class="w">            </span><span class="no">latency_p95=$(node scripts/get-latency-metric.js)</span>
<span class="w">            </span><span class="no">if (( $(echo &quot;$latency_p95 &gt; 200&quot; | bc -l) )); then</span>
<span class="w">              </span><span class="no">echo &quot;âŒ Latency too high: $latency_p95&quot;</span>
<span class="w">              </span><span class="no">kubectl apply -f canary/rollback.yaml</span>
<span class="w">              </span><span class="no">exit 1</span>
<span class="w">            </span><span class="no">fi</span>
<span class="w">            </span><span class="no">sleep 30</span>
<span class="w">          </span><span class="no">done</span>
<span class="w">        </span><span class="no">&#39;</span>

<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Full rollout</span>
<span class="w">      </span><span class="nt">if</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">success()</span>
<span class="w">      </span><span class="nt">run</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|</span>
<span class="w">        </span><span class="no">kubectl apply -f canary/100-percent.yaml</span>
<span class="w">        </span><span class="no">echo &quot;âœ… Deployment completed successfully!&quot;</span>
</code></pre></div>
<p><strong>Script kiá»ƒm tra káº¿t quáº£ performance:</strong></p>
<div class="highlight"><pre><span></span><code><span class="c1">// scripts/check-performance-regression.js</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">fs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">require</span><span class="p">(</span><span class="s1">&#39;fs&#39;</span><span class="p">);</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">path</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">require</span><span class="p">(</span><span class="s1">&#39;path&#39;</span><span class="p">);</span>

<span class="kd">class</span><span class="w"> </span><span class="nx">PerformanceRegressionChecker</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kr">constructor</span><span class="p">(</span><span class="nx">options</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{})</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">threshold</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">options</span><span class="p">.</span><span class="nx">threshold</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="mf">0.1</span><span class="p">;</span><span class="w"> </span><span class="c1">// 10%</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">metricsToCheck</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span>
<span class="w">      </span><span class="s1">&#39;http_req_duration{expected_response:true}&#39;</span><span class="p">,</span>
<span class="w">      </span><span class="s1">&#39;ws_connecting&#39;</span><span class="p">,</span>
<span class="w">      </span><span class="s1">&#39;ws_msgs_received&#39;</span><span class="p">,</span>
<span class="w">      </span><span class="s1">&#39;iteration_duration&#39;</span>
<span class="w">    </span><span class="p">];</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">async</span><span class="w"> </span><span class="nx">check</span><span class="p">(</span><span class="nx">currentFile</span><span class="p">,</span><span class="w"> </span><span class="nx">baselineFile</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">current</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">loadResults</span><span class="p">(</span><span class="nx">currentFile</span><span class="p">);</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">baseline</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">loadResults</span><span class="p">(</span><span class="nx">baselineFile</span><span class="p">);</span>

<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">regressions</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[];</span>

<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">const</span><span class="w"> </span><span class="nx">metric</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">metricsToCheck</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">currentValue</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">extractMetric</span><span class="p">(</span><span class="nx">current</span><span class="p">,</span><span class="w"> </span><span class="nx">metric</span><span class="p">);</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">baselineValue</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">extractMetric</span><span class="p">(</span><span class="nx">baseline</span><span class="p">,</span><span class="w"> </span><span class="nx">metric</span><span class="p">);</span>

<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">currentValue</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">baselineValue</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">diff</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">currentValue</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nx">baselineValue</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="nx">baselineValue</span><span class="p">;</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">diff</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">threshold</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="nx">regressions</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span>
<span class="w">            </span><span class="nx">metric</span><span class="p">,</span>
<span class="w">            </span><span class="nx">baseline</span><span class="o">:</span><span class="w"> </span><span class="nx">baselineValue</span><span class="p">,</span>
<span class="w">            </span><span class="nx">current</span><span class="o">:</span><span class="w"> </span><span class="nx">currentValue</span><span class="p">,</span>
<span class="w">            </span><span class="nx">degradation</span><span class="o">:</span><span class="w"> </span><span class="sb">`</span><span class="si">${</span><span class="p">(</span><span class="nx">diff</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">100</span><span class="p">).</span><span class="nx">toFixed</span><span class="p">(</span><span class="mf">2</span><span class="p">)</span><span class="si">}</span><span class="sb">%`</span><span class="p">,</span>
<span class="w">            </span><span class="nx">threshold</span><span class="o">:</span><span class="w"> </span><span class="sb">`</span><span class="si">${</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">threshold</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">100</span><span class="p">).</span><span class="nx">toFixed</span><span class="p">(</span><span class="mf">2</span><span class="p">)</span><span class="si">}</span><span class="sb">%`</span>
<span class="w">          </span><span class="p">});</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">hasRegression</span><span class="o">:</span><span class="w"> </span><span class="nx">regressions</span><span class="p">.</span><span class="nx">length</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">0</span><span class="p">,</span>
<span class="w">      </span><span class="nx">regressions</span><span class="p">,</span>
<span class="w">      </span><span class="nx">summary</span><span class="o">:</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">generateSummary</span><span class="p">(</span><span class="nx">current</span><span class="p">,</span><span class="w"> </span><span class="nx">baseline</span><span class="p">)</span>
<span class="w">    </span><span class="p">};</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nx">loadResults</span><span class="p">(</span><span class="nx">filePath</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">raw</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">fs</span><span class="p">.</span><span class="nx">readFileSync</span><span class="p">(</span><span class="nx">filePath</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;utf8&#39;</span><span class="p">);</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nb">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">raw</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nx">extractMetric</span><span class="p">(</span><span class="nx">results</span><span class="p">,</span><span class="w"> </span><span class="nx">metricPattern</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// TÃ¬m metric trong káº¿t quáº£ k6</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">const</span><span class="w"> </span><span class="p">[</span><span class="nx">key</span><span class="p">,</span><span class="w"> </span><span class="nx">value</span><span class="p">]</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="nb">Object</span><span class="p">.</span><span class="nx">entries</span><span class="p">(</span><span class="nx">results</span><span class="p">.</span><span class="nx">metrics</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">key</span><span class="p">.</span><span class="nx">includes</span><span class="p">(</span><span class="nx">metricPattern</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nx">value</span><span class="p">.</span><span class="nx">values</span><span class="p">[</span><span class="s1">&#39;p(95)&#39;</span><span class="p">]</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nx">value</span><span class="p">.</span><span class="nx">values</span><span class="p">.</span><span class="nx">avg</span><span class="p">;</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nx">generateSummary</span><span class="p">(</span><span class="nx">current</span><span class="p">,</span><span class="w"> </span><span class="nx">baseline</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">timestamp</span><span class="o">:</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nb">Date</span><span class="p">().</span><span class="nx">toISOString</span><span class="p">(),</span>
<span class="w">      </span><span class="nx">current</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">vus</span><span class="o">:</span><span class="w"> </span><span class="nx">current</span><span class="p">.</span><span class="nx">metrics</span><span class="p">.</span><span class="nx">vus_max</span><span class="p">.</span><span class="nx">values</span><span class="p">.</span><span class="nx">max</span><span class="p">,</span>
<span class="w">        </span><span class="nx">iterations</span><span class="o">:</span><span class="w"> </span><span class="nx">current</span><span class="p">.</span><span class="nx">metrics</span><span class="p">.</span><span class="nx">iterations</span><span class="p">.</span><span class="nx">values</span><span class="p">.</span><span class="nx">count</span><span class="p">,</span>
<span class="w">        </span><span class="nx">duration</span><span class="o">:</span><span class="w"> </span><span class="nx">current</span><span class="p">.</span><span class="nx">metrics</span><span class="p">.</span><span class="nx">iteration_duration</span><span class="p">.</span><span class="nx">values</span><span class="p">.</span><span class="nx">avg</span>
<span class="w">      </span><span class="p">},</span>
<span class="w">      </span><span class="nx">baseline</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">vus</span><span class="o">:</span><span class="w"> </span><span class="nx">baseline</span><span class="p">.</span><span class="nx">metrics</span><span class="p">.</span><span class="nx">vus_max</span><span class="p">.</span><span class="nx">values</span><span class="p">.</span><span class="nx">max</span><span class="p">,</span>
<span class="w">        </span><span class="nx">iterations</span><span class="o">:</span><span class="w"> </span><span class="nx">baseline</span><span class="p">.</span><span class="nx">metrics</span><span class="p">.</span><span class="nx">iterations</span><span class="p">.</span><span class="nx">values</span><span class="p">.</span><span class="nx">count</span><span class="p">,</span>
<span class="w">        </span><span class="nx">duration</span><span class="o">:</span><span class="w"> </span><span class="nx">baseline</span><span class="p">.</span><span class="nx">metrics</span><span class="p">.</span><span class="nx">iteration_duration</span><span class="p">.</span><span class="nx">values</span><span class="p">.</span><span class="nx">avg</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">};</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>

<span class="c1">// Sá»­ dá»¥ng</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">checker</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">PerformanceRegressionChecker</span><span class="p">({</span><span class="w"> </span><span class="nx">threshold</span><span class="o">:</span><span class="w"> </span><span class="mf">0.15</span><span class="w"> </span><span class="p">});</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">checker</span><span class="p">.</span><span class="nx">check</span><span class="p">(</span>
<span class="w">  </span><span class="s1">&#39;load-results.json&#39;</span><span class="p">,</span>
<span class="w">  </span><span class="s1">&#39;baseline-results.json&#39;</span>
<span class="p">);</span>

<span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">result</span><span class="p">.</span><span class="nx">hasRegression</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s1">&#39;âš ï¸ Performance regression detected!&#39;</span><span class="p">);</span>
<span class="w">  </span><span class="nx">console</span><span class="p">.</span><span class="nx">table</span><span class="p">(</span><span class="nx">result</span><span class="p">.</span><span class="nx">regressions</span><span class="p">);</span>
<span class="w">  </span><span class="nx">process</span><span class="p">.</span><span class="nx">exit</span><span class="p">(</span><span class="mf">1</span><span class="p">);</span>
<span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;âœ… No performance regression detected&#39;</span><span class="p">);</span>
<span class="w">  </span><span class="nx">process</span><span class="p">.</span><span class="nx">exit</span><span class="p">(</span><span class="mf">0</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>
<h4 id="12-cau-hinh-k6-trong-docker">1.2 Cáº¥u hÃ¬nh k6 trong Docker<a class="headerlink" href="#12-cau-hinh-k6-trong-docker" title="Permanent link">&para;</a></h4>
<p><strong>Dockerfile cho k6:</strong></p>
<div class="highlight"><pre><span></span><code><span class="c"># Dockerfile.k6</span>
<span class="k">FROM</span><span class="w"> </span><span class="s">grafana/k6:latest</span>

<span class="c"># CÃ i Ä‘áº·t thÃªm cÃ¡c package cáº§n thiáº¿t</span>
<span class="k">USER</span><span class="w"> </span><span class="s">root</span>
<span class="k">RUN</span><span class="w"> </span>apk<span class="w"> </span>add<span class="w"> </span>--no-cache<span class="w"> </span>nodejs<span class="w"> </span>npm<span class="w"> </span>curl<span class="w"> </span>jq<span class="w"> </span>bash

<span class="c"># Copy test scripts</span>
<span class="k">COPY</span><span class="w"> </span>tests/performance<span class="w"> </span>/scripts
<span class="k">COPY</span><span class="w"> </span>scripts<span class="w"> </span>/scripts/scripts

<span class="c"># Copy package.json náº¿u cáº§n cÃ¡c thÆ° viá»‡n Node.js</span>
<span class="k">COPY</span><span class="w"> </span>package*.json<span class="w"> </span>/scripts/
<span class="k">RUN</span><span class="w"> </span><span class="nb">cd</span><span class="w"> </span>/scripts<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span>npm<span class="w"> </span>ci<span class="w"> </span>--only<span class="o">=</span>production

<span class="c"># Thiáº¿t láº­p working directory</span>
<span class="k">WORKDIR</span><span class="w"> </span><span class="s">/scripts</span>

<span class="c"># Entrypoint máº·c Ä‘á»‹nh</span>
<span class="k">ENTRYPOINT</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;k6&quot;</span><span class="p">]</span>
<span class="k">CMD</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;run&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;smoke-test.js&quot;</span><span class="p">]</span>
</code></pre></div>
<p><strong>Docker Compose cho testing environment:</strong></p>
<div class="highlight"><pre><span></span><code><span class="c1"># docker-compose.performance.yml</span>
<span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;3.8&#39;</span>

<span class="nt">services</span><span class="p">:</span>
<span class="w">  </span><span class="nt">chat-app</span><span class="p">:</span>
<span class="w">    </span><span class="nt">build</span><span class="p">:</span>
<span class="w">      </span><span class="nt">context</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">.</span>
<span class="w">      </span><span class="nt">dockerfile</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Dockerfile</span>
<span class="w">    </span><span class="nt">ports</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;3000:3000&quot;</span>
<span class="w">    </span><span class="nt">environment</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">NODE_ENV=test</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">REDIS_URL=redis://redis:6379</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">DATABASE_URL=postgres://postgres:password@postgres:5432/chat_test</span>
<span class="w">    </span><span class="nt">depends_on</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">redis</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">postgres</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">influxdb</span>
<span class="w">    </span><span class="nt">healthcheck</span><span class="p">:</span>
<span class="w">      </span><span class="nt">test</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&quot;CMD&quot;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;curl&quot;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;-f&quot;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;http://localhost:3000/health&quot;</span><span class="p p-Indicator">]</span>
<span class="w">      </span><span class="nt">interval</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">30s</span>
<span class="w">      </span><span class="nt">timeout</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">10s</span>
<span class="w">      </span><span class="nt">retries</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">3</span>

<span class="w">  </span><span class="nt">k6-master</span><span class="p">:</span>
<span class="w">    </span><span class="nt">build</span><span class="p">:</span>
<span class="w">      </span><span class="nt">context</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">.</span>
<span class="w">      </span><span class="nt">dockerfile</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Dockerfile.k6</span>
<span class="w">    </span><span class="nt">environment</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">K6_STATSD_ENABLE_TAGS=true</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">K6_OUT=influxdb=http://influxdb:8086/k6</span>
<span class="w">    </span><span class="nt">volumes</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">./tests/performance:/scripts</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">./test-data:/test-data</span>
<span class="w">    </span><span class="nt">depends_on</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">chat-app</span>
<span class="w">    </span><span class="nt">command</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">run --out influxdb=http://influxdb:8086/k6 /scripts/load-test.js</span>

<span class="w">  </span><span class="nt">k6-slaves</span><span class="p">:</span>
<span class="w">    </span><span class="nt">scale</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">3</span>
<span class="w">    </span><span class="nt">build</span><span class="p">:</span>
<span class="w">      </span><span class="nt">context</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">.</span>
<span class="w">      </span><span class="nt">dockerfile</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Dockerfile.k6</span>
<span class="w">    </span><span class="nt">environment</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">K6_MODE=worker</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">K6_MASTER_NODE=k6-master:6565</span>
<span class="w">    </span><span class="nt">depends_on</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">k6-master</span>
<span class="w">    </span><span class="nt">command</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">run --out influxdb=http://influxdb:8086/k6 /scripts/load-test.js</span>

<span class="w">  </span><span class="nt">influxdb</span><span class="p">:</span>
<span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">influxdb:2.0</span>
<span class="w">    </span><span class="nt">ports</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;8086:8086&quot;</span>
<span class="w">    </span><span class="nt">environment</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">DOCKER_INFLUXDB_INIT_MODE=setup</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">DOCKER_INFLUXDB_INIT_USERNAME=admin</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">DOCKER_INFLUXDB_INIT_PASSWORD=password123</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">DOCKER_INFLUXDB_INIT_ORG=myorg</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">DOCKER_INFLUXDB_INIT_BUCKET=k6</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">DOCKER_INFLUXDB_INIT_ADMIN_TOKEN=mytoken</span>
<span class="w">    </span><span class="nt">volumes</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">influxdb-data:/var/lib/influxdb2</span>

<span class="w">  </span><span class="nt">grafana</span><span class="p">:</span>
<span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">grafana/grafana:latest</span>
<span class="w">    </span><span class="nt">ports</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;3001:3000&quot;</span>
<span class="w">    </span><span class="nt">environment</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">GF_SECURITY_ADMIN_PASSWORD=admin</span>
<span class="w">    </span><span class="nt">volumes</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">./grafana/provisioning:/etc/grafana/provisioning</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">grafana-data:/var/lib/grafana</span>
<span class="w">    </span><span class="nt">depends_on</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">influxdb</span>

<span class="w">  </span><span class="nt">redis</span><span class="p">:</span>
<span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">redis:alpine</span>
<span class="w">    </span><span class="nt">ports</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;6379:6379&quot;</span>
<span class="w">    </span><span class="nt">command</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">redis-server --appendonly yes</span>

<span class="w">  </span><span class="nt">postgres</span><span class="p">:</span>
<span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">postgres:14</span>
<span class="w">    </span><span class="nt">environment</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">POSTGRES_PASSWORD=password</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">POSTGRES_DB=chat_test</span>
<span class="w">    </span><span class="nt">ports</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;5432:5432&quot;</span>
<span class="w">    </span><span class="nt">volumes</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">postgres-data:/var/lib/postgresql/data</span>

<span class="nt">volumes</span><span class="p">:</span>
<span class="w">  </span><span class="nt">influxdb-data</span><span class="p">:</span>
<span class="w">  </span><span class="nt">grafana-data</span><span class="p">:</span>
<span class="w">  </span><span class="nt">postgres-data</span><span class="p">:</span>
</code></pre></div>
<hr />
<h3 id="cach-monitor-chat-application-trong-production">ğŸ“Š CÃ¡ch Monitor Chat Application trong Production<a class="headerlink" href="#cach-monitor-chat-application-trong-production" title="Permanent link">&para;</a></h3>
<h4 id="21-cau-truc-monitoring-stack">2.1 Cáº¥u trÃºc Monitoring Stack<a class="headerlink" href="#21-cau-truc-monitoring-stack" title="Permanent link">&para;</a></h4>
<p><strong>Kiáº¿n trÃºc hoÃ n chá»‰nh:</strong></p>
<div class="highlight"><pre><span></span><code>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Application Layer                        â”‚
â”‚  Chat App (Node.js) â”€â”€â”€â”¤ Socket.IO â”€â”€â”€â”¤ Redis â”€â”€â”€â”¤ Postgresâ”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Observability Layer                       â”‚
â”‚  Prometheus Metrics â”€â”€â”€â”¤ Distributed Tracing â”€â”€â”€â”¤ Logging   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Visualization Layer                       â”‚
â”‚  Grafana Dashboards â”€â”€â”€â”¤ AlertManager â”€â”€â”€â”¤ Custom Reports   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Alerting &amp; Action Layer                   â”‚
â”‚  PagerDuty/Slack â”€â”€â”€â”¤ Auto-scaling â”€â”€â”€â”¤ Runbooks/SOPs       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</code></pre></div>
<h4 id="22-metrics-collector-implementation">2.2 Metrics Collector Implementation<a class="headerlink" href="#22-metrics-collector-implementation" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1">// monitoring/metrics-collector.js</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">prometheus</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">require</span><span class="p">(</span><span class="s1">&#39;prom-client&#39;</span><span class="p">);</span>
<span class="kd">const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">EventEmitter</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">require</span><span class="p">(</span><span class="s1">&#39;events&#39;</span><span class="p">);</span>

<span class="kd">class</span><span class="w"> </span><span class="nx">ChatMetricsCollector</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nx">EventEmitter</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kr">constructor</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">super</span><span class="p">();</span>

<span class="w">    </span><span class="c1">// ÄÄƒng kÃ½ default metrics</span>
<span class="w">    </span><span class="nx">prometheus</span><span class="p">.</span><span class="nx">collectDefaultMetrics</span><span class="p">({</span>
<span class="w">      </span><span class="nx">timeout</span><span class="o">:</span><span class="w"> </span><span class="mf">5000</span><span class="p">,</span>
<span class="w">      </span><span class="nx">register</span><span class="o">:</span><span class="w"> </span><span class="nx">prometheus</span><span class="p">.</span><span class="nx">register</span>
<span class="w">    </span><span class="p">});</span>

<span class="w">    </span><span class="c1">// 1. Connection Metrics</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">connectionMetrics</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">activeConnections</span><span class="o">:</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">prometheus</span><span class="p">.</span><span class="nx">Gauge</span><span class="p">({</span>
<span class="w">        </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;chat_active_connections&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="nx">help</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Number of active WebSocket connections&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="nx">labelNames</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="s1">&#39;namespace&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;room&#39;</span><span class="p">]</span>
<span class="w">      </span><span class="p">}),</span>

<span class="w">      </span><span class="nx">connectionRate</span><span class="o">:</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">prometheus</span><span class="p">.</span><span class="nx">Counter</span><span class="p">({</span>
<span class="w">        </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;chat_connections_total&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="nx">help</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Total number of WebSocket connections&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="nx">labelNames</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">]</span><span class="w"> </span><span class="c1">// established, failed, rejected</span>
<span class="w">      </span><span class="p">}),</span>

<span class="w">      </span><span class="nx">connectionDuration</span><span class="o">:</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">prometheus</span><span class="p">.</span><span class="nx">Histogram</span><span class="p">({</span>
<span class="w">        </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;chat_connection_duration_seconds&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="nx">help</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Duration of WebSocket connections&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="nx">buckets</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="mf">1</span><span class="p">,</span><span class="w"> </span><span class="mf">5</span><span class="p">,</span><span class="w"> </span><span class="mf">15</span><span class="p">,</span><span class="w"> </span><span class="mf">30</span><span class="p">,</span><span class="w"> </span><span class="mf">60</span><span class="p">,</span><span class="w"> </span><span class="mf">120</span><span class="p">,</span><span class="w"> </span><span class="mf">300</span><span class="p">,</span><span class="w"> </span><span class="mf">600</span><span class="p">,</span><span class="w"> </span><span class="mf">1800</span><span class="p">,</span><span class="w"> </span><span class="mf">3600</span><span class="p">]</span>
<span class="w">      </span><span class="p">})</span>
<span class="w">    </span><span class="p">};</span>

<span class="w">    </span><span class="c1">// 2. Message Metrics</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">messageMetrics</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">messagesReceived</span><span class="o">:</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">prometheus</span><span class="p">.</span><span class="nx">Counter</span><span class="p">({</span>
<span class="w">        </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;chat_messages_received_total&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="nx">help</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Total messages received from clients&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="nx">labelNames</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span><span class="w"> </span><span class="c1">// text, image, file, command</span>
<span class="w">      </span><span class="p">}),</span>

<span class="w">      </span><span class="nx">messagesSent</span><span class="o">:</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">prometheus</span><span class="p">.</span><span class="nx">Counter</span><span class="p">({</span>
<span class="w">        </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;chat_messages_sent_total&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="nx">help</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Total messages sent to clients&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="nx">labelNames</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;destination&#39;</span><span class="p">]</span><span class="w"> </span><span class="c1">// broadcast, unicast, room</span>
<span class="w">      </span><span class="p">}),</span>

<span class="w">      </span><span class="nx">messageLatency</span><span class="o">:</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">prometheus</span><span class="p">.</span><span class="nx">Histogram</span><span class="p">({</span>
<span class="w">        </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;chat_message_latency_seconds&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="nx">help</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;End-to-end message latency&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="nx">buckets</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="mf">0.001</span><span class="p">,</span><span class="w"> </span><span class="mf">0.005</span><span class="p">,</span><span class="w"> </span><span class="mf">0.01</span><span class="p">,</span><span class="w"> </span><span class="mf">0.05</span><span class="p">,</span><span class="w"> </span><span class="mf">0.1</span><span class="p">,</span><span class="w"> </span><span class="mf">0.5</span><span class="p">,</span><span class="w"> </span><span class="mf">1</span><span class="p">,</span><span class="w"> </span><span class="mf">2</span><span class="p">,</span><span class="w"> </span><span class="mf">5</span><span class="p">]</span>
<span class="w">      </span><span class="p">}),</span>

<span class="w">      </span><span class="nx">messageSize</span><span class="o">:</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">prometheus</span><span class="p">.</span><span class="nx">Histogram</span><span class="p">({</span>
<span class="w">        </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;chat_message_size_bytes&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="nx">help</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Size of messages in bytes&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="nx">buckets</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="mf">100</span><span class="p">,</span><span class="w"> </span><span class="mf">500</span><span class="p">,</span><span class="w"> </span><span class="mf">1000</span><span class="p">,</span><span class="w"> </span><span class="mf">5000</span><span class="p">,</span><span class="w"> </span><span class="mf">10000</span><span class="p">,</span><span class="w"> </span><span class="mf">50000</span><span class="p">,</span><span class="w"> </span><span class="mf">100000</span><span class="p">]</span>
<span class="w">      </span><span class="p">})</span>
<span class="w">    </span><span class="p">};</span>

<span class="w">    </span><span class="c1">// 3. Room Metrics</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">roomMetrics</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">activeRooms</span><span class="o">:</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">prometheus</span><span class="p">.</span><span class="nx">Gauge</span><span class="p">({</span>
<span class="w">        </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;chat_active_rooms&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="nx">help</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Number of active chat rooms&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="nx">labelNames</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span><span class="w"> </span><span class="c1">// private, group, public</span>
<span class="w">      </span><span class="p">}),</span>

<span class="w">      </span><span class="nx">roomParticipants</span><span class="o">:</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">prometheus</span><span class="p">.</span><span class="nx">Gauge</span><span class="p">({</span>
<span class="w">        </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;chat_room_participants&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="nx">help</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Number of participants per room&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="nx">labelNames</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="s1">&#39;room_id&#39;</span><span class="p">]</span>
<span class="w">      </span><span class="p">}),</span>

<span class="w">      </span><span class="nx">roomMessageRate</span><span class="o">:</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">prometheus</span><span class="p">.</span><span class="nx">Gauge</span><span class="p">({</span>
<span class="w">        </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;chat_room_message_rate&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="nx">help</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Messages per second per room&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="nx">labelNames</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="s1">&#39;room_id&#39;</span><span class="p">]</span>
<span class="w">      </span><span class="p">})</span>
<span class="w">    </span><span class="p">};</span>

<span class="w">    </span><span class="c1">// 4. Business Metrics</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">businessMetrics</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">activeUsers</span><span class="o">:</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">prometheus</span><span class="p">.</span><span class="nx">Gauge</span><span class="p">({</span>
<span class="w">        </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;chat_active_users&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="nx">help</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Number of active users in last 5 minutes&#39;</span>
<span class="w">      </span><span class="p">}),</span>

<span class="w">      </span><span class="nx">userRetention</span><span class="o">:</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">prometheus</span><span class="p">.</span><span class="nx">Histogram</span><span class="p">({</span>
<span class="w">        </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;chat_user_session_duration_minutes&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="nx">help</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;User session duration in minutes&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="nx">buckets</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="mf">1</span><span class="p">,</span><span class="w"> </span><span class="mf">5</span><span class="p">,</span><span class="w"> </span><span class="mf">10</span><span class="p">,</span><span class="w"> </span><span class="mf">30</span><span class="p">,</span><span class="w"> </span><span class="mf">60</span><span class="p">,</span><span class="w"> </span><span class="mf">120</span><span class="p">,</span><span class="w"> </span><span class="mf">240</span><span class="p">,</span><span class="w"> </span><span class="mf">480</span><span class="p">,</span><span class="w"> </span><span class="mf">720</span><span class="p">,</span><span class="w"> </span><span class="mf">1440</span><span class="p">]</span>
<span class="w">      </span><span class="p">}),</span>

<span class="w">      </span><span class="nx">messagesPerUser</span><span class="o">:</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">prometheus</span><span class="p">.</span><span class="nx">Histogram</span><span class="p">({</span>
<span class="w">        </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;chat_messages_per_user&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="nx">help</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Messages sent per user per session&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="nx">buckets</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="mf">1</span><span class="p">,</span><span class="w"> </span><span class="mf">5</span><span class="p">,</span><span class="w"> </span><span class="mf">10</span><span class="p">,</span><span class="w"> </span><span class="mf">50</span><span class="p">,</span><span class="w"> </span><span class="mf">100</span><span class="p">,</span><span class="w"> </span><span class="mf">500</span><span class="p">,</span><span class="w"> </span><span class="mf">1000</span><span class="p">]</span>
<span class="w">      </span><span class="p">})</span>
<span class="w">    </span><span class="p">};</span>

<span class="w">    </span><span class="c1">// 5. System Health Metrics</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">systemMetrics</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">memoryUsage</span><span class="o">:</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">prometheus</span><span class="p">.</span><span class="nx">Gauge</span><span class="p">({</span>
<span class="w">        </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;chat_memory_usage_bytes&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="nx">help</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Memory usage of the chat application&#39;</span>
<span class="w">      </span><span class="p">}),</span>

<span class="w">      </span><span class="nx">eventLoopLag</span><span class="o">:</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">prometheus</span><span class="p">.</span><span class="nx">Gauge</span><span class="p">({</span>
<span class="w">        </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;chat_event_loop_lag_seconds&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="nx">help</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Event loop lag in seconds&#39;</span>
<span class="w">      </span><span class="p">}),</span>

<span class="w">      </span><span class="nx">gcDuration</span><span class="o">:</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">prometheus</span><span class="p">.</span><span class="nx">Histogram</span><span class="p">({</span>
<span class="w">        </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;chat_gc_duration_seconds&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="nx">help</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Garbage collection duration&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="nx">buckets</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="mf">0.001</span><span class="p">,</span><span class="w"> </span><span class="mf">0.01</span><span class="p">,</span><span class="w"> </span><span class="mf">0.1</span><span class="p">,</span><span class="w"> </span><span class="mf">0.5</span><span class="p">,</span><span class="w"> </span><span class="mf">1</span><span class="p">,</span><span class="w"> </span><span class="mf">2</span><span class="p">]</span>
<span class="w">      </span><span class="p">})</span>
<span class="w">    </span><span class="p">};</span>

<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">startCollection</span><span class="p">();</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nx">startCollection</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// Thu tháº­p memory usage má»—i 5 giÃ¢y</span>
<span class="w">    </span><span class="nx">setInterval</span><span class="p">(()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">memory</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">process</span><span class="p">.</span><span class="nx">memoryUsage</span><span class="p">();</span>
<span class="w">      </span><span class="k">this</span><span class="p">.</span><span class="nx">systemMetrics</span><span class="p">.</span><span class="nx">memoryUsage</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="nx">memory</span><span class="p">.</span><span class="nx">heapUsed</span><span class="p">);</span>
<span class="w">    </span><span class="p">},</span><span class="w"> </span><span class="mf">5000</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// Thu tháº­p event loop lag</span>
<span class="w">    </span><span class="nx">setInterval</span><span class="p">(()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">start</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">process</span><span class="p">.</span><span class="nx">hrtime</span><span class="p">();</span>
<span class="w">      </span><span class="nx">setImmediate</span><span class="p">(()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">delta</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">process</span><span class="p">.</span><span class="nx">hrtime</span><span class="p">(</span><span class="nx">start</span><span class="p">);</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">lag</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">delta</span><span class="p">[</span><span class="mf">0</span><span class="p">]</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">1e9</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">delta</span><span class="p">[</span><span class="mf">1</span><span class="p">];</span>
<span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="nx">systemMetrics</span><span class="p">.</span><span class="nx">eventLoopLag</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="nx">lag</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mf">1e9</span><span class="p">);</span>
<span class="w">      </span><span class="p">});</span>
<span class="w">    </span><span class="p">},</span><span class="w"> </span><span class="mf">1000</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// Thu tháº­p GC stats</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">global</span><span class="p">.</span><span class="nx">gc</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">gc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">require</span><span class="p">(</span><span class="s1">&#39;gc-stats&#39;</span><span class="p">)();</span>
<span class="w">      </span><span class="nx">gc</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;stats&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="nx">stats</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="nx">systemMetrics</span><span class="p">.</span><span class="nx">gcDuration</span><span class="p">.</span><span class="nx">observe</span><span class="p">(</span><span class="nx">stats</span><span class="p">.</span><span class="nx">pauseMS</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mf">1000</span><span class="p">);</span>
<span class="w">      </span><span class="p">});</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="c1">// PhÆ°Æ¡ng thá»©c Ä‘á»ƒ sá»­ dá»¥ng trong á»©ng dá»¥ng</span>
<span class="w">  </span><span class="nx">trackConnection</span><span class="p">(</span><span class="nx">socket</span><span class="p">,</span><span class="w"> </span><span class="nx">roomId</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">startTime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Date</span><span class="p">.</span><span class="nx">now</span><span class="p">();</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">namespace</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">socket</span><span class="p">.</span><span class="nx">nsp</span><span class="p">.</span><span class="nx">name</span><span class="p">;</span>

<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">connectionMetrics</span><span class="p">.</span><span class="nx">activeConnections</span><span class="p">.</span><span class="nx">inc</span><span class="p">({</span><span class="w"> </span><span class="nx">namespace</span><span class="p">,</span><span class="w"> </span><span class="nx">room</span><span class="o">:</span><span class="w"> </span><span class="nx">roomId</span><span class="w"> </span><span class="p">});</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">connectionMetrics</span><span class="p">.</span><span class="nx">connectionRate</span><span class="p">.</span><span class="nx">inc</span><span class="p">({</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;established&#39;</span><span class="w"> </span><span class="p">});</span>

<span class="w">    </span><span class="nx">socket</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;disconnect&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="nx">reason</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">duration</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nb">Date</span><span class="p">.</span><span class="nx">now</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nx">startTime</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mf">1000</span><span class="p">;</span>

<span class="w">      </span><span class="k">this</span><span class="p">.</span><span class="nx">connectionMetrics</span><span class="p">.</span><span class="nx">activeConnections</span><span class="p">.</span><span class="nx">dec</span><span class="p">({</span><span class="w"> </span><span class="nx">namespace</span><span class="p">,</span><span class="w"> </span><span class="nx">room</span><span class="o">:</span><span class="w"> </span><span class="nx">roomId</span><span class="w"> </span><span class="p">});</span>
<span class="w">      </span><span class="k">this</span><span class="p">.</span><span class="nx">connectionMetrics</span><span class="p">.</span><span class="nx">connectionDuration</span><span class="p">.</span><span class="nx">observe</span><span class="p">(</span><span class="nx">duration</span><span class="p">);</span>
<span class="w">      </span><span class="k">this</span><span class="p">.</span><span class="nx">connectionMetrics</span><span class="p">.</span><span class="nx">connectionRate</span><span class="p">.</span><span class="nx">inc</span><span class="p">({</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;closed&#39;</span><span class="w"> </span><span class="p">});</span>

<span class="w">      </span><span class="c1">// Track reason for analytics</span>
<span class="w">      </span><span class="k">this</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;connection_closed&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">socketId</span><span class="o">:</span><span class="w"> </span><span class="nx">socket</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span>
<span class="w">        </span><span class="nx">duration</span><span class="p">,</span>
<span class="w">        </span><span class="nx">reason</span><span class="p">,</span>
<span class="w">        </span><span class="nx">roomId</span>
<span class="w">      </span><span class="p">});</span>
<span class="w">    </span><span class="p">});</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nx">trackMessage</span><span class="p">(</span><span class="nx">socket</span><span class="p">,</span><span class="w"> </span><span class="nx">message</span><span class="p">,</span><span class="w"> </span><span class="nx">roomId</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">messageType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">message</span><span class="p">.</span><span class="nx">type</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;text&#39;</span><span class="p">;</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">startTime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">message</span><span class="p">.</span><span class="nx">timestamp</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nb">Date</span><span class="p">.</span><span class="nx">now</span><span class="p">();</span>

<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">messageMetrics</span><span class="p">.</span><span class="nx">messagesReceived</span><span class="p">.</span><span class="nx">inc</span><span class="p">({</span><span class="w"> </span><span class="nx">type</span><span class="o">:</span><span class="w"> </span><span class="nx">messageType</span><span class="w"> </span><span class="p">});</span>

<span class="w">    </span><span class="c1">// TÃ­nh latency khi message Ä‘Æ°á»£c xá»­ lÃ½ xong</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">trackDelivery</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">latency</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nb">Date</span><span class="p">.</span><span class="nx">now</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nx">startTime</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mf">1000</span><span class="p">;</span>
<span class="w">      </span><span class="k">this</span><span class="p">.</span><span class="nx">messageMetrics</span><span class="p">.</span><span class="nx">messageLatency</span><span class="p">.</span><span class="nx">observe</span><span class="p">(</span><span class="nx">latency</span><span class="p">);</span>

<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">message</span><span class="p">.</span><span class="nx">content</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">Buffer</span><span class="p">.</span><span class="nx">byteLength</span><span class="p">(</span><span class="nb">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">message</span><span class="p">.</span><span class="nx">content</span><span class="p">),</span><span class="w"> </span><span class="s1">&#39;utf8&#39;</span><span class="p">);</span>
<span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="nx">messageMetrics</span><span class="p">.</span><span class="nx">messageSize</span><span class="p">.</span><span class="nx">observe</span><span class="p">(</span><span class="nx">size</span><span class="p">);</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">};</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">trackDelivery</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nx">getMetrics</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">prometheus</span><span class="p">.</span><span class="nx">register</span><span class="p">.</span><span class="nx">metrics</span><span class="p">();</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nx">getMetricsAsJSON</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">prometheus</span><span class="p">.</span><span class="nx">register</span><span class="p">.</span><span class="nx">getMetricsAsJSON</span><span class="p">();</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>

<span class="c1">// Sá»­ dá»¥ng trong á»©ng dá»¥ng Socket.IO</span>
<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">ChatMetricsCollector</span><span class="w"> </span><span class="p">};</span>
</code></pre></div>
<h4 id="23-distributed-tracing-voi-opentelemetry">2.3 Distributed Tracing vá»›i OpenTelemetry<a class="headerlink" href="#23-distributed-tracing-voi-opentelemetry" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1">// monitoring/tracing.js</span>
<span class="kd">const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">NodeTracerProvider</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">require</span><span class="p">(</span><span class="s1">&#39;@opentelemetry/sdk-trace-node&#39;</span><span class="p">);</span>
<span class="kd">const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">SimpleSpanProcessor</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">require</span><span class="p">(</span><span class="s1">&#39;@opentelemetry/sdk-trace-base&#39;</span><span class="p">);</span>
<span class="kd">const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">JaegerExporter</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">require</span><span class="p">(</span><span class="s1">&#39;@opentelemetry/exporter-jaeger&#39;</span><span class="p">);</span>
<span class="kd">const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">ZipkinExporter</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">require</span><span class="p">(</span><span class="s1">&#39;@opentelemetry/exporter-zipkin&#39;</span><span class="p">);</span>
<span class="kd">const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">Resource</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">require</span><span class="p">(</span><span class="s1">&#39;@opentelemetry/resources&#39;</span><span class="p">);</span>
<span class="kd">const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">SemanticResourceAttributes</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">require</span><span class="p">(</span><span class="s1">&#39;@opentelemetry/semantic-conventions&#39;</span><span class="p">);</span>
<span class="kd">const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">trace</span><span class="p">,</span><span class="w"> </span><span class="nx">context</span><span class="p">,</span><span class="w"> </span><span class="nx">propagation</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">require</span><span class="p">(</span><span class="s1">&#39;@opentelemetry/api&#39;</span><span class="p">);</span>
<span class="kd">const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">W3CTraceContextPropagator</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">require</span><span class="p">(</span><span class="s1">&#39;@opentelemetry/core&#39;</span><span class="p">);</span>

<span class="kd">class</span><span class="w"> </span><span class="nx">ChatTracing</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kr">constructor</span><span class="p">(</span><span class="nx">serviceName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;chat-service&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">serviceName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">serviceName</span><span class="p">;</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">tracer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">setupTracing</span><span class="p">();</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nx">setupTracing</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// 1. Táº¡o provider</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">provider</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">NodeTracerProvider</span><span class="p">({</span>
<span class="w">      </span><span class="nx">resource</span><span class="o">:</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">Resource</span><span class="p">({</span>
<span class="w">        </span><span class="p">[</span><span class="nx">SemanticResourceAttributes</span><span class="p">.</span><span class="nx">SERVICE_NAME</span><span class="p">]</span><span class="o">:</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">serviceName</span><span class="p">,</span>
<span class="w">        </span><span class="p">[</span><span class="nx">SemanticResourceAttributes</span><span class="p">.</span><span class="nx">DEPLOYMENT_ENVIRONMENT</span><span class="p">]</span><span class="o">:</span><span class="w"> </span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">NODE_ENV</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;development&#39;</span>
<span class="w">      </span><span class="p">})</span>
<span class="w">    </span><span class="p">});</span>

<span class="w">    </span><span class="c1">// 2. Cáº¥u hÃ¬nh exporters</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">exporters</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[];</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">JAEGER_ENDPOINT</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">exporters</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="ow">new</span><span class="w"> </span><span class="nx">JaegerExporter</span><span class="p">({</span>
<span class="w">        </span><span class="nx">endpoint</span><span class="o">:</span><span class="w"> </span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">JAEGER_ENDPOINT</span><span class="p">,</span>
<span class="w">        </span><span class="nx">tags</span><span class="o">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">          </span><span class="p">{</span><span class="w"> </span><span class="nx">key</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;application&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">value</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;chat-app&#39;</span><span class="w"> </span><span class="p">},</span>
<span class="w">          </span><span class="p">{</span><span class="w"> </span><span class="nx">key</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;version&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">value</span><span class="o">:</span><span class="w"> </span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">VERSION</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;1.0.0&#39;</span><span class="w"> </span><span class="p">}</span>
<span class="w">        </span><span class="p">]</span>
<span class="w">      </span><span class="p">}));</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">ZIPKIN_ENDPOINT</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">exporters</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="ow">new</span><span class="w"> </span><span class="nx">ZipkinExporter</span><span class="p">({</span>
<span class="w">        </span><span class="nx">url</span><span class="o">:</span><span class="w"> </span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">ZIPKIN_ENDPOINT</span><span class="p">,</span>
<span class="w">        </span><span class="nx">serviceName</span><span class="o">:</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">serviceName</span>
<span class="w">      </span><span class="p">}));</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// 3. ThÃªm span processors</span>
<span class="w">    </span><span class="nx">exporters</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="nx">exporter</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">provider</span><span class="p">.</span><span class="nx">addSpanProcessor</span><span class="p">(</span><span class="ow">new</span><span class="w"> </span><span class="nx">SimpleSpanProcessor</span><span class="p">(</span><span class="nx">exporter</span><span class="p">));</span>
<span class="w">    </span><span class="p">});</span>

<span class="w">    </span><span class="c1">// 4. ÄÄƒng kÃ½ provider</span>
<span class="w">    </span><span class="nx">provider</span><span class="p">.</span><span class="nx">register</span><span class="p">({</span>
<span class="w">      </span><span class="nx">propagator</span><span class="o">:</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">W3CTraceContextPropagator</span><span class="p">()</span>
<span class="w">    </span><span class="p">});</span>

<span class="w">    </span><span class="c1">// 5. Láº¥y tracer</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">tracer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">trace</span><span class="p">.</span><span class="nx">getTracer</span><span class="p">(</span><span class="s1">&#39;chat-tracer&#39;</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="c1">// Táº¡o span cho WebSocket connection</span>
<span class="w">  </span><span class="nx">traceConnection</span><span class="p">(</span><span class="nx">socket</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">span</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">tracer</span><span class="p">.</span><span class="nx">startSpan</span><span class="p">(</span><span class="s1">&#39;websocket.connection&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">attributes</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="s1">&#39;socket.id&#39;</span><span class="o">:</span><span class="w"> </span><span class="nx">socket</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span>
<span class="w">        </span><span class="s1">&#39;user.id&#39;</span><span class="o">:</span><span class="w"> </span><span class="nx">socket</span><span class="p">.</span><span class="nx">userId</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;anonymous&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="s1">&#39;connection.type&#39;</span><span class="o">:</span><span class="w"> </span><span class="nx">socket</span><span class="p">.</span><span class="nx">conn</span><span class="p">.</span><span class="nx">transport</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span>
<span class="w">        </span><span class="s1">&#39;user.agent&#39;</span><span class="o">:</span><span class="w"> </span><span class="nx">socket</span><span class="p">.</span><span class="nx">request</span><span class="p">.</span><span class="nx">headers</span><span class="p">[</span><span class="s1">&#39;user-agent&#39;</span><span class="p">]</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">});</span>

<span class="w">    </span><span class="c1">// LÆ°u span vÃ o socket Ä‘á»ƒ sá»­ dá»¥ng sau</span>
<span class="w">    </span><span class="nx">socket</span><span class="p">.</span><span class="nx">__span</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">span</span><span class="p">;</span>

<span class="w">    </span><span class="nx">socket</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;disconnect&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="nx">reason</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">span</span><span class="p">.</span><span class="nx">setAttribute</span><span class="p">(</span><span class="s1">&#39;disconnect.reason&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">reason</span><span class="p">);</span>
<span class="w">      </span><span class="nx">span</span><span class="p">.</span><span class="nx">setAttribute</span><span class="p">(</span><span class="s1">&#39;connection.duration&#39;</span><span class="p">,</span><span class="w"> </span><span class="nb">Date</span><span class="p">.</span><span class="nx">now</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nx">span</span><span class="p">.</span><span class="nx">startTime</span><span class="p">);</span>
<span class="w">      </span><span class="nx">span</span><span class="p">.</span><span class="nx">end</span><span class="p">();</span>
<span class="w">    </span><span class="p">});</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">span</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="c1">// Táº¡o span cho message processing</span>
<span class="w">  </span><span class="nx">traceMessage</span><span class="p">(</span><span class="nx">socket</span><span class="p">,</span><span class="w"> </span><span class="nx">message</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">parentSpan</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">socket</span><span class="p">.</span><span class="nx">__span</span><span class="p">;</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">spanContext</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">parentSpan</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nx">trace</span><span class="p">.</span><span class="nx">setSpan</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nx">active</span><span class="p">(),</span><span class="w"> </span><span class="nx">parentSpan</span><span class="p">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="nx">context</span><span class="p">.</span><span class="nx">active</span><span class="p">();</span>

<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">span</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">tracer</span><span class="p">.</span><span class="nx">startSpan</span><span class="p">(</span><span class="s1">&#39;message.process&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">attributes</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="s1">&#39;message.id&#39;</span><span class="o">:</span><span class="w"> </span><span class="nx">message</span><span class="p">.</span><span class="nx">id</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;unknown&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="s1">&#39;message.type&#39;</span><span class="o">:</span><span class="w"> </span><span class="nx">message</span><span class="p">.</span><span class="nx">type</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;text&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="s1">&#39;message.size&#39;</span><span class="o">:</span><span class="w"> </span><span class="nb">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">message</span><span class="p">).</span><span class="nx">length</span><span class="p">,</span>
<span class="w">        </span><span class="s1">&#39;room.id&#39;</span><span class="o">:</span><span class="w"> </span><span class="nx">message</span><span class="p">.</span><span class="nx">roomId</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nx">socket</span><span class="p">.</span><span class="nx">roomId</span><span class="p">,</span>
<span class="w">        </span><span class="s1">&#39;sender.id&#39;</span><span class="o">:</span><span class="w"> </span><span class="nx">socket</span><span class="p">.</span><span class="nx">userId</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;anonymous&#39;</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">},</span><span class="w"> </span><span class="nx">spanContext</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// Inject trace context vÃ o message Ä‘á»ƒ truyá»n qua cÃ¡c service</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">carrier</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{};</span>
<span class="w">    </span><span class="nx">propagation</span><span class="p">.</span><span class="nx">inject</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nx">active</span><span class="p">(),</span><span class="w"> </span><span class="nx">carrier</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">set</span><span class="p">(</span><span class="nx">carrier</span><span class="p">,</span><span class="w"> </span><span class="nx">key</span><span class="p">,</span><span class="w"> </span><span class="nx">value</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">carrier</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">value</span><span class="p">;</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">});</span>

<span class="w">    </span><span class="nx">message</span><span class="p">.</span><span class="nx">traceContext</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">carrier</span><span class="p">;</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">span</span><span class="p">,</span>
<span class="w">      </span><span class="nx">end</span><span class="o">:</span><span class="w"> </span><span class="p">(</span><span class="nx">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;success&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">span</span><span class="p">.</span><span class="nx">setAttribute</span><span class="p">(</span><span class="s1">&#39;processing.status&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">status</span><span class="p">);</span>
<span class="w">        </span><span class="nx">span</span><span class="p">.</span><span class="nx">end</span><span class="p">();</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">};</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="c1">// Táº¡o span cho database query</span>
<span class="w">  </span><span class="nx">traceDatabase</span><span class="p">(</span><span class="nx">query</span><span class="p">,</span><span class="w"> </span><span class="nx">params</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">tracer</span><span class="p">.</span><span class="nx">startSpan</span><span class="p">(</span><span class="s1">&#39;database.query&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">attributes</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="s1">&#39;db.system&#39;</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;postgresql&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="s1">&#39;db.operation&#39;</span><span class="o">:</span><span class="w"> </span><span class="nx">query</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)[</span><span class="mf">0</span><span class="p">].</span><span class="nx">toLowerCase</span><span class="p">(),</span>
<span class="w">        </span><span class="s1">&#39;db.query&#39;</span><span class="o">:</span><span class="w"> </span><span class="nx">query</span><span class="p">,</span>
<span class="w">        </span><span class="s1">&#39;db.params.count&#39;</span><span class="o">:</span><span class="w"> </span><span class="nx">params</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nx">params</span><span class="p">.</span><span class="nx">length</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="mf">0</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">});</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="c1">// Táº¡o span cho Redis operation</span>
<span class="w">  </span><span class="nx">traceRedis</span><span class="p">(</span><span class="nx">operation</span><span class="p">,</span><span class="w"> </span><span class="nx">key</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">tracer</span><span class="p">.</span><span class="nx">startSpan</span><span class="p">(</span><span class="s1">&#39;redis.operation&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">attributes</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="s1">&#39;db.system&#39;</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;redis&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="s1">&#39;redis.operation&#39;</span><span class="o">:</span><span class="w"> </span><span class="nx">operation</span><span class="p">,</span>
<span class="w">        </span><span class="s1">&#39;redis.key&#39;</span><span class="o">:</span><span class="w"> </span><span class="nx">key</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">});</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>

<span class="c1">// Middleware cho Express Ä‘á»ƒ trace HTTP requests</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">tracingMiddleware</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">tracing</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">(</span><span class="nx">req</span><span class="p">,</span><span class="w"> </span><span class="nx">res</span><span class="p">,</span><span class="w"> </span><span class="nx">next</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">span</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">tracing</span><span class="p">.</span><span class="nx">tracer</span><span class="p">.</span><span class="nx">startSpan</span><span class="p">(</span><span class="s1">&#39;http.request&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">attributes</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="s1">&#39;http.method&#39;</span><span class="o">:</span><span class="w"> </span><span class="nx">req</span><span class="p">.</span><span class="nx">method</span><span class="p">,</span>
<span class="w">      </span><span class="s1">&#39;http.url&#39;</span><span class="o">:</span><span class="w"> </span><span class="nx">req</span><span class="p">.</span><span class="nx">url</span><span class="p">,</span>
<span class="w">      </span><span class="s1">&#39;http.route&#39;</span><span class="o">:</span><span class="w"> </span><span class="nx">req</span><span class="p">.</span><span class="nx">route</span><span class="o">?</span><span class="p">.</span><span class="nx">path</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;unknown&#39;</span><span class="p">,</span>
<span class="w">      </span><span class="s1">&#39;http.user_agent&#39;</span><span class="o">:</span><span class="w"> </span><span class="nx">req</span><span class="p">.</span><span class="nx">headers</span><span class="p">[</span><span class="s1">&#39;user-agent&#39;</span><span class="p">],</span>
<span class="w">      </span><span class="s1">&#39;http.client_ip&#39;</span><span class="o">:</span><span class="w"> </span><span class="nx">req</span><span class="p">.</span><span class="nx">ip</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">});</span>

<span class="w">  </span><span class="c1">// Gáº¯n span vÃ o request context</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">spanContext</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">trace</span><span class="p">.</span><span class="nx">setSpan</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nx">active</span><span class="p">(),</span><span class="w"> </span><span class="nx">span</span><span class="p">);</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">ctx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">trace</span><span class="p">.</span><span class="nx">bindContext</span><span class="p">(</span><span class="nx">spanContext</span><span class="p">,</span><span class="w"> </span><span class="nx">context</span><span class="p">.</span><span class="nx">active</span><span class="p">());</span>

<span class="w">  </span><span class="nx">context</span><span class="p">.</span><span class="kd">with</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// Theo dÃµi response</span>
<span class="w">    </span><span class="nx">res</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;finish&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">span</span><span class="p">.</span><span class="nx">setAttribute</span><span class="p">(</span><span class="s1">&#39;http.status_code&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">res</span><span class="p">.</span><span class="nx">statusCode</span><span class="p">);</span>
<span class="w">      </span><span class="nx">span</span><span class="p">.</span><span class="nx">setAttribute</span><span class="p">(</span><span class="s1">&#39;http.response_size&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">res</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;Content-Length&#39;</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="mf">0</span><span class="p">);</span>
<span class="w">      </span><span class="nx">span</span><span class="p">.</span><span class="nx">end</span><span class="p">();</span>
<span class="w">    </span><span class="p">});</span>

<span class="w">    </span><span class="nx">next</span><span class="p">();</span>
<span class="w">  </span><span class="p">});</span>
<span class="p">};</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">ChatTracing</span><span class="p">,</span><span class="w"> </span><span class="nx">tracingMiddleware</span><span class="w"> </span><span class="p">};</span>
</code></pre></div>
<h4 id="24-grafana-dashboard-configuration">2.4 Grafana Dashboard Configuration<a class="headerlink" href="#24-grafana-dashboard-configuration" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="p">{</span>
<span class="w">  </span><span class="nt">&quot;dashboard&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;title&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Chat Application Monitoring&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;panels&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">      </span><span class="p">{</span>
<span class="w">        </span><span class="nt">&quot;title&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Active Connections&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="nt">&quot;targets&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[{</span>
<span class="w">          </span><span class="nt">&quot;expr&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;sum(chat_active_connections)&quot;</span><span class="p">,</span>
<span class="w">          </span><span class="nt">&quot;legendFormat&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Connections&quot;</span>
<span class="w">        </span><span class="p">}],</span>
<span class="w">        </span><span class="nt">&quot;type&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;stat&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="nt">&quot;thresholds&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="nt">&quot;steps&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">            </span><span class="p">{</span><span class="w"> </span><span class="nt">&quot;color&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;green&quot;</span><span class="p">,</span><span class="w"> </span><span class="nt">&quot;value&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="p">},</span>
<span class="w">            </span><span class="p">{</span><span class="w"> </span><span class="nt">&quot;color&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;red&quot;</span><span class="p">,</span><span class="w"> </span><span class="nt">&quot;value&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">10000</span><span class="w"> </span><span class="p">}</span>
<span class="w">          </span><span class="p">]</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">      </span><span class="p">},</span>
<span class="w">      </span><span class="p">{</span>
<span class="w">        </span><span class="nt">&quot;title&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Message Latency (p95)&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="nt">&quot;targets&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[{</span>
<span class="w">          </span><span class="nt">&quot;expr&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;histogram_quantile(0.95, rate(chat_message_latency_seconds_bucket[5m]))&quot;</span><span class="p">,</span>
<span class="w">          </span><span class="nt">&quot;legendFormat&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Latency p95&quot;</span>
<span class="w">        </span><span class="p">}],</span>
<span class="w">        </span><span class="nt">&quot;type&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;graph&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="nt">&quot;yaxes&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[{</span>
<span class="w">          </span><span class="nt">&quot;format&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;s&quot;</span><span class="p">,</span>
<span class="w">          </span><span class="nt">&quot;min&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span>
<span class="w">        </span><span class="p">}]</span>
<span class="w">      </span><span class="p">},</span>
<span class="w">      </span><span class="p">{</span>
<span class="w">        </span><span class="nt">&quot;title&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Messages Per Second&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="nt">&quot;targets&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[{</span>
<span class="w">          </span><span class="nt">&quot;expr&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;rate(chat_messages_received_total[5m])&quot;</span><span class="p">,</span>
<span class="w">          </span><span class="nt">&quot;legendFormat&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Received&quot;</span>
<span class="w">        </span><span class="p">},</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="nt">&quot;expr&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;rate(chat_messages_sent_total[5m])&quot;</span><span class="p">,</span>
<span class="w">          </span><span class="nt">&quot;legendFormat&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Sent&quot;</span>
<span class="w">        </span><span class="p">}],</span>
<span class="w">        </span><span class="nt">&quot;type&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;graph&quot;</span>
<span class="w">      </span><span class="p">},</span>
<span class="w">      </span><span class="p">{</span>
<span class="w">        </span><span class="nt">&quot;title&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Error Rate&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="nt">&quot;targets&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[{</span>
<span class="w">          </span><span class="nt">&quot;expr&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;rate(chat_connections_total{status=\&quot;failed\&quot;}[5m]) / rate(chat_connections_total[5m]) * 100&quot;</span><span class="p">,</span>
<span class="w">          </span><span class="nt">&quot;legendFormat&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Connection Error Rate&quot;</span>
<span class="w">        </span><span class="p">}],</span>
<span class="w">        </span><span class="nt">&quot;type&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;gauge&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="nt">&quot;thresholds&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="nt">&quot;steps&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">            </span><span class="p">{</span><span class="w"> </span><span class="nt">&quot;color&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;green&quot;</span><span class="p">,</span><span class="w"> </span><span class="nt">&quot;value&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="p">},</span>
<span class="w">            </span><span class="p">{</span><span class="w"> </span><span class="nt">&quot;color&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;yellow&quot;</span><span class="p">,</span><span class="w"> </span><span class="nt">&quot;value&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="p">},</span>
<span class="w">            </span><span class="p">{</span><span class="w"> </span><span class="nt">&quot;color&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;red&quot;</span><span class="p">,</span><span class="w"> </span><span class="nt">&quot;value&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">5</span><span class="w"> </span><span class="p">}</span>
<span class="w">          </span><span class="p">]</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">      </span><span class="p">},</span>
<span class="w">      </span><span class="p">{</span>
<span class="w">        </span><span class="nt">&quot;title&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Room Activity&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="nt">&quot;targets&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[{</span>
<span class="w">          </span><span class="nt">&quot;expr&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;topk(10, chat_room_message_rate)&quot;</span><span class="p">,</span>
<span class="w">          </span><span class="nt">&quot;legendFormat&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;{{room_id}}&quot;</span>
<span class="w">        </span><span class="p">}],</span>
<span class="w">        </span><span class="nt">&quot;type&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;table&quot;</span>
<span class="w">      </span><span class="p">},</span>
<span class="w">      </span><span class="p">{</span>
<span class="w">        </span><span class="nt">&quot;title&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;System Resources&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="nt">&quot;targets&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[{</span>
<span class="w">          </span><span class="nt">&quot;expr&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;process_resident_memory_bytes&quot;</span><span class="p">,</span>
<span class="w">          </span><span class="nt">&quot;legendFormat&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Memory&quot;</span>
<span class="w">        </span><span class="p">},</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="nt">&quot;expr&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;rate(process_cpu_seconds_total[5m]) * 100&quot;</span><span class="p">,</span>
<span class="w">          </span><span class="nt">&quot;legendFormat&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;CPU&quot;</span>
<span class="w">        </span><span class="p">}],</span>
<span class="w">        </span><span class="nt">&quot;type&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;graph&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="nt">&quot;yaxes&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[{</span>
<span class="w">          </span><span class="nt">&quot;format&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;bytes&quot;</span>
<span class="w">        </span><span class="p">},</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="nt">&quot;format&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;percent&quot;</span>
<span class="w">        </span><span class="p">}]</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">],</span>
<span class="w">    </span><span class="nt">&quot;refresh&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;10s&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;time&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nt">&quot;from&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;now-1h&quot;</span><span class="p">,</span><span class="w"> </span><span class="nt">&quot;to&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;now&quot;</span><span class="w"> </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<h4 id="25-alerting-rules">2.5 Alerting Rules<a class="headerlink" href="#25-alerting-rules" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1"># alerting/rules.yml</span>
<span class="nt">groups</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">chat-application</span>
<span class="w">    </span><span class="nt">rules</span><span class="p">:</span>
<span class="w">      </span><span class="c1"># Alert khi connection error rate &gt; 5%</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">alert</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">HighConnectionErrorRate</span>
<span class="w">        </span><span class="nt">expr</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|</span>
<span class="w">          </span><span class="no">rate(chat_connections_total{status=&quot;failed&quot;}[5m]) </span>
<span class="w">          </span><span class="no">/ rate(chat_connections_total[5m]) </span>
<span class="w">          </span><span class="no">&gt; 0.05</span>
<span class="w">        </span><span class="nt">for</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">5m</span>
<span class="w">        </span><span class="nt">labels</span><span class="p">:</span>
<span class="w">          </span><span class="nt">severity</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">critical</span>
<span class="w">          </span><span class="nt">team</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">chat-platform</span>
<span class="w">        </span><span class="nt">annotations</span><span class="p">:</span>
<span class="w">          </span><span class="nt">summary</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;High</span><span class="nv"> </span><span class="s">connection</span><span class="nv"> </span><span class="s">error</span><span class="nv"> </span><span class="s">rate</span><span class="nv"> </span><span class="s">({{</span><span class="nv"> </span><span class="s">$value</span><span class="nv"> </span><span class="s">}}%)&quot;</span>
<span class="w">          </span><span class="nt">description</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;Connection</span><span class="nv"> </span><span class="s">error</span><span class="nv"> </span><span class="s">rate</span><span class="nv"> </span><span class="s">is</span><span class="nv"> </span><span class="s">above</span><span class="nv"> </span><span class="s">5%</span><span class="nv"> </span><span class="s">for</span><span class="nv"> </span><span class="s">5</span><span class="nv"> </span><span class="s">minutes&quot;</span>

<span class="w">      </span><span class="c1"># Alert khi message latency p95 &gt; 200ms</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">alert</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">HighMessageLatency</span>
<span class="w">        </span><span class="nt">expr</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|</span>
<span class="w">          </span><span class="no">histogram_quantile(0.95, rate(chat_message_latency_seconds_bucket[5m])) </span>
<span class="w">          </span><span class="no">&gt; 0.2</span>
<span class="w">        </span><span class="nt">for</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">5m</span>
<span class="w">        </span><span class="nt">labels</span><span class="p">:</span>
<span class="w">          </span><span class="nt">severity</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">warning</span>
<span class="w">          </span><span class="nt">team</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">chat-platform</span>
<span class="w">        </span><span class="nt">annotations</span><span class="p">:</span>
<span class="w">          </span><span class="nt">summary</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;High</span><span class="nv"> </span><span class="s">message</span><span class="nv"> </span><span class="s">latency</span><span class="nv"> </span><span class="s">(p95:</span><span class="nv"> </span><span class="s">{{</span><span class="nv"> </span><span class="s">$value</span><span class="nv"> </span><span class="s">}}s)&quot;</span>
<span class="w">          </span><span class="nt">description</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;Message</span><span class="nv"> </span><span class="s">latency</span><span class="nv"> </span><span class="s">p95</span><span class="nv"> </span><span class="s">is</span><span class="nv"> </span><span class="s">above</span><span class="nv"> </span><span class="s">200ms</span><span class="nv"> </span><span class="s">for</span><span class="nv"> </span><span class="s">5</span><span class="nv"> </span><span class="s">minutes&quot;</span>

<span class="w">      </span><span class="c1"># Alert khi active connections &gt; 10,000</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">alert</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">HighConcurrentConnections</span>
<span class="w">        </span><span class="nt">expr</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|</span>
<span class="w">          </span><span class="no">sum(chat_active_connections) </span>
<span class="w">          </span><span class="no">&gt; 10000</span>
<span class="w">        </span><span class="nt">for</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">2m</span>
<span class="w">        </span><span class="nt">labels</span><span class="p">:</span>
<span class="w">          </span><span class="nt">severity</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">warning</span>
<span class="w">          </span><span class="nt">team</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">chat-platform</span>
<span class="w">        </span><span class="nt">annotations</span><span class="p">:</span>
<span class="w">          </span><span class="nt">summary</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;High</span><span class="nv"> </span><span class="s">concurrent</span><span class="nv"> </span><span class="s">connections</span><span class="nv"> </span><span class="s">({{</span><span class="nv"> </span><span class="s">$value</span><span class="nv"> </span><span class="s">}})&quot;</span>
<span class="w">          </span><span class="nt">description</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;Active</span><span class="nv"> </span><span class="s">connections</span><span class="nv"> </span><span class="s">exceeded</span><span class="nv"> </span><span class="s">10,000&quot;</span>

<span class="w">      </span><span class="c1"># Alert khi memory usage &gt; 80%</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">alert</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">HighMemoryUsage</span>
<span class="w">        </span><span class="nt">expr</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|</span>
<span class="w">          </span><span class="no">process_resident_memory_bytes </span>
<span class="w">          </span><span class="no">/ node_memory_MemTotal_bytes </span>
<span class="w">          </span><span class="no">&gt; 0.8</span>
<span class="w">        </span><span class="nt">for</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">10m</span>
<span class="w">        </span><span class="nt">labels</span><span class="p">:</span>
<span class="w">          </span><span class="nt">severity</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">warning</span>
<span class="w">          </span><span class="nt">team</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">chat-platform</span>
<span class="w">        </span><span class="nt">annotations</span><span class="p">:</span>
<span class="w">          </span><span class="nt">summary</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;High</span><span class="nv"> </span><span class="s">memory</span><span class="nv"> </span><span class="s">usage</span><span class="nv"> </span><span class="s">({{</span><span class="nv"> </span><span class="s">$value</span><span class="nv"> </span><span class="s">|</span><span class="nv"> </span><span class="s">humanizePercentage</span><span class="nv"> </span><span class="s">}})&quot;</span>
<span class="w">          </span><span class="nt">description</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;Memory</span><span class="nv"> </span><span class="s">usage</span><span class="nv"> </span><span class="s">is</span><span class="nv"> </span><span class="s">above</span><span class="nv"> </span><span class="s">80%</span><span class="nv"> </span><span class="s">for</span><span class="nv"> </span><span class="s">10</span><span class="nv"> </span><span class="s">minutes&quot;</span>

<span class="w">      </span><span class="c1"># Alert khi cÃ³ sá»± giáº£m Ä‘á»™t ngá»™t sá»‘ connections</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">alert</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ConnectionDrop</span>
<span class="w">        </span><span class="nt">expr</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|</span>
<span class="w">          </span><span class="no">deriv(chat_active_connections[5m]) </span>
<span class="w">          </span><span class="no">&lt; -1000</span>
<span class="w">        </span><span class="nt">for</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1m</span>
<span class="w">        </span><span class="nt">labels</span><span class="p">:</span>
<span class="w">          </span><span class="nt">severity</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">critical</span>
<span class="w">          </span><span class="nt">team</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">chat-platform</span>
<span class="w">        </span><span class="nt">annotations</span><span class="p">:</span>
<span class="w">          </span><span class="nt">summary</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;Sudden</span><span class="nv"> </span><span class="s">connection</span><span class="nv"> </span><span class="s">drop</span><span class="nv"> </span><span class="s">({{</span><span class="nv"> </span><span class="s">$value</span><span class="nv"> </span><span class="s">}}</span><span class="nv"> </span><span class="s">connections/min)&quot;</span>
<span class="w">          </span><span class="nt">description</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;Active</span><span class="nv"> </span><span class="s">connections</span><span class="nv"> </span><span class="s">dropped</span><span class="nv"> </span><span class="s">by</span><span class="nv"> </span><span class="s">more</span><span class="nv"> </span><span class="s">than</span><span class="nv"> </span><span class="s">1000</span><span class="nv"> </span><span class="s">in</span><span class="nv"> </span><span class="s">1</span><span class="nv"> </span><span class="s">minute&quot;</span>
</code></pre></div>
<hr />
<h3 id="cach-troubleshoot-cac-van-e-performance-pho-bien">ğŸ”§ CÃ¡ch Troubleshoot CÃ¡c Váº¥n Äá» Performance Phá»• Biáº¿n<a class="headerlink" href="#cach-troubleshoot-cac-van-e-performance-pho-bien" title="Permanent link">&para;</a></h3>
<h4 id="31-diagnostic-framework">3.1 Diagnostic Framework<a class="headerlink" href="#31-diagnostic-framework" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1">// troubleshooting/diagnostic-toolkit.js</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">os</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">require</span><span class="p">(</span><span class="s1">&#39;os&#39;</span><span class="p">);</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">v8</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">require</span><span class="p">(</span><span class="s1">&#39;v8&#39;</span><span class="p">);</span>
<span class="kd">const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">promisify</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">require</span><span class="p">(</span><span class="s1">&#39;util&#39;</span><span class="p">);</span>
<span class="kd">const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">exec</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">require</span><span class="p">(</span><span class="s1">&#39;child_process&#39;</span><span class="p">);</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">execAsync</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">promisify</span><span class="p">(</span><span class="nx">exec</span><span class="p">);</span>

<span class="kd">class</span><span class="w"> </span><span class="nx">ChatDiagnosticToolkit</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kr">constructor</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">diagnosticHistory</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[];</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">metricsCache</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nb">Map</span><span class="p">();</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="c1">// 1. DIAGNOSE HIGH LATENCY</span>
<span class="w">  </span><span class="k">async</span><span class="w"> </span><span class="nx">diagnoseLatency</span><span class="p">(</span><span class="nx">latencyThreshold</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">200</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">report</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">timestamp</span><span class="o">:</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nb">Date</span><span class="p">().</span><span class="nx">toISOString</span><span class="p">(),</span>
<span class="w">      </span><span class="nx">issue</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;High Message Latency&#39;</span><span class="p">,</span>
<span class="w">      </span><span class="nx">checks</span><span class="o">:</span><span class="w"> </span><span class="p">[],</span>
<span class="w">      </span><span class="nx">recommendations</span><span class="o">:</span><span class="w"> </span><span class="p">[]</span>
<span class="w">    </span><span class="p">};</span>

<span class="w">    </span><span class="c1">// Check 1: System load</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">load</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">os</span><span class="p">.</span><span class="nx">loadavg</span><span class="p">();</span>
<span class="w">    </span><span class="nx">report</span><span class="p">.</span><span class="nx">checks</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span>
<span class="w">      </span><span class="nx">check</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;System Load Average&#39;</span><span class="p">,</span>
<span class="w">      </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="nx">load</span><span class="p">[</span><span class="mf">0</span><span class="p">]</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="nx">os</span><span class="p">.</span><span class="nx">cpus</span><span class="p">().</span><span class="nx">length</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="s1">&#39;HIGH&#39;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;OK&#39;</span><span class="p">,</span>
<span class="w">      </span><span class="nx">value</span><span class="o">:</span><span class="w"> </span><span class="nx">load</span><span class="p">,</span>
<span class="w">      </span><span class="nx">threshold</span><span class="o">:</span><span class="w"> </span><span class="nx">os</span><span class="p">.</span><span class="nx">cpus</span><span class="p">().</span><span class="nx">length</span>
<span class="w">    </span><span class="p">});</span>

<span class="w">    </span><span class="c1">// Check 2: Node.js event loop lag</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">eventLoopLag</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">measureEventLoopLag</span><span class="p">();</span>
<span class="w">    </span><span class="nx">report</span><span class="p">.</span><span class="nx">checks</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span>
<span class="w">      </span><span class="nx">check</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Event Loop Lag&#39;</span><span class="p">,</span>
<span class="w">      </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="nx">eventLoopLag</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">100</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="s1">&#39;HIGH&#39;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;OK&#39;</span><span class="p">,</span>
<span class="w">      </span><span class="nx">value</span><span class="o">:</span><span class="w"> </span><span class="sb">`</span><span class="si">${</span><span class="nx">eventLoopLag</span><span class="si">}</span><span class="sb">ms`</span><span class="p">,</span>
<span class="w">      </span><span class="nx">threshold</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;100ms&#39;</span>
<span class="w">    </span><span class="p">});</span>

<span class="w">    </span><span class="c1">// Check 3: Garbage Collection frequency</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">gcStats</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">v8</span><span class="p">.</span><span class="nx">getHeapStatistics</span><span class="p">();</span>
<span class="w">    </span><span class="nx">report</span><span class="p">.</span><span class="nx">checks</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span>
<span class="w">      </span><span class="nx">check</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Garbage Collection Pressure&#39;</span><span class="p">,</span>
<span class="w">      </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="nx">gcStats</span><span class="p">.</span><span class="nx">heap_size_limit</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nx">gcStats</span><span class="p">.</span><span class="nx">used_heap_size</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mf">100</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">1024</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">1024</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="s1">&#39;HIGH&#39;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;OK&#39;</span><span class="p">,</span>
<span class="w">      </span><span class="nx">value</span><span class="o">:</span><span class="w"> </span><span class="sb">`</span><span class="si">${</span><span class="nb">Math</span><span class="p">.</span><span class="nx">round</span><span class="p">((</span><span class="nx">gcStats</span><span class="p">.</span><span class="nx">used_heap_size</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="nx">gcStats</span><span class="p">.</span><span class="nx">heap_size_limit</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">100</span><span class="p">)</span><span class="si">}</span><span class="sb">%`</span><span class="p">,</span>
<span class="w">      </span><span class="nx">threshold</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;90%&#39;</span>
<span class="w">    </span><span class="p">});</span>

<span class="w">    </span><span class="c1">// Check 4: Network latency to dependencies</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">redisLatency</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">measureRedisLatency</span><span class="p">();</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">dbLatency</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">measureDatabaseLatency</span><span class="p">();</span>

<span class="w">    </span><span class="nx">report</span><span class="p">.</span><span class="nx">checks</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span>
<span class="w">      </span><span class="nx">check</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Redis Latency&#39;</span><span class="p">,</span>
<span class="w">      </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="nx">redisLatency</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">10</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="s1">&#39;HIGH&#39;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;OK&#39;</span><span class="p">,</span>
<span class="w">      </span><span class="nx">value</span><span class="o">:</span><span class="w"> </span><span class="sb">`</span><span class="si">${</span><span class="nx">redisLatency</span><span class="si">}</span><span class="sb">ms`</span><span class="p">,</span>
<span class="w">      </span><span class="nx">threshold</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;10ms&#39;</span>
<span class="w">    </span><span class="p">});</span>

<span class="w">    </span><span class="nx">report</span><span class="p">.</span><span class="nx">checks</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span>
<span class="w">      </span><span class="nx">check</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Database Latency&#39;</span><span class="p">,</span>
<span class="w">      </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="nx">dbLatency</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">50</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="s1">&#39;HIGH&#39;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;OK&#39;</span><span class="p">,</span>
<span class="w">      </span><span class="nx">value</span><span class="o">:</span><span class="w"> </span><span class="sb">`</span><span class="si">${</span><span class="nx">dbLatency</span><span class="si">}</span><span class="sb">ms`</span><span class="p">,</span>
<span class="w">      </span><span class="nx">threshold</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;50ms&#39;</span>
<span class="w">    </span><span class="p">});</span>

<span class="w">    </span><span class="c1">// Check 5: Message queue backlog</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">queueSize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">getMessageQueueSize</span><span class="p">();</span>
<span class="w">    </span><span class="nx">report</span><span class="p">.</span><span class="nx">checks</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span>
<span class="w">      </span><span class="nx">check</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Message Queue Backlog&#39;</span><span class="p">,</span>
<span class="w">      </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="nx">queueSize</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">1000</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="s1">&#39;HIGH&#39;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;OK&#39;</span><span class="p">,</span>
<span class="w">      </span><span class="nx">value</span><span class="o">:</span><span class="w"> </span><span class="nx">queueSize</span><span class="p">,</span>
<span class="w">      </span><span class="nx">threshold</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;1000 messages&#39;</span>
<span class="w">    </span><span class="p">});</span>

<span class="w">    </span><span class="c1">// Generate recommendations</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">report</span><span class="p">.</span><span class="nx">checks</span><span class="p">.</span><span class="nx">some</span><span class="p">(</span><span class="nx">c</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">c</span><span class="p">.</span><span class="nx">status</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;HIGH&#39;</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">report</span><span class="p">.</span><span class="nx">recommendations</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">generateLatencyRecommendations</span><span class="p">(</span><span class="nx">report</span><span class="p">.</span><span class="nx">checks</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">diagnosticHistory</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">report</span><span class="p">);</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">report</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="c1">// 2. DIAGNOSE HIGH MEMORY USAGE</span>
<span class="w">  </span><span class="k">async</span><span class="w"> </span><span class="nx">diagnoseMemory</span><span class="p">(</span><span class="nx">memoryThreshold</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.8</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">report</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">timestamp</span><span class="o">:</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nb">Date</span><span class="p">().</span><span class="nx">toISOString</span><span class="p">(),</span>
<span class="w">      </span><span class="nx">issue</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;High Memory Usage&#39;</span><span class="p">,</span>
<span class="w">      </span><span class="nx">checks</span><span class="o">:</span><span class="w"> </span><span class="p">[],</span>
<span class="w">      </span><span class="nx">recommendations</span><span class="o">:</span><span class="w"> </span><span class="p">[]</span>
<span class="w">    </span><span class="p">};</span>

<span class="w">    </span><span class="c1">// Check 1: Memory usage percentage</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">totalMem</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">os</span><span class="p">.</span><span class="nx">totalmem</span><span class="p">();</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">freeMem</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">os</span><span class="p">.</span><span class="nx">freemem</span><span class="p">();</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">usedPercentage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">totalMem</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nx">freeMem</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="nx">totalMem</span><span class="p">;</span>

<span class="w">    </span><span class="nx">report</span><span class="p">.</span><span class="nx">checks</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span>
<span class="w">      </span><span class="nx">check</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;System Memory Usage&#39;</span><span class="p">,</span>
<span class="w">      </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="nx">usedPercentage</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="nx">memoryThreshold</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="s1">&#39;HIGH&#39;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;OK&#39;</span><span class="p">,</span>
<span class="w">      </span><span class="nx">value</span><span class="o">:</span><span class="w"> </span><span class="sb">`</span><span class="si">${</span><span class="nb">Math</span><span class="p">.</span><span class="nx">round</span><span class="p">(</span><span class="nx">usedPercentage</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">100</span><span class="p">)</span><span class="si">}</span><span class="sb">%`</span><span class="p">,</span>
<span class="w">      </span><span class="nx">threshold</span><span class="o">:</span><span class="w"> </span><span class="sb">`</span><span class="si">${</span><span class="nx">memoryThreshold</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">100</span><span class="si">}</span><span class="sb">%`</span>
<span class="w">    </span><span class="p">});</span>

<span class="w">    </span><span class="c1">// Check 2: Node.js heap statistics</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">heapStats</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">v8</span><span class="p">.</span><span class="nx">getHeapStatistics</span><span class="p">();</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">heapUsage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">heapStats</span><span class="p">.</span><span class="nx">used_heap_size</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="nx">heapStats</span><span class="p">.</span><span class="nx">heap_size_limit</span><span class="p">;</span>

<span class="w">    </span><span class="nx">report</span><span class="p">.</span><span class="nx">checks</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span>
<span class="w">      </span><span class="nx">check</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Node.js Heap Usage&#39;</span><span class="p">,</span>
<span class="w">      </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="nx">heapUsage</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">0.8</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="s1">&#39;HIGH&#39;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;OK&#39;</span><span class="p">,</span>
<span class="w">      </span><span class="nx">value</span><span class="o">:</span><span class="w"> </span><span class="sb">`</span><span class="si">${</span><span class="nb">Math</span><span class="p">.</span><span class="nx">round</span><span class="p">(</span><span class="nx">heapUsage</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">100</span><span class="p">)</span><span class="si">}</span><span class="sb">%`</span><span class="p">,</span>
<span class="w">      </span><span class="nx">threshold</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;80%&#39;</span>
<span class="w">    </span><span class="p">});</span>

<span class="w">    </span><span class="c1">// Check 3: Memory leak detection</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">memoryTrend</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">analyzeMemoryTrend</span><span class="p">();</span>
<span class="w">    </span><span class="nx">report</span><span class="p">.</span><span class="nx">checks</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span>
<span class="w">      </span><span class="nx">check</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Memory Leak Detection&#39;</span><span class="p">,</span>
<span class="w">      </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="nx">memoryTrend</span><span class="p">.</span><span class="nx">slope</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">0.1</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="s1">&#39;DETECTED&#39;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;OK&#39;</span><span class="p">,</span>
<span class="w">      </span><span class="nx">value</span><span class="o">:</span><span class="w"> </span><span class="sb">`Trend: </span><span class="si">${</span><span class="nx">memoryTrend</span><span class="p">.</span><span class="nx">slope</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">0</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="s1">&#39;+&#39;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="si">}${</span><span class="nx">memoryTrend</span><span class="p">.</span><span class="nx">slope</span><span class="p">.</span><span class="nx">toFixed</span><span class="p">(</span><span class="mf">3</span><span class="p">)</span><span class="si">}</span><span class="sb"> MB/min`</span><span class="p">,</span>
<span class="w">      </span><span class="nx">threshold</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;0.1 MB/min increase&#39;</span>
<span class="w">    </span><span class="p">});</span>

<span class="w">    </span><span class="c1">// Check 4: External memory usage</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">redisMemory</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">checkRedisMemory</span><span class="p">();</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">dbMemory</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">checkDatabaseMemory</span><span class="p">();</span>

<span class="w">    </span><span class="nx">report</span><span class="p">.</span><span class="nx">checks</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span>
<span class="w">      </span><span class="nx">check</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Redis Memory Usage&#39;</span><span class="p">,</span>
<span class="w">      </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="nx">redisMemory</span><span class="p">.</span><span class="nx">usage</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">0.7</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="s1">&#39;HIGH&#39;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;OK&#39;</span><span class="p">,</span>
<span class="w">      </span><span class="nx">value</span><span class="o">:</span><span class="w"> </span><span class="sb">`</span><span class="si">${</span><span class="nb">Math</span><span class="p">.</span><span class="nx">round</span><span class="p">(</span><span class="nx">redisMemory</span><span class="p">.</span><span class="nx">usage</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">100</span><span class="p">)</span><span class="si">}</span><span class="sb">% (</span><span class="si">${</span><span class="nx">redisMemory</span><span class="p">.</span><span class="nx">used</span><span class="si">}</span><span class="sb">MB)`</span><span class="p">,</span>
<span class="w">      </span><span class="nx">threshold</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;70%&#39;</span>
<span class="w">    </span><span class="p">});</span>

<span class="w">    </span><span class="c1">// Check 5: Connection pool memory</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">connectionMemory</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">estimateConnectionMemory</span><span class="p">();</span>
<span class="w">    </span><span class="nx">report</span><span class="p">.</span><span class="nx">checks</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span>
<span class="w">      </span><span class="nx">check</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;WebSocket Connection Memory&#39;</span><span class="p">,</span>
<span class="w">      </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="nx">connectionMemory</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">500</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">1024</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">1024</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="s1">&#39;HIGH&#39;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;OK&#39;</span><span class="p">,</span><span class="w"> </span><span class="c1">// &gt; 500MB</span>
<span class="w">      </span><span class="nx">value</span><span class="o">:</span><span class="w"> </span><span class="sb">`</span><span class="si">${</span><span class="nb">Math</span><span class="p">.</span><span class="nx">round</span><span class="p">(</span><span class="nx">connectionMemory</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="p">(</span><span class="mf">1024</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">1024</span><span class="p">))</span><span class="si">}</span><span class="sb">MB`</span><span class="p">,</span>
<span class="w">      </span><span class="nx">threshold</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;500MB&#39;</span>
<span class="w">    </span><span class="p">});</span>

<span class="w">    </span><span class="c1">// Heap dump analysis</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">report</span><span class="p">.</span><span class="nx">checks</span><span class="p">.</span><span class="nx">some</span><span class="p">(</span><span class="nx">c</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">c</span><span class="p">.</span><span class="nx">status</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;HIGH&#39;</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nx">c</span><span class="p">.</span><span class="nx">status</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;DETECTED&#39;</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">heapAnalysis</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">analyzeHeapDump</span><span class="p">();</span>
<span class="w">      </span><span class="nx">report</span><span class="p">.</span><span class="nx">heapAnalysis</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">heapAnalysis</span><span class="p">;</span>

<span class="w">      </span><span class="nx">report</span><span class="p">.</span><span class="nx">recommendations</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">generateMemoryRecommendations</span><span class="p">(</span>
<span class="w">        </span><span class="nx">report</span><span class="p">.</span><span class="nx">checks</span><span class="p">,</span>
<span class="w">        </span><span class="nx">heapAnalysis</span>
<span class="w">      </span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">report</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="c1">// 3. DIAGNOSE CONNECTION ISSUES</span>
<span class="w">  </span><span class="k">async</span><span class="w"> </span><span class="nx">diagnoseConnections</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">report</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">timestamp</span><span class="o">:</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nb">Date</span><span class="p">().</span><span class="nx">toISOString</span><span class="p">(),</span>
<span class="w">      </span><span class="nx">issue</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Connection Issues&#39;</span><span class="p">,</span>
<span class="w">      </span><span class="nx">checks</span><span class="o">:</span><span class="w"> </span><span class="p">[],</span>
<span class="w">      </span><span class="nx">recommendations</span><span class="o">:</span><span class="w"> </span><span class="p">[]</span>
<span class="w">    </span><span class="p">};</span>

<span class="w">    </span><span class="c1">// Check 1: File descriptor limits</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">fdLimit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">getFileDescriptorLimit</span><span class="p">();</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">fdUsage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">getFileDescriptorUsage</span><span class="p">();</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">fdPercentage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">fdUsage</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="nx">fdLimit</span><span class="p">;</span>

<span class="w">    </span><span class="nx">report</span><span class="p">.</span><span class="nx">checks</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span>
<span class="w">      </span><span class="nx">check</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;File Descriptor Usage&#39;</span><span class="p">,</span>
<span class="w">      </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="nx">fdPercentage</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">0.8</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="s1">&#39;HIGH&#39;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;OK&#39;</span><span class="p">,</span>
<span class="w">      </span><span class="nx">value</span><span class="o">:</span><span class="w"> </span><span class="sb">`</span><span class="si">${</span><span class="nx">fdUsage</span><span class="si">}</span><span class="sb">/</span><span class="si">${</span><span class="nx">fdLimit</span><span class="si">}</span><span class="sb"> (</span><span class="si">${</span><span class="nb">Math</span><span class="p">.</span><span class="nx">round</span><span class="p">(</span><span class="nx">fdPercentage</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">100</span><span class="p">)</span><span class="si">}</span><span class="sb">%)`</span><span class="p">,</span>
<span class="w">      </span><span class="nx">threshold</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;80%&#39;</span>
<span class="w">    </span><span class="p">});</span>

<span class="w">    </span><span class="c1">// Check 2: TCP connection states</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">tcpStats</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">getTCPConnectionStats</span><span class="p">();</span>
<span class="w">    </span><span class="nx">report</span><span class="p">.</span><span class="nx">checks</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span>
<span class="w">      </span><span class="nx">check</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;TCP TIME_WAIT Connections&#39;</span><span class="p">,</span>
<span class="w">      </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="nx">tcpStats</span><span class="p">.</span><span class="nx">timeWait</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">10000</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="s1">&#39;HIGH&#39;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;OK&#39;</span><span class="p">,</span>
<span class="w">      </span><span class="nx">value</span><span class="o">:</span><span class="w"> </span><span class="nx">tcpStats</span><span class="p">.</span><span class="nx">timeWait</span><span class="p">,</span>
<span class="w">      </span><span class="nx">threshold</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;10,000&#39;</span>
<span class="w">    </span><span class="p">});</span>

<span class="w">    </span><span class="c1">// Check 3: WebSocket handshake failures</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">wsFailures</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">getWebSocketFailureRate</span><span class="p">();</span>
<span class="w">    </span><span class="nx">report</span><span class="p">.</span><span class="nx">checks</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span>
<span class="w">      </span><span class="nx">check</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;WebSocket Handshake Failure Rate&#39;</span><span class="p">,</span>
<span class="w">      </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="nx">wsFailures</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">0.05</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="s1">&#39;HIGH&#39;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;OK&#39;</span><span class="p">,</span>
<span class="w">      </span><span class="nx">value</span><span class="o">:</span><span class="w"> </span><span class="sb">`</span><span class="si">${</span><span class="nb">Math</span><span class="p">.</span><span class="nx">round</span><span class="p">(</span><span class="nx">wsFailures</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">100</span><span class="p">)</span><span class="si">}</span><span class="sb">%`</span><span class="p">,</span>
<span class="w">      </span><span class="nx">threshold</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;5%&#39;</span>
<span class="w">    </span><span class="p">});</span>

<span class="w">    </span><span class="c1">// Check 4: Authentication latency</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">authLatency</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">getAuthenticationLatency</span><span class="p">();</span>
<span class="w">    </span><span class="nx">report</span><span class="p">.</span><span class="nx">checks</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span>
<span class="w">      </span><span class="nx">check</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Authentication Latency&#39;</span><span class="p">,</span>
<span class="w">      </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="nx">authLatency</span><span class="p">.</span><span class="nx">p95</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">1000</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="s1">&#39;HIGH&#39;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;OK&#39;</span><span class="p">,</span>
<span class="w">      </span><span class="nx">value</span><span class="o">:</span><span class="w"> </span><span class="sb">`p95: </span><span class="si">${</span><span class="nx">authLatency</span><span class="p">.</span><span class="nx">p95</span><span class="si">}</span><span class="sb">ms`</span><span class="p">,</span>
<span class="w">      </span><span class="nx">threshold</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;1000ms&#39;</span>
<span class="w">    </span><span class="p">});</span>

<span class="w">    </span><span class="c1">// Check 5: Load balancer health</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">lbHealth</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">checkLoadBalancerHealth</span><span class="p">();</span>
<span class="w">    </span><span class="nx">report</span><span class="p">.</span><span class="nx">checks</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span>
<span class="w">      </span><span class="nx">check</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Load Balancer Health&#39;</span><span class="p">,</span>
<span class="w">      </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="nx">lbHealth</span><span class="p">.</span><span class="nx">healthyInstances</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="nx">lbHealth</span><span class="p">.</span><span class="nx">totalInstances</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">0.8</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="s1">&#39;DEGRADED&#39;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;OK&#39;</span><span class="p">,</span>
<span class="w">      </span><span class="nx">value</span><span class="o">:</span><span class="w"> </span><span class="sb">`</span><span class="si">${</span><span class="nx">lbHealth</span><span class="p">.</span><span class="nx">healthyInstances</span><span class="si">}</span><span class="sb">/</span><span class="si">${</span><span class="nx">lbHealth</span><span class="p">.</span><span class="nx">totalInstances</span><span class="si">}</span><span class="sb"> healthy`</span><span class="p">,</span>
<span class="w">      </span><span class="nx">threshold</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;80% healthy&#39;</span>
<span class="w">    </span><span class="p">});</span>

<span class="w">    </span><span class="c1">// Generate recommendations</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">highChecks</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">report</span><span class="p">.</span><span class="nx">checks</span><span class="p">.</span><span class="nx">filter</span><span class="p">(</span><span class="nx">c</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span>
<span class="w">      </span><span class="nx">c</span><span class="p">.</span><span class="nx">status</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;HIGH&#39;</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nx">c</span><span class="p">.</span><span class="nx">status</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;DEGRADED&#39;</span>
<span class="w">    </span><span class="p">);</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">highChecks</span><span class="p">.</span><span class="nx">length</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">report</span><span class="p">.</span><span class="nx">recommendations</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">generateConnectionRecommendations</span><span class="p">(</span><span class="nx">highChecks</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">report</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="c1">// Utility methods (giáº£ láº­p - trong production cáº§n implement tháº­t)</span>
<span class="w">  </span><span class="k">async</span><span class="w"> </span><span class="nx">measureEventLoopLag</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">start</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">process</span><span class="p">.</span><span class="nx">hrtime</span><span class="p">.</span><span class="nx">bigint</span><span class="p">();</span>
<span class="w">    </span><span class="k">await</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nb">Promise</span><span class="p">(</span><span class="nx">resolve</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">setImmediate</span><span class="p">(</span><span class="nx">resolve</span><span class="p">));</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">end</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">process</span><span class="p">.</span><span class="nx">hrtime</span><span class="p">.</span><span class="nx">bigint</span><span class="p">();</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nb">Number</span><span class="p">(</span><span class="nx">end</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nx">start</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mf">1</span><span class="nx">_000_000</span><span class="p">;</span><span class="w"> </span><span class="c1">// Convert to milliseconds</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">async</span><span class="w"> </span><span class="nx">measureRedisLatency</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">start</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Date</span><span class="p">.</span><span class="nx">now</span><span class="p">();</span>
<span class="w">      </span><span class="c1">// Giáº£ láº­p Redis PING</span>
<span class="w">      </span><span class="k">await</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nb">Promise</span><span class="p">(</span><span class="nx">resolve</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">setTimeout</span><span class="p">(</span><span class="nx">resolve</span><span class="p">,</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">random</span><span class="p">()</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">20</span><span class="p">));</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="nb">Date</span><span class="p">.</span><span class="nx">now</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nx">start</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="nx">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="kc">Infinity</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">async</span><span class="w"> </span><span class="nx">measureDatabaseLatency</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// Giáº£ láº­p database query latency</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">random</span><span class="p">()</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">100</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">async</span><span class="w"> </span><span class="nx">getMessageQueueSize</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// Giáº£ láº­p message queue size</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span><span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nx">random</span><span class="p">()</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">2000</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">async</span><span class="w"> </span><span class="nx">analyzeMemoryTrend</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// Thu tháº­p 10 máº«u memory trong 1 phÃºt</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">samples</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[];</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">let</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mf">10</span><span class="p">;</span><span class="w"> </span><span class="nx">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">samples</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">memoryUsage</span><span class="p">().</span><span class="nx">heapUsed</span><span class="p">);</span>
<span class="w">      </span><span class="k">await</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nb">Promise</span><span class="p">(</span><span class="nx">resolve</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">setTimeout</span><span class="p">(</span><span class="nx">resolve</span><span class="p">,</span><span class="w"> </span><span class="mf">6000</span><span class="p">));</span><span class="w"> </span><span class="c1">// 6 giÃ¢y</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// TÃ­nh trend line</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">samples</span><span class="p">.</span><span class="nx">map</span><span class="p">((</span><span class="nx">_</span><span class="p">,</span><span class="w"> </span><span class="nx">i</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">i</span><span class="p">);</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">samples</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">v</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">v</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="p">(</span><span class="mf">1024</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">1024</span><span class="p">));</span><span class="w"> </span><span class="c1">// Convert to MB</span>

<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">n</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">x</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">sumX</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">x</span><span class="p">.</span><span class="nx">reduce</span><span class="p">((</span><span class="nx">a</span><span class="p">,</span><span class="w"> </span><span class="nx">b</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">a</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">b</span><span class="p">,</span><span class="w"> </span><span class="mf">0</span><span class="p">);</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">sumY</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">y</span><span class="p">.</span><span class="nx">reduce</span><span class="p">((</span><span class="nx">a</span><span class="p">,</span><span class="w"> </span><span class="nx">b</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">a</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">b</span><span class="p">,</span><span class="w"> </span><span class="mf">0</span><span class="p">);</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">sumXY</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">x</span><span class="p">.</span><span class="nx">reduce</span><span class="p">((</span><span class="nx">sum</span><span class="p">,</span><span class="w"> </span><span class="nx">xi</span><span class="p">,</span><span class="w"> </span><span class="nx">i</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">sum</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">xi</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">y</span><span class="p">[</span><span class="nx">i</span><span class="p">],</span><span class="w"> </span><span class="mf">0</span><span class="p">);</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">sumXX</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">x</span><span class="p">.</span><span class="nx">reduce</span><span class="p">((</span><span class="nx">sum</span><span class="p">,</span><span class="w"> </span><span class="nx">xi</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">sum</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">xi</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">xi</span><span class="p">,</span><span class="w"> </span><span class="mf">0</span><span class="p">);</span>

<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">slope</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">n</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">sumXY</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nx">sumX</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">sumY</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="p">(</span><span class="nx">n</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">sumXX</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nx">sumX</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">sumX</span><span class="p">);</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">samples</span><span class="o">:</span><span class="w"> </span><span class="nx">y</span><span class="p">,</span>
<span class="w">      </span><span class="nx">slope</span><span class="o">:</span><span class="w"> </span><span class="nx">slope</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">10</span><span class="p">,</span><span class="w"> </span><span class="c1">// Convert to MB per minute (6s intervals * 10 = 1 minute)</span>
<span class="w">      </span><span class="nx">trend</span><span class="o">:</span><span class="w"> </span><span class="nx">slope</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">0</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="s1">&#39;increasing&#39;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="nx">slope</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mf">0</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="s1">&#39;decreasing&#39;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;stable&#39;</span>
<span class="w">    </span><span class="p">};</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">async</span><span class="w"> </span><span class="nx">checkRedisMemory</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// Giáº£ láº­p Redis memory check</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">usage</span><span class="o">:</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">random</span><span class="p">(),</span><span class="w"> </span><span class="nx">used</span><span class="o">:</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">random</span><span class="p">()</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">1000</span><span class="w"> </span><span class="p">};</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">async</span><span class="w"> </span><span class="nx">checkDatabaseMemory</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// Giáº£ láº­p database memory check</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">usage</span><span class="o">:</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">random</span><span class="p">()</span><span class="w"> </span><span class="p">};</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">async</span><span class="w"> </span><span class="nx">estimateConnectionMemory</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// Giáº£ láº­p connection memory estimation</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">random</span><span class="p">()</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">1000</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">1024</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">1024</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">async</span><span class="w"> </span><span class="nx">analyzeHeapDump</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// Trong production, sá»­ dá»¥ng heapdump module</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">heapStats</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">v8</span><span class="p">.</span><span class="nx">getHeapStatistics</span><span class="p">();</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">heapSpaceStats</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">v8</span><span class="p">.</span><span class="nx">getHeapSpaceStatistics</span><span class="p">();</span>

<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">analysis</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">summary</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">totalHeapSize</span><span class="o">:</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">round</span><span class="p">(</span><span class="nx">heapStats</span><span class="p">.</span><span class="nx">total_heap_size</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="p">(</span><span class="mf">1024</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">1024</span><span class="p">)),</span>
<span class="w">        </span><span class="nx">usedHeapSize</span><span class="o">:</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">round</span><span class="p">(</span><span class="nx">heapStats</span><span class="p">.</span><span class="nx">used_heap_size</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="p">(</span><span class="mf">1024</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">1024</span><span class="p">)),</span>
<span class="w">        </span><span class="nx">heapSizeLimit</span><span class="o">:</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">round</span><span class="p">(</span><span class="nx">heapStats</span><span class="p">.</span><span class="nx">heap_size_limit</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="p">(</span><span class="mf">1024</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">1024</span><span class="p">)),</span>
<span class="w">        </span><span class="nx">mallocedMemory</span><span class="o">:</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">round</span><span class="p">(</span><span class="nx">heapStats</span><span class="p">.</span><span class="nx">malloced_memory</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="p">(</span><span class="mf">1024</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">1024</span><span class="p">))</span>
<span class="w">      </span><span class="p">},</span>
<span class="w">      </span><span class="nx">spaces</span><span class="o">:</span><span class="w"> </span><span class="nx">heapSpaceStats</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">space</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">({</span>
<span class="w">        </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="nx">space</span><span class="p">.</span><span class="nx">space_name</span><span class="p">,</span>
<span class="w">        </span><span class="nx">size</span><span class="o">:</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">round</span><span class="p">(</span><span class="nx">space</span><span class="p">.</span><span class="nx">space_size</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="p">(</span><span class="mf">1024</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">1024</span><span class="p">)),</span>
<span class="w">        </span><span class="nx">used</span><span class="o">:</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">round</span><span class="p">(</span><span class="nx">space</span><span class="p">.</span><span class="nx">space_used_size</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="p">(</span><span class="mf">1024</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">1024</span><span class="p">)),</span>
<span class="w">        </span><span class="nx">available</span><span class="o">:</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">round</span><span class="p">(</span><span class="nx">space</span><span class="p">.</span><span class="nx">space_available_size</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="p">(</span><span class="mf">1024</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">1024</span><span class="p">)),</span>
<span class="w">        </span><span class="nx">physical</span><span class="o">:</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">round</span><span class="p">(</span><span class="nx">space</span><span class="p">.</span><span class="nx">physical_space_size</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="p">(</span><span class="mf">1024</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">1024</span><span class="p">))</span>
<span class="w">      </span><span class="p">})),</span>
<span class="w">      </span><span class="nx">potentialIssues</span><span class="o">:</span><span class="w"> </span><span class="p">[]</span>
<span class="w">    </span><span class="p">};</span>

<span class="w">    </span><span class="c1">// Detect common memory issues</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">issues</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[];</span>

<span class="w">    </span><span class="c1">// Issue 1: Large strings in heap</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">heapSpaceStats</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="nx">s</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">s</span><span class="p">.</span><span class="nx">space_name</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;large_object_space&#39;</span><span class="p">)</span><span class="o">?</span><span class="p">.</span><span class="nx">space_used_size</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">100</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">1024</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">1024</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">issues</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="s1">&#39;Large objects space &gt; 100MB (check for large strings/arrays)&#39;</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// Issue 2: Old spaceæ¥è¿‘limit</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">oldSpace</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">heapSpaceStats</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="nx">s</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">s</span><span class="p">.</span><span class="nx">space_name</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;old_space&#39;</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">oldSpace</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">oldSpace</span><span class="p">.</span><span class="nx">space_used_size</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="nx">oldSpace</span><span class="p">.</span><span class="nx">space_size</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">0.9</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">issues</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="s1">&#39;Old space usage &gt; 90% (potential memory leak in long-lived objects)&#39;</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// Issue 3: Frequent GC</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">heapStats</span><span class="p">.</span><span class="nx">total_available_size</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="nx">heapStats</span><span class="p">.</span><span class="nx">heap_size_limit</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mf">0.2</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">issues</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="s1">&#39;Available heap &lt; 20% (frequent garbage collection)&#39;</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="nx">analysis</span><span class="p">.</span><span class="nx">potentialIssues</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">issues</span><span class="p">;</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">analysis</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">async</span><span class="w"> </span><span class="nx">getFileDescriptorLimit</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">stdout</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">execAsync</span><span class="p">(</span><span class="s1">&#39;ulimit -n&#39;</span><span class="p">);</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="nb">parseInt</span><span class="p">(</span><span class="nx">stdout</span><span class="p">.</span><span class="nx">trim</span><span class="p">());</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="mf">1024</span><span class="p">;</span><span class="w"> </span><span class="c1">// Default</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">async</span><span class="w"> </span><span class="nx">getFileDescriptorUsage</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">stdout</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">execAsync</span><span class="p">(</span><span class="sb">`lsof -p </span><span class="si">${</span><span class="nx">process</span><span class="p">.</span><span class="nx">pid</span><span class="si">}</span><span class="sb"> | wc -l`</span><span class="p">);</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="nb">parseInt</span><span class="p">(</span><span class="nx">stdout</span><span class="p">.</span><span class="nx">trim</span><span class="p">());</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">async</span><span class="w"> </span><span class="nx">getTCPConnectionStats</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// Giáº£ láº­p TCP stats</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">timeWait</span><span class="o">:</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span><span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nx">random</span><span class="p">()</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">20000</span><span class="p">)</span><span class="w"> </span><span class="p">};</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">async</span><span class="w"> </span><span class="nx">getWebSocketFailureRate</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// Giáº£ láº­p WebSocket failure rate</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">random</span><span class="p">()</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">0.1</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">async</span><span class="w"> </span><span class="nx">getAuthenticationLatency</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// Giáº£ láº­p authentication latency</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">p95</span><span class="o">:</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">random</span><span class="p">()</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">2000</span><span class="w"> </span><span class="p">};</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">async</span><span class="w"> </span><span class="nx">checkLoadBalancerHealth</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// Giáº£ láº­p load balancer health</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">healthyInstances</span><span class="o">:</span><span class="w"> </span><span class="mf">8</span><span class="p">,</span><span class="w"> </span><span class="nx">totalInstances</span><span class="o">:</span><span class="w"> </span><span class="mf">10</span><span class="w"> </span><span class="p">};</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nx">generateLatencyRecommendations</span><span class="p">(</span><span class="nx">checks</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">recommendations</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[];</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">checks</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="nx">c</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">c</span><span class="p">.</span><span class="nx">check</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;System Load Average&#39;</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">c</span><span class="p">.</span><span class="nx">status</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;HIGH&#39;</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">recommendations</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span>
<span class="w">        </span><span class="nx">priority</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;HIGH&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="nx">action</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Scale horizontally by adding more instances&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="nx">details</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;System load indicates CPU saturation&#39;</span>
<span class="w">      </span><span class="p">});</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">checks</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="nx">c</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">c</span><span class="p">.</span><span class="nx">check</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;Event Loop Lag&#39;</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">c</span><span class="p">.</span><span class="nx">status</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;HIGH&#39;</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">recommendations</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span>
<span class="w">        </span><span class="nx">priority</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;HIGH&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="nx">action</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Investigate blocking operations in event loop&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="nx">details</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Check for synchronous I/O, CPU-intensive tasks, or large JSON parsing&#39;</span>
<span class="w">      </span><span class="p">});</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">checks</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="nx">c</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">c</span><span class="p">.</span><span class="nx">check</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;Message Queue Backlog&#39;</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">c</span><span class="p">.</span><span class="nx">status</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;HIGH&#39;</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">recommendations</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span>
<span class="w">        </span><span class="nx">priority</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;MEDIUM&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="nx">action</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Increase message processing workers&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="nx">details</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Message backlog indicates processing bottleneck&#39;</span>
<span class="w">      </span><span class="p">});</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">recommendations</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nx">generateMemoryRecommendations</span><span class="p">(</span><span class="nx">checks</span><span class="p">,</span><span class="w"> </span><span class="nx">heapAnalysis</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">recommendations</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[];</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">checks</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="nx">c</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">c</span><span class="p">.</span><span class="nx">check</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;Node.js Heap Usage&#39;</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">c</span><span class="p">.</span><span class="nx">status</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;HIGH&#39;</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">recommendations</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span>
<span class="w">        </span><span class="nx">priority</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;HIGH&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="nx">action</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Increase Node.js heap memory limit&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="nx">details</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Add --max-old-space-size=4096 flag (for 4GB)&#39;</span>
<span class="w">      </span><span class="p">});</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">heapAnalysis</span><span class="p">.</span><span class="nx">potentialIssues</span><span class="p">.</span><span class="nx">some</span><span class="p">(</span><span class="nx">issue</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">issue</span><span class="p">.</span><span class="nx">includes</span><span class="p">(</span><span class="s1">&#39;Large objects space&#39;</span><span class="p">)))</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">recommendations</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span>
<span class="w">        </span><span class="nx">priority</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;MEDIUM&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="nx">action</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Optimize large message handling&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="nx">details</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Consider streaming large messages or using external storage&#39;</span>
<span class="w">      </span><span class="p">});</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">checks</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="nx">c</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">c</span><span class="p">.</span><span class="nx">check</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;WebSocket Connection Memory&#39;</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">c</span><span class="p">.</span><span class="nx">status</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;HIGH&#39;</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">recommendations</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span>
<span class="w">        </span><span class="nx">priority</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;HIGH&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="nx">action</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Implement connection cleanup and heartbeat&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="nx">details</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Add ping/pong mechanism to detect and clean dead connections&#39;</span>
<span class="w">      </span><span class="p">});</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">recommendations</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nx">generateConnectionRecommendations</span><span class="p">(</span><span class="nx">checks</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">recommendations</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[];</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">checks</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="nx">c</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">c</span><span class="p">.</span><span class="nx">check</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;File Descriptor Usage&#39;</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">c</span><span class="p">.</span><span class="nx">status</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;HIGH&#39;</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">recommendations</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span>
<span class="w">        </span><span class="nx">priority</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;CRITICAL&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="nx">action</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Increase system file descriptor limit&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="nx">details</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Run: ulimit -n 65535 &amp;&amp; sysctl -w fs.file-max=100000&#39;</span>
<span class="w">      </span><span class="p">});</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">checks</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="nx">c</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">c</span><span class="p">.</span><span class="nx">check</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;TCP TIME_WAIT Connections&#39;</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">c</span><span class="p">.</span><span class="nx">status</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;HIGH&#39;</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">recommendations</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span>
<span class="w">        </span><span class="nx">priority</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;HIGH&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="nx">action</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Tune TCP kernel parameters&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="nx">details</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Adjust net.ipv4.tcp_tw_reuse and net.ipv4.tcp_fin_timeout&#39;</span>
<span class="w">      </span><span class="p">});</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">recommendations</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>

<span class="c1">// Sá»­ dá»¥ng diagnostic toolkit</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">toolkit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">ChatDiagnosticToolkit</span><span class="p">();</span>

<span class="c1">// Khi cÃ³ performance issue, cháº¡y diagnostics</span>
<span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">troubleshootIssue</span><span class="p">(</span><span class="nx">issueType</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">let</span><span class="w"> </span><span class="nx">report</span><span class="p">;</span>

<span class="w">  </span><span class="k">switch</span><span class="p">(</span><span class="nx">issueType</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="s1">&#39;latency&#39;</span><span class="o">:</span>
<span class="w">      </span><span class="nx">report</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">toolkit</span><span class="p">.</span><span class="nx">diagnoseLatency</span><span class="p">();</span>
<span class="w">      </span><span class="k">break</span><span class="p">;</span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="s1">&#39;memory&#39;</span><span class="o">:</span>
<span class="w">      </span><span class="nx">report</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">toolkit</span><span class="p">.</span><span class="nx">diagnoseMemory</span><span class="p">();</span>
<span class="w">      </span><span class="k">break</span><span class="p">;</span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="s1">&#39;connections&#39;</span><span class="o">:</span>
<span class="w">      </span><span class="nx">report</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">toolkit</span><span class="p">.</span><span class="nx">diagnoseConnections</span><span class="p">();</span>
<span class="w">      </span><span class="k">break</span><span class="p">;</span>
<span class="w">    </span><span class="k">default</span><span class="o">:</span>
<span class="w">      </span><span class="c1">// Run all diagnostics</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="p">[</span><span class="nx">latencyReport</span><span class="p">,</span><span class="w"> </span><span class="nx">memoryReport</span><span class="p">,</span><span class="w"> </span><span class="nx">connectionReport</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nb">Promise</span><span class="p">.</span><span class="nx">all</span><span class="p">([</span>
<span class="w">        </span><span class="nx">toolkit</span><span class="p">.</span><span class="nx">diagnoseLatency</span><span class="p">(),</span>
<span class="w">        </span><span class="nx">toolkit</span><span class="p">.</span><span class="nx">diagnoseMemory</span><span class="p">(),</span>
<span class="w">        </span><span class="nx">toolkit</span><span class="p">.</span><span class="nx">diagnoseConnections</span><span class="p">()</span>
<span class="w">      </span><span class="p">]);</span>
<span class="w">      </span><span class="nx">report</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">latencyReport</span><span class="p">,</span><span class="w"> </span><span class="nx">memoryReport</span><span class="p">,</span><span class="w"> </span><span class="nx">connectionReport</span><span class="w"> </span><span class="p">};</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;ğŸ” Diagnostic Report:&#39;</span><span class="p">);</span>
<span class="w">  </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nb">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">report</span><span class="p">,</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w"> </span><span class="mf">2</span><span class="p">));</span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">report</span><span class="p">;</span>
<span class="p">}</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">ChatDiagnosticToolkit</span><span class="p">,</span><span class="w"> </span><span class="nx">troubleshootIssue</span><span class="w"> </span><span class="p">};</span>
</code></pre></div>
<h4 id="32-performance-bottleneck-analysis">3.2 Performance Bottleneck Analysis<a class="headerlink" href="#32-performance-bottleneck-analysis" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1">// troubleshooting/bottleneck-analyzer.js</span>
<span class="kd">const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">performance</span><span class="p">,</span><span class="w"> </span><span class="nx">PerformanceObserver</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">require</span><span class="p">(</span><span class="s1">&#39;perf_hooks&#39;</span><span class="p">);</span>

<span class="kd">class</span><span class="w"> </span><span class="nx">BottleneckAnalyzer</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kr">constructor</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">bottlenecks</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nb">Map</span><span class="p">();</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">performanceMarks</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nb">Map</span><span class="p">();</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">setupPerformanceObservers</span><span class="p">();</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nx">setupPerformanceObservers</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// Observer cho WebSocket operations</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">wsObserver</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">PerformanceObserver</span><span class="p">((</span><span class="nx">list</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">entries</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">list</span><span class="p">.</span><span class="nx">getEntries</span><span class="p">();</span>
<span class="w">      </span><span class="nx">entries</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="nx">entry</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="nx">analyzeWebSocketOperation</span><span class="p">(</span><span class="nx">entry</span><span class="p">);</span>
<span class="w">      </span><span class="p">});</span>
<span class="w">    </span><span class="p">});</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">wsObserver</span><span class="p">.</span><span class="nx">observe</span><span class="p">({</span><span class="w"> </span><span class="nx">entryTypes</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="s1">&#39;measure&#39;</span><span class="p">],</span><span class="w"> </span><span class="nx">buffered</span><span class="o">:</span><span class="w"> </span><span class="kc">true</span><span class="w"> </span><span class="p">});</span>

<span class="w">    </span><span class="c1">// Observer cho database operations</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">dbObserver</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">PerformanceObserver</span><span class="p">((</span><span class="nx">list</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">entries</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">list</span><span class="p">.</span><span class="nx">getEntries</span><span class="p">();</span>
<span class="w">      </span><span class="nx">entries</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="nx">entry</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="nx">analyzeDatabaseOperation</span><span class="p">(</span><span class="nx">entry</span><span class="p">);</span>
<span class="w">      </span><span class="p">});</span>
<span class="w">    </span><span class="p">});</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">dbObserver</span><span class="p">.</span><span class="nx">observe</span><span class="p">({</span><span class="w"> </span><span class="nx">entryTypes</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="s1">&#39;measure&#39;</span><span class="p">],</span><span class="w"> </span><span class="nx">buffered</span><span class="o">:</span><span class="w"> </span><span class="kc">true</span><span class="w"> </span><span class="p">});</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="c1">// Track WebSocket message flow</span>
<span class="w">  </span><span class="nx">trackMessageFlow</span><span class="p">(</span><span class="nx">messageId</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">marks</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">received</span><span class="o">:</span><span class="w"> </span><span class="sb">`message_</span><span class="si">${</span><span class="nx">messageId</span><span class="si">}</span><span class="sb">_received`</span><span class="p">,</span>
<span class="w">      </span><span class="nx">authenticated</span><span class="o">:</span><span class="w"> </span><span class="sb">`message_</span><span class="si">${</span><span class="nx">messageId</span><span class="si">}</span><span class="sb">_authenticated`</span><span class="p">,</span>
<span class="w">      </span><span class="nx">processed</span><span class="o">:</span><span class="w"> </span><span class="sb">`message_</span><span class="si">${</span><span class="nx">messageId</span><span class="si">}</span><span class="sb">_processed`</span><span class="p">,</span>
<span class="w">      </span><span class="nx">broadcast</span><span class="o">:</span><span class="w"> </span><span class="sb">`message_</span><span class="si">${</span><span class="nx">messageId</span><span class="si">}</span><span class="sb">_broadcast`</span><span class="p">,</span>
<span class="w">      </span><span class="nx">delivered</span><span class="o">:</span><span class="w"> </span><span class="sb">`message_</span><span class="si">${</span><span class="nx">messageId</span><span class="si">}</span><span class="sb">_delivered`</span>
<span class="w">    </span><span class="p">};</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">markReceived</span><span class="o">:</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">performance</span><span class="p">.</span><span class="nx">mark</span><span class="p">(</span><span class="nx">marks</span><span class="p">.</span><span class="nx">received</span><span class="p">),</span>
<span class="w">      </span><span class="nx">markAuthenticated</span><span class="o">:</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">performance</span><span class="p">.</span><span class="nx">mark</span><span class="p">(</span><span class="nx">marks</span><span class="p">.</span><span class="nx">authenticated</span><span class="p">),</span>
<span class="w">      </span><span class="nx">markProcessed</span><span class="o">:</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">performance</span><span class="p">.</span><span class="nx">mark</span><span class="p">(</span><span class="nx">marks</span><span class="p">.</span><span class="nx">processed</span><span class="p">),</span>
<span class="w">      </span><span class="nx">markBroadcast</span><span class="o">:</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">performance</span><span class="p">.</span><span class="nx">mark</span><span class="p">(</span><span class="nx">marks</span><span class="p">.</span><span class="nx">broadcast</span><span class="p">),</span>
<span class="w">      </span><span class="nx">markDelivered</span><span class="o">:</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">performance</span><span class="p">.</span><span class="nx">mark</span><span class="p">(</span><span class="nx">marks</span><span class="p">.</span><span class="nx">delivered</span><span class="p">),</span>

<span class="w">      </span><span class="nx">measureTotal</span><span class="o">:</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">performance</span><span class="p">.</span><span class="nx">measure</span><span class="p">(</span>
<span class="w">          </span><span class="sb">`message_</span><span class="si">${</span><span class="nx">messageId</span><span class="si">}</span><span class="sb">_total`</span><span class="p">,</span>
<span class="w">          </span><span class="nx">marks</span><span class="p">.</span><span class="nx">received</span><span class="p">,</span>
<span class="w">          </span><span class="nx">marks</span><span class="p">.</span><span class="nx">delivered</span>
<span class="w">        </span><span class="p">);</span>

<span class="w">        </span><span class="c1">// Measure individual stages</span>
<span class="w">        </span><span class="nx">performance</span><span class="p">.</span><span class="nx">measure</span><span class="p">(</span>
<span class="w">          </span><span class="sb">`message_</span><span class="si">${</span><span class="nx">messageId</span><span class="si">}</span><span class="sb">_auth`</span><span class="p">,</span>
<span class="w">          </span><span class="nx">marks</span><span class="p">.</span><span class="nx">received</span><span class="p">,</span>
<span class="w">          </span><span class="nx">marks</span><span class="p">.</span><span class="nx">authenticated</span>
<span class="w">        </span><span class="p">);</span>

<span class="w">        </span><span class="nx">performance</span><span class="p">.</span><span class="nx">measure</span><span class="p">(</span>
<span class="w">          </span><span class="sb">`message_</span><span class="si">${</span><span class="nx">messageId</span><span class="si">}</span><span class="sb">_processing`</span><span class="p">,</span>
<span class="w">          </span><span class="nx">marks</span><span class="p">.</span><span class="nx">authenticated</span><span class="p">,</span>
<span class="w">          </span><span class="nx">marks</span><span class="p">.</span><span class="nx">processed</span>
<span class="w">        </span><span class="p">);</span>

<span class="w">        </span><span class="nx">performance</span><span class="p">.</span><span class="nx">measure</span><span class="p">(</span>
<span class="w">          </span><span class="sb">`message_</span><span class="si">${</span><span class="nx">messageId</span><span class="si">}</span><span class="sb">_broadcasting`</span><span class="p">,</span>
<span class="w">          </span><span class="nx">marks</span><span class="p">.</span><span class="nx">processed</span><span class="p">,</span>
<span class="w">          </span><span class="nx">marks</span><span class="p">.</span><span class="nx">broadcast</span>
<span class="w">        </span><span class="p">);</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">};</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nx">analyzeWebSocketOperation</span><span class="p">(</span><span class="nx">entry</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">name</span><span class="p">,</span><span class="w"> </span><span class="nx">duration</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">entry</span><span class="p">;</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">duration</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">100</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="c1">// &gt; 100ms lÃ  cháº­m</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">bottleneck</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">type</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;websocket_operation&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="nx">operation</span><span class="o">:</span><span class="w"> </span><span class="nx">name</span><span class="p">,</span>
<span class="w">        </span><span class="nx">duration</span><span class="p">,</span>
<span class="w">        </span><span class="nx">timestamp</span><span class="o">:</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nb">Date</span><span class="p">().</span><span class="nx">toISOString</span><span class="p">(),</span>
<span class="w">        </span><span class="nx">severity</span><span class="o">:</span><span class="w"> </span><span class="nx">duration</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">500</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="s1">&#39;HIGH&#39;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;MEDIUM&#39;</span>
<span class="w">      </span><span class="p">};</span>

<span class="w">      </span><span class="k">this</span><span class="p">.</span><span class="nx">bottlenecks</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="sb">`</span><span class="si">${</span><span class="nx">name</span><span class="si">}</span><span class="sb">_</span><span class="si">${</span><span class="nb">Date</span><span class="p">.</span><span class="nx">now</span><span class="p">()</span><span class="si">}</span><span class="sb">`</span><span class="p">,</span><span class="w"> </span><span class="nx">bottleneck</span><span class="p">);</span>
<span class="w">      </span><span class="k">this</span><span class="p">.</span><span class="nx">notifyBottleneck</span><span class="p">(</span><span class="nx">bottleneck</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nx">analyzeDatabaseOperation</span><span class="p">(</span><span class="nx">entry</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">name</span><span class="p">,</span><span class="w"> </span><span class="nx">duration</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">entry</span><span class="p">;</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">duration</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">50</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="c1">// &gt; 50ms lÃ  cháº­m</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">bottleneck</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">type</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;database_operation&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="nx">operation</span><span class="o">:</span><span class="w"> </span><span class="nx">name</span><span class="p">,</span>
<span class="w">        </span><span class="nx">duration</span><span class="p">,</span>
<span class="w">        </span><span class="nx">timestamp</span><span class="o">:</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nb">Date</span><span class="p">().</span><span class="nx">toISOString</span><span class="p">(),</span>
<span class="w">        </span><span class="nx">severity</span><span class="o">:</span><span class="w"> </span><span class="nx">duration</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">200</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="s1">&#39;HIGH&#39;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;MEDIUM&#39;</span>
<span class="w">      </span><span class="p">};</span>

<span class="w">      </span><span class="k">this</span><span class="p">.</span><span class="nx">bottlenecks</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="sb">`</span><span class="si">${</span><span class="nx">name</span><span class="si">}</span><span class="sb">_</span><span class="si">${</span><span class="nb">Date</span><span class="p">.</span><span class="nx">now</span><span class="p">()</span><span class="si">}</span><span class="sb">`</span><span class="p">,</span><span class="w"> </span><span class="nx">bottleneck</span><span class="p">);</span>

<span class="w">      </span><span class="c1">// Náº¿u lÃ  query cháº­m, log Ä‘á»ƒ optimization sau</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">name</span><span class="p">.</span><span class="nx">includes</span><span class="p">(</span><span class="s1">&#39;query&#39;</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">console</span><span class="p">.</span><span class="nx">warn</span><span class="p">(</span><span class="sb">`Slow database query detected: </span><span class="si">${</span><span class="nx">name</span><span class="si">}</span><span class="sb"> (</span><span class="si">${</span><span class="nx">duration</span><span class="si">}</span><span class="sb">ms)`</span><span class="p">);</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nx">detectCommonBottlenecks</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">commonPatterns</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span>
<span class="w">      </span><span class="p">{</span>
<span class="w">        </span><span class="nx">pattern</span><span class="o">:</span><span class="w"> </span><span class="sr">/message_.*_auth/</span><span class="p">,</span>
<span class="w">        </span><span class="nx">threshold</span><span class="o">:</span><span class="w"> </span><span class="mf">50</span><span class="p">,</span>
<span class="w">        </span><span class="nx">issue</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Authentication bottleneck&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="nx">solution</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Cache authentication results, use JWT tokens&#39;</span>
<span class="w">      </span><span class="p">},</span>
<span class="w">      </span><span class="p">{</span>
<span class="w">        </span><span class="nx">pattern</span><span class="o">:</span><span class="w"> </span><span class="sr">/message_.*_broadcasting/</span><span class="p">,</span>
<span class="w">        </span><span class="nx">threshold</span><span class="o">:</span><span class="w"> </span><span class="mf">100</span><span class="p">,</span>
<span class="w">        </span><span class="nx">issue</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Broadcast bottleneck&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="nx">solution</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Optimize room management, use efficient broadcast algorithms&#39;</span>
<span class="w">      </span><span class="p">},</span>
<span class="w">      </span><span class="p">{</span>
<span class="w">        </span><span class="nx">pattern</span><span class="o">:</span><span class="w"> </span><span class="sr">/database_query.*SELECT/</span><span class="p">,</span>
<span class="w">        </span><span class="nx">threshold</span><span class="o">:</span><span class="w"> </span><span class="mf">100</span><span class="p">,</span>
<span class="w">        </span><span class="nx">issue</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Slow database query&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="nx">solution</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Add indexes, optimize query, implement caching&#39;</span>
<span class="w">      </span><span class="p">},</span>
<span class="w">      </span><span class="p">{</span>
<span class="w">        </span><span class="nx">pattern</span><span class="o">:</span><span class="w"> </span><span class="sr">/redis_.*/</span><span class="p">,</span>
<span class="w">        </span><span class="nx">threshold</span><span class="o">:</span><span class="w"> </span><span class="mf">10</span><span class="p">,</span>
<span class="w">        </span><span class="nx">issue</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Redis latency&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="nx">solution</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Check Redis server load, network latency, use connection pooling&#39;</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">];</span>

<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">detectedIssues</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[];</span>

<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">const</span><span class="w"> </span><span class="p">[</span><span class="nx">key</span><span class="p">,</span><span class="w"> </span><span class="nx">bottleneck</span><span class="p">]</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">bottlenecks</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">const</span><span class="w"> </span><span class="nx">pattern</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="nx">commonPatterns</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">pattern</span><span class="p">.</span><span class="nx">pattern</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">bottleneck</span><span class="p">.</span><span class="nx">operation</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">bottleneck</span><span class="p">.</span><span class="nx">duration</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="nx">pattern</span><span class="p">.</span><span class="nx">threshold</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="nx">detectedIssues</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span>
<span class="w">            </span><span class="p">...</span><span class="nx">bottleneck</span><span class="p">,</span>
<span class="w">            </span><span class="nx">commonIssue</span><span class="o">:</span><span class="w"> </span><span class="nx">pattern</span><span class="p">.</span><span class="nx">issue</span><span class="p">,</span>
<span class="w">            </span><span class="nx">suggestedSolution</span><span class="o">:</span><span class="w"> </span><span class="nx">pattern</span><span class="p">.</span><span class="nx">solution</span>
<span class="w">          </span><span class="p">});</span>
<span class="w">          </span><span class="k">break</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">detectedIssues</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nx">notifyBottleneck</span><span class="p">(</span><span class="nx">bottleneck</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// Gá»­i alert qua monitoring system</span>
<span class="w">    </span><span class="nx">console</span><span class="p">.</span><span class="nx">warn</span><span class="p">(</span><span class="sb">`ğŸš¨ Performance bottleneck detected:`</span><span class="p">,</span><span class="w"> </span><span class="nx">bottleneck</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// CÃ³ thá»ƒ tÃ­ch há»£p vá»›i Slack, PagerDuty, etc.</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">bottleneck</span><span class="p">.</span><span class="nx">severity</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;HIGH&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">this</span><span class="p">.</span><span class="nx">sendAlert</span><span class="p">({</span>
<span class="w">        </span><span class="nx">title</span><span class="o">:</span><span class="w"> </span><span class="sb">`High severity bottleneck: </span><span class="si">${</span><span class="nx">bottleneck</span><span class="p">.</span><span class="nx">type</span><span class="si">}</span><span class="sb">`</span><span class="p">,</span>
<span class="w">        </span><span class="nx">message</span><span class="o">:</span><span class="w"> </span><span class="sb">`</span><span class="si">${</span><span class="nx">bottleneck</span><span class="p">.</span><span class="nx">operation</span><span class="si">}</span><span class="sb"> took </span><span class="si">${</span><span class="nx">bottleneck</span><span class="p">.</span><span class="nx">duration</span><span class="si">}</span><span class="sb">ms`</span><span class="p">,</span>
<span class="w">        </span><span class="nx">priority</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;P1&#39;</span>
<span class="w">      </span><span class="p">});</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nx">sendAlert</span><span class="p">(</span><span class="nx">alert</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// Implement alert sending logic</span>
<span class="w">    </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;Alert:&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">alert</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nx">generateOptimizationReport</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">issues</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">detectCommonBottlenecks</span><span class="p">();</span>

<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">report</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">timestamp</span><span class="o">:</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nb">Date</span><span class="p">().</span><span class="nx">toISOString</span><span class="p">(),</span>
<span class="w">      </span><span class="nx">summary</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">totalBottlenecks</span><span class="o">:</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">bottlenecks</span><span class="p">.</span><span class="nx">size</span><span class="p">,</span>
<span class="w">        </span><span class="nx">highSeverity</span><span class="o">:</span><span class="w"> </span><span class="nb">Array</span><span class="p">.</span><span class="kr">from</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">bottlenecks</span><span class="p">.</span><span class="nx">values</span><span class="p">()).</span><span class="nx">filter</span><span class="p">(</span><span class="nx">b</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">b</span><span class="p">.</span><span class="nx">severity</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;HIGH&#39;</span><span class="p">).</span><span class="nx">length</span><span class="p">,</span>
<span class="w">        </span><span class="nx">byType</span><span class="o">:</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">groupByType</span><span class="p">(</span><span class="nb">Array</span><span class="p">.</span><span class="kr">from</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">bottlenecks</span><span class="p">.</span><span class="nx">values</span><span class="p">()))</span>
<span class="w">      </span><span class="p">},</span>
<span class="w">      </span><span class="nx">detectedIssues</span><span class="o">:</span><span class="w"> </span><span class="nx">issues</span><span class="p">,</span>
<span class="w">      </span><span class="nx">recommendations</span><span class="o">:</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">generateOptimizationRecommendations</span><span class="p">(</span><span class="nx">issues</span><span class="p">),</span>
<span class="w">      </span><span class="nx">nextSteps</span><span class="o">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">        </span><span class="s1">&#39;1. Review high severity bottlenecks first&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="s1">&#39;2. Implement suggested optimizations&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="s1">&#39;3. Monitor performance after changes&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="s1">&#39;4. Update thresholds based on new baseline&#39;</span>
<span class="w">      </span><span class="p">]</span>
<span class="w">    </span><span class="p">};</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">report</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nx">groupByType</span><span class="p">(</span><span class="nx">bottlenecks</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">groups</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{};</span>
<span class="w">    </span><span class="nx">bottlenecks</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="nx">b</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">groups</span><span class="p">[</span><span class="nx">b</span><span class="p">.</span><span class="nx">type</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">groups</span><span class="p">[</span><span class="nx">b</span><span class="p">.</span><span class="nx">type</span><span class="p">]</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="p">[];</span>
<span class="w">      </span><span class="nx">groups</span><span class="p">[</span><span class="nx">b</span><span class="p">.</span><span class="nx">type</span><span class="p">].</span><span class="nx">push</span><span class="p">(</span><span class="nx">b</span><span class="p">);</span>
<span class="w">    </span><span class="p">});</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">groups</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nx">generateOptimizationRecommendations</span><span class="p">(</span><span class="nx">issues</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">recommendations</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[];</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">solutionMap</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nb">Map</span><span class="p">();</span>

<span class="w">    </span><span class="nx">issues</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="nx">issue</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">issue</span><span class="p">.</span><span class="nx">suggestedSolution</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">solutionMap</span><span class="p">.</span><span class="nx">has</span><span class="p">(</span><span class="nx">issue</span><span class="p">.</span><span class="nx">suggestedSolution</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="nx">solutionMap</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="nx">issue</span><span class="p">.</span><span class="nx">suggestedSolution</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">solution</span><span class="o">:</span><span class="w"> </span><span class="nx">issue</span><span class="p">.</span><span class="nx">suggestedSolution</span><span class="p">,</span>
<span class="w">            </span><span class="nx">relatedIssues</span><span class="o">:</span><span class="w"> </span><span class="p">[],</span>
<span class="w">            </span><span class="nx">priority</span><span class="o">:</span><span class="w"> </span><span class="nx">issue</span><span class="p">.</span><span class="nx">severity</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;HIGH&#39;</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="s1">&#39;P1&#39;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;P2&#39;</span>
<span class="w">          </span><span class="p">});</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="nx">solutionMap</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">issue</span><span class="p">.</span><span class="nx">suggestedSolution</span><span class="p">).</span><span class="nx">relatedIssues</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">issue</span><span class="p">.</span><span class="nx">commonIssue</span><span class="p">);</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">});</span>

<span class="w">    </span><span class="nx">solutionMap</span><span class="p">.</span><span class="nx">forEach</span><span class="p">((</span><span class="nx">value</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">recommendations</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span>
<span class="w">        </span><span class="p">...</span><span class="nx">value</span><span class="p">,</span>
<span class="w">        </span><span class="nx">estimatedEffort</span><span class="o">:</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">estimateEffort</span><span class="p">(</span><span class="nx">value</span><span class="p">.</span><span class="nx">priority</span><span class="p">),</span>
<span class="w">        </span><span class="nx">impactedComponents</span><span class="o">:</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">getImpactedComponents</span><span class="p">(</span><span class="nx">value</span><span class="p">.</span><span class="nx">relatedIssues</span><span class="p">)</span>
<span class="w">      </span><span class="p">});</span>
<span class="w">    </span><span class="p">});</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">recommendations</span><span class="p">.</span><span class="nx">sort</span><span class="p">((</span><span class="nx">a</span><span class="p">,</span><span class="w"> </span><span class="nx">b</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">priorityOrder</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="s1">&#39;P1&#39;</span><span class="o">:</span><span class="w"> </span><span class="mf">1</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;P2&#39;</span><span class="o">:</span><span class="w"> </span><span class="mf">2</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;P3&#39;</span><span class="o">:</span><span class="w"> </span><span class="mf">3</span><span class="w"> </span><span class="p">};</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="nx">priorityOrder</span><span class="p">[</span><span class="nx">a</span><span class="p">.</span><span class="nx">priority</span><span class="p">]</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nx">priorityOrder</span><span class="p">[</span><span class="nx">b</span><span class="p">.</span><span class="nx">priority</span><span class="p">];</span>
<span class="w">    </span><span class="p">});</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nx">estimateEffort</span><span class="p">(</span><span class="nx">priority</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">efforts</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="s1">&#39;P1&#39;</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;1-3 days (critical fix)&#39;</span><span class="p">,</span>
<span class="w">      </span><span class="s1">&#39;P2&#39;</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;1-2 weeks (important optimization)&#39;</span><span class="p">,</span>
<span class="w">      </span><span class="s1">&#39;P3&#39;</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;1 month (long-term improvement)&#39;</span>
<span class="w">    </span><span class="p">};</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">efforts</span><span class="p">[</span><span class="nx">priority</span><span class="p">]</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;TBD&#39;</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nx">getImpactedComponents</span><span class="p">(</span><span class="nx">issues</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">components</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nb">Set</span><span class="p">();</span>

<span class="w">    </span><span class="nx">issues</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="nx">issue</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">issue</span><span class="p">.</span><span class="nx">includes</span><span class="p">(</span><span class="s1">&#39;database&#39;</span><span class="p">))</span><span class="w"> </span><span class="nx">components</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="s1">&#39;Database&#39;</span><span class="p">);</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">issue</span><span class="p">.</span><span class="nx">includes</span><span class="p">(</span><span class="s1">&#39;WebSocket&#39;</span><span class="p">))</span><span class="w"> </span><span class="nx">components</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="s1">&#39;WebSocket Server&#39;</span><span class="p">);</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">issue</span><span class="p">.</span><span class="nx">includes</span><span class="p">(</span><span class="s1">&#39;Redis&#39;</span><span class="p">))</span><span class="w"> </span><span class="nx">components</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="s1">&#39;Redis Cache&#39;</span><span class="p">);</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">issue</span><span class="p">.</span><span class="nx">includes</span><span class="p">(</span><span class="s1">&#39;authentication&#39;</span><span class="p">))</span><span class="w"> </span><span class="nx">components</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="s1">&#39;Auth Service&#39;</span><span class="p">);</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">issue</span><span class="p">.</span><span class="nx">includes</span><span class="p">(</span><span class="s1">&#39;broadcast&#39;</span><span class="p">))</span><span class="w"> </span><span class="nx">components</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="s1">&#39;Message Broadcast&#39;</span><span class="p">);</span>
<span class="w">    </span><span class="p">});</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nb">Array</span><span class="p">.</span><span class="kr">from</span><span class="p">(</span><span class="nx">components</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>

<span class="c1">// Sá»­ dá»¥ng trong á»©ng dá»¥ng</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">analyzer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">BottleneckAnalyzer</span><span class="p">();</span>

<span class="c1">// VÃ­ dá»¥: Track má»™t message flow</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">messageId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;msg_12345&#39;</span><span class="p">;</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">tracker</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">analyzer</span><span class="p">.</span><span class="nx">trackMessageFlow</span><span class="p">(</span><span class="nx">messageId</span><span class="p">);</span>

<span class="nx">tracker</span><span class="p">.</span><span class="nx">markReceived</span><span class="p">();</span>
<span class="nx">tracker</span><span class="p">.</span><span class="nx">markAuthenticated</span><span class="p">();</span>
<span class="nx">tracker</span><span class="p">.</span><span class="nx">markProcessed</span><span class="p">();</span>
<span class="nx">tracker</span><span class="p">.</span><span class="nx">markBroadcast</span><span class="p">();</span>
<span class="nx">tracker</span><span class="p">.</span><span class="nx">markDelivered</span><span class="p">();</span>
<span class="nx">tracker</span><span class="p">.</span><span class="nx">measureTotal</span><span class="p">();</span>

<span class="c1">// Generate report hÃ ng giá»</span>
<span class="nx">setInterval</span><span class="p">(()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">report</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">analyzer</span><span class="p">.</span><span class="nx">generateOptimizationReport</span><span class="p">();</span>
<span class="w">  </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;ğŸ“Š Performance Optimization Report:&#39;</span><span class="p">);</span>
<span class="w">  </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nb">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">report</span><span class="p">,</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w"> </span><span class="mf">2</span><span class="p">));</span>
<span class="p">},</span><span class="w"> </span><span class="mf">3600000</span><span class="p">);</span><span class="w"> </span><span class="c1">// Má»—i giá»</span>
</code></pre></div>
<h4 id="33-real-time-debugging-tools">3.3 Real-time Debugging Tools<a class="headerlink" href="#33-real-time-debugging-tools" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1">// debugging/realtime-debugger.js</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">WebSocket</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">require</span><span class="p">(</span><span class="s1">&#39;ws&#39;</span><span class="p">);</span>
<span class="kd">const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">EventEmitter</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">require</span><span class="p">(</span><span class="s1">&#39;events&#39;</span><span class="p">);</span>

<span class="kd">class</span><span class="w"> </span><span class="nx">RealtimeDebugger</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nx">EventEmitter</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kr">constructor</span><span class="p">(</span><span class="nx">options</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{})</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">super</span><span class="p">();</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">port</span><span class="o">:</span><span class="w"> </span><span class="nx">options</span><span class="p">.</span><span class="nx">port</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="mf">8081</span><span class="p">,</span>
<span class="w">      </span><span class="nx">maxConnections</span><span class="o">:</span><span class="w"> </span><span class="nx">options</span><span class="p">.</span><span class="nx">maxConnections</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="mf">100</span><span class="p">,</span>
<span class="w">      </span><span class="nx">retentionPeriod</span><span class="o">:</span><span class="w"> </span><span class="nx">options</span><span class="p">.</span><span class="nx">retentionPeriod</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="mf">3600000</span><span class="w"> </span><span class="c1">// 1 hour</span>
<span class="w">    </span><span class="p">};</span>

<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">debugConnections</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nb">Map</span><span class="p">();</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">messageBuffer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[];</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">performanceTraces</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nb">Map</span><span class="p">();</span>

<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">setupDebugServer</span><span class="p">();</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">setupMetricsCollection</span><span class="p">();</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nx">setupDebugServer</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">debugServer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">WebSocket</span><span class="p">.</span><span class="nx">Server</span><span class="p">({</span>
<span class="w">      </span><span class="nx">port</span><span class="o">:</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">port</span><span class="p">,</span>
<span class="w">      </span><span class="nx">clientTracking</span><span class="o">:</span><span class="w"> </span><span class="kc">true</span>
<span class="w">    </span><span class="p">});</span>

<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">debugServer</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;connection&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="nx">ws</span><span class="p">,</span><span class="w"> </span><span class="nx">req</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">clientId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">req</span><span class="p">.</span><span class="nx">headers</span><span class="p">[</span><span class="s1">&#39;x-client-id&#39;</span><span class="p">]</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="sb">`client_</span><span class="si">${</span><span class="nb">Date</span><span class="p">.</span><span class="nx">now</span><span class="p">()</span><span class="si">}</span><span class="sb">`</span><span class="p">;</span>

<span class="w">      </span><span class="k">this</span><span class="p">.</span><span class="nx">debugConnections</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="nx">clientId</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">ws</span><span class="p">,</span>
<span class="w">        </span><span class="nx">connectedAt</span><span class="o">:</span><span class="w"> </span><span class="nb">Date</span><span class="p">.</span><span class="nx">now</span><span class="p">(),</span>
<span class="w">        </span><span class="nx">subscriptions</span><span class="o">:</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nb">Set</span><span class="p">()</span>
<span class="w">      </span><span class="p">});</span>

<span class="w">      </span><span class="nx">ws</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="nb">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">({</span>
<span class="w">        </span><span class="nx">type</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;INIT&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="nx">data</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="nx">serverTime</span><span class="o">:</span><span class="w"> </span><span class="nb">Date</span><span class="p">.</span><span class="nx">now</span><span class="p">(),</span>
<span class="w">          </span><span class="nx">activeConnections</span><span class="o">:</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">debugServer</span><span class="p">.</span><span class="nx">clients</span><span class="p">.</span><span class="nx">size</span><span class="p">,</span>
<span class="w">          </span><span class="nx">metrics</span><span class="o">:</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">getCurrentMetrics</span><span class="p">()</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">      </span><span class="p">}));</span>

<span class="w">      </span><span class="nx">ws</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;message&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="nx">data</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="nx">handleDebugCommand</span><span class="p">(</span><span class="nx">clientId</span><span class="p">,</span><span class="w"> </span><span class="nb">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">data</span><span class="p">));</span>
<span class="w">      </span><span class="p">});</span>

<span class="w">      </span><span class="nx">ws</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;close&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="nx">debugConnections</span><span class="p">.</span><span class="ow">delete</span><span class="p">(</span><span class="nx">clientId</span><span class="p">);</span>
<span class="w">      </span><span class="p">});</span>
<span class="w">    </span><span class="p">});</span>

<span class="w">    </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`ğŸ” Realtime debugger listening on port </span><span class="si">${</span><span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">port</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nx">setupMetricsCollection</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">setInterval</span><span class="p">(()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">metrics</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">getCurrentMetrics</span><span class="p">();</span>

<span class="w">      </span><span class="k">this</span><span class="p">.</span><span class="nx">messageBuffer</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span>
<span class="w">        </span><span class="nx">timestamp</span><span class="o">:</span><span class="w"> </span><span class="nb">Date</span><span class="p">.</span><span class="nx">now</span><span class="p">(),</span>
<span class="w">        </span><span class="nx">metrics</span><span class="p">,</span>
<span class="w">        </span><span class="nx">type</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;METRICS_SNAPSHOT&#39;</span>
<span class="w">      </span><span class="p">});</span>

<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">cutoff</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Date</span><span class="p">.</span><span class="nx">now</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">retentionPeriod</span><span class="p">;</span>
<span class="w">      </span><span class="k">this</span><span class="p">.</span><span class="nx">messageBuffer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">messageBuffer</span><span class="p">.</span><span class="nx">filter</span><span class="p">(</span><span class="nx">m</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">m</span><span class="p">.</span><span class="nx">timestamp</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="nx">cutoff</span><span class="p">);</span>

<span class="w">      </span><span class="k">this</span><span class="p">.</span><span class="nx">broadcastToSubscribers</span><span class="p">(</span><span class="s1">&#39;metrics&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">metrics</span><span class="p">);</span>
<span class="w">    </span><span class="p">},</span><span class="w"> </span><span class="mf">5000</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nx">handleDebugCommand</span><span class="p">(</span><span class="nx">clientId</span><span class="p">,</span><span class="w"> </span><span class="nx">command</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">client</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">debugConnections</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">clientId</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">client</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="p">;</span>

<span class="w">    </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="nx">command</span><span class="p">.</span><span class="nx">type</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="s1">&#39;SUBSCRIBE&#39;</span><span class="o">:</span>
<span class="w">        </span><span class="nx">command</span><span class="p">.</span><span class="nx">topics</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="nx">topic</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">client</span><span class="p">.</span><span class="nx">subscriptions</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nx">topic</span><span class="p">));</span>
<span class="w">        </span><span class="k">break</span><span class="p">;</span>
<span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="s1">&#39;UNSUBSCRIBE&#39;</span><span class="o">:</span>
<span class="w">        </span><span class="nx">command</span><span class="p">.</span><span class="nx">topics</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="nx">topic</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">client</span><span class="p">.</span><span class="nx">subscriptions</span><span class="p">.</span><span class="ow">delete</span><span class="p">(</span><span class="nx">topic</span><span class="p">));</span>
<span class="w">        </span><span class="k">break</span><span class="p">;</span>
<span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="s1">&#39;GET_HISTORY&#39;</span><span class="o">:</span>
<span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="nx">sendHistory</span><span class="p">(</span><span class="nx">clientId</span><span class="p">,</span><span class="w"> </span><span class="nx">command</span><span class="p">);</span>
<span class="w">        </span><span class="k">break</span><span class="p">;</span>
<span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="s1">&#39;TRACE_MESSAGE&#39;</span><span class="o">:</span>
<span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="nx">traceMessageFlow</span><span class="p">(</span><span class="nx">command</span><span class="p">.</span><span class="nx">messageId</span><span class="p">);</span>
<span class="w">        </span><span class="k">break</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nx">logEvent</span><span class="p">(</span><span class="nx">type</span><span class="p">,</span><span class="w"> </span><span class="nx">data</span><span class="p">,</span><span class="w"> </span><span class="nx">severity</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;INFO&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">event</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">timestamp</span><span class="o">:</span><span class="w"> </span><span class="nb">Date</span><span class="p">.</span><span class="nx">now</span><span class="p">(),</span>
<span class="w">      </span><span class="nx">type</span><span class="p">,</span>
<span class="w">      </span><span class="nx">data</span><span class="p">,</span>
<span class="w">      </span><span class="nx">severity</span><span class="p">,</span>
<span class="w">      </span><span class="nx">source</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;chat-application&#39;</span>
<span class="w">    </span><span class="p">};</span>

<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">messageBuffer</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">event</span><span class="p">);</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">broadcastToSubscribers</span><span class="p">(</span><span class="nx">type</span><span class="p">,</span><span class="w"> </span><span class="nx">event</span><span class="p">);</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;event&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">event</span><span class="p">);</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">severity</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;ERROR&#39;</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nx">severity</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;CRITICAL&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="sb">`[</span><span class="si">${</span><span class="nx">severity</span><span class="si">}</span><span class="sb">] </span><span class="si">${</span><span class="nx">type</span><span class="si">}</span><span class="sb">:`</span><span class="p">,</span><span class="w"> </span><span class="nx">data</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nx">traceMessageFlow</span><span class="p">(</span><span class="nx">messageId</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">traceId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sb">`trace_</span><span class="si">${</span><span class="nx">messageId</span><span class="si">}</span><span class="sb">`</span><span class="p">;</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">performanceTraces</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="nx">traceId</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">messageId</span><span class="p">,</span>
<span class="w">      </span><span class="nx">startTime</span><span class="o">:</span><span class="w"> </span><span class="nb">Date</span><span class="p">.</span><span class="nx">now</span><span class="p">(),</span>
<span class="w">      </span><span class="nx">stages</span><span class="o">:</span><span class="w"> </span><span class="p">{},</span>
<span class="w">      </span><span class="nx">completed</span><span class="o">:</span><span class="w"> </span><span class="kc">false</span>
<span class="w">    </span><span class="p">});</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">markStage</span><span class="o">:</span><span class="w"> </span><span class="p">(</span><span class="nx">stageName</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">trace</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">performanceTraces</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">traceId</span><span class="p">);</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">trace</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="nx">trace</span><span class="p">.</span><span class="nx">stages</span><span class="p">[</span><span class="nx">stageName</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Date</span><span class="p">.</span><span class="nx">now</span><span class="p">();</span>
<span class="w">          </span><span class="k">this</span><span class="p">.</span><span class="nx">logEvent</span><span class="p">(</span><span class="s1">&#39;TRACE_UPDATE&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">traceId</span><span class="p">,</span>
<span class="w">            </span><span class="nx">stage</span><span class="o">:</span><span class="w"> </span><span class="nx">stageName</span><span class="p">,</span>
<span class="w">            </span><span class="nx">timestamp</span><span class="o">:</span><span class="w"> </span><span class="nb">Date</span><span class="p">.</span><span class="nx">now</span><span class="p">()</span>
<span class="w">          </span><span class="p">});</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">      </span><span class="p">},</span>
<span class="w">      </span><span class="nx">complete</span><span class="o">:</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">trace</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">performanceTraces</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">traceId</span><span class="p">);</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">trace</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="nx">trace</span><span class="p">.</span><span class="nx">completed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span>
<span class="w">          </span><span class="nx">trace</span><span class="p">.</span><span class="nx">endTime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Date</span><span class="p">.</span><span class="nx">now</span><span class="p">();</span>
<span class="w">          </span><span class="nx">trace</span><span class="p">.</span><span class="nx">totalDuration</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">trace</span><span class="p">.</span><span class="nx">endTime</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nx">trace</span><span class="p">.</span><span class="nx">startTime</span><span class="p">;</span>
<span class="w">          </span><span class="k">this</span><span class="p">.</span><span class="nx">logEvent</span><span class="p">(</span><span class="s1">&#39;TRACE_COMPLETE&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">trace</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">};</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nx">broadcastToSubscribers</span><span class="p">(</span><span class="nx">topic</span><span class="p">,</span><span class="w"> </span><span class="nx">data</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">message</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">({</span>
<span class="w">      </span><span class="nx">type</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;UPDATE&#39;</span><span class="p">,</span>
<span class="w">      </span><span class="nx">topic</span><span class="p">,</span>
<span class="w">      </span><span class="nx">data</span><span class="p">,</span>
<span class="w">      </span><span class="nx">timestamp</span><span class="o">:</span><span class="w"> </span><span class="nb">Date</span><span class="p">.</span><span class="nx">now</span><span class="p">()</span>
<span class="w">    </span><span class="p">});</span>

<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">debugConnections</span><span class="p">.</span><span class="nx">forEach</span><span class="p">((</span><span class="nx">client</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">client</span><span class="p">.</span><span class="nx">subscriptions</span><span class="p">.</span><span class="nx">has</span><span class="p">(</span><span class="nx">topic</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nx">client</span><span class="p">.</span><span class="nx">subscriptions</span><span class="p">.</span><span class="nx">has</span><span class="p">(</span><span class="s1">&#39;*&#39;</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="nx">client</span><span class="p">.</span><span class="nx">ws</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="nx">message</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="nx">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s1">&#39;Failed to send debug message:&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">error</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">});</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nx">sendHistory</span><span class="p">(</span><span class="nx">clientId</span><span class="p">,</span><span class="w"> </span><span class="nx">command</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">client</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">debugConnections</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">clientId</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">client</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="p">;</span>

<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">filtered</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">messageBuffer</span><span class="p">.</span><span class="nx">filter</span><span class="p">(</span><span class="nx">event</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">command</span><span class="p">.</span><span class="nx">filters</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">command</span><span class="p">.</span><span class="nx">filters</span><span class="p">.</span><span class="nx">type</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">event</span><span class="p">.</span><span class="nx">type</span><span class="w"> </span><span class="o">!==</span><span class="w"> </span><span class="nx">command</span><span class="p">.</span><span class="nx">filters</span><span class="p">.</span><span class="nx">type</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">command</span><span class="p">.</span><span class="nx">filters</span><span class="p">.</span><span class="nx">startTime</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">event</span><span class="p">.</span><span class="nx">timestamp</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="nx">command</span><span class="p">.</span><span class="nx">filters</span><span class="p">.</span><span class="nx">startTime</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span>
<span class="w">    </span><span class="p">}).</span><span class="nx">slice</span><span class="p">(</span><span class="o">-</span><span class="nx">command</span><span class="p">.</span><span class="nx">limit</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="mf">100</span><span class="p">);</span>

<span class="w">    </span><span class="nx">client</span><span class="p">.</span><span class="nx">ws</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="nb">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">({</span>
<span class="w">      </span><span class="nx">type</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;HISTORY_RESPONSE&#39;</span><span class="p">,</span>
<span class="w">      </span><span class="nx">data</span><span class="o">:</span><span class="w"> </span><span class="nx">filtered</span><span class="p">,</span>
<span class="w">      </span><span class="nx">count</span><span class="o">:</span><span class="w"> </span><span class="nx">filtered</span><span class="p">.</span><span class="nx">length</span>
<span class="w">    </span><span class="p">}));</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nx">getCurrentMetrics</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">memory</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">process</span><span class="p">.</span><span class="nx">memoryUsage</span><span class="p">();</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">timestamp</span><span class="o">:</span><span class="w"> </span><span class="nb">Date</span><span class="p">.</span><span class="nx">now</span><span class="p">(),</span>
<span class="w">      </span><span class="nx">system</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">memory</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="nx">heapUsed</span><span class="o">:</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">round</span><span class="p">(</span><span class="nx">memory</span><span class="p">.</span><span class="nx">heapUsed</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mf">1024</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mf">1024</span><span class="p">),</span>
<span class="w">          </span><span class="nx">heapTotal</span><span class="o">:</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">round</span><span class="p">(</span><span class="nx">memory</span><span class="p">.</span><span class="nx">heapTotal</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mf">1024</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mf">1024</span><span class="p">),</span>
<span class="w">          </span><span class="nx">rss</span><span class="o">:</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">round</span><span class="p">(</span><span class="nx">memory</span><span class="p">.</span><span class="nx">rss</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mf">1024</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mf">1024</span><span class="p">)</span>
<span class="w">        </span><span class="p">},</span>
<span class="w">        </span><span class="nx">uptime</span><span class="o">:</span><span class="w"> </span><span class="nx">process</span><span class="p">.</span><span class="nx">uptime</span><span class="p">()</span>
<span class="w">      </span><span class="p">},</span>
<span class="w">      </span><span class="nx">application</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">debugConnections</span><span class="o">:</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">debugServer</span><span class="p">.</span><span class="nx">clients</span><span class="p">.</span><span class="nx">size</span><span class="p">,</span>
<span class="w">        </span><span class="nx">messageBufferSize</span><span class="o">:</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">messageBuffer</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span>
<span class="w">        </span><span class="nx">activeTraces</span><span class="o">:</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">performanceTraces</span><span class="p">.</span><span class="nx">size</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">};</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">RealtimeDebugger</span><span class="w"> </span><span class="p">};</span>
</code></pre></div>
<h4 id="34-runbook-cho-common-issues">3.4 Runbook cho Common Issues<a class="headerlink" href="#34-runbook-cho-common-issues" title="Permanent link">&para;</a></h4>
<h5 id="critical-issue-high-message-latency-500ms-p95">ğŸš¨ CRITICAL ISSUE: High Message Latency (&gt;500ms p95)<a class="headerlink" href="#critical-issue-high-message-latency-500ms-p95" title="Permanent link">&para;</a></h5>
<p><strong>Symptoms:</strong>
- Users report delayed messages
- Monitoring shows p95 latency &gt; 500ms
- Message queue backlog increasing</p>
<p><strong>Immediate Actions (First 5 minutes):</strong></p>
<ol>
<li>
<p><strong>Scale Horizontally</strong>
   <div class="highlight"><pre><span></span><code><span class="c1"># Scale up chat servers</span>
kubectl<span class="w"> </span>scale<span class="w"> </span>deployment<span class="w"> </span>chat-server<span class="w"> </span>--replicas<span class="o">=</span><span class="m">10</span>

<span class="c1"># Scale up Redis</span>
kubectl<span class="w"> </span>scale<span class="w"> </span>statefulset<span class="w"> </span>redis<span class="w"> </span>--replicas<span class="o">=</span><span class="m">3</span>
</code></pre></div></p>
</li>
<li>
<p><strong>Check Dependencies</strong>
   <div class="highlight"><pre><span></span><code><span class="c1"># Check database health</span>
kubectl<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>-it<span class="w"> </span>postgres-0<span class="w"> </span>--<span class="w"> </span>pg_isready

<span class="c1"># Check Redis latency</span>
kubectl<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>-it<span class="w"> </span>redis-0<span class="w"> </span>--<span class="w"> </span>redis-cli<span class="w"> </span>--latency
</code></pre></div></p>
</li>
<li>
<p><strong>Reduce Load</strong>
   <div class="highlight"><pre><span></span><code><span class="c1"># Temporarily disable non-essential features</span>
curl<span class="w"> </span>-X<span class="w"> </span>POST<span class="w"> </span>http://chat-server/features/disable<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-d<span class="w"> </span><span class="s1">&#39;{&quot;features&quot;: [&quot;typing_indicators&quot;, &quot;read_receipts&quot;]}&#39;</span>
</code></pre></div></p>
</li>
</ol>
<p><strong>Investigation (5-15 minutes):</strong></p>
<ol>
<li>
<p><strong>Identify Bottleneck</strong>
   <div class="highlight"><pre><span></span><code><span class="c1">// Use diagnostic toolkit</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">report</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">diagnosticToolkit</span><span class="p">.</span><span class="nx">diagnoseLatency</span><span class="p">();</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">report</span><span class="p">);</span>
</code></pre></div></p>
</li>
<li>
<p><strong>Check Resource Usage</strong>
   <div class="highlight"><pre><span></span><code><span class="c1"># CPU usage</span>
kubectl<span class="w"> </span>top<span class="w"> </span>pods<span class="w"> </span>-l<span class="w"> </span><span class="nv">app</span><span class="o">=</span>chat-server

<span class="c1"># Memory usage</span>
kubectl<span class="w"> </span>describe<span class="w"> </span>pods<span class="w"> </span>-l<span class="w"> </span><span class="nv">app</span><span class="o">=</span>chat-server<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>-A<span class="w"> </span><span class="m">5</span><span class="w"> </span><span class="s2">&quot;Limits&quot;</span>

<span class="c1"># Network connections</span>
kubectl<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>-it<span class="w"> </span>chat-server-pod<span class="w"> </span>--<span class="w"> </span>netstat<span class="w"> </span>-an<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>ESTABLISHED<span class="w"> </span><span class="p">|</span><span class="w"> </span>wc<span class="w"> </span>-l
</code></pre></div></p>
</li>
</ol>
<p><strong>Resolution:</strong>
- <strong>If CPU-bound:</strong> Optimize algorithms, add caching, use worker threads
- <strong>If Memory-bound:</strong> Increase limits, fix leaks, optimize data structures
- <strong>If I/O-bound:</strong> Add indexes, implement pooling, use Redis caching</p>
<h5 id="warning-high-memory-usage-80">ğŸŸ¡ WARNING: High Memory Usage (&gt;80%)<a class="headerlink" href="#warning-high-memory-usage-80" title="Permanent link">&para;</a></h5>
<p><strong>Symptoms:</strong>
- Memory usage &gt; 80% sustained
- Frequent garbage collection
- Increased response times</p>
<p><strong>Immediate Actions:</strong></p>
<ol>
<li>
<p><strong>Restart Pods with Highest Memory</strong>
   <div class="highlight"><pre><span></span><code>kubectl<span class="w"> </span>top<span class="w"> </span>pods<span class="w"> </span>-l<span class="w"> </span><span class="nv">app</span><span class="o">=</span>chat-server<span class="w"> </span>--sort-by<span class="o">=</span>memory
kubectl<span class="w"> </span>delete<span class="w"> </span>pod<span class="w"> </span>chat-server-worst-pod
</code></pre></div></p>
</li>
<li>
<p><strong>Increase Memory Limits</strong>
   <div class="highlight"><pre><span></span><code>kubectl<span class="w"> </span>patch<span class="w"> </span>deployment<span class="w"> </span>chat-server<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-p<span class="w"> </span><span class="s1">&#39;{&quot;spec&quot;:{&quot;template&quot;:{&quot;spec&quot;:{&quot;containers&quot;:[{&quot;name&quot;:&quot;chat-server&quot;,&quot;resources&quot;:{&quot;limits&quot;:{&quot;memory&quot;:&quot;2Gi&quot;}}}]}}}}&#39;</span>
</code></pre></div></p>
</li>
</ol>
<p><strong>Resolution:</strong>
- Fix memory leaks in connections
- Optimize large message buffers
- Implement connection cleanup</p>
<h5 id="critical-connection-storm-10k-connectionsminute">ğŸ”´ CRITICAL: Connection Storm (&gt;10k connections/minute)<a class="headerlink" href="#critical-connection-storm-10k-connectionsminute" title="Permanent link">&para;</a></h5>
<p><strong>Symptoms:</strong>
- Rapid increase in connections
- Authentication service overwhelmed
- System resources exhausted</p>
<p><strong>Immediate Actions:</strong></p>
<ol>
<li>
<p><strong>Enable Rate Limiting</strong>
   <div class="highlight"><pre><span></span><code><span class="c1"># nginx configuration</span>
<span class="k">limit_conn_zone</span><span class="w"> </span><span class="nv">$binary_remote_addr</span><span class="w"> </span><span class="s">zone=conn_limit_per_ip:10m</span><span class="p">;</span>
<span class="k">limit_conn</span><span class="w"> </span><span class="s">conn_limit_per_ip</span><span class="w"> </span><span class="mi">10</span><span class="p">;</span>
</code></pre></div></p>
</li>
<li>
<p><strong>Scale Authentication Service</strong>
   <div class="highlight"><pre><span></span><code>kubectl<span class="w"> </span>scale<span class="w"> </span>deployment<span class="w"> </span>auth-service<span class="w"> </span>--replicas<span class="o">=</span><span class="m">5</span>
</code></pre></div></p>
</li>
<li>
<p><strong>Implement Connection Queue</strong>
   <div class="highlight"><pre><span></span><code><span class="kd">let</span><span class="w"> </span><span class="nx">connectionQueue</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[];</span>
<span class="kd">let</span><span class="w"> </span><span class="nx">processing</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">MAX_CONCURRENT</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1000</span><span class="p">;</span>

<span class="nx">io</span><span class="p">.</span><span class="nx">engine</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;connection&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="nx">socket</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">connectionQueue</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">socket</span><span class="p">);</span>
<span class="w">  </span><span class="nx">processQueue</span><span class="p">();</span>
<span class="p">});</span>

<span class="kd">function</span><span class="w"> </span><span class="nx">processQueue</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="nx">processing</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="nx">MAX_CONCURRENT</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">connectionQueue</span><span class="p">.</span><span class="nx">length</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">processing</span><span class="o">++</span><span class="p">;</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">socket</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">connectionQueue</span><span class="p">.</span><span class="nx">shift</span><span class="p">();</span>
<span class="w">    </span><span class="nx">handleConnection</span><span class="p">(</span><span class="nx">socket</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div></p>
</li>
</ol>
<hr />
<h2 id="tong-ket">ğŸ¯ Tá»”NG Káº¾T<a class="headerlink" href="#tong-ket" title="Permanent link">&para;</a></h2>
<p>Äá»ƒ trá»Ÿ thÃ nh QA/SDET chuyÃªn sÃ¢u cho chat application, báº¡n cáº§n:</p>
<ol>
<li>âœ… <strong>TÃ­ch há»£p Performance Test vÃ o CI/CD</strong> Ä‘á»ƒ phÃ¡t hiá»‡n sá»›m regression</li>
<li>âœ… <strong>Thiáº¿t láº­p Monitoring Stack</strong> Ä‘á»ƒ theo dÃµi production 24/7</li>
<li>âœ… <strong>XÃ¢y dá»±ng Diagnostic Toolkit</strong> Ä‘á»ƒ troubleshoot nhanh chÃ³ng</li>
<li>âœ… <strong>Táº¡o Runbook</strong> cho cÃ¡c sá»± cá»‘ phá»• biáº¿n</li>
</ol>
<p>CÃ¡c cÃ´ng cá»¥ vÃ  quy trÃ¬nh nÃ y sáº½ giÃºp báº¡n Ä‘áº£m báº£o chat application luÃ´n hoáº¡t Ä‘á»™ng á»•n Ä‘á»‹nh, hiá»‡u nÄƒng cao, vÃ  cÃ³ thá»ƒ scale Ä‘á»ƒ Ä‘Ã¡p á»©ng nhu cáº§u ngÆ°á»i dÃ¹ng.</p>
<p><strong>ChÃºc báº¡n thÃ nh cÃ´ng! ğŸš€</strong></p>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg>
  Back to top
</button>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      
      <script id="__config" type="application/json">{"annotate": null, "base": "..", "features": ["navigation.expand", "navigation.sections", "navigation.top", "content.code.copy", "content.code.annotate", "search.highlight", "search.suggest"], "search": "../assets/javascripts/workers/search.2c215733.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../assets/javascripts/bundle.79ae519e.min.js"></script>
      
    
  </body>
</html>